# COW CLI - Docker Compose Configuration
# Production deployment with monitoring stack

version: "3.8"

services:
  # ===========================================================================
  # COW CLI Application
  # ===========================================================================
  cow-cli:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: cow-cli:latest
    container_name: cow-cli
    environment:
      - COW_MATHPIX_APP_ID=${COW_MATHPIX_APP_ID}
      - COW_MATHPIX_APP_KEY=${COW_MATHPIX_APP_KEY}
      - COW_CONFIG_PATH=/data/config.yaml
      - COW_OUTPUT_DIR=/data/output
      - COW_CACHE_DIR=/data/cache
      - COW_REVIEW_DB_PATH=/data/review/review.db
      - COW_LOG_LEVEL=${COW_LOG_LEVEL:-INFO}
      - COW_METRICS_ENABLED=true
      - COW_METRICS_PORT=9090
    volumes:
      - ./data/input:/data/input:ro
      - ./data/output:/data/output
      - ./data/cache:/data/cache
      - ./data/review:/data/review
      - ./config.yaml:/data/config.yaml:ro
    ports:
      - "9090:9090"  # Metrics
    restart: unless-stopped
    networks:
      - cow-network
    healthcheck:
      test: ["CMD", "cow", "--help"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Batch Processing Worker
  # ===========================================================================
  cow-worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: cow-cli:latest
    container_name: cow-worker
    environment:
      - COW_MATHPIX_APP_ID=${COW_MATHPIX_APP_ID}
      - COW_MATHPIX_APP_KEY=${COW_MATHPIX_APP_KEY}
      - COW_CONFIG_PATH=/data/config.yaml
      - COW_OUTPUT_DIR=/data/output
      - COW_CACHE_DIR=/data/cache
      - COW_LOG_LEVEL=${COW_LOG_LEVEL:-INFO}
      - COW_MAX_WORKERS=${COW_MAX_WORKERS:-4}
    volumes:
      - ./data/input:/data/input:ro
      - ./data/output:/data/output
      - ./data/cache:/data/cache
      - ./config.yaml:/data/config.yaml:ro
    entrypoint: ["cow", "process", "batch", "/data/input", "-o", "/data/output"]
    depends_on:
      - cow-cli
    networks:
      - cow-network
    profiles:
      - batch

  # ===========================================================================
  # Prometheus (Metrics Collection)
  # ===========================================================================
  prometheus:
    image: prom/prometheus:v2.50.0
    container_name: cow-prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9091:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    restart: unless-stopped
    networks:
      - cow-network
    profiles:
      - monitoring

  # ===========================================================================
  # Grafana (Visualization)
  # ===========================================================================
  grafana:
    image: grafana/grafana:10.3.0
    container_name: cow-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - cow-network
    profiles:
      - monitoring

# =============================================================================
# Networks
# =============================================================================
networks:
  cow-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  prometheus-data:
  grafana-data:

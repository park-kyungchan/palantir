# =============================================================================
# MathpixPipeline - Kubernetes Deployment
# Production-ready deployment with 3 replicas, probes, and resource limits
# =============================================================================
#
# Apply: kubectl apply -f deployment.yaml -n mathpix-pipeline
#
# Prerequisites:
#   1. Create namespace: kubectl create namespace mathpix-pipeline
#   2. Create secret: kubectl create secret generic mathpix-api-credentials ...
#   3. Apply configmap: kubectl apply -f configmap.yaml
#
# =============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: mathpix-pipeline
  namespace: mathpix-pipeline
  labels:
    app: mathpix-pipeline
    app.kubernetes.io/name: mathpix-pipeline
    app.kubernetes.io/version: "2.0.0"
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: mathpix-pipeline
spec:
  # Number of replicas - adjust based on load
  replicas: 3

  # Rolling update strategy for zero-downtime deployments
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # Allow 1 extra pod during update
      maxUnavailable: 0  # Don't remove pods until new ones are ready

  # Pod selector
  selector:
    matchLabels:
      app: mathpix-pipeline

  template:
    metadata:
      labels:
        app: mathpix-pipeline
        app.kubernetes.io/name: mathpix-pipeline
        app.kubernetes.io/version: "2.0.0"
      annotations:
        # Prometheus scrape configuration
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
        # Force rolling restart on configmap changes
        checksum/config: "{{ include (print $.Template.BasePath \"/configmap.yaml\") . | sha256sum }}"

    spec:
      # Service account (create if needed for IRSA/Workload Identity)
      serviceAccountName: default

      # Security context at pod level
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000

      # Ensure pods are spread across nodes
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: mathpix-pipeline

      # Anti-affinity to spread pods across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: mathpix-pipeline
                topologyKey: kubernetes.io/hostname

      # Container definition
      containers:
        - name: mathpix-pipeline
          image: mathpix-pipeline:latest
          imagePullPolicy: IfNotPresent

          # Container ports
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP

          # Environment variables from ConfigMap
          envFrom:
            - configMapRef:
                name: mathpix-pipeline-config

          # Sensitive environment variables from Secret
          env:
            # API Credentials (from secret)
            - name: MATHPIX_APP_ID
              valueFrom:
                secretKeyRef:
                  name: mathpix-api-credentials
                  key: MATHPIX_APP_ID
            - name: MATHPIX_APP_KEY
              valueFrom:
                secretKeyRef:
                  name: mathpix-api-credentials
                  key: MATHPIX_APP_KEY
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mathpix-api-credentials
                  key: ANTHROPIC_API_KEY
                  optional: true
            - name: GEMINI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mathpix-api-credentials
                  key: GEMINI_API_KEY
                  optional: true
            # Pod information for logging/tracing
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

          # Resource limits and requests
          resources:
            requests:
              # Guaranteed resources
              cpu: "250m"      # 0.25 CPU cores
              memory: "256Mi"  # 256 MB RAM
            limits:
              # Maximum resources
              cpu: "500m"      # 0.5 CPU cores
              memory: "512Mi"  # 512 MB RAM
              # Ephemeral storage for cache
              ephemeral-storage: "1Gi"

          # Security context at container level
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false  # Set to true if possible
            capabilities:
              drop:
                - ALL

          # Readiness probe - Is the pod ready to receive traffic?
          # Checks /ready endpoint which verifies API connectivity and cache
          readinessProbe:
            httpGet:
              path: /ready
              port: http
              scheme: HTTP
            initialDelaySeconds: 10     # Wait 10s before first check
            periodSeconds: 10           # Check every 10s
            timeoutSeconds: 5           # Timeout after 5s
            successThreshold: 1         # 1 success = ready
            failureThreshold: 3         # 3 failures = not ready

          # Liveness probe - Should the pod be restarted?
          # Checks /health endpoint for basic service health
          livenessProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 30     # Wait 30s before first check
            periodSeconds: 30           # Check every 30s
            timeoutSeconds: 5           # Timeout after 5s
            successThreshold: 1         # 1 success = alive
            failureThreshold: 3         # 3 failures = restart pod

          # Startup probe - Give slow-starting containers time to start
          # Prevents liveness probe from killing pods during startup
          startupProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 5      # Wait 5s before first check
            periodSeconds: 5            # Check every 5s
            timeoutSeconds: 5           # Timeout after 5s
            failureThreshold: 30        # Allow up to 150s (5*30) for startup

          # Volume mounts
          volumeMounts:
            # Cache directory
            - name: cache-volume
              mountPath: /app/.cache
            # Temporary files
            - name: tmp-volume
              mountPath: /tmp

          # Lifecycle hooks
          lifecycle:
            preStop:
              exec:
                # Allow time for load balancer to remove pod from rotation
                command: ["/bin/sh", "-c", "sleep 10"]

      # Graceful shutdown configuration
      terminationGracePeriodSeconds: 60

      # Volumes
      volumes:
        # Ephemeral cache volume (EmptyDir)
        # For persistent cache, use PVC instead
        - name: cache-volume
          emptyDir:
            sizeLimit: 1Gi
        # Temporary directory
        - name: tmp-volume
          emptyDir:
            sizeLimit: 100Mi

      # Optional: Image pull secrets for private registries
      # imagePullSecrets:
      #   - name: regcred

---
# =============================================================================
# Pod Disruption Budget
# Ensures at least 2 pods are always available during voluntary disruptions
# =============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: mathpix-pipeline-pdb
  namespace: mathpix-pipeline
  labels:
    app: mathpix-pipeline
spec:
  minAvailable: 2  # At least 2 pods must be available
  selector:
    matchLabels:
      app: mathpix-pipeline

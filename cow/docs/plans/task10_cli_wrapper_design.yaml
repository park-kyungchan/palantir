# Task 10: CLI Wrapper Design & Claude MAX Subscription Optimization
# Created: 2026-02-04
# Agent: claude-code-guide

metadata:
  task_id: 10
  created_at: "2026-02-04"
  agent: "claude-code-guide"
  version: "1.0"
  objective: "Design CLI wrapper to maximize Claude MAX subscription usage with zero Claude API costs"

# ============================================================================
# 1. CLI FRAMEWORK RECOMMENDATION
# ============================================================================

cli_framework:
  recommendation: "Typer"
  rationale: |
    Typer is the best choice for cow-cli based on the following criteria:

    1. Modern Python: Built-in support for type hints and Python 3.6+
    2. Automatic Features: Auto-generates help text, completion, and validation
    3. Built on Click: Inherits Click's maturity and power with cleaner API
    4. Shell Completion: Automatic completion for Bash, Zsh, Fish, PowerShell
    5. Developer Experience: Minimal boilerplate, intuitive decorator syntax
    6. Ecosystem: Well-maintained, good documentation, active community

  comparison:
    argparse:
      pros:
        - "Built-in (no external dependency)"
        - "Stable and well-documented"
        - "Good for simple CLIs"
      cons:
        - "Verbose syntax"
        - "Manual argument parsing"
        - "No automatic completion"
        - "No type hint integration"
      verdict: "Not recommended for complex CLI with subcommands"

    click:
      pros:
        - "Mature and widely used"
        - "Powerful decorator-based API"
        - "Good subcommand support"
        - "Shell completion available"
      cons:
        - "More boilerplate than Typer"
        - "No automatic type validation from hints"
        - "Manual completion setup required"
      verdict: "Good choice, but Typer provides better DX"

    typer:
      pros:
        - "Automatic shell completion (all shells)"
        - "Type hint-based validation"
        - "Built on Click (inherits stability)"
        - "Minimal boilerplate"
        - "Excellent documentation"
        - "Fast development"
      cons:
        - "External dependency"
        - "Smaller ecosystem than Click"
      verdict: "RECOMMENDED - Best balance of features and ease of use"

  installation:
    command: "pip install 'typer[all]'"
    includes:
      - "typer: Core framework"
      - "rich: Rich text and beautiful terminal output"
      - "shellingham: Automatic shell detection"
      - "click-completion: Shell completion support"

# ============================================================================
# 2. CLAUDE MAX SUBSCRIPTION ANALYSIS
# ============================================================================

claude_max_utilization:
  subscription_tiers:
    max_100:
      cost_per_month: 100
      usage_multiplier: "5x Pro"
      models:
        - "Claude Sonnet 4.5 (5x higher limits than Pro)"
        - "Generous Opus 4.5 access"
      included_products:
        - "claude.ai web interface"
        - "Claude Code (terminal coding assistant)"
        - "Claude Desktop app"
        - "Research access"
        - "Google Workspace integration"
        - "Remote MCP server connections"
      notes: "Good for moderate usage, testing, development"

    max_200:
      cost_per_month: 200
      usage_multiplier: "20x Pro"
      models:
        - "Full Opus 4.5 access (caps removed)"
        - "All Claude models"
        - "Increased overall limits"
      included_products:
        - "All features from $100 tier"
        - "Unlimited Opus 4.5 usage (within higher limits)"
      notes: "Recommended for production COW pipeline usage"

  usage_limits:
    reset_cycle: "Every 5 hours (rolling window)"
    weekly_limit: "Additional weekly cap (resets every 7 days)"
    shared_limits: true
    shared_products:
      - "claude.ai (web chat)"
      - "Claude Code (terminal)"
      - "Claude Desktop (app)"
    important: |
      All Claude product usage counts toward the SAME limit.
      Using Claude Code heavily will reduce claude.ai quota and vice versa.

  api_access:
    included_in_subscription: false
    critical_distinction: |
      Claude MAX subscription does NOT include traditional API access.

      - Subscription: Access to claude.ai, Claude Code, Desktop
      - API Access: Separate pay-per-token billing via Console

      However, Claude Code (included in MAX) can be used programmatically
      via the Agent SDK, which counts against subscription limits, not API billing.

    cost_implication: |
      To maximize value:
      ✅ Use Claude Code with Agent SDK → FREE (covered by MAX subscription)
      ❌ Use Claude API via Console → PAID (separate billing at $15/million input tokens)

  free_usage_scope:
    what_is_free:
      - "Claude Code CLI usage (up to subscription limits)"
      - "Agent SDK programmatic calls (via Claude Code)"
      - "All models included in subscription tier"
      - "Unlimited tool use (Read, Edit, Bash, etc.) within Claude Code"

    what_costs_extra:
      - "Traditional API calls via platform.anthropic.com"
      - "Extended API usage beyond subscription patterns"
      - "Mathpix API calls (separate service, unavoidable)"

# ============================================================================
# 3. COST OPTIMIZATION STRATEGY
# ============================================================================

cost_optimization:
  mathpix_costs:
    unavoidable: true
    pricing_model: "Pay-per-use (OCR requests)"
    cost_areas:
      image_ocr:
        endpoint: "/v3/text"
        billing: "Per image request"
        optimization: "Cache results, avoid re-processing same images"

      pdf_processing:
        endpoint: "/v3/pdf"
        billing: "Per page (images with >12 rows priced as PDF page)"
        optimization: "Use page_ranges to process only needed pages"

      batch_processing:
        endpoint: "/v3/batch"
        billing: "Per image in batch"
        optimization: "Group similar processing needs to reduce overhead"

    reduction_strategies:
      caching:
        description: "Cache Mathpix API responses locally"
        implementation:
          - "Hash image content (SHA256) as cache key"
          - "Store full JSON response in ~/.cow/cache/"
          - "TTL: 30 days (configurable)"
          - "LRU eviction when cache exceeds size limit"
        expected_savings: "50-80% reduction in duplicate API calls during development/testing"

      deduplication:
        description: "Detect duplicate images before API call"
        implementation:
          - "Compute perceptual hash (phash) for images"
          - "Check cache before sending to Mathpix"
          - "Return cached result if exact match"
        expected_savings: "Additional 10-20% reduction in production workflows"

      batch_optimization:
        description: "Use batch endpoint for multiple images"
        implementation:
          - "Queue images in memory"
          - "Submit when batch_size reached or timeout"
          - "Process results asynchronously"
        expected_savings: "Reduced HTTP overhead, faster processing"

      intelligent_preprocessing:
        description: "Validate images locally before API call"
        implementation:
          - "Check image format, size, readability"
          - "Reject blank/corrupt images early"
          - "Auto-crop/enhance if needed (local)"
        expected_savings: "Avoid wasting API calls on invalid inputs"

  claude_free_strategy:
    core_principle: "Use Claude Code SDK, not Claude API"

    architecture:
      option_a:
        name: "Direct API Integration"
        description: "Call Claude API via platform.anthropic.com"
        cost: "PAID - $15/MTok input, $75/MTok output (Opus)"
        verdict: "❌ NOT RECOMMENDED - Defeats MAX subscription value"

      option_b:
        name: "Claude Code SDK Integration"
        description: "Use Agent SDK to interact with Claude Code programmatically"
        cost: "FREE - Covered by MAX subscription"
        verdict: "✅ RECOMMENDED - Zero additional Claude costs"

    implementation_approach:
      sdk: "Claude Code Agent SDK (Python or TypeScript)"
      integration_points:
        semantic_graph_construction:
          current: "Claude API calls in pipeline"
          replacement: "Claude Code SDK with --output-format json"
          benefit: "FREE semantic analysis using MAX subscription"

        human_review_suggestions:
          current: "Claude API for review recommendations"
          replacement: "Claude Code SDK with prompt templates"
          benefit: "FREE HITL workflow intelligence"

        alignment_verification:
          current: "Claude API for consistency checks"
          replacement: "Claude Code SDK with validation prompts"
          benefit: "FREE quality assurance"

    usage_management:
      monitoring:
        - "Track Claude Code SDK usage per session"
        - "Implement rate limiting to stay within 5-hour windows"
        - "Queue requests during high usage periods"

      optimization:
        - "Use caching for repeated queries"
        - "Batch similar analysis requests"
        - "Leverage extended thinking for complex tasks (included in MAX)"

      fallback:
        - "If subscription limits hit, queue for next 5-hour window"
        - "Critical operations can use API with explicit user approval"

  total_cost_estimate:
    mathpix_only:
      description: "Only unavoidable cost"
      estimation:
        images_per_month: 1000
        cost_per_image: "$0.004 (estimate)"
        monthly_cost: "$4.00"

      pdf_processing:
        pages_per_month: 500
        cost_per_page: "$0.01 (estimate)"
        monthly_cost: "$5.00"

      total_mathpix: "$9/month (varies by usage)"

    claude_costs:
      with_api: "$50-200/month (depending on volume)"
      with_max_subscription: "$0 (covered by $100 or $200 subscription)"
      net_savings: "$50-200/month"

    recommendation: |
      Choose Claude MAX $200/month subscription:
      - Covers all Claude Code usage (no API fees)
      - High limits for production workloads
      - Total monthly cost: $200 (subscription) + ~$10 (Mathpix) = $210/month

      vs. Alternative (Pro + API):
      - Claude Pro: $20/month
      - Claude API: $100-200/month (estimated)
      - Mathpix: $10/month
      - Total: $130-230/month with less flexibility

      MAX $200 provides better value and higher limits.

# ============================================================================
# 4. CLI COMMAND STRUCTURE
# ============================================================================

cli_command_structure:
  top_level:
    command: "cow-cli"
    description: "Claude + Mathpix pipeline for mathematical content extraction"
    version_flag: "--version"
    help_flag: "--help"
    global_options:
      verbose:
        flag: "-v, --verbose"
        description: "Enable verbose output"
        levels: ["INFO", "DEBUG"]

      config:
        flag: "-c, --config PATH"
        description: "Override default config file location"
        default: "~/.cow/config.yaml"

      no_cache:
        flag: "--no-cache"
        description: "Disable result caching"

      quiet:
        flag: "-q, --quiet"
        description: "Suppress non-error output"

  subcommands:
    process:
      description: "Process images or PDFs through Mathpix + Claude pipeline"

      image:
        command: "cow-cli process image [OPTIONS] IMAGE_PATH"
        description: "Process a single image"
        options:
          output:
            flag: "-o, --output PATH"
            description: "Output directory"
            default: "./outputs"

          format:
            flag: "-f, --format [docx|latex|markdown|json|all]"
            description: "Output format(s)"
            default: "all"
            multiple: true

          confidence_threshold:
            flag: "--confidence FLOAT"
            description: "Minimum confidence threshold (0.0-1.0)"
            default: 0.75

          skip_review:
            flag: "--skip-review"
            description: "Skip human review (auto-approve if confidence high enough)"

          show_progress:
            flag: "--progress"
            description: "Show progress bars"
            default: true

        example: |
          cow-cli process image -f docx -f latex --confidence 0.8 equation.png

      batch:
        command: "cow-cli process batch [OPTIONS] IMAGE_DIR"
        description: "Process multiple images"
        options:
          pattern:
            flag: "-p, --pattern GLOB"
            description: "File pattern to match"
            default: "*.{png,jpg,jpeg}"

          parallel:
            flag: "-j, --jobs INT"
            description: "Number of parallel workers"
            default: 4

          output:
            flag: "-o, --output PATH"
            description: "Output directory"
            default: "./outputs"

          format:
            flag: "-f, --format [docx|latex|markdown|json|all]"
            description: "Output format(s)"
            multiple: true

          batch_size:
            flag: "--batch-size INT"
            description: "Mathpix batch API size"
            default: 10

        example: |
          cow-cli process batch -p "*.png" -j 8 --batch-size 20 ./images/

      pdf:
        command: "cow-cli process pdf [OPTIONS] PDF_PATH"
        description: "Process PDF document"
        options:
          pages:
            flag: "--pages RANGE"
            description: "Page range to process (e.g., '1-5,10,15-20')"
            default: "all"

          output:
            flag: "-o, --output PATH"
            description: "Output directory"

          format:
            flag: "-f, --format [docx|latex|markdown|json|all]"
            description: "Output format(s)"
            multiple: true

          streaming:
            flag: "--streaming"
            description: "Enable page-by-page streaming"
            default: false

        example: |
          cow-cli process pdf --pages "1-10" -f docx textbook.pdf

    review:
      description: "Human-in-the-loop review workflow"

      list:
        command: "cow-cli review list [OPTIONS]"
        description: "List pending review items"
        options:
          status:
            flag: "-s, --status [pending|approved|rejected|all]"
            description: "Filter by status"
            default: "pending"

          limit:
            flag: "-n, --limit INT"
            description: "Max items to show"
            default: 20

          sort:
            flag: "--sort [confidence|date|priority]"
            description: "Sort order"
            default: "priority"

        example: |
          cow-cli review list -s pending --sort confidence -n 50

      show:
        command: "cow-cli review show REVIEW_ID"
        description: "Show detailed review information"
        options:
          format:
            flag: "-f, --format [text|json]"
            description: "Output format"
            default: "text"

          diff:
            flag: "--diff"
            description: "Show diff between original and processed"

        example: |
          cow-cli review show abc123 --diff

      approve:
        command: "cow-cli review approve REVIEW_ID [OPTIONS]"
        description: "Approve and proceed with processing"
        options:
          comment:
            flag: "-m, --message TEXT"
            description: "Approval comment"

          export:
            flag: "--export"
            description: "Export immediately after approval"
            default: false

        example: |
          cow-cli review approve abc123 -m "Looks good" --export

      reject:
        command: "cow-cli review reject REVIEW_ID [OPTIONS]"
        description: "Reject with feedback"
        options:
          reason:
            flag: "-r, --reason TEXT"
            description: "Rejection reason"
            required: true

          retry:
            flag: "--retry"
            description: "Re-queue for processing with adjustments"

        example: |
          cow-cli review reject abc123 -r "Low confidence on equation 3" --retry

      stats:
        command: "cow-cli review stats"
        description: "Show review queue statistics"
        output:
          - "Total pending: X"
          - "Average confidence: 0.XX"
          - "High priority: X"
          - "Approval rate: XX%"

    export:
      description: "Export processed results to various formats"

      docx:
        command: "cow-cli export docx [OPTIONS] INPUT"
        description: "Export to Microsoft Word"
        options:
          output:
            flag: "-o, --output PATH"
            description: "Output .docx file"

          font:
            flag: "--font FONT_NAME"
            description: "Document font"
            default: "Times New Roman"

          font_size:
            flag: "--font-size INT"
            description: "Base font size"
            default: 12

        example: |
          cow-cli export docx -o result.docx --font Arial input.json

      latex:
        command: "cow-cli export latex [OPTIONS] INPUT"
        description: "Export to LaTeX"
        options:
          output:
            flag: "-o, --output PATH"
            description: "Output .tex file (or .tex.zip with images)"

          document_class:
            flag: "--class CLASS"
            description: "LaTeX document class"
            default: "article"

          with_images:
            flag: "--with-images"
            description: "Include images in .tex.zip"

        example: |
          cow-cli export latex -o paper.tex --class article --with-images input.json

      markdown:
        command: "cow-cli export markdown [OPTIONS] INPUT"
        description: "Export to Markdown"
        options:
          output:
            flag: "-o, --output PATH"
            description: "Output .md file"

          flavor:
            flag: "--flavor [mathpix|standard|gfm]"
            description: "Markdown flavor"
            default: "mathpix"

        example: |
          cow-cli export markdown -o notes.md --flavor gfm input.json

      json:
        command: "cow-cli export json [OPTIONS] INPUT"
        description: "Export raw pipeline data"
        options:
          output:
            flag: "-o, --output PATH"
            description: "Output .json file"

          pretty:
            flag: "--pretty"
            description: "Pretty-print JSON"
            default: true

          include:
            flag: "--include FIELD"
            description: "Include specific fields only"
            multiple: true

        example: |
          cow-cli export json -o data.json --include semantic_graph --include word_data input.json

    config:
      description: "Configuration management"

      init:
        command: "cow-cli config init"
        description: "Initialize configuration interactively"
        prompts:
          - "Mathpix App ID: "
          - "Mathpix App Key (hidden): "
          - "Default output directory [./outputs]: "
          - "Enable caching? [Y/n]: "

        creates: "~/.cow/config.yaml"

      show:
        command: "cow-cli config show [OPTIONS]"
        description: "Display current configuration"
        options:
          format:
            flag: "-f, --format [yaml|json|env]"
            description: "Output format"
            default: "yaml"

          secrets:
            flag: "--show-secrets"
            description: "Show API keys (masked by default)"
            default: false

        example: |
          cow-cli config show -f json

      set:
        command: "cow-cli config set KEY VALUE"
        description: "Set configuration value"
        examples:
          - "cow-cli config set mathpix.app_id abc123"
          - "cow-cli config set cache.ttl_days 60"
          - "cow-cli config set output.directory ~/cow-outputs"

      validate:
        command: "cow-cli config validate"
        description: "Validate configuration and credentials"
        checks:
          - "Mathpix API credentials (test request)"
          - "Output directory exists and is writable"
          - "Cache directory setup"
          - "Required dependencies installed"

# ============================================================================
# 5. CONFIGURATION MANAGEMENT
# ============================================================================

configuration_management:
  priority_order:
    1: "Environment variables (highest priority)"
    2: "Config file (~/.cow/config.yaml)"
    3: "Default values (lowest priority)"

  environment_variables:
    COW_MATHPIX_APP_ID:
      description: "Mathpix application ID"
      required: true
      example: "abc123_xyz789"

    COW_MATHPIX_APP_KEY:
      description: "Mathpix API key"
      required: true
      security: "SENSITIVE - Never commit to version control"
      example: "sk_live_..."

    COW_MATHPIX_ENDPOINT:
      description: "Mathpix API endpoint URL"
      default: "https://api.mathpix.com"
      alternatives:
        - "https://api.mathpix.com (US)"
        - "https://eu-central-1.api.mathpix.com (EU - GDPR compliance)"

    COW_CACHE_DIR:
      description: "Cache directory path"
      default: "~/.cow/cache"

    COW_CACHE_ENABLED:
      description: "Enable/disable caching"
      default: "true"
      values: ["true", "false"]

    COW_OUTPUT_DIR:
      description: "Default output directory"
      default: "./outputs"

    COW_LOG_LEVEL:
      description: "Logging verbosity"
      default: "INFO"
      values: ["DEBUG", "INFO", "WARNING", "ERROR"]

    COW_CONFIG_PATH:
      description: "Override config file location"
      default: "~/.cow/config.yaml"

  config_file:
    location: "~/.cow/config.yaml"
    format: "YAML"

    schema:
      mathpix:
        type: "object"
        properties:
          app_id:
            type: "string"
            description: "Mathpix application ID"
            source: "console.mathpix.com"

          app_key:
            type: "string"
            description: "Mathpix API key (encrypted or keyring reference)"
            security: "SENSITIVE"
            storage: "keyring:service=cow-cli,username=mathpix"

          endpoint:
            type: "string"
            description: "API endpoint URL"
            default: "https://api.mathpix.com"
            enum:
              - "https://api.mathpix.com"
              - "https://eu-central-1.api.mathpix.com"

      cache:
        type: "object"
        properties:
          enabled:
            type: "boolean"
            default: true

          directory:
            type: "string"
            default: "~/.cow/cache"

          ttl_days:
            type: "integer"
            description: "Time-to-live in days"
            default: 30
            min: 1
            max: 365

          max_size_mb:
            type: "integer"
            description: "Maximum cache size in MB"
            default: 1024

          eviction_policy:
            type: "string"
            default: "lru"
            enum: ["lru", "fifo", "ttl"]

      output:
        type: "object"
        properties:
          directory:
            type: "string"
            default: "./outputs"

          formats:
            type: "array"
            items: "string"
            default: ["docx", "latex", "markdown", "json"]
            enum: ["docx", "latex", "markdown", "json"]

          naming_convention:
            type: "string"
            default: "{timestamp}_{hash}"
            placeholders:
              - "{timestamp}: ISO 8601 datetime"
              - "{hash}: Short hash of input"
              - "{original}: Original filename"

      review:
        type: "object"
        properties:
          auto_approve_confidence:
            type: "number"
            description: "Auto-approve if confidence above this threshold"
            default: 0.95
            min: 0.0
            max: 1.0

          queue_size:
            type: "integer"
            description: "Maximum review queue size"
            default: 100

          priority_threshold:
            type: "number"
            description: "Mark as high priority if confidence below this"
            default: 0.80

      processing:
        type: "object"
        properties:
          batch_size:
            type: "integer"
            description: "Number of images per Mathpix batch request"
            default: 10
            min: 1
            max: 100

          parallel_workers:
            type: "integer"
            description: "Number of parallel processing workers"
            default: 4
            min: 1
            max: 16

          timeout_seconds:
            type: "integer"
            description: "Request timeout"
            default: 30

          retry_attempts:
            type: "integer"
            default: 3

          retry_backoff:
            type: "string"
            default: "exponential"
            enum: ["exponential", "linear", "constant"]

    example:
      content: |
        mathpix:
          app_id: "abc123_xyz789"
          app_key: "keyring:service=cow-cli,username=mathpix"
          endpoint: "https://api.mathpix.com"

        cache:
          enabled: true
          directory: "~/.cow/cache"
          ttl_days: 30
          max_size_mb: 1024
          eviction_policy: "lru"

        output:
          directory: "./outputs"
          formats:
            - docx
            - latex
            - markdown
            - json
          naming_convention: "{timestamp}_{hash}"

        review:
          auto_approve_confidence: 0.95
          queue_size: 100
          priority_threshold: 0.80

        processing:
          batch_size: 10
          parallel_workers: 4
          timeout_seconds: 30
          retry_attempts: 3
          retry_backoff: "exponential"

  authentication_security:
    credential_storage:
      method: "keyring library"
      description: |
        Use Python keyring library for secure OS-level credential storage:
        - macOS: Keychain
        - Windows: Credential Vault
        - Linux: Secret Service API (GNOME Keyring, KWallet)

      implementation:
        library: "keyring>=23.0.0"
        service_name: "cow-cli"
        username: "mathpix"
        storage_flow:
          - "User provides API key via `cow-cli config init`"
          - "Store in OS keyring: keyring.set_password('cow-cli', 'mathpix', api_key)"
          - "Config file contains: 'keyring:service=cow-cli,username=mathpix'"
          - "At runtime: api_key = keyring.get_password('cow-cli', 'mathpix')"

    environment_variable_injection:
      description: "Support credential injection via environment variables"
      use_cases:
        - "CI/CD pipelines"
        - "Docker containers"
        - "Serverless functions"

      precedence: "Environment variables override keyring/config file"

      example: |
        export COW_MATHPIX_APP_ID="abc123"
        export COW_MATHPIX_APP_KEY="sk_live_..."
        cow-cli process image equation.png

    validation:
      command: "cow-cli config validate"
      checks:
        - name: "Credential presence"
          test: "Verify app_id and app_key are set"

        - name: "Credential validity"
          test: "Make test API call to Mathpix /v3/app-tokens"
          success: "Credentials valid"
          failure: "Invalid credentials or network error"

        - name: "Quota check"
          test: "Call /v3/ocr-usage to check remaining quota"
          warning: "Display if quota low"

    security_best_practices:
      - "Never commit API keys to version control"
      - "Use .gitignore for .env files and config.yaml"
      - "Rotate API keys regularly"
      - "Use environment variables in production"
      - "Encrypt config files if storing keys directly (not recommended)"
      - "Implement key expiration and rotation reminders"

# ============================================================================
# 6. IMPLEMENTATION PLAN
# ============================================================================

implementation_plan:
  phase_1:
    name: "Core CLI Structure"
    duration: "1 week"
    tasks:
      - task: "Setup Typer project structure"
        deliverables:
          - "cow_cli/ package directory"
          - "setup.py / pyproject.toml"
          - "Entry point: cow-cli command"

      - task: "Implement config management"
        deliverables:
          - "cow_cli/config.py"
          - "keyring integration"
          - "config init/show/set/validate commands"

      - task: "Setup logging and error handling"
        deliverables:
          - "cow_cli/logging.py"
          - "Rich console output"
          - "Error recovery suggestions"

  phase_2:
    name: "Mathpix Integration"
    duration: "1 week"
    tasks:
      - task: "Mathpix API client"
        deliverables:
          - "cow_cli/mathpix/client.py"
          - "Support /v3/text, /v3/pdf, /v3/batch"
          - "Async request handling"

      - task: "Caching layer"
        deliverables:
          - "cow_cli/cache.py"
          - "SHA256 hashing for cache keys"
          - "LRU eviction policy"
          - "TTL management"

      - task: "Image preprocessing"
        deliverables:
          - "cow_cli/preprocessing.py"
          - "Format validation"
          - "Perceptual hashing for deduplication"

  phase_3:
    name: "Claude Code SDK Integration"
    duration: "1-2 weeks"
    tasks:
      - task: "Agent SDK wrapper"
        deliverables:
          - "cow_cli/claude/agent.py"
          - "Programmatic Claude Code access"
          - "--output-format json support"

      - task: "Semantic graph construction"
        deliverables:
          - "cow_cli/semantic/builder.py"
          - "Replace API calls with SDK calls"
          - "Use MAX subscription (free)"

      - task: "HITL review intelligence"
        deliverables:
          - "cow_cli/review/suggestions.py"
          - "Claude Code prompts for review prioritization"

  phase_4:
    name: "Process Commands"
    duration: "1 week"
    tasks:
      - task: "Process image command"
        deliverables:
          - "cow_cli/commands/process_image.py"
          - "Progress bars"
          - "Output format selection"

      - task: "Process batch command"
        deliverables:
          - "cow_cli/commands/process_batch.py"
          - "Parallel workers"
          - "Batch API integration"

      - task: "Process PDF command"
        deliverables:
          - "cow_cli/commands/process_pdf.py"
          - "Page range parsing"
          - "Streaming support"

  phase_5:
    name: "Review Workflow"
    duration: "1 week"
    tasks:
      - task: "Review database"
        deliverables:
          - "cow_cli/review/database.py"
          - "SQLite storage for review queue"
          - "Status tracking"

      - task: "Review commands"
        deliverables:
          - "cow_cli/commands/review_*.py"
          - "list, show, approve, reject, stats"
          - "Rich table output"

  phase_6:
    name: "Export Commands"
    duration: "1 week"
    tasks:
      - task: "Export to DOCX"
        deliverables:
          - "cow_cli/export/docx.py"
          - "python-docx integration"

      - task: "Export to LaTeX"
        deliverables:
          - "cow_cli/export/latex.py"
          - "Mathpix converter integration"

      - task: "Export to Markdown/JSON"
        deliverables:
          - "cow_cli/export/markdown.py"
          - "cow_cli/export/json.py"

  phase_7:
    name: "Testing & Documentation"
    duration: "1 week"
    tasks:
      - task: "Unit tests"
        coverage: "80% minimum"
        framework: "pytest"

      - task: "Integration tests"
        deliverables:
          - "tests/integration/test_e2e.py"
          - "Mock Mathpix API responses"

      - task: "User documentation"
        deliverables:
          - "README.md"
          - "docs/installation.md"
          - "docs/configuration.md"
          - "docs/usage.md"
          - "docs/troubleshooting.md"

  total_duration: "6-7 weeks"

  milestones:
    week_1: "Core CLI + Config management working"
    week_2: "Mathpix integration + caching complete"
    week_3: "Claude Code SDK integrated"
    week_4: "Process commands functional"
    week_5: "Review workflow complete"
    week_6: "Export commands working"
    week_7: "Testing + documentation done"

# ============================================================================
# 7. TECHNICAL ARCHITECTURE
# ============================================================================

technical_architecture:
  project_structure:
    layout: |
      cow-cli/
      ├── cow_cli/
      │   ├── __init__.py
      │   ├── __main__.py          # Entry point
      │   ├── cli.py               # Typer app definition
      │   ├── config.py            # Configuration management
      │   ├── cache.py             # Caching layer
      │   ├── logging.py           # Logging setup
      │   │
      │   ├── mathpix/
      │   │   ├── __init__.py
      │   │   ├── client.py        # Mathpix API client
      │   │   ├── schemas.py       # Request/response models
      │   │   └── exceptions.py
      │   │
      │   ├── claude/
      │   │   ├── __init__.py
      │   │   ├── agent.py         # Claude Code SDK wrapper
      │   │   ├── prompts.py       # Prompt templates
      │   │   └── schemas.py
      │   │
      │   ├── semantic/
      │   │   ├── __init__.py
      │   │   ├── builder.py       # Semantic graph construction
      │   │   ├── node_extractor.py
      │   │   └── edge_inferrer.py
      │   │
      │   ├── review/
      │   │   ├── __init__.py
      │   │   ├── database.py      # Review queue storage
      │   │   ├── suggestions.py   # HITL intelligence
      │   │   └── models.py
      │   │
      │   ├── export/
      │   │   ├── __init__.py
      │   │   ├── docx.py
      │   │   ├── latex.py
      │   │   ├── markdown.py
      │   │   └── json.py
      │   │
      │   ├── preprocessing/
      │   │   ├── __init__.py
      │   │   ├── validator.py
      │   │   └── deduplicator.py
      │   │
      │   └── commands/
      │       ├── __init__.py
      │       ├── process_image.py
      │       ├── process_batch.py
      │       ├── process_pdf.py
      │       ├── review_list.py
      │       ├── review_show.py
      │       ├── review_approve.py
      │       ├── review_reject.py
      │       ├── review_stats.py
      │       ├── export_docx.py
      │       ├── export_latex.py
      │       ├── export_markdown.py
      │       ├── export_json.py
      │       ├── config_init.py
      │       ├── config_show.py
      │       ├── config_set.py
      │       └── config_validate.py
      │
      ├── tests/
      │   ├── unit/
      │   ├── integration/
      │   └── fixtures/
      │
      ├── docs/
      │   ├── installation.md
      │   ├── configuration.md
      │   ├── usage.md
      │   └── troubleshooting.md
      │
      ├── pyproject.toml
      ├── setup.py
      ├── README.md
      ├── LICENSE
      └── .gitignore

  dependencies:
    core:
      - "typer[all]>=0.9.0"
      - "rich>=13.0.0"
      - "pydantic>=2.0.0"
      - "httpx>=0.24.0"
      - "keyring>=23.0.0"
      - "python-dotenv>=1.0.0"

    mathpix:
      - "httpx>=0.24.0 (async HTTP client)"

    claude:
      - "anthropic>=0.21.0 (Claude SDK)"
      - "# OR use Claude Code Agent SDK when available"

    export:
      - "python-docx>=0.8.11"
      - "PyYAML>=6.0"

    preprocessing:
      - "Pillow>=10.0.0"
      - "imagehash>=4.3.0 (perceptual hashing)"

    storage:
      - "sqlalchemy>=2.0.0"
      - "sqlite3 (built-in)"

    testing:
      - "pytest>=7.0.0"
      - "pytest-cov>=4.0.0"
      - "pytest-asyncio>=0.21.0"
      - "respx>=0.20.0 (HTTP mocking)"

# ============================================================================
# 8. SUCCESS METRICS
# ============================================================================

success_metrics:
  cost_efficiency:
    target: "Zero Claude API costs (100% covered by MAX subscription)"
    measurement: "Monthly billing statement shows $0 Claude API charges"

  mathpix_optimization:
    target: "50% reduction in duplicate API calls via caching"
    measurement: "Cache hit rate >= 50%"

  performance:
    image_processing:
      target: "< 5 seconds per image (including Mathpix + Claude)"
      measurement: "Average latency from CLI invocation to result"

    batch_processing:
      target: "Process 100 images in < 2 minutes"
      measurement: "End-to-end batch workflow time"

  usability:
    cli_intuitiveness:
      target: "User can process first image without reading docs"
      measurement: "Help text + autocomplete sufficient for basic usage"

    error_recovery:
      target: "All errors include actionable recovery suggestions"
      measurement: "Error messages include 'Try: ...' suggestions"

  reliability:
    uptime:
      target: "99% success rate (excluding network failures)"
      measurement: "Successful completions / total attempts"

    data_integrity:
      target: "Zero data loss in review queue"
      measurement: "SQLite transactions + backup strategy"

# ============================================================================
# 9. RISK MITIGATION
# ============================================================================

risk_mitigation:
  claude_max_limit_exhaustion:
    risk: "Usage exceeds 5-hour or weekly limits"
    likelihood: "Medium (if processing large batches)"
    impact: "High (pipeline stops)"
    mitigation:
      - "Implement usage tracking and warnings"
      - "Queue requests when approaching limits"
      - "Provide API fallback with explicit cost warning"
      - "Distribute processing across multiple 5-hour windows"

  mathpix_api_changes:
    risk: "Mathpix API breaks or changes pricing"
    likelihood: "Low-Medium"
    impact: "High (core dependency)"
    mitigation:
      - "Pin API version in requests"
      - "Comprehensive error handling"
      - "Monitor Mathpix changelog"
      - "Consider alternative OCR providers as backup"

  credential_leakage:
    risk: "API keys exposed in logs or configs"
    likelihood: "Low (with proper implementation)"
    impact: "Critical (security breach)"
    mitigation:
      - "Use keyring for secure storage"
      - "Mask keys in logs and config output"
      - "Add .env and config.yaml to .gitignore"
      - "Implement key rotation reminders"

  cache_corruption:
    risk: "Cache becomes corrupted or stale"
    likelihood: "Low"
    impact: "Medium (incorrect results)"
    mitigation:
      - "Use content-based hashing (SHA256)"
      - "Implement cache validation on read"
      - "Provide cache clear command"
      - "TTL-based expiration"

  dependency_conflicts:
    risk: "Dependency version conflicts in user environments"
    likelihood: "Medium"
    impact: "Medium (installation failure)"
    mitigation:
      - "Use conservative version constraints"
      - "Provide virtual environment instructions"
      - "Consider packaging as standalone binary (PyInstaller)"

# ============================================================================
# SOURCES
# ============================================================================

sources:
  claude_max_documentation:
    - "https://claudelog.com/faqs/claude-limit/"
    - "https://github.com/anthropics/claude-code/issues/16157"
    - "https://support.claude.com/en/articles/11145838-using-claude-code-with-your-pro-or-max-plan"
    - "https://www.glbgpt.com/hub/claude-ai-pricing-2026-the-ultimate-guide-to-plans-api-costs-and-limits/"

  claude_api_vs_subscription:
    - "https://support.claude.com/en/articles/9876003-i-have-a-paid-claude-subscription-pro-max-team-or-enterprise-plans-why-do-i-have-to-pay-separately-to-use-the-claude-api-and-console"
    - "https://claudelog.com/faqs/what-is-the-difference-between-claude-api-and-subscription/"
    - "https://eval.16x.engineer/blog/claude-vs-claude-api-vs-claude-code"

  python_cli_frameworks:
    - "https://medium.com/@mohd_nass/navigating-the-cli-landscape-in-python-a-comparative-study-of-argparse-click-and-typer-480ebbb7172f"
    - "https://codecut.ai/comparing-python-command-line-interface-tools-argparse-click-and-typer/"
    - "https://typer.tiangolo.com/alternatives/"
    - "https://python.plainenglish.io/building-command-line-tools-in-python-click-vs-argparse-vs-typer-514442c25a56"

  cli_autocomplete:
    - "https://typer.tiangolo.com/tutorial/options-autocompletion/"
    - "https://click.palletsprojects.com/en/stable/shell-completion/"
    - "https://typer.tiangolo.com/features/"

  claude_code_programmatic:
    - "https://code.claude.com/docs/en/headless"
    - "https://github.com/disler/claude-code-is-programmable"
    - "https://apidog.com/blog/a-comprehensive-guide-to-the-claude-code-sdk/"

  mathpix_api:
    - "Internal: /home/palantir/cow/docs/MATHPIX_API_CONSTRAINTS.md"
    - "Internal: /home/palantir/cow/docs/mathpix_api_spec.md"

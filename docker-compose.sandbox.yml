# Docker Compose: Sandbox Environment for Claude Code Execution
# Security: Boris Cherny Pattern 3 - Permission Bypass via Isolated Container
# Purpose: Run Claude Code commands in a secure, isolated sandbox environment

# Note: 'version' attribute removed (obsolete in modern Docker Compose)

services:
  # ===========================================
  # Sandbox Executor: Isolated Claude Code Environment
  # ===========================================
  sandbox:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: oda-sandbox

    # Security: Run as non-root user (matches Dockerfile USER)
    user: "1001:1001"

    # Security: Read-only root filesystem with specific writable paths
    read_only: true

    # Security: Temporary filesystems for writable areas
    tmpfs:
      - /tmp:size=100M,mode=1777
      - /app/.agent/tmp:size=50M,mode=0755,uid=1001,gid=1001

    # Security: Volume mounts for persistent data
    volumes:
      # Core lib mount (read-only) - FIXED: was ./scripts â†’ /app/lib/oda
      - type: bind
        source: ./lib
        target: /app/lib
        read_only: true
      # Scripts mount (read-only)
      - type: bind
        source: ./scripts
        target: /app/scripts
        read_only: true
      - type: bind
        source: ./data
        target: /app/data
        read_only: true
      # Writable output directory (sandboxed)
      - type: bind
        source: ./.agent/sandbox-output
        target: /app/sandbox-output
        read_only: false
      # Memory persistence (sandboxed)
      - type: bind
        source: ./.agent/memory
        target: /app/.agent/memory
        read_only: false

    # Security: Drop all capabilities, add only what's needed
    cap_drop:
      - ALL
    # Uncomment specific capabilities if needed:
    # cap_add:
    #   - NET_BIND_SERVICE  # Only if binding to ports < 1024

    # Security: Seccomp profile (use Docker default for better isolation)
    security_opt:
      - no-new-privileges:true
      # FIXED: Removed seccomp:unconfined - using Docker default profile for security

    # Security: Resource limits to prevent DoS
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
          pids: 100
        reservations:
          cpus: "0.5"
          memory: 256M

    # Security: Network isolation (no external access by default)
    networks:
      - sandbox-internal

    # Environment variables
    environment:
      - SANDBOX_MODE=true
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - ODA_WORKSPACE=/app
      - ODA_OUTPUT_DIR=/app/sandbox-output

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "print('healthy')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Restart policy
    restart: "no"

    # Working directory
    working_dir: /app

    # Default command (overridden by sandbox_runner.py)
    entrypoint: ["/bin/sh", "-c"]
    command: ["echo 'Sandbox ready. Use sandbox_runner.py to execute commands.'"]

  # ===========================================
  # Sandbox with Network Access (Optional)
  # Use when commands need external network access
  # ===========================================
  sandbox-networked:
    extends:
      service: sandbox
    container_name: oda-sandbox-networked

    # Security: Limited network access
    networks:
      - sandbox-internal
      - sandbox-external

    # Additional security for networked sandbox
    dns:
      - 8.8.8.8
      - 8.8.4.4

    # Limit outbound connections
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ===========================================
  # Database Sandbox: Isolated SQLite Operations
  # ===========================================
  sandbox-db:
    # NOTE: Not extending sandbox to avoid tmpfs/volume conflicts
    # This is a standalone definition for database operations
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: oda-sandbox-db
    user: "1001:1001"
    read_only: true

    tmpfs:
      - /tmp:size=100M,mode=1777

    volumes:
      - type: bind
        source: ./lib
        target: /app/lib
        read_only: true
      - type: bind
        source: ./scripts
        target: /app/scripts
        read_only: true
      - type: bind
        source: ./.agent/tmp
        target: /app/.agent/tmp
        read_only: false

    cap_drop:
      - ALL

    security_opt:
      - no-new-privileges:true

    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
          pids: 100

    networks:
      - sandbox-internal

    environment:
      - SANDBOX_MODE=true
      - DATABASE_PATH=/app/.agent/tmp/ontology.db
      - ODA_DB_READONLY=false
      - ORION_WORKSPACE_ROOT=/app
      - ORION_DB_PATH=/app/.agent/tmp/ontology.db

    working_dir: /app
    entrypoint: ["/bin/sh", "-c"]
    command: ["echo 'Database sandbox ready.'"]

networks:
  # Internal network: No external access
  sandbox-internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.28.0.0/16

  # External network: Limited external access
  sandbox-external:
    driver: bridge
    internal: false

# Volume definitions for persistent sandbox data
volumes:
  sandbox-output:
    driver: local
  sandbox-memory:
    driver: local

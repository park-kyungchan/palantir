# Strategic Plan: PDF-to-Digital-Twin Pipeline
**Target Architecture:** Vision-Native De-rendering (Gemini 3.0 Pro)
**Goal:** Transform complex PDFs (Math/Tables/Multi-column) into a Structured, Interactive "Digital Twin".

---

## SECTION 1. The "Hybrid JSON Schema" Design

Our "Source of Truth" will be a **Semantic-Visual DOM (SVDOM)**. This structure bridges the gap between a visual representation (PDF) and a semantic one (Editor).

### 1.1 Global Context
The root holds document-wide constraints, allowing "global" style edits.

```json
{
  "document_id": "doc_2504_action_table",
  "global_settings": {
    "page_dimensions": {"width": 210, "height": 297, "unit": "mm"},
    "base_font": "Malgun Gothic",
    "base_font_size": "10pt",
    "global_padding": "20mm",
    "column_gap": "5mm"
  },
  "pages": [] 
}
```

### 1.2 The "Atomic Block" Structure
Each element (Paragraph, Header, Math Formula, Image) is an atom.
*   **Separation of Concerns:** `content` is pure data, `style` is presentation, `geometry` is verification.

#### **JSON Snippet Example (Math Problem)**
```json
{
  "id": "page1_block12",
  "type": "math_problem",
  "role": "question", 
  "content": {
    "text_pre": "Find the roots of the equation:",
    "latex": "ax^2 + bx + c = 0",
    "text_post": "(where a ≠ 0)"
  },
  "style": {
    "layout": "block",
    "margin_top": "10px",
    "margin_bottom": "20px",
    "padding": "15px",
    "background_color": "#f0f0f0",
    "border_left": "3px solid blue",
    "alignment": "center"
  },
  "geometry": {
    "page_num": 1,
    "bbox": [150, 400, 500, 200], 
    "confidence": 0.98
  }
}
```

---

## SECTION 2. The "Read-Edit-Write" Logic

This protocol defines how the "Digital Twin" handles user Intent.

### Scenario A: Content Modification
**User:** "Fix the typo in the quadratic formula in Q3."
**Protocol:**
1.  **Locate:** Search `pages[].blocks[]` where `type="math_problem"` AND `content` contains "quadratic" (or by explicit ID if UI-selected).
2.  **Update:** Modify `target_block["content"]["latex"]`.
3.  **Preserve:** `style` and `geometry` remain untouched (unless text reflow forces a recalc).

### Scenario B: Global Layout Adjustment
**User:** "The layout is too tight, add 10px padding to all questions."
**Protocol:**
1.  **Iterate:** Traverse all blocks where `role == "question"`.
2.  **Patch:** Update `block["style"]["padding"] = "10px"`.
3.  **Reflow (Virtual):** Mark pages as "dirty" for re-rendering confidence check.

### Scenario C: Export Pipeline
**User:** "Export to PDF."
**Protocol:**
1.  **Compile:** Iterate JSON to generate intermediate representation (HTML/CSS or LaTeX).
    *   *HTML Path:* Map `block["style"]` to CSS classes. Inject `block["content"]` into `<div>` tags.
2.  **Render:** Use `WeasyPrint` (HTML→PDF) or `Pandoc` (Markdown→PDF).
    *   *Vision-Fidelity:* Use `global_settings` to ensure page margins match original.

---

## SECTION 3. The "Execution Prompt" Generation

This is the **System Prompt** to be used with the Vision Model in the next step.

```markdown
### SYSTEM ROLE: High-Fidelity De-rendering Engine (Vision-Native)

**YOUR GOAL:** 
You are acting as a "De-renderer". You will look at the provided document image and "reverse engineer" it into a STRUCTURED JSON DIGITAL TWIN.

**INPUT:**
- Image(s) of a PDF page.

**OUTPUT FORMAT:**
- You must output VALID JSON only. No markdown conversational text.
- Follow this exact schema:

{
  "page_num": <int>,
  "blocks": [
    {
       "id": "p<pageNum>_b<index>",
       "type": "text | header | math | table | image",
       "role": "title | question | body | caption",
       "content": {
          "text": "<raw text content>",
          "latex": "<if math, latex code>",
          "src": "<if image, placeholder_id>" 
       },
       "style": {
          "alignment": "left | center | right",
          "font_weight": "normal | bold",
          "estimated_font_size": "<e.g. 12pt>"
       },
       "geometry": {
          "bbox": [x, y, w, h] // Approximate bounding box [top-left-x, top-left-y, width, height] in image % (0-100)
       }
    }
  ]
}

**CRITICAL INSTRUCTIONS:**
1. **[Visual Handling]** Use your vision capabilities to distinguish between "Body Text" and "Tables". Do not merge them.
2. **[Math Parsing]** If you see a formula, de-render it to LaTeX within a "math" block. Do not OCR it as garbled text.
3. **[Layout Awareness]** If text is in a multi-column layout, capture the flow logical order (Column 1 Top -> Bottom, then Column 2).
4. **[Table Structure]** For Type="table", content should be a 2D array of cell values.
5. **[Derendering_Depth]**: "Atomic". Do not group large headers with body text. Split them.

**PARAMETER: [De-rendering Depth] = High**
Map every distinct visual paragraph, equation, or cell as a separate block.
```

# ODA 3-Stage Protocol Framework

**Version:** 1.2
**Date:** 2026-01-05
**Status:** FULLY IMPLEMENTED & VERIFIED
**Protocol Enforcement:** SCRIPT-LEVEL (Enforced by GovernanceEngine)

---

## 1. Overview

The **3-Stage Protocol Framework** is a mandatory operational framework in Orion ODA that ensures every action, plan, and audit follows a rigorous deep-dive methodology. Unlike guideline-based protocols, this framework is embedded at the script-level to programmatically mandate compliance and evidence gathering.

### Core Objectives
1. **Anti-Hallucination**: Force the agent to provide proof of codebase analysis via mandatory evidence logs.
2. **Integration Safety**: Trace data flows and side effects before performing mutations.
3. **Universal Consistency**: Apply the same rigor to Auditing, Planning, Task Distribution, and Execution.

---

## 2. Framework Architecture

### 2.1 Core Components (`scripts/ontology/protocols/base.py`)

#### `Stage` Enum
- `A_SCAN`: Surface scan/blueprint scan (Landscape view).
- `B_TRACE`: Logic trace/Integration trace (Call stack/Data flow).
- `C_VERIFY`: Quality audit/Quality gate (Atomic verification).

#### `StageResult`
Each stage must return a result containing:
- `passed`: Boolean status.
- `findings`: List of observations.
- `evidence`: **Mandatory** evidence map (files viewed, line numbers, quoted snippets).

#### `ThreeStageProtocol` (Base Class)
Abstract base class defining the sequence:
1. `stage_a(context)` (SCAN)
2. `stage_b(context, stage_a_result)` (TRACE)
3. `stage_c(context, stage_b_result)` (VERIFY)

Execution is handled by the `execute(context)` method, which runs the sequence and stops if any stage fails.

### 2.2 V6.0 Enhancements (Native Method)

The V6.0 kernel introduces programmatic enforcement of self-correction and fact-checking directly into the base classes.

#### Recursive-Self-Improvement Loop (RSIL)
Implemented as `execute_with_rsil(context, max_retries=3)`, this method provides automated self-correction. If a stage fails or lacks critical evidence, the protocol clears ephemeral context and restarts the loop (HALT -> CORRECT -> RESTART), isomorphic to **Palantir Automate** retry patterns.

#### Anti-Hallucination Enforcement
The `AntiHallucinationError` exception is raised when a stage passes without mandatory `files_viewed` evidence. This ensures that analysis is grounded in actual file system reads rather than model priors.

---

## 3. Protocol Implementations

| Protocol | Stage A (SCAN) | Stage B (TRACE) | Stage C (VERIFY) |
|----------|----------------|-----------------|------------------|
| **AuditProtocol** | File structure & patterns | Call stack & data flow | Line-by-line quality |
| **PlanningProtocol**| Domain requirements | Integration dependencies | Design & Safety gate |
| **ExecutionProtocol**| Pre-state & Pre-flight | Action execution | Post-state validation |
| **Orchestration** | Task decomposition | Dependency mapping | Synthesis & Consolidation |

---

## 4. Enforcement Layer

### 4.1 `@require_protocol` Decorator
Actions can be decorated to mandate a specific protocol pass before execution.
```python
@require_protocol(AuditProtocol, policy=ProtocolPolicy.BLOCK)
class DeepAuditAction(ActionType):
    ...
```

### 4.2 GovernanceEngine Integration
The `GovernanceEngine` checks for a valid, passed protocol session associated with the current `ActionContext`.
- **BLOCK**: Execution is denied if protocol has not passed.
- **WARN**: Execution proceeds but logs a compliance violation.

### 4.3 Evidence-Based Validation
The framework verifies that `StageResult.evidence` is populated with actual file paths and references tracked by the system, making it impossible to "skip" analysis without leaving a trace.

---

## 5. Metadata Schema (Evidence Tracking)

Protocols log evidence in the following format to ensure auditability:
```json
{
  "files_viewed": ["scripts/ontology/actions/__init__.py"],
  "lines_referenced": {
    "scripts/ontology/actions/__init__.py": [242, 315]
  },
  "verification_checks": ["pydantic_validation", "null_check"]
}
```

---

## 6. Implementation Roadmap (Jan 2026)

1. **Phase 1**: Implement `base.py` and `StageResult` structures. (✅ COMPLETED)
2. **Phase 2**: Integrate `ProtocolRegistry` into `GovernanceEngine`. (✅ COMPLETED)
3. **Phase 3**: Audit and Integrate `.agent/workflows` and `.agent/rules`. (✅ COMPLETED)
4. **Phase 4**: Migration of `/deep-audit` to enforced `AuditProtocol`. (✅ COMPLETED)
5. **Phase 5**: Kernel v6.0 (Native Edition) - RSIL (✅), Anti-Hallucination (✅), RulesInterpreter (In Progress), and Artifact standard.

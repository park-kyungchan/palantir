# Orion ODA: Master Architecture and Alignment Overview

## 1. ODA Execution Flow: Prompt-to-Kernel Trace

The execution flow follows a structured 3-phase lifecycle, transforming raw user prompts into governed system actions.

### Phase 1: Injection (System Prompt)
The Kernel prepends the **System Directive** (e.g., `GEMINI.md`) to the context.
- **Purpose**: Establishes the "Constitution" for the agent.
- **Mechanism**: Combines immutable protocols, dynamic environment state, and user input.
- **ODA Rule**: The System Prompt is the source of trust for governance.

### Phase 2: Cognitive (The Plan)
The LLM processes context and produces a structured **Plan**.
- **Plan Type**: A sequence of Tool Calls (e.g., `read_file`, `search_web`).
- **Isomorphism**: Equivalent to a "Proposal" in Palantir Foundry.

### Phase 3: Kernel (Execution & Governance)
The Runtime (`kernel.py`, `marshaler.py`) intercepts tool calls.
- **Governance Gate**: Safe actions execute immediately; hazardous actions trigger a "Proposal" state.
- **Concurrency**: Optimistic locking via `version` fields in `OntologyObject`.

---

## 2. Action Registry & Dispatch

### Core Components
- **`ActionType`**: Interface for all ontology actions (`api_name`, `submission_criteria`, etc.).
- **`ActionRegistry`**: Singleton tracking registered actions via `@register_action`.
- **`ToolMarshaler`**: Secure entry point handling `ActionContext` and standard result wrapping.
- **`EditOperation`**: Atomic changes (CREATE, MODIFY, DELETE, LINK) within a transaction.

### Execution Loop
1. **Signal Dequeue**: Tasks pulled from `RelayQueue`.
2. **Cognitive Analysis**: Natural language mapped to a structured `Plan`.
3. **Governance Check**: Job evaluated against `.agent/rules/`.
4. **Execution**: Dispatched to `ToolMarshaler` or persisted as a `Proposal`.

---

## 3. Palantir AIP/Foundry Alignment

The ODA is designed for 90% architectural alignment with Palantir Foundry OSDK standards.

### Feature Mapping
| Palantir Foundry Pattern | ODA Implementation | Alignment Details |
|-------------------------|--------------------|-------------------|
| **Action Types** | `ActionType` Base Class | Parameters and submission criteria support. |
| **$validateOnly** | `validate_only` argument | Executes validation but skips mutation. |
| **$returnEdits** | `return_edits` argument | Includes `EditOperation` audit trail. |
| **modifiedEntities** | `affected_types` | Map of affected object types. |
| **Transactional Mutation**| `Database.transaction()` | SQLite WAL mode for atomic writebacks. |
| **Submission Criteria** | `validate_evidence()` | Enforces anti-hallucination evidence. |
| **Palantir Automate** | `execute_with_rsil()` | Implements automated retry logic (RSIL). |
| **Logic Effects** | `ThreeStageProtocol` | Chained execution (A -> B -> C). |

### AI Ultra & API-Free Context
- **Object Limit**: Up to 50 Ontology object types.
- **SDK Support**: Full OSDK 2.0 functionality.
- **Offline Protocol**: Operates in **API-Free** mode, simulating Foundry backend via local OSDK patterns.

---

## 4. MCP Research Findings (Jan 2026)

Research using `context7` (resolve-library-id, query-docs) and `tavily` confirmed the following patterns:

### Tool Usage
- **Context7**: Discovered Palantir Foundry documentation snippets (Action Types, Side Effects, Proposals).
- **Tavily**: Validated OSDK architecture and latest 2024 best practices.

### Key Palantir Patterns Discovered
- **Writeback**: Pre-mutation hook; failure aborts the action.
- **Side Effect**: Post-mutation hook (Webhook, Log, EventBus); failure is logged but doesn't roll back the transaction.
- **Approval Policy**: Configurable reviewers and approval counts for Proposals.

---

## 5. Ontology Modeling Standards (OSv2)

### Primary Key (PK) Restrictions
- **Prohibited PK Types**: Geopoint, Geoshapes, Arrays, Time series, Real numbers (`decimal`, `float`).
- **Standard**: UUIDv4 strings are recommended for PKs to ensure stability.

### Action Log Standards
- Capture **Action RID**, **UserId**, and **Timestamp (UTC)**.
- Record the **Primary Key** values of all objects modified during the action.

---

## 6. Runtime & Persistence Patterns

- **Schema is Law**: Strict Pydantic enforcement.
- **Registry Supremacy**: All operations must go through registered `ActionType` classes.
- **DatabaseWAL**: Write-Ahead Logging is enforced for concurrency.
- **Isolation**: Connection isolation via `contextvars` for testing/overrides.

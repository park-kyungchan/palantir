# HWPX Engineering Manual: Reconstruction & Features

## 1. Architecture Overview

### 1.1 The Semantic-Visual DOM (SVDOM)
The SVDOM (defined in `lib/ir.py`) is a Hybrid JSON structure that enforces strict separation of concerns between Content, Style, and Geometry.
- **Section**: Page layout division supporting columns and page setup.
- **Paragraph**: Block of content with style attributes.
- **Tables**: Hierarchical grid (`Table` -> `TableRow` -> `TableCell`).
- **Controls**: Inline objects like Images, TextBoxes, and Equations.

### 1.2 IR-to-HWP Compiler (`lib/compiler.py`)
The `Compiler` translates SVDOM objects into a sequential list of HWP Actions (defined in `lib/models.py`). It uses a recursive dispatch logic and tracks formatting state to minimize API signal noise.

### 1.3 Stateful Document Assembly (DocumentBuilder)
The `HwpxDocumentBuilder` operates as a cursor-based state machine.
- **Context Tracking**: Monitors `_current_table`, `_current_cell`, and `_current_container` (active `hp:tc` or `section_elem`).
- **Style State**: Tracks typography (Size, Bold, Align) and applies them to `InsertText` actions.

---

## 2. Implementation Guide (Phases 1-15)

### 2.1 Dimensional Precision (KS X 6101)
- **Base Unit**: HwpUnit (1/7200 inch).
- **Formula**: 1 mm â‰ˆ 283.46 HwpUnits; 1 pt = 100 HwpUnits.
- **Geometry**: Table widths use remainder distribution to ensure 100% conformance.

### 2.2 Shared Resource Management (HeaderManager)
- **Deduplication**: Composite keys for `charPr`, `paraPr`, and `borderFill` ensure style reuse.
- **ID Scavenging**: Scans `header.xml` to determine valid ID increments.

### 2.3 Structural Element Handling
- **Cell Merging**: Support for `<hp:cellSpan>` with logical coordinate tracking (`cellAddr`). HWPX prohibits "ghost cells".
- **Nested Tables**: Recursive structures enabled by container context injection into table paragraphe.
- **Advanced Lists**: 7-level hierarchical numbering linked via `numberingIDRef`.

---

## 3. High-Fidelity Features

### 3.1 Scientific Equations
Equations use a proprietary script format within `<hp:eqEdit>`.
- **Conversion**: LaTeX is transpilation via recursive regex in `lib/owpml/equation_converter.py`.
- **Placement**: Embedded within `<hp:ctrl>` inside a paragraph run.

### 3.2 Context-Aware Inline Controls
Images (`hp:pic`), TextBoxes (`hp:rect`), and Equations are re-routed to the active `_current_container`. This allows these objects to reside correctly within table cells.

---

## 4. Stability & Quality Gate
- **Namespace Consistency**: Standard OWPML 2011/2016 URIs must be used.
- **ID Integrity**: All `Ref` attributes must point to valid `header.xml` entries.
- **Verification**: 100% pass on regression suite (7 manual verification scripts).

# BinData Management Logic (Phase 3)

## 1. Overview
BinData management is critical for embedding images, OLE objects, and other binary attachments into HWPX (OCF/OPF) documents. It involves updating the package manifest (`content.hpf`) and ensuring the binary files are correctly injected into the ZIP entry `BinData/`.

## 2. Manifest Structure (content.hpf)
The `content.hpf` file uses a standard OPF (`http://www.idpf.org/2007/opf/`) structure but includes HWPX-specific attributes.

### Manifest Entries
New binary items must be added to the `<opf:manifest>` element:
```xml
<opf:item 
    id="bin0001" 
    href="BinData/bin0001.png" 
    media-type="image/png" 
    isEmbeded="1" />
```
- **id**: A unique identifier, typically following the `binXXXX` pattern.
- **href**: The path relative to the root of the ZIP (must reside in `BinData/`).
- **media-type**: Standard MIME type.
- **isEmbeded**: HWPX-specific flag (`1` for embedded).

## 3. BinDataManager Implementation
The `BinDataManager` (`lib/owpml/bindata_manager.py`) encapsulates the logic for:
1.  **ID Generation**: Scanning the existing manifest for the highest `binXXXX` value to prevent collisions.
2.  **XML Manipulation**: Adding the necessary `<opf:item>` elements to the manifest.
3.  **Path Resolution**: Mapping source files to deterministic internal paths (e.g., `image.png` â†’ `BinData/bin0001.png`).

### Key Methods:
- `__init__(content_hpf_elem)`: Initializes with the parsed XML of `content.hpf`.
- `add_bin_item(filename, mime_type)`: Registers a new item and returns its ID and internal HWPX path.

## 4. Archive Injection (HwpxPackage Integration)
Programmatic injection of binary data into the `.hwpx` ZIP archive is handled via the `HwpxPackage.set_part()` method. 

**Trace (Stage B Verification):**
```python
pkg = HwpxPackage.open(path)
pkg.set_part('BinData/bin0001.png', bytes_content)
pkg.save(output_path)
```
## 5. Integration with Control Objects
The `BinDataManager` is used by the `HwpxDocumentBuilder` during the construction of `<hp:pic>` elements. While the `BinDataManager` handles the registration and ID assignment, the actual XML structure of the picture object is managed by the Control Object logic (see `control_objects_implementation.md`).

## 6. Verification (Stage C)
The implementation was verified using `tests/manual_verify_image.py` and `tests/manual_bindata_poc.py`, which confirmed:
- Arbitrary binary data can be injected into the archive using `set_part`.
- `content.hpf` correctly references these binaries with unique `binXXXX` IDs.
- The `isEmbeded="1"` attribute is correctly applied for HWPX compliance.

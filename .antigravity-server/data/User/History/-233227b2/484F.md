# BinData Management Logic (Phase 3)

## 1. Overview
BinData management is critical for embedding images, OLE objects, and other binary attachments into HWPX (OCF/OPF) documents. It involves updating the package manifest (`content.hpf`) and ensuring the binary files are correctly injected into the ZIP entry `BinData/`.

## 2. Manifest Structure (content.hpf)
The `content.hpf` file uses a standard OPF (`http://www.idpf.org/2007/opf/`) structure but includes HWPX-specific attributes.

### Manifest Entries
New binary items must be added to the `<opf:manifest>` element:
```xml
<opf:item 
    id="bin0001" 
    href="BinData/bin0001.png" 
    media-type="image/png" 
    isEmbeded="1" />
```
- **id**: A unique identifier, typically following the `binXXXX` pattern.
- **href**: The path relative to the root of the ZIP (must reside in `BinData/`).
- **media-type**: Standard MIME type.
- **isEmbeded**: HWPX-specific flag (`1` for embedded).

## 3. BinDataManager Implementation
The `BinDataManager` (`lib/owpml/bindata_manager.py`) encapsulates the logic for:
1.  **ID Generation**: Scanning the existing manifest for the highest `binXXXX` value to prevent collisions.
2.  **XML Manipulation**: Adding the necessary `<opf:item>` elements to the manifest.
3.  **Path Resolution**: Mapping source files to deterministic internal paths (e.g., `image.png` → `BinData/bin0001.png`).

### Key Methods:
- `__init__(content_hpf_elem)`: Initializes with the parsed XML of `content.hpf`.
- `add_bin_item(filename, mime_type)`: Registers a new item and returns its ID and internal HWPX path.

## 4. Archive Injection (HwpxPackage Integration)
Programmatic injection of binary data into the `.hwpx` ZIP archive is handled via the `HwpxPackage.set_part()` method. 

**Trace (Stage B Verification):**
```python
pkg = HwpxPackage.open(path)
pkg.set_part('BinData/bin0001.png', bytes_content)
pkg.save(output_path)
```
## 5. Image Control Integration (Phase 6)
The `HwpxDocumentBuilder` utilizes the `BinDataManager` to implement the `InsertImage` action by generating the OWPML `<hp:pic>` structure.

### Pic XML Structure:
```xml
<hp:pic id="7000x" zOrder="0" numberingType="PICTURE">
    <hp:sz width="28346" height="28346" widthRelTo="ABSOLUTE" heightRelTo="ABSOLUTE" />
    <hp:pos treatAsChar="1" flowWithText="1" vertRelTo="PARA" horzRelTo="PARA" />
    <hp:outMargin left="0" right="0" top="0" bottom="0" />
    <hp:img binaryItemIDRef="bin0001" imageType="REAL_PIC" effect="REAL_PIC" />
</hp:pic>
```

### Key Integration Points:
1.  **HwpUnit Conversion**: Image dimensions (mm) are converted to HwpUnits (1 mm ≈ 283.46 HwpUnits) for the `<hp:sz>` element.
2.  **MIME Detection**: `mimetypes.guess_type()` is used to determine the `media-type` for the manifest entry.
3.  **Namespace Handling**: During serialization, `<hp:pic>` may appear as `<ns1:pic>` depending on the prefix registration in `section0.xml`.
4.  **Inline Placement**: By setting `treatAsChar="1"`, the image is treated as a character within a paragraph (`<hp:run>`), ensuring predictable flow in text-heavy documents.

## 6. Verification (Stage C)
The implementation was verified using `tests/manual_verify_image.py`, which confirmed:
- A dummy PNG is correctly added to `BinData/` inside the ZIP.
- `content.hpf` contains the correct manifest entry with `isEmbeded="1"`.
- `section0.xml` contains the `<hp:pic>` element referencing the `binaryItemIDRef`.

# Styles and Formatting Logic (Phase 8)

## 1. Overview
HWPX (OWPML) utilizes an ID-based reference system for styles to ensure document efficiency. Instead of embedding style attributes directly in every paragraph or text run, styles are defined once in `header.xml` and referenced by ID.

- **Paragraph Shapes**: Defined in `<hh:paraProperties>` (`<hh:paraPr>`). Referenced by `paraPrIDRef` in `<hp:p>`.
- **Character Shapes**: Defined in `<hh:charProperties>` (`<hh:charPr>`). Referenced by `charPrIDRef` in `<hp:run>`.

## 2. Header Management Implementation
The `HeaderManager` provides two core methods for dynamic style registration:

### 2.1 Character Properties (`hh:charPr`)
**Method**: `get_or_create_char_pr(font_size_pt, is_bold, color)`
- **Font Size**: Converted from points to OWPML units by multiplying by 100 (e.g., 10pt = 1000).
- **Bold**: Value `1` if true, `0` if false.
- **Namespaces**: Uses `hh` (`http://www.hancom.co.kr/hwpml/2011/head`).
- **Defaults**:
  - `fontRef`: Standardized to `0` (typically "Hamchorom" in skeleton templates).
  - `ratio` / `spacing`: Fixed at `100` and `0` respectively for standard text.

### 2.2 Paragraph Properties (`hh:paraPr`)
**Method**: `get_or_create_para_pr(align, indent, line_spacing)`
- **Alignment**: Direct mapping to OWPML `horizontal` attributes: `LEFT`, `CENTER`, `RIGHT`, `JUSTIFY`, `DISTRIBUTE`.
- **Indent**: Converted from points to HwUnits (1pt = 100 HwUnits).
- **Line Spacing**: Typically set as `PERCENT` (e.g., `160%`).

## 3. Stateful Integration in DocumentBuilder
The `HwpxDocumentBuilder` maintains the document style state to ensure consistent application across multiple `InsertText` or `InsertImage` actions.

### 3.1 State Tracking
- `self._font_size`: float (default 10.0)
- `self._is_bold`: bool (default False)
- `self._font_color`: str (default "#000000")
- `self._current_align`: str (default "LEFT")

### 3.2 Dynamic ID Application
During `_insert_text`, the builder requests the appropriate IDs from `HeaderManager`:
```python
para_id = self.header_manager.get_or_create_para_pr(
    align=self._current_align,
    indent=self.current_para_shape.indent if self.current_para_shape else 0,
    line_spacing=self.current_para_shape.line_spacing if self.current_para_shape else 160
)

char_id = self.header_manager.get_or_create_char_pr(
    font_size_pt=int(self._font_size),
    is_bold=self._is_bold,
    color=self._font_color
)
```
These IDs are then applied to the `<hp:p paraPrIDRef="...">` and `<hp:run charPrIDRef="...">` elements.

## 4. Known Implementation Notes (January 2026)
- **ID Deduplication**: The current implementation increments IDs for every request. Future optimization should include a lookup table (e.g., `Dict[StyleTuple, ID]`) within `HeaderManager` to prevent "Header Bloat".
- **Auto-layout**: Paragraph `linesegarray` is omitted for complex objects (like equations) to allow the HWPX viewer to handle rendering, while basic text paragraphs retain standard segments for compatibility.
- **Reference Integrity**: All IDs generated by `HeaderManager` automatically update the `itemCnt` attribute in `header.xml` to maintain OWPML validity.

# Styles and Formatting Logic (Phase 8)

## 1. Overview
HWPX (OWPML) utilizes an ID-based reference system for styles to ensure document efficiency. Instead of embedding style attributes directly in every paragraph or text run, styles are defined once in `header.xml` and referenced by ID.

- **Paragraph Shapes**: Defined in `<hh:paraProperties>` (`<hh:paraPr>`). Referenced by `paraPrIDRef` in `<hp:p>`.
- **Character Shapes**: Defined in `<hh:charProperties>` (`<hh:charPr>`). Referenced by `charPrIDRef` in `<hp:run>`.

## 2. Header Management
The `HeaderManager` is responsible for maintaining the registry of unique style combinations.

### 2.1 Character Properties (`hh:charPr`)
- **Height**: Specified in 0.01pt units (`value="1000"` = 10pt).
- **Attributes**: Supports `bold`, `italic`, `underline`, `textColor`, `fontRef`, `ratio` (장평), `spacing` (자간).
- **Registration**: Match existing properties to avoid duplicates.

### 2.2 Paragraph Properties (`hh:paraPr`)
- **Alignment**: `horizontal` attribute supports `LEFT`, `CENTER`, `RIGHT`, `JUSTIFY`, `DISTRIBUTE`.
- **Margins**: `left`, `right`, `indent` (first line), `prevSpace` (before), `nextSpace` (after). Units are HwpUnits (1/7200 inch).
- **Line Spacing**: `lineSpacing` value and `lineSpacingType` (`PERCENT`, `FIXED`, `BETWEEN`).

## 3. Implementation Strategy: Stateful Styling
Since `HwpxDocumentBuilder.build()` processes a list of actions sequentially, a state-based approach is used to track current style settings.

1. **Current State**: Maintain `self.current_para_style_id` and `self.current_char_style_id`.
2. **Action Update**: When a `SetParaShape` or `SetFontSize` action is encountered, request a new ID from `HeaderManager`.
3. **Application**: Apply the current IDs to any subsequent `InsertText`, `InsertImage`, or `InsertTextBox` actions until the state is updated again.

## 4. Measurement Conversions
- **Fonts**: 1pt = 100 XML units for `height`.
- **Paragraph Margins**: Use `mm_to_hwpunit` conversion for consistent layout.

## 5. Preliminary Research Findings (January 2026)
- **Skeleton Defaults**: Standard documents typically start with `id="0"` as the default for both paragraph and character properties.
- **Reference Integrity**: If a paragraph references an ID that doesn't exist in `header.xml`, Hancom Office may crash or fallback to a default (usually plain text).
- **State Persistence**: Styles applied via `SetParaShape` should persist across multiple `InsertText` actions unless cleared or overridden.

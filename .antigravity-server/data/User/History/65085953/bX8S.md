# Implementation: HWP Action Ontology

The HWP Action Ontology defines the programmatic representation of Hancom Office API commands. These models serve as the "Instruction Set" for the `Executor` to rebuild documents on Windows.

## 1. Core Principles
- **Strict Typing**: Every HwpAction is a Pydantic model with validated parameters.
- **API Mapping**: Action names (e.g., `CreateTable`, `SetAlign`) map directly to HWP automation objects or sequences of OLE actions.
- **Resolution**: Geometry and style values are normalized (e.g., mm for margins, points for fonts).

## 2. Key Action Models

### 2.1 Text & Formatting
- `InsertText`: Inserts raw text content at the current caret position.
- `SetFontSize`: Changes the active font size (in points).
- `SetFontBold`: Boolean toggle for bold styling.
- `SetAlign`: Sets paragraph alignment (`Left`, `Center`, `Right`, `Justify`).
- `SetLetterSpacing`: Adjusts character spacing (Ja-gan).
- `SetLineSpacing`: Adjusts vertical paragraph spacing (Jul-gan-gyeok).

### 2.2 Tables
- `CreateTable`: Initializes a table with specified `rows` and `cols`.
- `MoveToCell`: Positions the caret inside a specific `row` and `col` for content insertion.
- `SetCellBorder`: Sets border type, width, and color for the selected cell(s).

### 2.3 Layout & Structure
- `SetPageSetup`: Configures margins (Top, Bottom, Left, Right) and headers.
- `MultiColumn`: Defines the column layout (e.g., 2-column spread).
- `BreakSection`: Forces a section break, allowing for changing column layouts on a single page (`continuous=True`).
- `BreakColumn`: Forces a break to the next column.

### 2.4 Rich Content
- `InsertEquation`: Inserts a math formula using HWP script format.
- `InsertImage`: Embeds an image file from a local path.
- `InsertTextBox`: Creates a floating text box with absolute positioning.

## 3. Implementation Details
The ontology is implemented in `lib/models.py` using `pydantic.BaseModel`.

```python
class SetCellBorder(HwpAction):
    """
    Action to set cell border/fill properties.
    Maps to 'CellBorderFill' action.
    """
    action_type: Literal["SetCellBorder"] = "SetCellBorder"
    border_type: str = Field("Solid", description="Border Type: Solid, None, Dash, etc.")
    width: str = Field("0.1mm", description="Border Width")
    color: str = Field("Black", description="Border Color")

class InsertEquation(HwpAction):
    """
    Action to insert a Math Equation.
    """
    action_type: Literal["InsertEquation"] = "InsertEquation"
    script: str = Field(..., description="The Equation Script (e.g. 'x^2 + y^2 = r^2')")

class MoveToCell(HwpAction):
    """
    Action to move cursor to a specific table cell.
    Used after CreateTable to populate cell content.
    """
    action_type: Literal["MoveToCell"] = "MoveToCell"
    row: int = Field(..., ge=0, description="Row index (0-based)")
    col: int = Field(..., ge=0, description="Column index (0-based)")
```

## 4. Knowledge Base Schema
The ontology is complemented by a Knowledge Base schema (`lib/knowledge/schema.py`) that stores the official API reference data.

- **ActionDefinition**: Links an Action ID (mnemonic) to its ParameterSet.
- **ParameterSetDefinition**: Describes a collection of parameters required by an action.
- **ParameterItem**: Defines an individual parameter's ID, type (e.g., `PIT_BSTR`, `PIT_UI`), and description.
- **EventDefinition**: Describes HWP Automation Events (e.g., `DocumentBeforeSave`) and their arguments.
- **APIMethodDefinition**: Registry of official HWP automation methods (e.g., `Open`, `SaveAs`).
- **APIPropertyDefinition**: Registry of automation properties (e.g., `PageCount`, `IsModified`).

This dual-layer ontology (Runtime Actions + Reference Knowledge) allows the compiler to validate generation logic against the official manual.

## 5. HWP ObjectTypes (Type Mapping Matrix)
To achieve "ObjectTypes" alignment in ODA, the system maps internal HWP Parameter Types (PIT) to native Python/Pydantic types:

| HWP Type | Description | Python/Pydantic Type |
| :--- | :--- | :--- |
| **PIT_BSTR** | Basic String | `str` |
| **PIT_UI** | Unsigned Integer | `int` |
| **PIT_I** | Integer | `int` |
| **PIT_BOOL** | Boolean | `bool` |
| **PIT_COLOR** | Color Value (RGB) | `int` (Hex/Decimal) |
| **PIT_FLOAT** | Floating Point | `float` |

This mapping ensures that any action generated by the `Compiler` respects the underlying HWP engine's data expectations, preventing runtime OLE automation errors.
## 6. HWPX Control Patterns
Based on the deep audit of the `ActionTable_2504.pdf`, three distinct control patterns dictate how the `Compiler` and `Executor` interact with the Hancom Office API.

### 6.1 Pattern A: Direct Run (Immediate Command)
Actions with no associated `ParameterSet ID`. These are simple toggle or navigator commands that require no configuration.
- **Examples**: `BreakPage` (Page Break), `Cancel` (ESC), `Copy`, `Paste`.
- **Implementation**: `hwp.Run("ActionID")`

### 6.2 Pattern B: Parameterized Action (Constructed Set)
Actions that require a `ParameterSet ID`. These represent the majority of document engineering tasks. 
- **Examples**: `InsertText`, `TableCreate`, `CharShape`.
- **Implementation Lifecycle**:
  1. **CreateAction**: Instantiate the action object.
  2. **CreateSet**: Create the associated parameter set.
  3. **GetDefault**: Load current context.
  4. **SetItem/Execute**: Modify parameters and commit.

### 6.3 Pattern C: Dialog/Indirect Control
Actions marked with a `*` (e.g., `FindReplace*`) indicate that the action typically invokes a User Interface dialog.
- **Strategy**: Often requires `run_blocked = True` in the database to prevent hanging.

## 7. HWP Automation Events
The registry includes Automation Events (e.g., from `한글오토메이션EventHandler추가_2504.pdf`) allowing the system to hook into document lifecycle changes.

| Event ID | Description |
| :--- | :--- |
| **Quit** | Triggered when the HWP application is terminated. |
| **NewDocument** | Triggered when a new empty document is created. |
| **DocumentBeforeSave** | Triggered before a document is saved to disk. |
| **DocumentChange** | Triggered when content or state changes within the document. |

## 8. API Reference Methods & Properties
Beyond Actions, the system maps the full API surface of the `HwpObject`.

| Type | Examples |
| :--- | :--- |
| **Methods** | `Open`, `SaveAs`, `Insert`, `MovePos`, `InitScan` |
| **Properties** | `IsModified`, `PageCount`, `EditMode`, `CharShape` |

This comprehensive ontology enables 100% API fidelity during document reconstruction.

## 9. Advanced Interaction Patterns

### 9.1 The "F5 Selection" Pattern (Table-wide Styling)
Many HWP actions operate only on the *active selection*. To apply a style (like removing borders) to an entire table programmatically:
1.  **Select**: Emit `TableCellBlock` action three times (simulating `F5 x 3` which selects the whole table).
2.  **Act**: Emit the target action (e.g., `SetCellBorder`).
3.  **Deselect**: Emit `Cancel` (simulating `ESC`).

This pattern is verified for the **Transparent Layout Framework**.

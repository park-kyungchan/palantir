# DocLayout-YOLO Compatibility & Patching Guide

The `DocLayout-YOLO` model, specifically when loaded via the `ultralytics` library in certain environments, can exhibit two major compatibility issues that prevent standard inference.

## 1. Issue: `AttributeError: 'Conv' object has no attribute 'bn'`

### Symptom
Inference fails during the forward pass with `AttributeError: 'Conv' object has no attribute 'bn'` inside the `doclayout_yolo/nn/modules/g2l_crm.py` or similar modules. This occurs because the model attributes are queried at runtime but are missing from the loaded state dict or class definition.

### Resolution: Runtime Injection
Inject a dummy `nn.Identity()` layer for the missing `bn` attribute immediately after loading the model.

```python
import torch.nn as nn

def patch_model_bn(model):
    count = 0
    for m in model.modules():
        if hasattr(m, 'dcv') and not hasattr(m.dcv, 'bn'):
            m.dcv.bn = nn.Identity()
            count += 1
    return count
```

## 2. Issue: `AttributeError: 'dict' object has no attribute 'shape'`

### Symptom
After fixing the `bn` error, the call to `results = model(img)` fails within `ultralytics/utils/nms.py` (specifically in `non_max_suppression`).
```
  File "ultralytics/utils/nms.py", line 66, in non_max_suppression
    if prediction.shape[-1] == 6 or end2end:
AttributeError: 'dict' object has no attribute 'shape'
```

### Cause
The `DocLayout-YOLO` model architecture returns a dictionary of tensors (often containing keys like `'one2one'`, `'one2many'`) rather than the single concatenated prediction Tensor that the default `ultralytics` Non-Max Suppression (NMS) logic expects.

### Diagnosis
Inspect the raw output of the underlying PyTorch model:
```python
model = YOLO("path/to/model.pt")
# Direct forward pass on the internal model
raw_out = model.model(dummy_input)
print(type(raw_out)) # Output: <class 'dict'>
print(raw_out.keys()) # Output: dict_keys(['one2one', 'one2many', ...])
```

### Resolution: Transparent Model Wrapper
To fix the output format mismatch while maintaining compatibility with `ultralytics` internal calls (like `.fuse()` or attribute access), implement a transparent wrapper.

```python
import torch.nn as nn

class DocLayoutWrapper(nn.Module):
    """
    Wrapper to handle DocLayout-YOLO output format incompatibility.
    Extracts 'one2one' tensor from dict and delegates methods to the base model.
    """
    def __init__(self, model):
        super().__init__()
        self.model = model
    
    def forward(self, *args, **kwargs):
        res = self.model(*args, **kwargs)
        if isinstance(res, dict) and 'one2one' in res:
            return res['one2one']
        return res
        
    def fuse(self, *args, **kwargs):
        # Ultralytics often calls .fuse(verbose=...)
        if hasattr(self.model, 'fuse'):
            self.model.fuse(*args, **kwargs)
        return self
        
    def __getattr__(self, name):
        # Delegate attribute access to the underlying model
        try:
            return super().__getattr__(name)
        except AttributeError:
            return getattr(self.model, name)
```

Apply the wrapper during model initialization:
```python
self._model = YOLO(path)
# Patch 'bn' attributes...
# Wrap internal model
self._model.model = DocLayoutWrapper(self._model.model)
```

*Note: The `one2one` tensor is the primary output for end-to-end (DINO-style) YOLO variants used in DocLayout-YOLO.*

# Ingestion & Parsing Logic

The HWPX Pipeline supports multiple document ingestion engines to ensure high fidelity across different document types.

## 1. Mathpix Ingestor (`lib/ingestors/mathpix_ingestor.py`)
Used for high-fidelity OCR, especially for math-heavy documents.
- **Protocol**: Uploads PDF to `https://api.mathpix.com/v3/pdf` with `conversion_formats: {"md": True}`.
- **Processing**: Polls for completion and downloads the resulting Mathpix Markdown (MMD).
- **Configuration**: Requires `MATHPIX_APP_ID` and `MATHPIX_APP_KEY` environment variables.

## 2. Docling Ingestor (`lib/ingestors/docling_ingestor.py`)
Primary ingestor for structural document understanding.
- **Capabilities**: Layout analysis (DocLayout-YOLO), table recognition, and reading order sorting.
- **Offline Mode**: Enforces a pre-download strategy using `~/.cache/docling/models` to avoid HuggingFace DNS timeouts.
- **Fallback**: Includes a `_ingest_with_pymupdf` fallback if Docling's deep-learning based conversion fails.

## 3. Markdown Parser (`lib/parsers/markdown_parser.py`)
Translates Mathpix Markdown (MMG) into the pipeline's **Intermediate Representation (IR)**.
- **Top-Level Parsing**: Splits by lines, identifying headings (`#`) and regular paragraphs.
- **Semantic Tagging**:
    - `ProblemBox`: Identified via regex `^\s*(\d+\s*\.|\(?\d+\)?)\s*`.
    - `AnswerBox`: Identified via regex `^\s*(정답|답)\s*`.
- **Inline Elements**:
    - **Math**: Uses `MATH_DISPLAY_PATTERN` ($$) and `MATH_INLINE_PATTERN` ($) to extract `IREquation` objects.
    - **Images**: Uses `IMAGE_PATTERN` (![alt](url)) to extract `IRImage` objects.
    - **Text Runs**: Splits remaining text into `IRTextRun` objects, handling bold formatting (`**`).

## 4. Ingestor Integration Map
| Mode | Ingestor | Intermediate Format | Parser |
|---|---|---|---|
| OCR Enabled | `MathpixIngestor` | Mathpix Markdown (MMD) | `MarkdownParser` |
| OCR Disabled | `DoclingIngestor` | Docling Document | Integrated Mapping |

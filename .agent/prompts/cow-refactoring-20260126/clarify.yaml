# =============================================================================
# Clarify Output: COW Pipeline Refactoring
# =============================================================================
# Workload: cow-refactoring-20260126
# Created: 2026-01-26T12:00:00Z
# Method: Reverse Engineering from Codebase Analysis
# =============================================================================

meta:
  workload_id: cow-refactoring-20260126
  title: "COW Math Pipeline - Skill-Driven Architecture Refactoring"
  requester: autonomous
  clarify_date: "2026-01-26"
  method: "reverse_engineering"

# =============================================================================
# 1. REVERSE-ENGINEERED REQUIREMENTS
# =============================================================================

requirements:
  primary_goal: |
    COW (Math Image Parsing Pipeline) 프로젝트를 현재 Palantir 워크스페이스의
    Skill-Driven Architecture 패턴으로 대규모 리팩토링하여 유지보수성,
    테스트 커버리지, 확장성을 향상시킨다.

  key_requirements:
    # === Architecture Refactoring ===
    - id: REQ-001
      area: "Pipeline Modularization"
      requirement: "1,535 lines pipeline.py를 Stage별 독립 모듈로 분리"
      evidence: "pipeline.py에 8개 Stage가 단일 파일에 혼재"
      priority: P0-CRITICAL
      impact: maintainability, testability

    - id: REQ-002
      area: "Configuration Standardization"
      requirement: "Skill frontmatter 패턴으로 설정 표준화"
      evidence: "PipelineConfig가 ~975 lines, 다양한 설정 방식 혼재"
      priority: P0-CRITICAL
      impact: consistency, developer_experience

    - id: REQ-003
      area: "Validation Gates Integration"
      requirement: "Shift-Left 패턴으로 Stage 전환 시 검증 강화"
      evidence: "_validate_stage_transition()이 permissive (warn only)"
      priority: P0-CRITICAL
      impact: data_integrity, early_error_detection

    # === Test Coverage Enhancement ===
    - id: REQ-004
      area: "Missing Stage Tests"
      requirement: "Stage A, B, C, F, H 모듈별 단위 테스트 추가"
      evidence: "310+ tests 있으나 Stage A/B/C/F/H 전용 테스트 없음"
      priority: P0-CRITICAL
      impact: reliability, regression_prevention

    - id: REQ-005
      area: "Exception Testing"
      requirement: "Custom exception hierarchy 테스트 프레임워크 구축"
      evidence: "Exception 정의됨, 테스트 없음"
      priority: P1-HIGH
      impact: error_handling, debugging

    - id: REQ-006
      area: "Edge Case Coverage"
      requirement: "Boundary value 및 null/empty 테스트 추가"
      evidence: "All fixtures use synthetic data, no edge case fixtures"
      priority: P1-HIGH
      impact: robustness

    # === Code Quality Improvement ===
    - id: REQ-007
      area: "Type Annotation Consistency"
      requirement: "Optional[X] → X | None 현대화 (Python 3.10+)"
      evidence: "mathpix.py uses Optional[Dict] (Python 3.9 style)"
      priority: P2-MEDIUM
      impact: code_quality, IDE_support

    - id: REQ-008
      area: "Exception Handling Granularity"
      requirement: "Broad exception catches를 specific error handling으로 개선"
      evidence: "pipeline.py lines 997-1000: except Exception as e:"
      priority: P1-HIGH
      impact: debugging, error_recovery

    - id: REQ-009
      area: "Logging Consistency"
      requirement: "Structlog 의존성 통합 또는 stdlib logger 표준화"
      evidence: "Structlog optional dependency with fallback"
      priority: P2-MEDIUM
      impact: observability, debugging

    # === Integration Completion ===
    - id: REQ-010
      area: "Phase 5 Integration"
      requirement: "Threshold system을 Stage E, G에 통합 완료"
      evidence: "phase_5_integration.md: Stage E/G still using static thresholds"
      priority: P0-CRITICAL
      impact: accuracy, adaptive_learning

    - id: REQ-011
      area: "Schedule Module Testing"
      requirement: "drive_sync.py, schedule_parser.py 테스트 추가"
      evidence: "Schedule module lacks unit tests"
      priority: P1-HIGH
      impact: reliability

    # === Documentation ===
    - id: REQ-012
      area: "API Documentation"
      requirement: "docs/api/pipeline.md 상세화 및 예시 추가"
      evidence: "docs/api/pipeline.md minimal"
      priority: P2-MEDIUM
      impact: developer_experience, onboarding

# =============================================================================
# 2. GAP ANALYSIS
# =============================================================================

gap_analysis:
  - id: GAP-001
    category: "Test Coverage"
    current: "310 tests, semantic_graph & alignment only"
    target: "400+ tests, all stages covered"
    impact: HIGH
    remediation: |
      1. Create test_ingestion.py (Stage A)
      2. Create test_text_parse.py (Stage B)
      3. Create test_vision_parse.py (Stage C)
      4. Create test_regeneration.py (Stage F)
      5. Create test_export_engine.py (Stage H)
      6. Create test_human_review.py (Stage G)

  - id: GAP-002
    category: "Pipeline Modularity"
    current: "pipeline.py: 1,535 lines monolithic"
    target: "Stage별 독립 orchestrator (<300 lines each)"
    impact: HIGH
    remediation: |
      1. Extract _run_stage_a() → stages/ingestion_stage.py
      2. Extract _run_stage_b() → stages/text_parse_stage.py
      3. Extract _run_stage_c() → stages/vision_parse_stage.py
      4. ...repeat for D, E, F, G, H
      5. Create BaseStage abstract class

  - id: GAP-003
    category: "Validation Strictness"
    current: "Stage transitions warn but don't block"
    target: "Configurable strict mode with fail-fast"
    impact: HIGH
    remediation: |
      1. Add ValidationMode enum (STRICT, PERMISSIVE)
      2. Modify _validate_stage_transition() to respect mode
      3. Add pre-stage validation hooks
      4. Integrate with Shift-Left validation gates

  - id: GAP-004
    category: "Phase 5 Completion"
    current: "Stage E/G using static thresholds"
    target: "Dynamic 3-layer threshold system integrated"
    impact: CRITICAL
    remediation: |
      1. semantic_graph/builder.py: Replace static 0.60 with compute_effective_threshold()
      2. human_review/priority_scorer.py: Integrate threshold context
      3. Update threshold_calibration.yaml for new stages

  - id: GAP-005
    category: "Exception Framework"
    current: "Exceptions defined but not tested"
    target: "Full exception coverage with test suite"
    impact: MEDIUM
    remediation: |
      1. Create tests/exceptions/test_exception_hierarchy.py
      2. Test each custom exception type
      3. Verify exception chaining
      4. Test error message quality

# =============================================================================
# 3. SUCCESS CRITERIA
# =============================================================================

success_criteria:
  - id: SC-001
    criterion: "Test coverage 80% 이상 (현재 추정 ~60%)"
    verification: "pytest-cov 리포트로 측정"

  - id: SC-002
    criterion: "Stage A-H 각각 독립 테스트 파일 존재"
    verification: "tests/ 디렉토리에 test_stage_[a-h].py 확인"

  - id: SC-003
    criterion: "Pipeline.py 800 lines 이하로 감소"
    verification: "wc -l src/mathpix_pipeline/pipeline.py"

  - id: SC-004
    criterion: "Phase 5 threshold integration 완료"
    verification: "Stage E, G에서 compute_effective_threshold() 호출 확인"

  - id: SC-005
    criterion: "모든 기존 테스트 통과 (310+ tests)"
    verification: "pytest 전체 실행 PASS"

  - id: SC-006
    criterion: "Type annotation 현대화 완료"
    verification: "mypy --strict 경고 0개"

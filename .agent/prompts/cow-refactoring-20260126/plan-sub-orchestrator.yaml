# =============================================================================
# COW Pipeline Refactoring - Sub-Orchestrator Execution Plan
# =============================================================================
# Workload: cow-refactoring-20260126
# Created: 2026-01-26T15:55:00Z
# Mode: Sub-Orchestrator (Worker + Task Decomposition)
# Parent Task: #1 COW Pipeline 89개 컴포넌트 E2E 순차 검토
# =============================================================================

metadata:
  id: "cow-basestage-migration-plan"
  workload_id: "cow-refactoring-20260126"
  version: "2.0.0"
  created_at: "2026-01-26T15:55:00Z"
  updated_at: "2026-01-26T15:55:00Z"
  status: "approved"
  research_source: ".agent/prompts/cow-refactoring-20260126/research.md"
  clarify_source: ".agent/prompts/cow-refactoring-20260126/clarify.yaml"
  mode: "sub-orchestrator"

project:
  name: "COW Pipeline BaseStage Migration"
  description: |
    Math Image Parsing Pipeline(COW)의 나머지 5개 Stage를
    BaseStage 패턴으로 마이그레이션하여 70% 코드 감소 달성.

    Current State: 3/8 stages migrated (A, C, E)
    Target: 8/8 stages migrated (B, D, F, G, H remaining)

  objectives:
    - "Stage B (TextParse): MathpixClient wrapper → BaseStage"
    - "Stage D (Alignment): AlignmentEngine wrapper → BaseStage"
    - "Stage F (Regeneration): RegenerationEngine wrapper → BaseStage"
    - "Stage G (HumanReview): PriorityScorer + dynamic thresholds → BaseStage"
    - "Stage H (Export): ExportEngine wrapper → BaseStage"
    - "Pipeline.py 통합: 모든 stage를 framework-driven 패턴으로 전환"

# =============================================================================
# PHASES - Sub-Orchestrator Task Decomposition
# =============================================================================

phases:
  # ---------------------------------------------------------------------------
  # Phase 1: Parallel Stage Migrations (Can run in parallel)
  # ---------------------------------------------------------------------------
  - id: "P1-T1-text-parse"
    name: "TextParseStage Migration"
    description: |
      Stage B를 BaseStage 패턴으로 마이그레이션.
      MathpixClient를 감싸는 wrapper stage 구현.

      Reference: stages/semantic_graph_stage.py (218 lines)
    priority: "P1"
    owner: "Terminal-B"
    dependencies: []
    estimatedComplexity: "medium"

    targetFiles:
      - path: "cow/src/mathpix_pipeline/stages/text_parse_stage.py"
        action: "create"
        sections: ["TextParseStageConfig", "TextParseStage class"]
      - path: "cow/src/mathpix_pipeline/stages/__init__.py"
        action: "modify"
        sections: ["exports"]
      - path: "cow/tests/stages/test_text_parse_stage.py"
        action: "create"
        sections: ["unit tests"]

    referenceFiles:
      - path: "cow/src/mathpix_pipeline/stages/base.py"
        reason: "BaseStage ABC pattern"
      - path: "cow/src/mathpix_pipeline/clients/mathpix.py"
        reason: "MathpixClient to wrap"
      - path: "cow/src/mathpix_pipeline/stages/semantic_graph_stage.py"
        reason: "Reference implementation"

    completionCriteria:
      - "TextParseStage extends BaseStage[IngestionSpec, TextSpec]"
      - "validate() checks input image exists"
      - "_execute_async() calls MathpixClient"
      - "Unit tests pass"

    verificationSteps:
      - command: "pytest cow/tests/stages/test_text_parse_stage.py -v"
        expected: "All tests pass"

  - id: "P1-T2-alignment"
    name: "AlignmentStage Migration"
    description: |
      Stage D를 BaseStage 패턴으로 마이그레이션.
      AlignmentEngine을 감싸는 wrapper stage 구현.
      Composite input (TextSpec + VisionSpec) 처리.

      CRITICAL: Dynamic threshold integration required.
    priority: "P0"
    owner: "Terminal-C"
    dependencies: []
    estimatedComplexity: "high"

    targetFiles:
      - path: "cow/src/mathpix_pipeline/stages/alignment_stage.py"
        action: "create"
        sections: ["AlignmentInput", "AlignmentStageConfig", "AlignmentStage"]
      - path: "cow/src/mathpix_pipeline/stages/__init__.py"
        action: "modify"
        sections: ["exports"]
      - path: "cow/tests/stages/test_alignment_stage.py"
        action: "create"
        sections: ["unit tests", "threshold tests"]

    referenceFiles:
      - path: "cow/src/mathpix_pipeline/stages/base.py"
        reason: "BaseStage ABC pattern"
      - path: "cow/src/mathpix_pipeline/alignment/engine.py"
        reason: "AlignmentEngine to wrap (564 lines)"
      - path: "cow/src/mathpix_pipeline/schemas/threshold.py"
        reason: "3-layer threshold schema"

    completionCriteria:
      - "AlignmentStage extends BaseStage[AlignmentInput, AlignmentReport]"
      - "AlignmentInput dataclass with text_spec + vision_spec"
      - "compute_effective_threshold() integrated"
      - "Threshold context propagation working"
      - "Unit tests pass"

    verificationSteps:
      - command: "pytest cow/tests/stages/test_alignment_stage.py -v"
        expected: "All tests pass"

  - id: "P1-T3-regeneration"
    name: "RegenerationStage Migration"
    description: |
      Stage F를 BaseStage 패턴으로 마이그레이션.
      LaTeX/SVG generation engine wrapper 구현.
    priority: "P1"
    owner: "Terminal-D"
    dependencies: []
    estimatedComplexity: "medium"

    targetFiles:
      - path: "cow/src/mathpix_pipeline/stages/regeneration_stage.py"
        action: "create"
        sections: ["RegenerationStageConfig", "RegenerationStage"]
      - path: "cow/src/mathpix_pipeline/stages/__init__.py"
        action: "modify"
        sections: ["exports"]
      - path: "cow/tests/stages/test_regeneration_stage.py"
        action: "create"
        sections: ["unit tests"]

    referenceFiles:
      - path: "cow/src/mathpix_pipeline/stages/base.py"
        reason: "BaseStage ABC pattern"
      - path: "cow/src/mathpix_pipeline/regeneration/engine.py"
        reason: "RegenerationEngine to wrap"

    completionCriteria:
      - "RegenerationStage extends BaseStage[SemanticGraph, RegenerationSpec]"
      - "Multiple output formats supported"
      - "Unit tests pass"

    verificationSteps:
      - command: "pytest cow/tests/stages/test_regeneration_stage.py -v"
        expected: "All tests pass"

  # ---------------------------------------------------------------------------
  # Phase 2: Sequential Migrations (After Phase 1)
  # ---------------------------------------------------------------------------
  - id: "P2-T1-human-review"
    name: "HumanReviewStage Migration + Threshold Update"
    description: |
      Stage G를 BaseStage 패턴으로 마이그레이션.
      CRITICAL: Static thresholds (0.30, 0.45, 0.55) →
               Dynamic compute_effective_threshold() 전환.

      This is the final stage needing threshold integration.
    priority: "P0"
    owner: "Sub-Orchestrator"
    dependencies: ["P1-T2-alignment"]
    estimatedComplexity: "high"

    targetFiles:
      - path: "cow/src/mathpix_pipeline/stages/human_review_stage.py"
        action: "create"
        sections: ["HumanReviewInput", "HumanReviewStageConfig", "HumanReviewStage"]
      - path: "cow/src/mathpix_pipeline/human_review/priority_scorer.py"
        action: "modify"
        sections: ["dynamic threshold integration"]
      - path: "cow/tests/stages/test_human_review_stage.py"
        action: "create"
        sections: ["unit tests", "threshold tests"]

    referenceFiles:
      - path: "cow/src/mathpix_pipeline/schemas/threshold.py"
        reason: "compute_effective_threshold() function"
      - path: "cow/src/mathpix_pipeline/stages/semantic_graph_stage.py"
        reason: "Threshold integration pattern (lines 453-536)"

    completionCriteria:
      - "HumanReviewStage extends BaseStage[PipelineResult, ReviewSummary]"
      - "Static thresholds replaced with dynamic computation"
      - "ThresholdContext passed through pipeline"
      - "Unit tests pass"

    verificationSteps:
      - command: "pytest cow/tests/stages/test_human_review_stage.py -v"
        expected: "All tests pass"
      - command: "grep -r 'compute_effective_threshold' cow/src/mathpix_pipeline/human_review/"
        expected: "Function calls found"

  - id: "P2-T2-export"
    name: "ExportStage Migration"
    description: |
      Stage H를 BaseStage 패턴으로 마이그레이션.
      Multi-format export engine wrapper 구현.
    priority: "P1"
    owner: "Sub-Orchestrator"
    dependencies: ["P1-T3-regeneration"]
    estimatedComplexity: "medium"

    targetFiles:
      - path: "cow/src/mathpix_pipeline/stages/export_stage.py"
        action: "create"
        sections: ["ExportStageConfig", "ExportStage"]
      - path: "cow/src/mathpix_pipeline/stages/__init__.py"
        action: "modify"
        sections: ["exports"]
      - path: "cow/tests/stages/test_export_stage.py"
        action: "create"
        sections: ["unit tests"]

    referenceFiles:
      - path: "cow/src/mathpix_pipeline/export/engine.py"
        reason: "ExportEngine to wrap"

    completionCriteria:
      - "ExportStage extends BaseStage[RegenerationSpec, List[ExportSpec]]"
      - "Multiple export formats supported (PDF, DOCX, JSON, SVG, LaTeX)"
      - "Unit tests pass"

    verificationSteps:
      - command: "pytest cow/tests/stages/test_export_stage.py -v"
        expected: "All tests pass"

  # ---------------------------------------------------------------------------
  # Phase 3: Pipeline Integration (After Phase 2)
  # ---------------------------------------------------------------------------
  - id: "P3-T1-pipeline-integration"
    name: "Pipeline.py Integration"
    description: |
      pipeline.py의 _run_stage_*() 메서드를
      새 BaseStage 구현으로 교체.

      Target: 70% code reduction in stage methods
      Pattern: stage_result = await self._xxx_stage.run_async(input)
              self._apply_stage_result(stage_result, result, PipelineStage.XXX)
    priority: "P0"
    owner: "Sub-Orchestrator"
    dependencies: ["P2-T1-human-review", "P2-T2-export"]
    estimatedComplexity: "high"

    targetFiles:
      - path: "cow/src/mathpix_pipeline/pipeline.py"
        action: "modify"
        sections:
          - "imports"
          - "_init_components()"
          - "_run_stage_b()"
          - "_run_stage_d()"
          - "_run_stage_f()"
          - "_run_stage_g()"
          - "_run_stage_h()"

    referenceFiles:
      - path: "cow/src/mathpix_pipeline/pipeline.py"
        reason: "Lines 37-45: existing stage E integration pattern"

    completionCriteria:
      - "All 8 stages use framework-driven pattern"
      - "_apply_stage_result() used consistently"
      - "Stage timings collected properly"
      - "Integration tests pass"

    verificationSteps:
      - command: "pytest cow/tests/ -v --tb=short"
        expected: "265+ tests pass"
      - command: "wc -l cow/src/mathpix_pipeline/pipeline.py"
        expected: "< 1200 lines (down from 1580)"

  # ---------------------------------------------------------------------------
  # Phase 4: Verification & Cleanup
  # ---------------------------------------------------------------------------
  - id: "P4-T1-verification"
    name: "Full Test Suite Verification"
    description: |
      전체 테스트 스위트 실행 및 검증.
      Type checking 및 coverage 리포트 생성.
    priority: "P0"
    owner: "Sub-Orchestrator"
    dependencies: ["P3-T1-pipeline-integration"]
    estimatedComplexity: "low"

    targetFiles: []

    completionCriteria:
      - "pytest cow/tests/ passes (265+ tests)"
      - "mypy cow/src/mathpix_pipeline/stages/ passes"
      - "No regressions in existing functionality"

    verificationSteps:
      - command: "pytest cow/tests/ -v --tb=short"
        expected: "265+ tests pass"
      - command: "mypy cow/src/mathpix_pipeline/stages/"
        expected: "No errors"

# =============================================================================
# DEPENDENCIES - Task Dependency Graph
# =============================================================================

dependencies:
  internal:
    - from: "P2-T1-human-review"
      to: "P1-T2-alignment"
      reason: "Human Review needs Alignment's threshold pattern as reference"

    - from: "P2-T2-export"
      to: "P1-T3-regeneration"
      reason: "Export takes RegenerationSpec from Regeneration stage"

    - from: "P3-T1-pipeline-integration"
      to: "P2-T1-human-review"
      reason: "All stages must be ready before pipeline integration"

    - from: "P3-T1-pipeline-integration"
      to: "P2-T2-export"
      reason: "All stages must be ready before pipeline integration"

    - from: "P4-T1-verification"
      to: "P3-T1-pipeline-integration"
      reason: "Verification after integration"

  external:
    - name: "BaseStage ABC"
      version: "1.1.0"
      reason: "Abstract base class for all stages"

# =============================================================================
# PLAN AGENT REVIEW
# =============================================================================

planAgentReview:
  status: "approved"
  reviewedAt: "2026-01-26T15:55:00Z"
  reviewedBy: "Plan Agent"
  iterationCount: 1
  comments:
    - round: 1
      comment: "Dependencies form acyclic graph. Parallelization opportunities identified."
      resolution: "Approved for execution"

  approvalCriteria:
    - "All phases have clear completion criteria ✅"
    - "Dependencies form acyclic graph ✅"
    - "Target files are specified for each phase ✅"
    - "Risk mitigation strategies identified ✅"

# =============================================================================
# EXECUTION NOTES - Sub-Orchestrator Guidance
# =============================================================================

executionNotes:
  parallelization: |
    Phase 1 tasks (P1-T1, P1-T2, P1-T3) can run in parallel:
    - Terminal-B: TextParseStage
    - Terminal-C: AlignmentStage
    - Terminal-D: RegenerationStage

    Phase 2+ must be sequential due to dependencies.

  criticalPath: |
    P1-T2 (Alignment) → P2-T1 (Human Review) → P3-T1 (Pipeline) → P4-T1 (Verify)

    Stage D (Alignment) is critical due to threshold integration complexity.

  riskMitigation: |
    1. HIGH: AlignmentStage complexity (564 lines engine)
       - Mitigation: Focus on wrapper pattern, don't refactor engine internals

    2. MEDIUM: Threshold integration in Stage G
       - Mitigation: Use Stage E as reference implementation

    3. LOW: Test regression
       - Mitigation: Run full test suite after each phase

# =============================================================================
# SUB-ORCHESTRATOR NATIVE TASKS
# =============================================================================
# The Sub-Orchestrator will create these Native Tasks using TaskCreate:
#
# 1. TaskCreate: "P1-T1: TextParseStage migration" → owner: Terminal-B
# 2. TaskCreate: "P1-T2: AlignmentStage migration" → owner: Terminal-C
# 3. TaskCreate: "P1-T3: RegenerationStage migration" → owner: Terminal-D
# 4. TaskCreate: "P2-T1: HumanReviewStage + thresholds" → blockedBy: [P1-T2]
# 5. TaskCreate: "P2-T2: ExportStage migration" → blockedBy: [P1-T3]
# 6. TaskCreate: "P3-T1: Pipeline integration" → blockedBy: [P2-T1, P2-T2]
# 7. TaskCreate: "P4-T1: Full verification" → blockedBy: [P3-T1]
# =============================================================================

# =============================================================================
# Worker Task: Terminal-C - Shift Left Gates 3, 4 + Observability
# =============================================================================
# Read this file AFTER reading _context-shift-left-philosophy.yaml
# Location: .agent/prompts/pending/worker-terminal-c-shift-left-philosophy.yaml
# =============================================================================

assignedTo: "terminal-c"
orchestrator: "Terminal-A"
createdAt: "2026-01-25T16:40:00Z"
projectSlug: "shift-left-philosophy"

# =============================================================================
# CONTEXT REFERENCE
# =============================================================================
contextFile: ".agent/prompts/_context-shift-left-philosophy.yaml"
progressFile: ".agent/prompts/_progress-shift-left-philosophy.yaml"

# =============================================================================
# MY TASKS (2 tasks assigned)
# =============================================================================
myTasks:
  - taskId: "2"
    phaseId: "phase2-planning-orchestrate-gates"
    name: "Gate 3-4 Integration: /planning, /orchestrate"
    blockedBy: []
    canStartImmediately: true

  - taskId: "4"
    phaseId: "phase4-observability"
    name: "Validation Metrics & Dashboard"
    blockedBy: ["2"]
    canStartImmediately: false

# =============================================================================
# TASK 2: Gate 3-4 Integration (CAN START IMMEDIATELY)
# =============================================================================
task2:
  nativeTaskId: "2"
  phaseId: "phase2-planning-orchestrate-gates"
  name: "Gate 3-4 Integration: /planning, /orchestrate"
  priority: "P0"

  description: |
    /planning과 /orchestrate 스킬에 validation gates 통합.

    Gate 3 (/planning):
    - Plan Agent 리뷰 전 pre_flight_checks() 호출
    - Target files 존재/생성 가능 여부 검증
    - Circular dependency 조기 탐지

    Gate 4 (/orchestrate):
    - Task 생성 전 validate_phase_dependencies() 호출
    - 중복 phase ID 탐지
    - 정의되지 않은 dependency 탐지

  targetFiles:
    - path: ".claude/skills/planning/SKILL.md"
      action: "modify"
      sections: ["execution protocol - add pre-flight check"]
    - path: ".claude/hooks/planning-preflight.sh"
      action: "create"
      template: |
        #!/bin/bash
        source .claude/skills/shared/validation-gates.sh
        pre_flight_checks "$1"
    - path: ".claude/skills/orchestrate/SKILL.md"
      action: "modify"
      sections: ["execution protocol - add dependency validation"]
    - path: ".claude/hooks/orchestrate-validate.sh"
      action: "create"
      template: |
        #!/bin/bash
        source .claude/skills/shared/validation-gates.sh
        validate_phase_dependencies "$1"

  referenceFiles:
    - path: ".claude/skills/shared/validation-gates.sh"
      reason: "Gate 3, 4 함수 정의 확인"
    - path: ".claude/hooks/planning-finalize.sh"
      reason: "기존 hook 패턴 참조"

  completionCriteria:
    - "/planning에 pre-flight check 추가"
    - "planning-preflight.sh가 Gate 3 호출"
    - "/orchestrate에 dependency validation 추가"
    - "orchestrate-validate.sh가 Gate 4 호출"
    - "모든 hook 스크립트가 bash -n 통과"

  verificationSteps:
    - command: "bash -n .claude/hooks/planning-preflight.sh"
      expected: "exit 0"
    - command: "bash -n .claude/hooks/orchestrate-validate.sh"
      expected: "exit 0"

  onComplete:
    - "TaskUpdate(taskId='2', status='completed')"
    - "Task #4 (phase4-observability) is now unblocked"
    - "Report L1 summary to Orchestrator"

# =============================================================================
# TASK 4: Observability (WAIT FOR TASK 2)
# =============================================================================
task4:
  nativeTaskId: "4"
  phaseId: "phase4-observability"
  name: "Validation Metrics & Dashboard"
  priority: "P2"

  waitCondition: |
    Check TaskGet("2").status == "completed"
    Then proceed with this task

  description: |
    Shift-Left 효과 측정을 위한 메트릭 수집.

    1. 로그 집계:
       - .agent/logs/validation_gates.log 분석
       - Gate별 pass/warning/fail 카운트

    2. 대시보드:
       - _progress.yaml에 validation 섹션 추가
       - Gate별 성공률 시각화

    3. 개선 지표:
       - "Shift Left Ratio": 조기 탐지된 문제 / 전체 문제
       - "Prevention Rate": Gate에서 차단된 문제 수

    NOTE: Handle missing validation_gates.log gracefully

  targetFiles:
    - path: ".claude/hooks/validation-metrics.sh"
      action: "create"
      notes: "Check if log file exists before parsing"
    - path: ".agent/prompts/_progress.yaml"
      action: "modify"
      sections: ["add validation_metrics section"]

  referenceFiles:
    - path: ".agent/logs/validation_gates.log"
      reason: "Parse validation logs (may not exist yet)"
    - path: ".claude/skills/shared/validation-gates.sh"
      reason: "Understand log format"

  completionCriteria:
    - "validation-metrics.sh가 로그 분석"
    - "_progress.yaml에 validation 섹션 존재"
    - "Gate별 통계 출력 가능"
    - "Missing log file handled gracefully"

  verificationSteps:
    - command: "bash -n .claude/hooks/validation-metrics.sh"
      expected: "exit 0"

  onComplete:
    - "TaskUpdate(taskId='4', status='completed')"
    - "Task #5 (phase5-e2e-testing) 의존성 일부 해소"
    - "Report L1 summary to Orchestrator"

# =============================================================================
# EXECUTION SEQUENCE
# =============================================================================
executionSequence:
  - step: 1
    taskId: "2"
    action: "START IMMEDIATELY"
    blockedBy: []
  - step: 2
    taskId: "4"
    action: "Wait for Task #2, then start"
    blockedBy: ["2"]

# =============================================================================
# START COMMAND
# =============================================================================
startCommand: |
  /worker start terminal-c

# =============================================================================
# END OF WORKER PROMPT
# =============================================================================

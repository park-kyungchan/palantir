# =============================================================================
# Enhanced Feedback Loop Pattern Extension - Orchestrating Plan (Final)
# =============================================================================
# Generated: 2026-01-28
# Phase: /planning (After Phase 3.5 Main Agent Review)
# Source: plan-final.yaml + orchestrating-plan-draft + Gap Analysis
# =============================================================================

metadata:
  plan_id: efl-extension-20260128
  version: "1.0.0"
  status: FINALIZED
  workload_id: efl-extension_20260128_165000
  slug: efl-extension-20260128
  generated_by: main-orchestrator
  source_documents:
    - plan-final.yaml (1289 lines - EFL specification)
    - orchestrating-plan-draft-20260128.yaml (489 lines - Initial draft)
    - synthesized-l1-l2-20260128.md (242 lines - Synthesis analysis)
  total_effort: "16-20 hours"
  files_to_modify: 10  # Updated from 8 after gap analysis

# =============================================================================
# SECTION 1: Principles Mapping (from plan-final.yaml)
# =============================================================================
principles:
  P1:
    name: "skill_as_sub_orchestrator"
    original_title: "Every Skill = Sub-Orchestrator"
    status: PARTIAL
    affected_skills: ["/planning", "/research", "/orchestrate", "/collect", "/synthesis"]
    action: |
      - Standardize ALL pipeline skills as Sub-Orchestrators
      - Each skill must delegate to Agents, not execute directly
      - Add agent_delegation config to frontmatter
    priority: HIGH
    implications:
      - skill_is_conductor_not_executor
      - agent_delegation_with_l1_validation_and_feedback_loop
      - agent_composition_per_skill_characteristics

  P2:
    name: "parallel_agent_deployment"
    original_title: "Parallel Agent Deployment"
    status: MISSING
    affected_skills: ["/research", "/planning"]
    action: |
      - Add parallel_agent_config schema
      - Implement complexity-based agent count (2-5)
      - Add agent synchronization handlers
    priority: CRITICAL
    config:
      min_count: 2
      max_count: 5
      complexity_thresholds:
        simple: 2
        moderate: 3
        complex: 4
        very_complex: 5

  P3:
    name: "general_purpose_synthesis"
    original_title: "General-Purpose Agent Synthesis"
    status: MISSING
    affected_skills: ["/synthesis", "/collect"]
    action: |
      - Replace keyword matching with semantic analysis
      - Implement Phase 3-A (L2 Horizontal) + Phase 3-B (L3 Vertical) structure
      - Only synthesized L1/L2 injected to main context
    priority: CRITICAL
    phase_structure:
      phase_3a:
        name: "L2 Synthesis Horizontal"
        focus: "cross_area_consistency, gap_detection"
      phase_3b:
        name: "L3 Verification Vertical"
        focus: "code_reality_check, reference_accuracy"

  P4:
    name: "selective_feedback_loop"
    original_title: "Selective Feedback Loop"
    status: PARTIAL
    affected_skills: ["/clarify", "/orchestrate", "/collect", "/synthesis"]
    action: |
      - Add selective_feedback config with severity-based threshold
      - Implement partial_rerun_instead_of_full_rerun
      - Use MEDIUM+ severity for loop trigger (not numeric threshold)
    priority: HIGH
    severity_config:
      levels: [LOW, MEDIUM, HIGH, CRITICAL]
      threshold_for_loop: MEDIUM
      action_on_low: log_only

  P5:
    name: "phase_3.5_review_gate"
    original_title: "Repeat Until Final Approval"
    status: MISSING
    affected_skills: ["/collect", "/synthesis"]
    action: |
      - Add Phase 3.5 Review Gate
      - Main Agent reviews from holistic perspective
      - Implement repeat_until_quality_achieved pattern
    priority: HIGH
    review_criteria:
      - requirement_alignment
      - design_flow_consistency
      - gap_detection
      - conclusion_clarity

  P6:
    name: "agent_internal_feedback_loop"
    original_title: "All Agents Self Feedback Loop"
    status: PARTIAL
    affected_skills: ["/orchestrate", "/synthesis", "/collect"]
    action: |
      - Add agent_internal_feedback_loop config
      - Include self_validation_criteria in agent prompts
      - Max 3 iterations per agent
    priority: HIGH
    config:
      max_iterations: 3
      validation_criteria:
        explore:
          - analysis_completeness
          - information_accuracy
          - internal_consistency
        plan:
          - implementability
          - dependency_correctness
          - completeness
          - risk_identification
      prompt_template_required_sections:
        - internal_feedback_loop_instruction
        - internal_loop_status_report

# =============================================================================
# SECTION 2: Terminal Work Distribution (Refined)
# =============================================================================
terminal_distribution:
  main:
    role: "Orchestrator + Phase 3.5 Executor"
    responsibilities:
      - "Overall coordination and phase transitions"
      - "Phase 3.5 Review Gate execution (holistic verification)"
      - "Phase 4 Quality Assurance"
      - "Conflict resolution between terminals"
      - "Final synthesis and user approval (Phase 6)"
    review_gates: ["phase_1_complete", "phase_2_complete", "phase_3_complete", "phase_4_complete"]
    main_agent_perspective:
      metaphor: "See the forest"
      focus:
        - overall_design_flow_verification
        - architecture_perspective
        - global_optimization
        - requirement_alignment

  terminal_b:
    role: "Infrastructure & Foundation"
    workload_id: "terminal-b-efl-20260128"
    assigned_phases: [1, 2]
    tasks:
      - task_id: B-001
        phase: 1
        name: "Create validation-feedback-loop.sh"
        file: "/home/palantir/.claude/skills/shared/validation-feedback-loop.sh"
        principles: [P4, P5, P6]
        effort: "1.5 hours"
        components:
          - name: check_selective_feedback
            params: ["config_file", "result_json"]
            returns: "AUTO_APPROVE | REQUIRE_USER"
            logic: "severity_based_not_numeric_threshold"
          - name: review_gate
            params: ["skill_name", "result_json", "auto_approve"]
            returns: "exit_code (0=approved, 1=needs_review)"
            review_criteria: ["requirement_alignment", "design_flow_consistency", "gap_detection", "conclusion_clarity"]
          - name: run_feedback_loop
            params: ["skill_name", "max_iterations", "trigger_condition"]
            returns: "iteration_count"
            max_iterations: 3
          - name: generate_agent_prompt_with_internal_loop
            params: ["agent_type", "validation_criteria"]
            returns: "prompt_string"
            required_sections: ["internal_feedback_loop_instruction", "internal_loop_status_report"]

      - task_id: B-002
        phase: 1
        name: "Create parallel-agent.sh"
        file: "/home/palantir/.claude/skills/shared/parallel-agent.sh"
        principles: [P2]
        effort: "1 hour"
        components:
          - name: parallel_agent_spawn
            params: ["agent_config_json"]
            returns: "agent_id"
          - name: agent_synchronization
            params: ["agent_ids", "wait_strategy"]
            returns: "results_json"
          - name: result_aggregation
            params: ["results_array", "strategy"]
            returns: "aggregated_result"
          - name: get_agent_count_by_complexity
            params: ["complexity_level"]
            returns: "number (2-5)"
            thresholds: {simple: 2, moderate: 3, complex: 4, very_complex: 5}

      - task_id: B-003
        phase: 2
        name: "Update /clarify for P4"
        file: "/home/palantir/.claude/skills/clarify/SKILL.md"
        principles: [P4]
        effort: "1.5 hours"
        changes:
          - "Add selective_feedback frontmatter config"
          - "Use severity-based threshold (MEDIUM+), not numeric"
          - "Integrate check_selective_feedback() for auto-recommend"
          - "Default: enabled=false (user intent capture should not be automated)"
        blockedBy: [B-001]

      - task_id: B-004
        phase: 2
        name: "Update /research for P1+P2"
        file: "/home/palantir/.claude/skills/research/SKILL.md"
        principles: [P1, P2]
        effort: "2 hours"
        changes:
          - "Add agent_delegation config (P1: skill as sub-orchestrator)"
          - "Add parallel_agent_config section (P2)"
          - "Implement complexity-based agent count"
          - "Add agent synchronization and aggregation handlers"
        blockedBy: [B-002]

    total_effort: "6 hours"
    files_count: 4

  terminal_c:
    role: "Mid-Pipeline Skills"
    workload_id: "terminal-c-efl-20260128"
    assigned_phases: [3]
    tasks:
      - task_id: C-001
        phase: 3
        name: "Update /planning for P1+P2"
        file: "/home/palantir/.claude/skills/planning/SKILL.md"
        principles: [P1, P2]
        effort: "2.5 hours"
        changes:
          - "Add agent_delegation config (P1)"
          - "Add parallel_agent_config section matching /research pattern (P2)"
          - "Standardize L1 return format to YAML"
          - "Add l2Path and requiresL2Read fields"
        blockedBy: [B-004]

      - task_id: C-002
        phase: 3
        name: "Update /orchestrate for P1+P4+P6"
        file: "/home/palantir/.claude/skills/orchestrate/SKILL.md"
        principles: [P1, P4, P6]
        effort: "2.5 hours"
        changes:
          - "Add agent_delegation config (P1: sub-orchestrator pattern)"
          - "Add agent_internal_feedback_loop config (P6)"
          - "Implement local decomposition refinement"
          - "Add selective_feedback for Gate 4 warnings (P4)"
          - "Enable local use of feedbackLoopConfig"
          - "Add validation_criteria to agent prompts"
        blockedBy: [B-001, B-003]

    total_effort: "5 hours"
    files_count: 2

  terminal_d:
    role: "End-Pipeline Skills"
    workload_id: "terminal-d-efl-20260128"
    assigned_phases: [4]
    tasks:
      - task_id: D-001
        phase: 4
        name: "Update /collect for P1+P3+P5+P6"
        file: "/home/palantir/.claude/skills/collect/SKILL.md"
        principles: [P1, P3, P5, P6]
        effort: "3 hours"
        changes:
          - "Add agent_delegation config (P1)"
          - "Implement Phase 3-A: L2 horizontal structured data collection (P3)"
          - "Implement Phase 3-B: L3 vertical feedback aggregation (P3)"
          - "Add Phase 3.5 Review Gate (P5)"
          - "Add agent_internal_feedback_loop config (P6)"
          - "Integrate validation-feedback-loop.sh"
        blockedBy: [B-001, C-002]

      - task_id: D-002
        phase: 4
        name: "Update /synthesis for P1+P3+P5+P6"
        file: "/home/palantir/.claude/skills/synthesis/SKILL.md"
        principles: [P1, P3, P5, P6]
        effort: "3.5 hours"
        changes:
          - "Add agent_delegation config (P1)"
          - "Replace keyword matching with semantic analysis (P3)"
          - "Implement Phase 3-A/3-B structure (P3)"
          - "Add Phase 3.5 Review Gate (P5)"
          - "Add iteration tracking with convergence detection (P6)"
          - "Integrate feedback from previous synthesis attempts"
          - "Add validation_criteria to all agent prompts"
        blockedBy: [B-001, D-001]

    total_effort: "6.5 hours"
    files_count: 2

# =============================================================================
# SECTION 3: Implementation Phases
# =============================================================================
phases:
  - phase: 1
    name: "Shared Infrastructure"
    terminal: B
    tasks: [B-001, B-002]
    effort: "2.5 hours"
    outputs:
      - path: ".claude/skills/shared/validation-feedback-loop.sh"
        components: [check_selective_feedback, review_gate, run_feedback_loop, generate_agent_prompt_with_internal_loop]
      - path: ".claude/skills/shared/parallel-agent.sh"
        components: [parallel_agent_spawn, agent_synchronization, result_aggregation, get_agent_count_by_complexity]
    validation:
      - "Shell scripts are syntactically valid (shellcheck passes)"
      - "All functions are exportable"
      - "Severity-based threshold logic implemented (not numeric)"
      - "Agent prompt template includes internal_loop sections"

  - phase: 2
    name: "Foundation Skills"
    terminal: B
    tasks: [B-003, B-004]
    effort: "3.5 hours"
    dependencies: [phase_1]
    outputs:
      - "Updated /clarify SKILL.md with P4 (severity-based)"
      - "Updated /research SKILL.md with P1+P2"
    validation:
      - "Frontmatter schema is valid"
      - "Existing functionality preserved (backward compatible)"
      - "New features have defaults to current behavior"
      - "/research has agent_delegation and parallel_agent_config"

  - phase: 3
    name: "Mid-Pipeline Skills"
    terminal: C
    tasks: [C-001, C-002]
    effort: "5 hours"
    dependencies: [phase_2]
    outputs:
      - "Updated /planning SKILL.md with P1+P2"
      - "Updated /orchestrate SKILL.md with P1+P4+P6"
    validation:
      - "L1 return format is YAML (not emoji)"
      - "parallel_agent_config schema matches /research"
      - "Gate 4 uses severity-based selective_feedback"
      - "Agent prompts include validation_criteria"

  - phase: 4
    name: "End-Pipeline Skills"
    terminal: D
    tasks: [D-001, D-002]
    effort: "6.5 hours"
    dependencies: [phase_3]
    outputs:
      - "Updated /collect SKILL.md with P1+P3+P5+P6"
      - "Updated /synthesis SKILL.md with P1+P3+P5+P6"
    validation:
      - "Phase 3-A (L2 horizontal) / 3-B (L3 vertical) separation implemented"
      - "Review Gate checkpoints added (holistic verification)"
      - "Semantic matching replaces keyword matching"
      - "Iteration tracking with convergence detection functional"
      - "All agent prompts have internal_feedback_loop_instruction"

# =============================================================================
# SECTION 4: Cross-Terminal Dependencies
# =============================================================================
dependencies:
  phase_level:
    - from: phase_1
      to: phase_2
      type: SEQUENTIAL
      reason: "Shared modules must exist before skill updates"

    - from: phase_2
      to: phase_3
      type: SEQUENTIAL
      reason: "/planning P2 depends on /research P2 pattern"

    - from: phase_3
      to: phase_4
      type: SEQUENTIAL
      reason: "/collect depends on /orchestrate feedbackLoopConfig"

  task_level:
    - from: B-001
      to: [B-003, C-002, D-001, D-002]
      type: BLOCKER
      reason: "validation-feedback-loop.sh required by P4/P5/P6 implementations"

    - from: B-002
      to: [B-004, C-001]
      type: BLOCKER
      reason: "parallel-agent.sh required by P2 implementations"

    - from: B-004
      to: C-001
      type: PATTERN
      reason: "/planning P2 should follow /research P2 pattern"

    - from: C-002
      to: D-001
      type: CONFIG
      reason: "/collect uses feedbackLoopConfig from /orchestrate"

    - from: D-001
      to: D-002
      type: SEQUENTIAL
      reason: "/synthesis Phase 3-A depends on /collect structure"

# =============================================================================
# SECTION 5: Validation Gates
# =============================================================================
validation_gates:
  phase_1_complete:
    owner: Main
    criteria:
      - "validation-feedback-loop.sh exists and exports all 4 functions"
      - "parallel-agent.sh exists and exports all 4 functions"
      - "Both scripts pass shellcheck"
      - "Severity-based logic implemented (check_selective_feedback uses MEDIUM+)"
      - "Agent prompt template has required sections"
    auto_approve: true
    threshold: "all_criteria_met"

  phase_2_complete:
    owner: Main
    criteria:
      - "/clarify has selective_feedback frontmatter (severity-based)"
      - "/research has agent_delegation config (P1)"
      - "/research has parallel_agent_config section (P2)"
      - "No breaking changes to existing behavior"
    auto_approve: false
    threshold: "review_required"

  phase_3_complete:
    owner: Main
    criteria:
      - "/planning L1 returns YAML format"
      - "/planning has agent_delegation + parallel_agent_config"
      - "/orchestrate uses feedbackLoopConfig locally"
      - "/orchestrate has agent_internal_feedback_loop config"
      - "Gate 4 warnings trigger selective_feedback (severity-based)"
    auto_approve: false
    threshold: "review_required"

  phase_4_complete:
    owner: Main
    criteria:
      - "/collect has agent_delegation config"
      - "/collect has Phase 3-A/3-B separation"
      - "/collect has Review Gate (Phase 3.5 pattern)"
      - "/synthesis uses semantic matching"
      - "/synthesis has iteration tracking with convergence detection"
      - "All agent prompts have internal_feedback_loop_instruction section"
    auto_approve: false
    threshold: "full_review_required"

# =============================================================================
# SECTION 6: Shared Modules Specification (Detailed)
# =============================================================================
shared_modules:
  validation-feedback-loop.sh:
    path: "/home/palantir/.claude/skills/shared/validation-feedback-loop.sh"
    functions:
      - name: check_selective_feedback
        params: ["config_file", "result_json"]
        returns: "AUTO_APPROVE | REQUIRE_USER"
        logic: |
          severity=$(extract_severity "$result_json")
          if [[ "$severity" == "LOW" ]]; then
            echo "AUTO_APPROVE"  # log_only
          else
            echo "REQUIRE_USER"  # MEDIUM, HIGH, CRITICAL
          fi
        used_by: ["/clarify", "/orchestrate"]

      - name: review_gate
        params: ["skill_name", "result_json", "auto_approve"]
        returns: "exit_code (0=approved, 1=needs_review)"
        review_criteria:
          - requirement_alignment
          - design_flow_consistency
          - gap_detection
          - conclusion_clarity
        used_by: ["/collect", "/synthesis"]

      - name: run_feedback_loop
        params: ["skill_name", "max_iterations", "trigger_condition"]
        returns: "iteration_count"
        config:
          max_iterations: 3
          per_agent_max: 3
          on_max_reached: "user_decision"
        used_by: ["/orchestrate", "/synthesis"]

      - name: generate_agent_prompt_with_internal_loop
        params: ["agent_type", "validation_criteria"]
        returns: "prompt_string"
        required_sections:
          - name: internal_feedback_loop_instruction
            content: |
              - Perform analysis then self-validate results
              - Validation criteria: ${validation_criteria}
              - Retry on issues (max 3 times)
              - Output in L1/L2/L3 format after validation passes
          - name: internal_loop_status_report
            fields: [internalIterations, validationStatus, resolvedIssues]
        used_by: ["/research", "/planning", "/orchestrate", "/collect", "/synthesis"]

  parallel-agent.sh:
    path: "/home/palantir/.claude/skills/shared/parallel-agent.sh"
    functions:
      - name: parallel_agent_spawn
        params: ["agent_config_json"]
        returns: "agent_id"
        used_by: ["/research", "/planning"]

      - name: agent_synchronization
        params: ["agent_ids", "wait_strategy"]
        returns: "results_json"
        wait_strategies: ["parallel", "sequential", "barrier"]
        used_by: ["/research", "/planning"]

      - name: result_aggregation
        params: ["results_array", "strategy"]
        returns: "aggregated_result"
        strategies: ["merge", "vote", "consensus"]
        used_by: ["/research", "/planning"]

      - name: get_agent_count_by_complexity
        params: ["complexity_level"]
        returns: "number (2-5)"
        thresholds:
          simple: 2
          moderate: 3
          complex: 4
          very_complex: 5
        used_by: ["/research", "/planning"]

# =============================================================================
# SECTION 7: Risk Mitigation
# =============================================================================
risk_mitigation:
  - risk: "Breaking existing workflows"
    severity: HIGH
    mitigation:
      - "All new features have feature flags"
      - "Defaults preserve current behavior"
      - "Test with existing workloads before enabling"
      - "Backward compatibility testing in each validation gate"
    affected_phases: [2, 3, 4]

  - risk: "Infinite feedback loops"
    severity: MEDIUM
    mitigation:
      - "Hard cap maxIterations=3 in shared module"
      - "Log all iterations to .agent/logs/"
      - "Timeout enforcement (30s per iteration)"
      - "User decision option after max reached"
    affected_phases: [4]

  - risk: "/clarify auto-approve bypasses user intent"
    severity: HIGH
    mitigation:
      - "Default disabled (enabled: false)"
      - "Require explicit --auto-approve flag"
      - "Log auto-approvals for audit"
      - "User intent capture should not be automated by default"
    affected_phases: [2]

  - risk: "Semantic matching performance"
    severity: MEDIUM
    mitigation:
      - "Cache embedding results"
      - "Timeout of 10s for matching operations"
      - "Fallback to keyword matching on timeout"
    affected_phases: [4]

  - risk: "/worker feedbackLoop() integration gap"
    severity: LOW
    mitigation:
      - "Document known gap in this plan"
      - "Defer to future iteration"
      - "workerStartWithFeedbackLoop() exists (Line 1717-1760), needs Main Router update (Line 1812)"
    affected_phases: []
    note: "Out of scope for this iteration"

  - risk: "P1 inconsistent application across skills"
    severity: MEDIUM
    mitigation:
      - "Standardize agent_delegation config schema"
      - "Use shared module for prompt generation"
      - "Cross-terminal validation in review gates"
    affected_phases: [2, 3, 4]

# =============================================================================
# SECTION 8: Success Criteria
# =============================================================================
success_criteria:
  must_have:
    - "All 10 files created/modified (2 shared + 8 skills)"
    - "All 6 principles (P1-P6) addressed in applicable skills"
    - "All 4 phases complete with validation gates passed"
    - "No breaking changes to existing workflows"
    - "Severity-based feedback loop (not numeric threshold)"
    - "Phase 3-A/3-B structure in /collect and /synthesis"
    - "Agent prompts include internal_feedback_loop_instruction"

  should_have:
    - "Unit tests for shared modules"
    - "Integration test with sample workload"
    - "Documentation updated in CLAUDE.md"
    - "Backward compatibility verified"

  nice_to_have:
    - "/worker Main Router integration"
    - "Performance benchmarks"
    - "Rollback procedures documented"
    - "/build-research EFL analysis (deferred)"

# =============================================================================
# SECTION 9: Execution Commands for Terminals
# =============================================================================
execution_commands:
  terminal_b:
    start: "/worker start B-001"
    sequence:
      - "B-001 → B-002 (parallel possible within Phase 1)"
      - "Wait for phase_1_complete validation"
      - "B-003 → B-004 (B-003 first, then B-004)"
      - "Report phase_2_complete to Main"

  terminal_c:
    start: "/worker start C-001"
    sequence:
      - "Wait for phase_2_complete"
      - "C-001 → C-002 (sequential)"
      - "Report phase_3_complete to Main"

  terminal_d:
    start: "/worker start D-001"
    sequence:
      - "Wait for phase_3_complete"
      - "D-001 → D-002 (sequential)"
      - "Report phase_4_complete to Main"

# =============================================================================
# SECTION 10: Terminal-Specific Planning Outputs
# =============================================================================
terminal_planning_outputs:
  note: >
    Each terminal must generate their own /planning outputs based on assigned tasks.
    Below are the expected planning output paths for each terminal.

  terminal_b:
    plan_file: ".agent/prompts/efl-extension-20260128/terminal-b-plan.yaml"
    scope:
      - B-001: validation-feedback-loop.sh implementation plan
      - B-002: parallel-agent.sh implementation plan
      - B-003: /clarify P4 update plan
      - B-004: /research P1+P2 update plan
    required_sections:
      - implementation_steps
      - file_modifications
      - validation_criteria
      - rollback_strategy

  terminal_c:
    plan_file: ".agent/prompts/efl-extension-20260128/terminal-c-plan.yaml"
    scope:
      - C-001: /planning P1+P2 update plan
      - C-002: /orchestrate P1+P4+P6 update plan
    required_sections:
      - implementation_steps
      - file_modifications
      - validation_criteria
      - rollback_strategy

  terminal_d:
    plan_file: ".agent/prompts/efl-extension-20260128/terminal-d-plan.yaml"
    scope:
      - D-001: /collect P1+P3+P5+P6 update plan
      - D-002: /synthesis P1+P3+P5+P6 update plan
    required_sections:
      - implementation_steps
      - file_modifications
      - validation_criteria
      - rollback_strategy

# =============================================================================
# END OF ORCHESTRATING PLAN
# =============================================================================

# =============================================================================
# Global Context for Ontology-Definition Enhancement Project
# =============================================================================
# This file provides the BIG PICTURE for all Workers.
# Every Worker MUST read this file BEFORE starting their task.
#
# Location: .agent/prompts/_context.yaml
# Language: English (Machine-Readable)
# =============================================================================

version: "3.0"
project: "ontology-definition-enhancement"
projectName: "Ontology-Definition Package Enhancement"
orchestrator: "Terminal-A"
createdAt: "2026-01-25T14:40:00Z"
lastUpdated: "2026-01-25T14:40:00Z"

# =============================================================================
# PROJECT OBJECTIVES
# =============================================================================
objectives:
  primary:
    - "docs/Ontology.md 완전 커버리지 달성"
    - "Function, ObjectSet, Automation, Rules Engine, Writeback, Versioning 타입 추가"
    - "PropertyType 세부 속성 정교화 (isPrimaryKey, searchable, sortable)"
    - "ActionType ValueSource 옵션 완전 구현"
    - "Pydantic 기반 타입 안전성 유지"
    - "Foundry JSON 호환성 보장"

  constraints:
    - "Pydantic v2 모델 패턴 준수"
    - "기존 to_foundry_dict() / from_foundry_dict() 패턴 유지"
    - "OntologyEntity 기반 클래스 상속 구조 유지"
    - "기존 테스트 통과 유지"

# =============================================================================
# CODEBASE LOCATION
# =============================================================================
codebase:
  rootPath: "/home/palantir/park-kyungchan/palantir/Ontology-Definition"
  modulePath: "ontology_definition"
  testsPath: "tests"
  docsReference: "/home/palantir/park-kyungchan/palantir/docs/Ontology.md"

# =============================================================================
# DEPENDENCY GRAPH
# =============================================================================
dependencyGraph: |
  Task #1 (PropertyType)  ─────────────────────────────────────────────────┐
         │                                                                  │
         ├─────────────────────┬──────────────────────────────────────┐    │
         │                     │                                      │    │
         ▼                     ▼                                      ▼    │
  Task #2 (Function)    Task #3 (ObjectSet)                   Task #7 (Versioning)
         │                     │                                           │
         ├─────────┐           │                                           │
         │         │           │                                           │
         ▼         ▼           ▼                                           │
  Task #8 (ValueSource)    Task #4 (Automation)   Task #5 (Rules Engine)   │
                              │                          │                 │
                              ▼                          │                 │
                       Task #6 (Writeback)               │                 │
                              │                          │                 │
                              └──────────┬───────────────┘                 │
                                         │                                 │
                                         ▼                                 │
                                  Task #9 (Testing) ◄──────────────────────┘

# =============================================================================
# IMPLEMENTATION TASKS
# =============================================================================
tasks:
  "1":
    subject: "Phase 1: PropertyType 정교화"
    owner: "Terminal-B"
    status: "pending"
    priority: "P0"
    blockedBy: []
    canStartImmediately: true
    phaseId: "phase1-property-enhancement"
    targetFiles:
      - "ontology_definition/types/property_def.py"
      - "ontology_definition/core/enums.py"

  "2":
    subject: "Phase 2: Function 타입 정의 추가"
    owner: "Terminal-C"
    status: "pending"
    priority: "P0"
    blockedBy: ["1"]
    phaseId: "phase2-function-type"
    targetFiles:
      - "ontology_definition/types/function.py"
      - "ontology_definition/core/enums.py"
      - "ontology_definition/types/__init__.py"

  "3":
    subject: "Phase 3: ObjectSet 타입 정의 추가"
    owner: "Terminal-B"
    status: "pending"
    priority: "P0"
    blockedBy: ["1"]
    phaseId: "phase3-objectset-type"
    targetFiles:
      - "ontology_definition/types/objectset.py"
      - "ontology_definition/types/__init__.py"

  "4":
    subject: "Phase 4: Automation 타입 정의 추가"
    owner: "Terminal-C"
    status: "pending"
    priority: "P1"
    blockedBy: ["2", "3"]
    phaseId: "phase4-automation-type"
    targetFiles:
      - "ontology_definition/types/automation.py"
      - "ontology_definition/core/enums.py"

  "5":
    subject: "Phase 5: Rules Engine 타입 정의 추가"
    owner: "Terminal-B"
    status: "pending"
    priority: "P1"
    blockedBy: ["3"]
    phaseId: "phase5-rules-engine"
    targetFiles:
      - "ontology_definition/types/rules_engine.py"
      - "ontology_definition/types/__init__.py"

  "6":
    subject: "Phase 6: Writeback 설정 타입 추가"
    owner: "Terminal-C"
    status: "pending"
    priority: "P1"
    blockedBy: ["4"]
    phaseId: "phase6-writeback"
    targetFiles:
      - "ontology_definition/types/writeback.py"

  "7":
    subject: "Phase 7: Versioning & Governance 지원 추가"
    owner: "Terminal-B"
    status: "pending"
    priority: "P1"
    blockedBy: ["1"]
    phaseId: "phase7-versioning"
    targetFiles:
      - "ontology_definition/versioning/__init__.py"
      - "ontology_definition/versioning/schema_change.py"
      - "ontology_definition/versioning/migration.py"
      - "ontology_definition/versioning/proposal.py"

  "8":
    subject: "Phase 8: ActionType ValueSource 정교화"
    owner: "Terminal-C"
    status: "pending"
    priority: "P2"
    blockedBy: ["2"]
    phaseId: "phase8-valuesource-enhancement"
    targetFiles:
      - "ontology_definition/types/action_type.py"

  "9":
    subject: "Phase 9: 테스트 및 문서화"
    owner: "All"
    status: "pending"
    priority: "P0"
    blockedBy: ["1", "2", "3", "4", "5", "6", "7", "8"]
    phaseId: "phase9-testing"
    targetFiles:
      - "tests/test_function.py"
      - "tests/test_objectset.py"
      - "tests/test_automation.py"
      - "tests/test_rules_engine.py"
      - "tests/test_writeback.py"
      - "tests/test_versioning.py"
      - "README.md"

# =============================================================================
# REFERENCE FILES
# =============================================================================
referenceFiles:
  - path: "/home/palantir/park-kyungchan/palantir/docs/Ontology.md"
    reason: "Master specification document (12 sections, 1258 lines)"

  - path: "/home/palantir/.agent/plans/ontology_definition_enhancement_20260125.yaml"
    reason: "Approved planning document with phase specifications"

  - path: "ontology_definition/core/base.py"
    reason: "OntologyEntity base class reference"

  - path: "ontology_definition/core/enums.py"
    reason: "DataType, ObjectStatus enum definitions"

  - path: "ontology_definition/types/object_type.py"
    reason: "ObjectType model reference for pattern consistency"

  - path: "ontology_definition/types/property_def.py"
    reason: "PropertyDefinition model - Phase 1 modification target"

  - path: "ontology_definition/types/action_type.py"
    reason: "ActionType model - Phase 8 modification target"

# =============================================================================
# WORKER PROTOCOL
# =============================================================================
workerProtocol:
  onStart:
    - "TaskList() - Check assigned tasks"
    - "TaskGet(taskId) - Get full task details"
    - "Verify blockedBy is empty"
    - "TaskUpdate(status='in_progress')"
    - "Read _context.yaml (this file)"
    - "Read assigned promptFile"

  onComplete:
    - "TaskUpdate(status='completed')"
    - "Run verification command"
    - "Output to .agent/outputs/{terminal}/"
    - "Notify Orchestrator"

  onBlocked:
    - "DO NOT start blocked tasks"
    - "Wait for blockers to complete"
    - "Report to Orchestrator if critical"

# =============================================================================
# AUTONOMOUS EXECUTION PROTOCOL (자율 실행 프로토콜)
# =============================================================================
autonomousProtocol:
  enabled: true
  pollIntervalSeconds: 30

  executionLoop: |
    WHILE project NOT completed:
      1. TaskList() → 전체 Task 상태 확인
      2. Filter by owner == MY_TERMINAL
      3. FOR each myTask:
           IF myTask.status == "pending":
             IF myTask.blockedBy ALL completed:
               → TaskUpdate(taskId, status="in_progress")
               → Execute task
               → TaskUpdate(taskId, status="completed")
             ELSE:
               → Log "Waiting for blockers: {blockedBy}"
               → Continue to next task
      4. IF all myTasks completed:
           → Check if other terminals need help
           → Report final status
      5. Sleep(pollIntervalSeconds)

  checkBlockers: |
    function checkBlockersCompleted(taskId):
      task = TaskGet(taskId)
      blockedBy = task.blockedBy

      IF blockedBy is empty:
        RETURN true

      FOR each blockerId in blockedBy:
        blockerTask = TaskGet(blockerId)
        IF blockerTask.status != "completed":
          RETURN false

      RETURN true

  selfAssignment:
    primary: "Execute tasks assigned to my terminal"
    secondary: "If all my tasks done, check for unassigned tasks"
    forbidden: "Never take tasks assigned to other terminals"

  completionDetection:
    projectComplete: "All tasks #1-#9 have status='completed'"
    terminalComplete: "All tasks with owner=MY_TERMINAL have status='completed'"

  errorRecovery:
    onTaskFailure:
      - "Log error to .agent/logs/{terminal}.log"
      - "TaskUpdate(taskId, metadata.error='{error}')"
      - "Continue with next available task"
    onDeadlock:
      - "Detect: No progress for 3 poll cycles"
      - "Action: Report to Orchestrator with blockers list"

# =============================================================================
# QUALITY CRITERIA
# =============================================================================
qualityCriteria:
  - "Pydantic v2 model validation patterns"
  - "to_foundry_dict() / from_foundry_dict() roundtrip integrity"
  - "Type hints and docstrings for all public methods"
  - "Foundry JSON schema compatibility"
  - "Existing tests remain passing"
  - "New tests for all new types"

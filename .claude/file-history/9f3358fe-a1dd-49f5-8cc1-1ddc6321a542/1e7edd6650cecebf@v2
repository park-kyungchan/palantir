---
description: |
  Execute approved plan with Orchestrator-mode enforcement.
  Ensures Main Agent delegates all work to Subagents.
  Includes automatic result verification and recovery gate.
allowed-tools: Read, Grep, Glob, Bash, TodoWrite, Task, AskUserQuestion
argument-hint: [plan-file-path]
---

# /execute Command (Orchestrator Enforcement)

Execute an approved plan while **enforcing Orchestrator-only behavior**.
Main Agent is **prohibited from direct execution** - all work delegated to Subagents.

## Core Principle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¯ ORCHESTRATOR MODE                                           â”‚
â”‚                                                                 â”‚
â”‚  Main Agent = Conductor (delegates, verifies, NEVER executes)   â”‚
â”‚  Subagents = Performers (Explore/Plan/general-purpose)          â”‚
â”‚                                                                 â”‚
â”‚  Python Integration:                                            â”‚
â”‚  from lib.oda.planning import ExecutionOrchestrator             â”‚
â”‚  orchestrator = get_orchestrator()                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Arguments

$ARGUMENTS - Optional path to plan file (defaults to most recent IN_PROGRESS plan)

---

## Execution Flow (7 Steps)

### Step 1: ROLE DECLARATION
**TodoWrite ì²« ë²ˆì§¸ í•­ëª©ìœ¼ë¡œ Orchestrator ì—­í•  ì„ ì–¸:**
```
ğŸ¯ ORCHESTRATOR: ì§ì ‘ ì‹¤í–‰ ê¸ˆì§€ - Task()ë¡œ Subagentì— ìœ„ì„ | ê²°ê³¼ ê²€ì¦ í•„ìˆ˜
```

### Step 2: PLAN RETRIEVAL
**Python Module:** `lib/oda/planning/plan_file.py`
```python
from lib.oda.planning import load_plan
plan = load_plan(".agent/plans/{slug}.md")
```

### Step 3: DELEGATION MAPPING
**Python Module:** `lib/oda/planning/execution_orchestrator.py`

| Task Type | Subagent | Budget (ULTRATHINK) |
|-----------|----------|---------------------|
| Analysis | Explore | 15K |
| Design | Plan | 25K |
| Implementation | general-purpose | 32K |

### Step 4: TODOWRITE GENERATION
**Format:** `[Phase N] {ì‘ì—…} | â†’ Delegate: {type}:{agent_id} | Budget: {N}K`

### Step 5: ORCHESTRATED EXECUTION
```python
from lib.oda.planning import get_orchestrator, ThinkingMode

orchestrator = get_orchestrator(thinking_mode=ThinkingMode.ULTRATHINK)
orchestrator.load_plan(plan_path)

for phase in orchestrator.get_pending_phases():
    params = orchestrator.get_delegation_params(phase.number)
    Task(**params)  # Main Agent invokes Task()
    orchestrator.register_agent(agent_id, phase.number, params["subagent_type"])
```

### Step 6: RESULT VERIFICATION â˜… CRITICAL
```python
from lib.oda.planning import is_summary_only, verify_subagent_result

verification = orchestrator.verify_result(result, agent_id, agent_type)
# Returns: VerificationResult with decision (COMPLETE, L2_RECOVERED, NEEDS_REDELEGATION)
```

### Step 7: RECOVERY GATE â˜… BLOCKING
```python
if not orchestrator.recovery_gate(phase_result):
    # BLOCKED - cannot proceed without full results
    # RecoveryOptions: Resume, Re-execute, Manual Read, Skip
```

**HARD RULE: ìš”ì•½ë§Œìœ¼ë¡œ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰ ê¸ˆì§€**

---

## ExecutionOrchestrator API Reference

**Module:** `lib/oda/planning/execution_orchestrator.py`

| Method | Purpose |
|--------|---------|
| `get_orchestrator(session_id, thinking_mode)` | Factory - session-scoped instance |
| `load_plan(path)` | Load and parse plan file |
| `execute_phase(phase_num)` | Prepare phase for delegation |
| `get_delegation_params(phase_num)` | Get Task() parameters |
| `verify_result(result, agent_id)` | Check if summary-only |
| `recovery_gate(phase_result)` | Block if incomplete |
| `register_agent(agent_id, phase, type)` | Track for resume |

**Key Classes:**
- `RecoveryDecision`: COMPLETE, L2_RECOVERED, L3_RECOVERED, NEEDS_REDELEGATION, BLOCKED
- `VerificationResult`: is_complete, is_summary_only, content, layer_accessed
- `PhaseResult`: status, agent_ids, verifications, recovery_options

---

## Orchestrator Enforcement Rules

### Main Agent ALLOWED
| Action | Reason |
|--------|--------|
| `Read`, `Grep`, `Glob` | Information gathering |
| `TodoWrite` | Progress tracking |
| `Task()` | Subagent delegation |
| `AskUserQuestion` | User interaction |

### Main Agent PROHIBITED
| Action | Redirect |
|--------|----------|
| `Edit`, `Write` | `Task(subagent_type="general-purpose")` |
| Complex `Bash` | `Task(subagent_type="general-purpose")` |

---

## Usage Examples

### Basic (Auto-detect Plan)
```
/execute
```

### Specific Plan
```
/execute user_authentication
```

### After /plan Approval
```
User: /plan ì‚¬ìš©ì ì¸ì¦ ê¸°ëŠ¥ ì¶”ê°€
[Plan generated]
User: ìŠ¹ì¸. /execute
```

---

## Auto-Compact Recovery

**TodoWrite contains all recovery info:**
```
ğŸ¯ ORCHESTRATOR: ì§ì ‘ ì‹¤í–‰ ê¸ˆì§€
âœ… [Phase 1] ë¶„ì„ | Explore:a1b2c3d (done)
â³ [Phase 2] ì„¤ê³„ | Plan:b2c3d4e | Budget: 25K
[Phase 3] êµ¬í˜„ | general-purpose:pending
```

**Resume:** Extract agent_id â†’ `Task(resume="b2c3d4e")`

---

## Error Handling

| Error | Resolution |
|-------|------------|
| No plan found | Run `/plan` first |
| Summary-only result | Resume or re-execute |
| Context exhaustion | Run `/compact` |

---

## Related Commands

| Step | Command |
|------|---------|
| Requirements | `/ask` |
| Planning | `/plan` |
| Execution | `/execute` |
| Verification | `/quality-check` |

---

## Module References

| Component | Path |
|-----------|------|
| ExecutionOrchestrator | `lib/oda/planning/execution_orchestrator.py` |
| PlanFile | `lib/oda/planning/plan_file.py` |
| OutputLayerManager | `lib/oda/planning/output_layer_manager.py` |
| ContextBudgetManager | `lib/oda/planning/context_budget_manager.py` |
| TaskDecomposer | `lib/oda/planning/task_decomposer.py` |
| AgentRegistry | `lib/oda/planning/agent_registry.py` |

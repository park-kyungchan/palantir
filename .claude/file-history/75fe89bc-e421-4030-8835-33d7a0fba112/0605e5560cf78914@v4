# cow/ Pipeline Enhancement Plan V3

> **Version:** 3.0 | **Status:** ARCHITECTURE DECIDED | **Date:** 2026-01-19
> **Goal:** Gemini 3.0 Pro + Claude Vision êµì°¨ê²€ì¦ + Human-in-the-Loop íŒŒì´í”„ë¼ì¸
> **Last Updated:** 2026-01-19 (Q3: ìµœì¢… ì•„í‚¤í…ì²˜ ê²°ì •)

---

## Current Architecture (8-Stage)

```
A. INGESTION    â†’ B. TEXT PARSE   â†’ C. VISION PARSE  â†’ D. ALIGNMENT
      â†“                (Mathpix)       (YOLO+Gemini)        â†“
H. EXPORT      â† G. HUMAN REVIEW  â† F. REGENERATION  â† E. SEMANTIC GRAPH
```

## ğŸ¯ Target Architecture V3 (DECIDED)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NEW PIPELINE ARCHITECTURE                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  A. INGESTION â†’ B. VISION PARSE â†’ C. CROSS-VERIFY â†’ D. ALIGNMENT   â”‚
â”‚                  (Gemini 3.0 Pro)  (Claude Vision)                  â”‚
â”‚                                                                     â”‚
â”‚                         â†“                                           â”‚
â”‚                                                                     â”‚
â”‚  H. EXPORT â† G. REGENERATION â† F. HUMAN REVIEW â† E. SEMANTIC GRAPH â”‚
â”‚                                 (Human-in-the-Loop)                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í•µì‹¬ ë³€ê²½ì‚¬í•­

| Stage | Before | After | ë³€ê²½ ì´ìœ  |
|-------|--------|-------|----------|
| **B** | Mathpix OCR | **Gemini 3.0 Pro** | ë‹¨ì¼ APIë¡œ ìˆ˜ì‹+ë‹¤ì´ì–´ê·¸ë¨ í†µí•© ì²˜ë¦¬ |
| **C** | YOLO+Gemini | **Claude Vision** | êµì°¨ê²€ì¦ìœ¼ë¡œ í’ˆì§ˆ í–¥ìƒ (Claude Max í™œìš©) |
| **F** | Regeneration (E ì§í›„) | **Human Reviewë¡œ ì´ë™** | HITL í›„ ì¬ìƒì„±ì´ ë” íš¨ìœ¨ì  |
| **G** | Human Review (F ì§í›„) | **E ì§í›„ë¡œ ì´ë™** | ê·¸ë˜í”„ ìƒì„± í›„ ì¦‰ì‹œ ê²€í†  |

### Stage ìˆœì„œ ë³€ê²½

```
ê¸°ì¡´: A â†’ B â†’ C â†’ D â†’ E â†’ F â†’ G â†’ H
ë³€ê²½: A â†’ B â†’ C â†’ D â†’ E â†’ G â†’ F â†’ H
                      â†‘   â†‘
                      â”‚   â””â”€â”€ Human Review (Stage E ì§í›„)
                      â””â”€â”€â”€â”€â”€â”€ Semantic Graph
```

### ë¹„ìš© êµ¬ì¡°

| Component | Cost/Image | ë¹„ê³  |
|-----------|-----------|------|
| Gemini 3.0 Pro | ~$0.01 | ì£¼ ì²˜ë¦¬ |
| Claude Vision | $0.00 | Claude Max êµ¬ë… (ë¬´ë£Œ) |
| **Total** | **~$0.01** | Mathpix ì œê±°ë¡œ ë¹„ìš© ì ˆê° |

### Mathpix ì œê±° ê²°ì •
- âœ… Gemini 3.0 Proê°€ ìˆ˜ì‹ OCRë„ ì²˜ë¦¬ ê°€ëŠ¥
- âœ… Claude Visionìœ¼ë¡œ êµì°¨ê²€ì¦í•˜ì—¬ í’ˆì§ˆ ë³´ì™„
- âœ… API ë‹¨ì¼í™”ë¡œ ë³µì¡ë„ ê°ì†Œ

---

## Q&A Log (ë§¤ í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸)

### Q1: Stage CëŠ” ì™œ í•„ìš”í•˜ì§€? (2026-01-19)

**í˜„ì¬ Stage C êµ¬ì„±:**
| Component | Purpose | File |
|-----------|---------|------|
| **YOLO Detector** | ë‹¤ì´ì–´ê·¸ë¨/ë„í˜• ë°•ìŠ¤ ê°ì§€ | `vision/yolo_detector.py` |
| **Gemini Vision** | ê°ì§€ëœ ì˜ì—­ í•´ì„ | `vision/gemini_client.py` |
| **Hybrid Merger** | YOLO + Gemini ê²°ê³¼ ë³‘í•© | `vision/hybrid_merger.py` |
| **Detection Layer** | ì¢Œí‘œ ê¸°ë°˜ ê°ì§€ | `vision/detection_layer.py` |
| **Interpretation Layer** | ì˜ë¯¸ í•´ì„ | `vision/interpretation_layer.py` |

**Stage Cê°€ í•´ê²°í•˜ëŠ” ë¬¸ì œ:**
1. MathpixëŠ” **í…ìŠ¤íŠ¸/ìˆ˜ì‹ OCR**ì— íŠ¹í™” â†’ ë‹¤ì´ì–´ê·¸ë¨/ê·¸ë˜í”„ í•´ì„ ë¶ˆê°€
2. YOLOë¡œ **ì‹œê°ì  ìš”ì†Œ ìœ„ì¹˜** ê°ì§€ â†’ Geminië¡œ **ì˜ë¯¸ í•´ì„**
3. ìˆ˜í•™ ë¬¸ì œì— ê·¸ë¦¼ì´ í¬í•¨ëœ ê²½ìš° í•„ìš”

**Claude Visionìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥í•œê°€?**

| ê¸°ëŠ¥ | YOLO+Gemini | Claude Vision | ëŒ€ì²´ ê°€ëŠ¥? |
|------|-------------|---------------|-----------|
| ë„í˜• ê°ì§€ | YOLO bbox | ê°€ëŠ¥ | âœ… |
| ê·¸ë˜í”„ í•´ì„ | Gemini | ê°€ëŠ¥ | âœ… |
| ìˆ˜ì‹ OCR | âŒ | ê°€ëŠ¥ (ì •í™•ë„ ë‚®ìŒ) | âš ï¸ |
| ì¢Œí‘œ ë°˜í™˜ | ì •í™•í•œ bbox | ëŒ€ëµì  ìœ„ì¹˜ | âš ï¸ |

**ê²°ë¡ :**
- ìˆœìˆ˜ **ë‹¤ì´ì–´ê·¸ë¨ í•´ì„** ëª©ì ì´ë©´ â†’ Claude Visionìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥
- **ì •í™•í•œ ì¢Œí‘œ ê¸°ë°˜ ì²˜ë¦¬** í•„ìš”í•˜ë©´ â†’ YOLO ìœ ì§€ ê¶Œì¥

---

## Decision Points (ì‚¬ìš©ì í™•ì¸ í•„ìš”)

### DP1: Stage C ì²˜ë¦¬ ë°©ì‹
- [ ] **Option A:** Claude Visionìœ¼ë¡œ ì™„ì „ ëŒ€ì²´ (YOLO+Gemini ì œê±°)
- [ ] **Option B:** Claude Visionë§Œ ì‚¬ìš© (YOLO ì œê±°, Geminiâ†’Claude)
- [ ] **Option C:** Stage C ì „ì²´ ì œê±° (Mathpix OCRë§Œ ì‚¬ìš©)

### DP2: í›„ì† Stage ì²˜ë¦¬
- [ ] Stage D-G ì œê±° (ì •ë ¬/ê·¸ë˜í”„/ì¬ìƒì„±/ë¦¬ë·° ë¶ˆí•„ìš”)
- [ ] Stage Dë§Œ ìœ ì§€ (Textâ†”Vision ì •ë ¬ì€ í•„ìš”)
- [ ] ë‹¤ë¥¸ ì¡°í•©?

---

## Files to Modify/Remove (ì˜ˆì •)

### ì œê±° í›„ë³´
```
cow/src/mathpix_pipeline/
â”œâ”€â”€ vision/
â”‚   â”œâ”€â”€ yolo_detector.py       # DP1ì— ë”°ë¼ ê²°ì •
â”‚   â”œâ”€â”€ gemini_client.py       # DP1ì— ë”°ë¼ ê²°ì •
â”‚   â”œâ”€â”€ hybrid_merger.py       # ì œê±° ì˜ˆì •
â”‚   â”œâ”€â”€ detection_layer.py     # DP1ì— ë”°ë¼ ê²°ì •
â”‚   â””â”€â”€ interpretation_layer.py # Claude Visionìœ¼ë¡œ ëŒ€ì²´
â”œâ”€â”€ alignment/                 # DP2ì— ë”°ë¼ ê²°ì •
â”œâ”€â”€ semantic_graph/            # ì œê±° ì˜ˆì •
â”œâ”€â”€ regeneration/              # ì œê±° ì˜ˆì •
â””â”€â”€ human_review/              # ì œê±° ì˜ˆì •
```

### ìœ ì§€ í™•ì •
```
cow/src/mathpix_pipeline/
â”œâ”€â”€ ingestion/                 # Stage A - ìœ ì§€
â”œâ”€â”€ clients/mathpix.py         # Stage B - ìœ ì§€
â”œâ”€â”€ export/                    # Stage H - ìœ ì§€
â”œâ”€â”€ config.py                  # ê²½ëŸ‰í™” í•„ìš”
â”œâ”€â”€ pipeline.py                # ë¦¬íŒ©í† ë§ í•„ìš”
â””â”€â”€ schemas/                   # ê²½ëŸ‰í™” í•„ìš”
```

---

## Next Questions (ë‹¤ìŒ í”„ë¡¬í”„íŠ¸ì—ì„œ ë‹µë³€ í•„ìš”)

1. **DP1 ê²°ì •:** Claude Visionìœ¼ë¡œ Stage Cë¥¼ ì–´ë–»ê²Œ ëŒ€ì²´í• ì§€?
2. **ì¶œë ¥ í˜•ì‹:** ìµœì¢… ì¶œë ¥ì€ ë¬´ì—‡ì´ í•„ìš”í•œì§€? (JSON? LaTeX? ë‘˜ ë‹¤?)
3. **Stage D-G:** ì •ë ¬/ê·¸ë˜í”„/ë¦¬ë·° ê¸°ëŠ¥ì´ í•„ìš”í•œì§€?

---

---

## Q2: Gemini 3.0 Pro API ë¹„ìš© ë¶„ì„ (2026-01-19)

### Gemini 3.0 Pro ê°€ê²©í‘œ (2026ë…„ 1ì›” ê¸°ì¤€)

| Context Length | Input (1M tokens) | Output (1M tokens) |
|----------------|-------------------|-------------------|
| â‰¤ 200K tokens | **$2.00** | **$12.00** |
| > 200K tokens | $4.00 | $18.00 |

### ìˆ˜í•™ ë¬¸ì œ ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜ˆìƒ ë¹„ìš©

| ì‹œë‚˜ë¦¬ì˜¤ | Input Tokens | Output Tokens | ì˜ˆìƒ ë¹„ìš© |
|----------|--------------|---------------|----------|
| ì´ë¯¸ì§€ 1ì¥ (ë‹¨ìˆœ ìˆ˜ì‹) | ~1,000 | ~500 | **$0.008** |
| ì´ë¯¸ì§€ 1ì¥ (ë³µì¡í•œ ë‹¤ì´ì–´ê·¸ë¨) | ~3,000 | ~1,500 | **$0.024** |
| 100ì¥ ë°°ì¹˜ ì²˜ë¦¬ | ~300,000 | ~150,000 | **$2.40** |
| 1,000ì¥ ë°°ì¹˜ ì²˜ë¦¬ | ~3M | ~1.5M | **$24.00** |

### ê²½ìŸì‚¬ ë¹„êµ (2026ë…„ 1ì›”)

| Model | Input (1M) | Output (1M) | íŠ¹ì§• |
|-------|-----------|-------------|------|
| **Gemini 3.0 Pro** | $2.00 | $12.00 | 1M context, Vision ê°•ì  |
| GPT-5 | $1.25 | $10.00 | ê°€ì¥ ì €ë ´ |
| Claude Opus 4.5 | $5.00 | $25.00 | ì¶”ë¡  í’ˆì§ˆ ìµœê³  |
| Claude Sonnet 4 | $3.00 | $15.00 | ê· í˜• |

### ë¹„ìš© ìµœì í™” ì „ëµ

1. **Caching í™œìš©** - ë°˜ë³µ í”„ë¡¬í”„íŠ¸ ìºì‹±ìœ¼ë¡œ 50% ì ˆê° ê°€ëŠ¥
2. **Batch API** - ëŒ€ëŸ‰ ì²˜ë¦¬ ì‹œ 20-30% í• ì¸
3. **Context ìµœì í™”** - 200K ì´í•˜ ìœ ì§€ë¡œ 2ë°° ì ˆê°

---

## Q2-2: ê³ ë„í™” ë°©ì•ˆ

### Option A: Multi-Model Ensemble (ê¶Œì¥)

```
ì´ë¯¸ì§€ â†’ [Mathpix OCR] â”€â”€â”
                        â”œâ”€â”€â†’ [Fusion Layer] â†’ ìµœì¢… ê²°ê³¼
         [Gemini Vision]â”€â”€â”˜
```

**ì¥ì :**
- Mathpixì˜ ìˆ˜ì‹ OCR ì •í™•ë„ + Geminiì˜ ë‹¤ì´ì–´ê·¸ë¨ í•´ì„ë ¥
- ê° ëª¨ë¸ì˜ ê°•ì  í™œìš©
- ê²°ê³¼ êµì°¨ ê²€ì¦ìœ¼ë¡œ ì‹ ë¢°ë„ í–¥ìƒ

### Option B: Gemini 3.0 Pro ë‹¨ë… (ë¹„ìš© íš¨ìœ¨)

```
ì´ë¯¸ì§€ â†’ [Gemini 3.0 Pro] â†’ LaTeX + í•´ì„ ê²°ê³¼
         (Vision + OCR í†µí•©)
```

**ì¥ì :**
- API í˜¸ì¶œ 1íšŒë¡œ ë¹„ìš© ì ˆê°
- 1M contextë¡œ ì—¬ëŸ¬ ì´ë¯¸ì§€ ë°°ì¹˜ ì²˜ë¦¬ ê°€ëŠ¥
- ë‹¨ìˆœí•œ ì•„í‚¤í…ì²˜

### Option C: Hierarchical Processing (ìµœê³  í’ˆì§ˆ)

```
ì´ë¯¸ì§€ â†’ [Gemini Flash] â†’ ì´ˆê¸° ë¶„ë¥˜
              â†“
         [ë³µì¡ë„ íŒë‹¨]
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 ë‹¨ìˆœ ìˆ˜ì‹   ë³µì¡ ë‹¤ì´ì–´ê·¸ë¨  í˜¼í•©
    â†“           â†“          â†“
 Mathpix    Gemini Pro   ë‘˜ ë‹¤
```

**ì¥ì :**
- ë¹„ìš© ìµœì í™” (ë‹¨ìˆœ ë¬¸ì œëŠ” ì €ë ´í•œ ëª¨ë¸ ì‚¬ìš©)
- ë³µì¡í•œ ë¬¸ì œì—ë§Œ ê³ ê¸‰ ëª¨ë¸ íˆ¬ì…
- í™•ì¥ì„± ì¢‹ìŒ

### Option D: Fine-tuned Vision Model (ì¥ê¸°)

```
[ìì²´ í•™ìŠµ ë°ì´í„°] â†’ Fine-tuned Gemini â†’ ë„ë©”ì¸ íŠ¹í™”
```

**ì¥ì :**
- ìˆ˜í•™ ë¬¸ì œ íŠ¹í™” ëª¨ë¸
- ì¥ê¸°ì ìœ¼ë¡œ ë¹„ìš© ì ˆê°
- ë…ì ì  ê²½ìŸë ¥

---

## ì¶”ê°€ ê³ ë„í™” ê¸°ëŠ¥ ì œì•ˆ

### 1. Confidence Scoring ê°•í™”
```python
class EnhancedVisionResult:
    latex: str
    confidence: float  # 0.0-1.0
    alternative_interpretations: List[str]
    reasoning: str  # ì™œ ì´ë ‡ê²Œ í•´ì„í–ˆëŠ”ì§€
```

### 2. Interactive Correction Loop
```
ì‚¬ìš©ì í”¼ë“œë°± â†’ ëª¨ë¸ ì¬í•´ì„ â†’ ê°œì„ ëœ ê²°ê³¼
```

### 3. Multi-Modal Grounding
```
ì´ë¯¸ì§€ + í…ìŠ¤íŠ¸ íŒíŠ¸ â†’ ë” ì •í™•í•œ í•´ì„
```

### 4. Streaming Output
```
ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶€ë¶„ ê²°ê³¼ ë°˜í™˜ â†’ UX ê°œì„ 
```

---

## Decision Points (ì—…ë°ì´íŠ¸)

### DP1: ê³ ë„í™” ë°©í–¥ (New)
- [ ] **Option A:** Multi-Model Ensemble
- [ ] **Option B:** Gemini 3.0 Pro ë‹¨ë…
- [ ] **Option C:** Hierarchical Processing
- [ ] **Option D:** Fine-tuned ì¥ê¸° ê³„íš

### DP2: Stage C ì²˜ë¦¬ (Updated)
- [ ] Gemini 3.0 Proë¡œ ì—…ê·¸ë ˆì´ë“œ (í˜„ì¬ Gemini ë²„ì „ í™•ì¸ í•„ìš”)
- [ ] YOLO ìœ ì§€ + Gemini 3.0 Pro ì¡°í•©
- [ ] YOLO ì œê±°, Gemini ë‹¨ë…

---

## Change Log

| Date | Version | Change |
|------|---------|--------|
| 2026-01-19 | 1.0 | Initial plan, Q1 answered |
| 2026-01-19 | 2.0 | ê²½ëŸ‰í™”â†’ê³ ë„í™” ì „í™˜, Q2 Gemini ë¹„ìš© ë¶„ì„, ê³ ë„í™” ë°©ì•ˆ ì¶”ê°€ |
| 2026-01-19 | 3.0 | Q3: ìµœì¢… ì•„í‚¤í…ì²˜ ê²°ì • - Option B + Claude êµì°¨ê²€ì¦ + HITL ìˆœì„œ ë³€ê²½ |
| 2026-01-19 | 3.1 | Q4: Mathpix í˜¸ì¶œ ìœ„ì¹˜ ë¶„ì„ - Stage B `_run_stage_b()` (pipeline.py:915-998) |

---

## Q4: Mathpix í˜¸ì¶œ ìœ„ì¹˜ (2026-01-19)

### í˜„ì¬ Mathpix í˜¸ì¶œ êµ¬ì¡°

**Stage B (TEXT_PARSE)** ì—ì„œ Mathpix APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

| êµ¬ì„± ìš”ì†Œ | ìœ„ì¹˜ | ì—­í•  |
|-----------|------|------|
| `MathpixClient` | `clients/mathpix.py` | Mathpix API ë˜í¼ |
| `_run_stage_b()` | `pipeline.py:915-998` | Stage B ì‹¤í–‰ ë©”ì„œë“œ |
| `MathpixConfig` | `config.py` | API í‚¤, ì„¤ì • ê´€ë¦¬ |

### í•µì‹¬ ì½”ë“œ (pipeline.py)

```python
# Line 944-980
async def _run_stage_b(self, ingestion_spec, result) -> Optional[TextSpec]:
    """Run Stage B: Text Parse using Mathpix API."""

    # Initialize Mathpix client if not exists
    if not hasattr(self, '_mathpix_client'):
        if self.mathpix_config is None:
            # FAIL-FAST: Stage B requires valid Mathpix credentials
            error_msg = "Mathpix config not provided..."
            return None

        self._mathpix_client = MathpixClient(config=self.mathpix_config)

    # Call Mathpix API
    async with self._mathpix_client:
        text_spec = await self._mathpix_client.process_image(
            image_bytes,
            image_id=ingestion_spec.image_id,
        )
```

### V3 ë³€ê²½ ê³„íš

V3 ì•„í‚¤í…ì²˜ì—ì„œ ì´ ë¶€ë¶„ì´ ë‹¤ìŒê³¼ ê°™ì´ ë³€ê²½ë©ë‹ˆë‹¤:

| í˜„ì¬ (V2) | ë³€ê²½ í›„ (V3) |
|-----------|-------------|
| `MathpixClient` | `GeminiVisionClient` |
| `MathpixConfig` | `GeminiConfig` |
| `clients/mathpix.py` | `clients/gemini.py` (ê¸°ì¡´ `vision/gemini_client.py` ì´ë™) |
| Mathpix API í˜¸ì¶œ | Gemini 3.0 Pro API í˜¸ì¶œ |

### ë³€ê²½ ì˜í–¥ ë²”ìœ„

```
cow/src/mathpix_pipeline/
â”œâ”€â”€ clients/
â”‚   â”œâ”€â”€ mathpix.py          # âŒ ì œê±°
â”‚   â””â”€â”€ gemini.py           # âœ¨ ì‹ ê·œ (Stage Bìš©)
â”œâ”€â”€ vision/
â”‚   â”œâ”€â”€ gemini_client.py    # âœï¸ Stage Bë¡œ ì´ë™ ë˜ëŠ” í†µí•©
â”‚   â””â”€â”€ cross_verifier.py   # âœ¨ ì‹ ê·œ (Stage C - Claude Vision)
â”œâ”€â”€ pipeline.py
â”‚   â””â”€â”€ _run_stage_b()      # âœï¸ Gemini í˜¸ì¶œë¡œ ë³€ê²½
â”œâ”€â”€ config.py
â”‚   â””â”€â”€ MathpixConfig       # âŒ ì œê±°, GeminiConfigë¡œ ëŒ€ì²´
â””â”€â”€ schemas/
    â””â”€â”€ text_parse.py       # âœï¸ TextSpec í•„ë“œ ì¡°ì • (í•„ìš”ì‹œ)
```

---

## Q3: ìµœì¢… ì•„í‚¤í…ì²˜ ê²°ì • (2026-01-19)

### ì‚¬ìš©ì ê²°ì • ì‚¬í•­

1. **Option B ì„ íƒ:** Gemini 3.0 Pro ë‹¨ë… (Mathpix ì œê±°)
2. **Claude Max í™œìš©:** Claude Visionìœ¼ë¡œ êµì°¨ê²€ì¦ (ì¶”ê°€ ë¹„ìš© ì—†ìŒ)
3. **HITL ìœ„ì¹˜ ë³€ê²½:** Stage E (Semantic Graph) ì§í›„ì— Human Review
4. **Regeneration ì´ë™:** Human Review í›„ë¡œ ë¯¸ë£¸

### ìƒˆë¡œìš´ íŒŒì´í”„ë¼ì¸ ìƒì„¸

```
Stage A: INGESTION
    â”‚   - ì´ë¯¸ì§€ ë¡œë“œ, ê²€ì¦, ì „ì²˜ë¦¬
    â”‚   - (ê¸°ì¡´ ìœ ì§€)
    â–¼
Stage B: VISION PARSE (Gemini 3.0 Pro)
    â”‚   - ìˆ˜ì‹ OCR + ë‹¤ì´ì–´ê·¸ë¨ í•´ì„ í†µí•©
    â”‚   - Output: VisionSpec (latex, elements, confidence)
    â–¼
Stage C: CROSS-VERIFY (Claude Vision) â˜…NEW
    â”‚   - Gemini ê²°ê³¼ì™€ Claude ê²°ê³¼ ë¹„êµ
    â”‚   - ë¶ˆì¼ì¹˜ ì‹œ confidence í•˜ë½
    â”‚   - Output: CrossVerifyReport
    â–¼
Stage D: ALIGNMENT
    â”‚   - Textâ†”Vision ì •ë ¬
    â”‚   - (ê¸°ì¡´ ë¡œì§ ìœ ì§€, ì…ë ¥ë§Œ ë³€ê²½)
    â–¼
Stage E: SEMANTIC GRAPH
    â”‚   - ì˜ë¯¸ ê·¸ë˜í”„ êµ¬ì¶•
    â”‚   - (ê¸°ì¡´ ìœ ì§€)
    â–¼
Stage G: HUMAN REVIEW â˜…MOVED (ê¸°ì¡´ Stage F ìœ„ì¹˜)
    â”‚   - Confidence < threshold í•­ëª© ë¦¬ë·°
    â”‚   - ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘
    â”‚   - Output: ReviewedGraph
    â–¼
Stage F: REGENERATION â˜…MOVED (ê¸°ì¡´ Stage G ìœ„ì¹˜)
    â”‚   - ê²€í† ëœ ê·¸ë˜í”„ ê¸°ë°˜ ì¬ìƒì„±
    â”‚   - LaTeX/SVG ì¶œë ¥
    â–¼
Stage H: EXPORT
    â”‚   - ìµœì¢… ì¶œë ¥ (JSON, PDF, DOCX, LaTeX)
    â””â”€â”€ END
```

### Cross-Verify (Stage C) ìƒì„¸ ì„¤ê³„

```python
class CrossVerifyResult:
    gemini_output: VisionSpec
    claude_output: VisionSpec
    agreement_score: float  # 0.0-1.0
    discrepancies: List[Discrepancy]
    final_output: VisionSpec  # ë³‘í•©ëœ ìµœì¢… ê²°ê³¼

class Discrepancy:
    element_id: str
    gemini_interpretation: str
    claude_interpretation: str
    resolution: str  # "use_gemini" | "use_claude" | "flag_for_review"
```

**êµì°¨ê²€ì¦ ë¡œì§:**
1. Gemini 3.0 Proë¡œ ì´ë¯¸ì§€ ë¶„ì„
2. Claude Visionìœ¼ë¡œ ë™ì¼ ì´ë¯¸ì§€ ë¶„ì„
3. ê²°ê³¼ ë¹„êµ:
   - ì¼ì¹˜ â†’ confidence ìœ ì§€
   - ë¶ˆì¼ì¹˜ â†’ confidence í•˜ë½ + discrepancy ê¸°ë¡
4. ë³‘í•© ì „ëµìœ¼ë¡œ ìµœì¢… ê²°ê³¼ ìƒì„±

### Human-in-the-Loop (Stage G) ìƒì„¸ ì„¤ê³„

```python
class HumanReviewInput:
    semantic_graph: SemanticGraph
    cross_verify_report: CrossVerifyReport
    flagged_items: List[FlaggedItem]  # confidence < threshold

class HumanReviewOutput:
    approved_nodes: List[str]
    rejected_nodes: List[str]
    corrected_nodes: Dict[str, Correction]
    reviewer_notes: str
```

**HITL ì›Œí¬í”Œë¡œìš°:**
1. Stage E ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ Stage G ì§„ì…
2. Confidence < threshold í•­ëª© ì‚¬ìš©ìì—ê²Œ í‘œì‹œ
3. ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘ (ìŠ¹ì¸/ê±°ë¶€/ìˆ˜ì •)
4. ìˆ˜ì •ëœ ê·¸ë˜í”„ë¡œ Stage F (Regeneration) ì§„í–‰

### ì œê±°/ìˆ˜ì •í•  íŒŒì¼

```
cow/src/mathpix_pipeline/
â”œâ”€â”€ clients/
â”‚   â””â”€â”€ mathpix.py              # âŒ ì œê±° (Geminië¡œ ëŒ€ì²´)
â”œâ”€â”€ vision/
â”‚   â”œâ”€â”€ yolo_detector.py        # âŒ ì œê±°
â”‚   â”œâ”€â”€ hybrid_merger.py        # âŒ ì œê±°
â”‚   â”œâ”€â”€ gemini_client.py        # âœï¸ ìˆ˜ì • (Gemini 3.0 Proë¡œ ì—…ê·¸ë ˆì´ë“œ)
â”‚   â””â”€â”€ cross_verifier.py       # âœ¨ ì‹ ê·œ (Claude Vision êµì°¨ê²€ì¦)
â”œâ”€â”€ pipeline.py                 # âœï¸ ìˆ˜ì • (Stage ìˆœì„œ ë³€ê²½, ìƒˆ Stage C ì¶”ê°€)
â””â”€â”€ config.py                   # âœï¸ ìˆ˜ì • (Mathpix ì„¤ì • ì œê±°, Claude ì„¤ì • ì¶”ê°€)


# cow/ Pipeline V3 구현 계획

> **Version:** 3.2 | **Status:** DRAFT | **Date:** 2026-01-19
> **Goal:** Mathpix + Gemini 3.0 Pro + Claude Vision 멀티-스테이지 파이프라인
> **Auto-Compact Safe:** This file persists across context compaction

---

## 1. 현재 상태 분석

### 1.1 기존 아키텍처 (8-Stage)

```
A. INGESTION → B. TEXT PARSE → C. VISION PARSE → D. ALIGNMENT
                 (Mathpix)      (YOLO+Gemini)
      ↓                                              ↓
H. EXPORT ← G. HUMAN REVIEW ← F. REGENERATION ← E. SEMANTIC GRAPH
```

### 1.2 핵심 변경 결정 (Q&A 기반)

| # | 질문 | 결정 |
|---|------|------|
| Q1 | Stage C는 왜 필요? | YOLO 제거 → Gemini 3.0 Pro로 다이어그램 해석 |
| Q2 | 고도화 방향? | Multi-Stage: Mathpix(유지) + Gemini + Claude |
| Q3 | HITL 위치? | Stage E 직후 (기존 F→G를 G→F로 순서 변경) |
| Q4 | Mathpix 호출 위치? | Stage B `_run_stage_b()` (pipeline.py:915-998) |
| **Q5** | Mathpix 대체? | **❌ 대체하지 않음. Mathpix 유지, Gemini는 별도 Stage** |

---

## 2. 목표 아키텍처 (V3.2)

### 2.1 새로운 파이프라인 흐름 (9-Stage)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    V3.2 PIPELINE ARCHITECTURE (9-Stage)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  A. INGESTION → B. TEXT PARSE → C. VISION PARSE → D. CROSS-VERIFY          │
│                  (Mathpix OCR)   (Gemini 3.0 Pro)  (Claude Vision)          │
│                     [수식]        [다이어그램]      [교차검증]              │
│                                                                             │
│                              ↓                                              │
│                                                                             │
│  I. EXPORT ← H. REGENERATION ← G. HUMAN REVIEW ← F. SEMANTIC ← E. ALIGNMENT│
│                                 (HITL)            GRAPH                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Stage별 역할 (V3.2)

| Stage | 이름 | 처리 엔진 | 역할 |
|-------|------|----------|------|
| **A** | INGESTION | - | 이미지 로드, 전처리 |
| **B** | TEXT_PARSE | **Mathpix** | 수식 OCR (LaTeX 추출) |
| **C** | VISION_PARSE | **Gemini 3.0 Pro** | 다이어그램/그래프 해석 |
| **D** | CROSS_VERIFY | **Claude Vision** | B+C 결과 교차검증 |
| **E** | ALIGNMENT | - | Text ↔ Vision 정렬 |
| **F** | SEMANTIC_GRAPH | - | 의미 그래프 구축 |
| **G** | HUMAN_REVIEW | HITL | 저신뢰 항목 검토 |
| **H** | REGENERATION | - | 검토 후 재생성 |
| **I** | EXPORT | - | 최종 출력 (JSON, PDF, DOCX) |

### 2.3 Stage 순서 변경 상세

```
V2 (8-Stage): A → B → C → D → E → F → G → H
V3.2 (9-Stage): A → B → C → D → E → F → G → H → I
                         ↑       ↑   ↑
                    (신규 D)  (E→F) (F→G→H 순서변경)
```

| 변경 | 기존 | 신규 | 이유 |
|------|------|------|------|
| Stage D 추가 | (없음) | CROSS_VERIFY | Claude Vision 교차검증 |
| Stage E | ALIGNMENT | ALIGNMENT | D(기존) → E(신규) |
| Stage F | SEMANTIC_GRAPH | SEMANTIC_GRAPH | E(기존) → F(신규) |
| Stage G | REGENERATION | HUMAN_REVIEW | F↔G 순서 변경 (HITL 먼저) |
| Stage H | HUMAN_REVIEW | REGENERATION | HITL 후 재생성 |
| Stage I | EXPORT | EXPORT | G(기존) → I(신규) |

### 2.4 비용 구조

| Component | Cost/Image | 비고 |
|-----------|-----------|------|
| Mathpix | ~$0.04 | 수식 OCR 전문 |
| Gemini 3.0 Pro | ~$0.01 | 다이어그램 해석 |
| Claude Vision | $0.00 | Claude Max 구독 (무제한) |
| **Total** | **~$0.05** | 품질 최대화 (3중 검증) |

---

## 3. 파일 변경 계획

### 3.1 제거할 파일

```
cow/src/mathpix_pipeline/
└── vision/
    ├── yolo_detector.py        # YOLO 제거 → Gemini가 대체
    └── hybrid_merger.py        # 불필요
```

### 3.2 수정할 파일

```
cow/src/mathpix_pipeline/
├── clients/
│   └── mathpix.py              # 유지 (Stage B)
├── vision/
│   └── gemini_client.py        # → Gemini 3.0 Pro 업그레이드 (Stage C)
├── pipeline.py                 # Stage 추가 (D), 순서 변경 (G↔H)
├── config.py                   # Claude 설정 추가
└── schemas/
    └── common.py               # PipelineStage enum에 CROSS_VERIFY 추가
```

### 3.3 신규 생성할 파일

```
cow/src/mathpix_pipeline/
└── vision/
    └── cross_verifier.py       # Claude Vision 교차검증 (Stage D)
```

---

## 4. 구현 Phase

### Phase 1: Stage C 업그레이드 (YOLO → Gemini 3.0 Pro)

**영향 범위:**
- `vision/yolo_detector.py` → 제거
- `vision/hybrid_merger.py` → 제거
- `vision/gemini_client.py` → Gemini 3.0 Pro 업그레이드

**산출물:**
- [ ] `GeminiVisionClient` 업그레이드 (3.0 Pro)
- [ ] `GeminiConfig` 업데이트
- [ ] Stage C 테스트 케이스

### Phase 2: Stage D 추가 (Claude Vision 교차검증)

**영향 범위:**
- `vision/cross_verifier.py` → 신규 생성
- `schemas/common.py` → `PipelineStage.CROSS_VERIFY` 추가
- `pipeline.py` → `_run_stage_d()` 추가
- `config.py` → `ClaudeConfig` 추가

**산출물:**
- [ ] `CrossVerifier` 클래스
- [ ] `CrossVerifyResult` 스키마
- [ ] `ClaudeConfig` Pydantic 모델
- [ ] Stage D 테스트 케이스

### Phase 3: Stage 순서 재배열 (9-Stage)

**영향 범위:**
- `pipeline.py:process()` → Stage 실행 순서 변경
- Stage E~I 재넘버링
- HITL을 Regeneration 앞으로 이동

**산출물:**
- [ ] 9-Stage 파이프라인
- [ ] 통합 테스트 케이스

### Phase 4: Config/Schema 정리

**영향 범위:**
- `schemas/common.py` → PipelineStage enum 업데이트
- `config.py` → Claude 설정 추가
- `__init__.py` → export 정리

**산출물:**
- [ ] 업데이트된 PipelineStage enum
- [ ] 정리된 config.py
- [ ] 마이그레이션 가이드

---

## 5. 상세 설계

### 5.1 Stage B: MathpixClient (유지)

```python
# clients/mathpix.py (기존 유지)
class MathpixClient:
    """Mathpix API client for Stage B - 수식 OCR."""

    async def process_image(
        self,
        image_bytes: bytes,
        image_id: str,
    ) -> TextSpec:
        """Process image with Mathpix API.

        Returns:
            TextSpec: latex, line_segments, confidence
        """
        # 기존 로직 유지
        pass
```

### 5.2 Stage C: GeminiVisionClient (업그레이드)

```python
# vision/gemini_client.py (업그레이드)
class GeminiVisionClient:
    """Gemini 3.0 Pro Vision client for Stage C - 다이어그램 해석."""

    def __init__(self, config: GeminiConfig):
        self.config = config
        self.model = "gemini-3.0-pro"  # 버전 업그레이드

    async def process_image(
        self,
        image_bytes: bytes,
        image_id: str,
    ) -> VisionSpec:
        """Process image with Gemini 3.0 Pro.

        Returns:
            VisionSpec: elements, diagrams, graphs, confidence
        """
        # TODO(human): Implement Gemini 3.0 Pro API call
        pass
```

### 5.3 Stage D: CrossVerifier (신규)

```python
# vision/cross_verifier.py (신규)
class CrossVerifier:
    """Claude Vision cross-verification for Stage D."""

    async def verify(
        self,
        image_bytes: bytes,
        mathpix_result: TextSpec,    # Stage B 결과
        gemini_result: VisionSpec,   # Stage C 결과
    ) -> CrossVerifyResult:
        """Cross-verify Stage B + C results with Claude Vision.

        Returns:
            CrossVerifyResult: agreement_score, discrepancies, merged_output
        """
        # TODO(human): Implement Claude Vision call + 3-way comparison
        pass

class CrossVerifyResult(MathpixBaseModel):
    mathpix_output: TextSpec       # Stage B
    gemini_output: VisionSpec      # Stage C
    claude_output: VisionSpec      # Claude 독립 분석
    agreement_score: float         # 0.0-1.0 (3자 일치도)
    discrepancies: List[Discrepancy]
    merged_output: MergedSpec      # 최종 병합 결과
```

### 5.4 Stage G: Human Review (HITL)

```python
# human_review/ 기존 모듈 활용
class HumanReviewInput:
    semantic_graph: SemanticGraph
    cross_verify_report: CrossVerifyResult
    flagged_items: List[FlaggedItem]  # confidence < threshold

class HumanReviewOutput:
    approved_nodes: List[str]
    rejected_nodes: List[str]
    corrected_nodes: Dict[str, Correction]
```

---

## 6. 리스크 및 완화 전략

| Risk | Impact | Mitigation |
|------|--------|------------|
| Gemini 수식 OCR 정확도 | High | Claude Vision 교차검증으로 보완 |
| Claude Max API 제한 | Medium | Rate limiting 구현 |
| Stage 순서 변경 부작용 | Medium | 통합 테스트 강화 |
| 기존 테스트 실패 | Low | 테스트 케이스 업데이트 |

---

## 7. 질문 로그 (Q&A History)

| # | Date | Question | Answer |
|---|------|----------|--------|
| Q1 | 2026-01-19 | Stage C는 왜 필요? | YOLO: 도형 bbox, Gemini: 해석 |
| Q2 | 2026-01-19 | 고도화 방향? | Multi-Stage: Mathpix + Gemini + Claude |
| Q3 | 2026-01-19 | HITL 위치? | Stage F 직후 → Stage G로 이동 |
| Q4 | 2026-01-19 | Mathpix 호출 위치? | Stage B `_run_stage_b()` (pipeline.py:915-998) |
| **Q5** | 2026-01-19 | Mathpix 대체? | **❌ 대체 안함. Mathpix 유지, Gemini는 Stage C** |

---

## 8. 다음 단계

구현 착수 전 확인이 필요한 사항:

1. **Gemini 3.0 Pro API 접근** - API 키 발급 완료?
2. **Claude Max API 엔드포인트** - Vision API 접근 방법 확인
3. **기존 테스트 보존** - 마이그레이션 중 테스트 유지 전략
4. **롤백 계획** - V2 → V3 실패 시 복구 방법

---

## Change Log

| Date | Version | Change |
|------|---------|--------|
| 2026-01-19 | 1.0 | Initial Q&A (Stage C 목적) |
| 2026-01-19 | 2.0 | Gemini 비용 분석, 고도화 방안 추가 |
| 2026-01-19 | 3.0 | 최종 아키텍처 결정 (Option B + Claude + HITL) |
| 2026-01-19 | 3.1 | 전체 재정리 - 구현 계획 초안 완성 |
| 2026-01-19 | 3.2 | Q5: Mathpix 유지 결정 - 9-Stage 아키텍처로 변경 |

---

**Protocol Compliance:** orchestrator_protocol_v4.1.yaml

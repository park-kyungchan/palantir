# cow/ Pipeline Enhancement Plan V3

> **Version:** 3.0 | **Status:** ARCHITECTURE DECIDED | **Date:** 2026-01-19
> **Goal:** Gemini 3.0 Pro + Claude Vision 교차검증 + Human-in-the-Loop 파이프라인
> **Last Updated:** 2026-01-19 (Q3: 최종 아키텍처 결정)

---

## Current Architecture (8-Stage)

```
A. INGESTION    → B. TEXT PARSE   → C. VISION PARSE  → D. ALIGNMENT
      ↓                (Mathpix)       (YOLO+Gemini)        ↓
H. EXPORT      ← G. HUMAN REVIEW  ← F. REGENERATION  ← E. SEMANTIC GRAPH
```

## 🎯 Target Architecture V3 (DECIDED)

```
┌─────────────────────────────────────────────────────────────────────┐
│                    NEW PIPELINE ARCHITECTURE                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  A. INGESTION → B. VISION PARSE → C. CROSS-VERIFY → D. ALIGNMENT   │
│                  (Gemini 3.0 Pro)  (Claude Vision)                  │
│                                                                     │
│                         ↓                                           │
│                                                                     │
│  H. EXPORT ← G. REGENERATION ← F. HUMAN REVIEW ← E. SEMANTIC GRAPH │
│                                 (Human-in-the-Loop)                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 핵심 변경사항

| Stage | Before | After | 변경 이유 |
|-------|--------|-------|----------|
| **B** | Mathpix OCR | **Gemini 3.0 Pro** | 단일 API로 수식+다이어그램 통합 처리 |
| **C** | YOLO+Gemini | **Claude Vision** | 교차검증으로 품질 향상 (Claude Max 활용) |
| **F** | Regeneration (E 직후) | **Human Review로 이동** | HITL 후 재생성이 더 효율적 |
| **G** | Human Review (F 직후) | **E 직후로 이동** | 그래프 생성 후 즉시 검토 |

### Stage 순서 변경

```
기존: A → B → C → D → E → F → G → H
변경: A → B → C → D → E → G → F → H
                      ↑   ↑
                      │   └── Human Review (Stage E 직후)
                      └────── Semantic Graph
```

### 비용 구조

| Component | Cost/Image | 비고 |
|-----------|-----------|------|
| Gemini 3.0 Pro | ~$0.01 | 주 처리 |
| Claude Vision | $0.00 | Claude Max 구독 (무료) |
| **Total** | **~$0.01** | Mathpix 제거로 비용 절감 |

### Mathpix 제거 결정
- ✅ Gemini 3.0 Pro가 수식 OCR도 처리 가능
- ✅ Claude Vision으로 교차검증하여 품질 보완
- ✅ API 단일화로 복잡도 감소

---

## Q&A Log (매 프롬프트 업데이트)

### Q1: Stage C는 왜 필요하지? (2026-01-19)

**현재 Stage C 구성:**
| Component | Purpose | File |
|-----------|---------|------|
| **YOLO Detector** | 다이어그램/도형 박스 감지 | `vision/yolo_detector.py` |
| **Gemini Vision** | 감지된 영역 해석 | `vision/gemini_client.py` |
| **Hybrid Merger** | YOLO + Gemini 결과 병합 | `vision/hybrid_merger.py` |
| **Detection Layer** | 좌표 기반 감지 | `vision/detection_layer.py` |
| **Interpretation Layer** | 의미 해석 | `vision/interpretation_layer.py` |

**Stage C가 해결하는 문제:**
1. Mathpix는 **텍스트/수식 OCR**에 특화 → 다이어그램/그래프 해석 불가
2. YOLO로 **시각적 요소 위치** 감지 → Gemini로 **의미 해석**
3. 수학 문제에 그림이 포함된 경우 필요

**Claude Vision으로 대체 가능한가?**

| 기능 | YOLO+Gemini | Claude Vision | 대체 가능? |
|------|-------------|---------------|-----------|
| 도형 감지 | YOLO bbox | 가능 | ✅ |
| 그래프 해석 | Gemini | 가능 | ✅ |
| 수식 OCR | ❌ | 가능 (정확도 낮음) | ⚠️ |
| 좌표 반환 | 정확한 bbox | 대략적 위치 | ⚠️ |

**결론:**
- 순수 **다이어그램 해석** 목적이면 → Claude Vision으로 대체 가능
- **정확한 좌표 기반 처리** 필요하면 → YOLO 유지 권장

---

## Decision Points (사용자 확인 필요)

### DP1: Stage C 처리 방식
- [ ] **Option A:** Claude Vision으로 완전 대체 (YOLO+Gemini 제거)
- [ ] **Option B:** Claude Vision만 사용 (YOLO 제거, Gemini→Claude)
- [ ] **Option C:** Stage C 전체 제거 (Mathpix OCR만 사용)

### DP2: 후속 Stage 처리
- [ ] Stage D-G 제거 (정렬/그래프/재생성/리뷰 불필요)
- [ ] Stage D만 유지 (Text↔Vision 정렬은 필요)
- [ ] 다른 조합?

---

## Files to Modify/Remove (예정)

### 제거 후보
```
cow/src/mathpix_pipeline/
├── vision/
│   ├── yolo_detector.py       # DP1에 따라 결정
│   ├── gemini_client.py       # DP1에 따라 결정
│   ├── hybrid_merger.py       # 제거 예정
│   ├── detection_layer.py     # DP1에 따라 결정
│   └── interpretation_layer.py # Claude Vision으로 대체
├── alignment/                 # DP2에 따라 결정
├── semantic_graph/            # 제거 예정
├── regeneration/              # 제거 예정
└── human_review/              # 제거 예정
```

### 유지 확정
```
cow/src/mathpix_pipeline/
├── ingestion/                 # Stage A - 유지
├── clients/mathpix.py         # Stage B - 유지
├── export/                    # Stage H - 유지
├── config.py                  # 경량화 필요
├── pipeline.py                # 리팩토링 필요
└── schemas/                   # 경량화 필요
```

---

## Next Questions (다음 프롬프트에서 답변 필요)

1. **DP1 결정:** Claude Vision으로 Stage C를 어떻게 대체할지?
2. **출력 형식:** 최종 출력은 무엇이 필요한지? (JSON? LaTeX? 둘 다?)
3. **Stage D-G:** 정렬/그래프/리뷰 기능이 필요한지?

---

---

## Q2: Gemini 3.0 Pro API 비용 분석 (2026-01-19)

### Gemini 3.0 Pro 가격표 (2026년 1월 기준)

| Context Length | Input (1M tokens) | Output (1M tokens) |
|----------------|-------------------|-------------------|
| ≤ 200K tokens | **$2.00** | **$12.00** |
| > 200K tokens | $4.00 | $18.00 |

### 수학 문제 이미지 처리 예상 비용

| 시나리오 | Input Tokens | Output Tokens | 예상 비용 |
|----------|--------------|---------------|----------|
| 이미지 1장 (단순 수식) | ~1,000 | ~500 | **$0.008** |
| 이미지 1장 (복잡한 다이어그램) | ~3,000 | ~1,500 | **$0.024** |
| 100장 배치 처리 | ~300,000 | ~150,000 | **$2.40** |
| 1,000장 배치 처리 | ~3M | ~1.5M | **$24.00** |

### 경쟁사 비교 (2026년 1월)

| Model | Input (1M) | Output (1M) | 특징 |
|-------|-----------|-------------|------|
| **Gemini 3.0 Pro** | $2.00 | $12.00 | 1M context, Vision 강점 |
| GPT-5 | $1.25 | $10.00 | 가장 저렴 |
| Claude Opus 4.5 | $5.00 | $25.00 | 추론 품질 최고 |
| Claude Sonnet 4 | $3.00 | $15.00 | 균형 |

### 비용 최적화 전략

1. **Caching 활용** - 반복 프롬프트 캐싱으로 50% 절감 가능
2. **Batch API** - 대량 처리 시 20-30% 할인
3. **Context 최적화** - 200K 이하 유지로 2배 절감

---

## Q2-2: 고도화 방안

### Option A: Multi-Model Ensemble (권장)

```
이미지 → [Mathpix OCR] ──┐
                        ├──→ [Fusion Layer] → 최종 결과
         [Gemini Vision]──┘
```

**장점:**
- Mathpix의 수식 OCR 정확도 + Gemini의 다이어그램 해석력
- 각 모델의 강점 활용
- 결과 교차 검증으로 신뢰도 향상

### Option B: Gemini 3.0 Pro 단독 (비용 효율)

```
이미지 → [Gemini 3.0 Pro] → LaTeX + 해석 결과
         (Vision + OCR 통합)
```

**장점:**
- API 호출 1회로 비용 절감
- 1M context로 여러 이미지 배치 처리 가능
- 단순한 아키텍처

### Option C: Hierarchical Processing (최고 품질)

```
이미지 → [Gemini Flash] → 초기 분류
              ↓
         [복잡도 판단]
              ↓
    ┌─────────┼─────────┐
 단순 수식   복잡 다이어그램  혼합
    ↓           ↓          ↓
 Mathpix    Gemini Pro   둘 다
```

**장점:**
- 비용 최적화 (단순 문제는 저렴한 모델 사용)
- 복잡한 문제에만 고급 모델 투입
- 확장성 좋음

### Option D: Fine-tuned Vision Model (장기)

```
[자체 학습 데이터] → Fine-tuned Gemini → 도메인 특화
```

**장점:**
- 수학 문제 특화 모델
- 장기적으로 비용 절감
- 독점적 경쟁력

---

## 추가 고도화 기능 제안

### 1. Confidence Scoring 강화
```python
class EnhancedVisionResult:
    latex: str
    confidence: float  # 0.0-1.0
    alternative_interpretations: List[str]
    reasoning: str  # 왜 이렇게 해석했는지
```

### 2. Interactive Correction Loop
```
사용자 피드백 → 모델 재해석 → 개선된 결과
```

### 3. Multi-Modal Grounding
```
이미지 + 텍스트 힌트 → 더 정확한 해석
```

### 4. Streaming Output
```
실시간으로 부분 결과 반환 → UX 개선
```

---

## Decision Points (업데이트)

### DP1: 고도화 방향 (New)
- [ ] **Option A:** Multi-Model Ensemble
- [ ] **Option B:** Gemini 3.0 Pro 단독
- [ ] **Option C:** Hierarchical Processing
- [ ] **Option D:** Fine-tuned 장기 계획

### DP2: Stage C 처리 (Updated)
- [ ] Gemini 3.0 Pro로 업그레이드 (현재 Gemini 버전 확인 필요)
- [ ] YOLO 유지 + Gemini 3.0 Pro 조합
- [ ] YOLO 제거, Gemini 단독

---

## Change Log

| Date | Version | Change |
|------|---------|--------|
| 2026-01-19 | 1.0 | Initial plan, Q1 answered |
| 2026-01-19 | 2.0 | 경량화→고도화 전환, Q2 Gemini 비용 분석, 고도화 방안 추가 |
| 2026-01-19 | 3.0 | Q3: 최종 아키텍처 결정 - Option B + Claude 교차검증 + HITL 순서 변경 |

---

## Q3: 최종 아키텍처 결정 (2026-01-19)

### 사용자 결정 사항

1. **Option B 선택:** Gemini 3.0 Pro 단독 (Mathpix 제거)
2. **Claude Max 활용:** Claude Vision으로 교차검증 (추가 비용 없음)
3. **HITL 위치 변경:** Stage E (Semantic Graph) 직후에 Human Review
4. **Regeneration 이동:** Human Review 후로 미룸

### 새로운 파이프라인 상세

```
Stage A: INGESTION
    │   - 이미지 로드, 검증, 전처리
    │   - (기존 유지)
    ▼
Stage B: VISION PARSE (Gemini 3.0 Pro)
    │   - 수식 OCR + 다이어그램 해석 통합
    │   - Output: VisionSpec (latex, elements, confidence)
    ▼
Stage C: CROSS-VERIFY (Claude Vision) ★NEW
    │   - Gemini 결과와 Claude 결과 비교
    │   - 불일치 시 confidence 하락
    │   - Output: CrossVerifyReport
    ▼
Stage D: ALIGNMENT
    │   - Text↔Vision 정렬
    │   - (기존 로직 유지, 입력만 변경)
    ▼
Stage E: SEMANTIC GRAPH
    │   - 의미 그래프 구축
    │   - (기존 유지)
    ▼
Stage G: HUMAN REVIEW ★MOVED (기존 Stage F 위치)
    │   - Confidence < threshold 항목 리뷰
    │   - 사용자 피드백 수집
    │   - Output: ReviewedGraph
    ▼
Stage F: REGENERATION ★MOVED (기존 Stage G 위치)
    │   - 검토된 그래프 기반 재생성
    │   - LaTeX/SVG 출력
    ▼
Stage H: EXPORT
    │   - 최종 출력 (JSON, PDF, DOCX, LaTeX)
    └── END
```

### Cross-Verify (Stage C) 상세 설계

```python
class CrossVerifyResult:
    gemini_output: VisionSpec
    claude_output: VisionSpec
    agreement_score: float  # 0.0-1.0
    discrepancies: List[Discrepancy]
    final_output: VisionSpec  # 병합된 최종 결과

class Discrepancy:
    element_id: str
    gemini_interpretation: str
    claude_interpretation: str
    resolution: str  # "use_gemini" | "use_claude" | "flag_for_review"
```

**교차검증 로직:**
1. Gemini 3.0 Pro로 이미지 분석
2. Claude Vision으로 동일 이미지 분석
3. 결과 비교:
   - 일치 → confidence 유지
   - 불일치 → confidence 하락 + discrepancy 기록
4. 병합 전략으로 최종 결과 생성

### Human-in-the-Loop (Stage G) 상세 설계

```python
class HumanReviewInput:
    semantic_graph: SemanticGraph
    cross_verify_report: CrossVerifyReport
    flagged_items: List[FlaggedItem]  # confidence < threshold

class HumanReviewOutput:
    approved_nodes: List[str]
    rejected_nodes: List[str]
    corrected_nodes: Dict[str, Correction]
    reviewer_notes: str
```

**HITL 워크플로우:**
1. Stage E 완료 후 자동으로 Stage G 진입
2. Confidence < threshold 항목 사용자에게 표시
3. 사용자 피드백 수집 (승인/거부/수정)
4. 수정된 그래프로 Stage F (Regeneration) 진행

### 제거/수정할 파일

```
cow/src/mathpix_pipeline/
├── clients/
│   └── mathpix.py              # ❌ 제거 (Gemini로 대체)
├── vision/
│   ├── yolo_detector.py        # ❌ 제거
│   ├── hybrid_merger.py        # ❌ 제거
│   ├── gemini_client.py        # ✏️ 수정 (Gemini 3.0 Pro로 업그레이드)
│   └── cross_verifier.py       # ✨ 신규 (Claude Vision 교차검증)
├── pipeline.py                 # ✏️ 수정 (Stage 순서 변경, 새 Stage C 추가)
└── config.py                   # ✏️ 수정 (Mathpix 설정 제거, Claude 설정 추가)


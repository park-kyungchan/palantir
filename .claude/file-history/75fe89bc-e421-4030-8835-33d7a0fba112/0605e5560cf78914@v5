# cow/ Pipeline V3 구현 계획

> **Version:** 3.1 | **Status:** DRAFT | **Date:** 2026-01-19
> **Goal:** Gemini 3.0 Pro + Claude Vision 교차검증 파이프라인
> **Auto-Compact Safe:** This file persists across context compaction

---

## 1. 현재 상태 분석

### 1.1 기존 아키텍처 (8-Stage)

```
A. INGESTION → B. TEXT PARSE → C. VISION PARSE → D. ALIGNMENT
                 (Mathpix)      (YOLO+Gemini)
      ↓                                              ↓
H. EXPORT ← G. HUMAN REVIEW ← F. REGENERATION ← E. SEMANTIC GRAPH
```

### 1.2 핵심 변경 결정 (Q&A 기반)

| # | 질문 | 결정 |
|---|------|------|
| Q1 | Stage C는 왜 필요? | YOLO+Gemini → Claude Vision으로 교차검증 |
| Q2 | 고도화 방향? | Option B: Gemini 3.0 Pro 단독 (Mathpix 제거) |
| Q3 | HITL 위치? | Stage E 직후 (기존 F→G를 G→F로 순서 변경) |
| Q4 | Mathpix 호출 위치? | Stage B `_run_stage_b()` (pipeline.py:915-998) |

---

## 2. 목표 아키텍처 (V3)

### 2.1 새로운 파이프라인 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                    V3 PIPELINE ARCHITECTURE                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  A. INGESTION → B. VISION PARSE → C. CROSS-VERIFY → D. ALIGNMENT   │
│                  (Gemini 3.0 Pro)  (Claude Vision)                  │
│                                                                     │
│                         ↓                                           │
│                                                                     │
│  H. EXPORT ← G. REGENERATION ← F. HUMAN REVIEW ← E. SEMANTIC GRAPH │
│                                 (HITL)                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 Stage별 변경 내역

| Stage | 기존 | V3 | 변경 이유 |
|-------|------|-----|----------|
| **A** | Ingestion | 유지 | 변경 없음 |
| **B** | Mathpix OCR | **Gemini 3.0 Pro** | 수식+다이어그램 통합 처리 |
| **C** | YOLO+Gemini | **Claude Vision** | 교차검증으로 품질 향상 |
| **D** | Alignment | 유지 | 입력 형식만 조정 |
| **E** | Semantic Graph | 유지 | 변경 없음 |
| **F** | Regeneration | **→ G로 이동** | HITL 후 재생성 |
| **G** | Human Review | **→ F로 이동** | 그래프 생성 후 즉시 검토 |
| **H** | Export | 유지 | 변경 없음 |

### 2.3 비용 구조

| Component | Cost/Image | 비고 |
|-----------|-----------|------|
| Gemini 3.0 Pro | ~$0.01 | Input $2/1M, Output $12/1M |
| Claude Vision | $0.00 | Claude Max 구독 (무제한) |
| **Total** | **~$0.01** | Mathpix ($0.04) 대비 75% 절감 |

---

## 3. 파일 변경 계획

### 3.1 제거할 파일

```
cow/src/mathpix_pipeline/
├── clients/
│   └── mathpix.py              # Stage B → Gemini로 대체
└── vision/
    ├── yolo_detector.py        # Stage C → Claude로 대체
    └── hybrid_merger.py        # 불필요
```

### 3.2 수정할 파일

```
cow/src/mathpix_pipeline/
├── vision/
│   └── gemini_client.py        # → Gemini 3.0 Pro 업그레이드 + Stage B로 이동
├── pipeline.py                 # Stage 순서 변경, 새 Stage C 추가
├── config.py                   # Mathpix 설정 제거, Claude 설정 추가
└── schemas/
    └── text_parse.py           # TextSpec → VisionSpec 통합 (필요시)
```

### 3.3 신규 생성할 파일

```
cow/src/mathpix_pipeline/
├── clients/
│   └── gemini.py               # Gemini 3.0 Pro 클라이언트 (Stage B)
└── vision/
    └── cross_verifier.py       # Claude Vision 교차검증 (Stage C)
```

---

## 4. 구현 Phase

### Phase 1: Stage B 교체 (Mathpix → Gemini)

**영향 범위:**
- `clients/mathpix.py` → 제거
- `clients/gemini.py` → 신규 생성
- `pipeline.py:_run_stage_b()` → Gemini 호출로 변경
- `config.py:MathpixConfig` → `GeminiConfig`로 교체

**산출물:**
- [ ] `GeminiVisionClient` 클래스
- [ ] `GeminiConfig` Pydantic 모델
- [ ] Stage B 테스트 케이스

### Phase 2: Stage C 교체 (YOLO+Gemini → Claude Vision)

**영향 범위:**
- `vision/yolo_detector.py` → 제거
- `vision/hybrid_merger.py` → 제거
- `vision/cross_verifier.py` → 신규 생성
- `pipeline.py:_run_stage_c()` → Claude 호출로 변경

**산출물:**
- [ ] `CrossVerifier` 클래스
- [ ] `CrossVerifyResult` 스키마
- [ ] Stage C 테스트 케이스

### Phase 3: Stage 순서 변경 (F↔G)

**영향 범위:**
- `pipeline.py:process()` → Stage 실행 순서 변경
- `pipeline.py:_run_stage_f()` → Human Review로 변경
- `pipeline.py:_run_stage_g()` → Regeneration으로 변경

**산출물:**
- [ ] 순서 변경된 파이프라인
- [ ] 통합 테스트 케이스

### Phase 4: Config/Schema 정리

**영향 범위:**
- `config.py` → Mathpix 관련 설정 제거
- `schemas/` → 불필요한 스키마 정리
- `__init__.py` → export 정리

**산출물:**
- [ ] 정리된 config.py
- [ ] 정리된 schemas/
- [ ] 마이그레이션 가이드

---

## 5. 상세 설계

### 5.1 Stage B: GeminiVisionClient

```python
# clients/gemini.py (신규)
class GeminiVisionClient:
    """Gemini 3.0 Pro Vision client for Stage B."""

    def __init__(self, config: GeminiConfig):
        self.config = config
        self.model = "gemini-3.0-pro"

    async def process_image(
        self,
        image_bytes: bytes,
        image_id: str,
    ) -> VisionSpec:
        """Process image with Gemini 3.0 Pro.

        Returns:
            VisionSpec: latex, elements, confidence, raw_response
        """
        # TODO(human): Implement Gemini API call
        pass
```

### 5.2 Stage C: CrossVerifier

```python
# vision/cross_verifier.py (신규)
class CrossVerifier:
    """Claude Vision cross-verification for Stage C."""

    async def verify(
        self,
        image_bytes: bytes,
        gemini_result: VisionSpec,
    ) -> CrossVerifyResult:
        """Cross-verify Gemini result with Claude Vision.

        Returns:
            CrossVerifyResult: agreement_score, discrepancies, final_output
        """
        # TODO(human): Implement Claude Vision call + comparison logic
        pass

class CrossVerifyResult(MathpixBaseModel):
    gemini_output: VisionSpec
    claude_output: VisionSpec
    agreement_score: float  # 0.0-1.0
    discrepancies: List[Discrepancy]
    final_output: VisionSpec
```

### 5.3 Stage F: Human Review (HITL)

```python
# human_review/ 기존 모듈 활용
class HumanReviewInput:
    semantic_graph: SemanticGraph
    cross_verify_report: CrossVerifyResult
    flagged_items: List[FlaggedItem]  # confidence < threshold

class HumanReviewOutput:
    approved_nodes: List[str]
    rejected_nodes: List[str]
    corrected_nodes: Dict[str, Correction]
```

---

## 6. 리스크 및 완화 전략

| Risk | Impact | Mitigation |
|------|--------|------------|
| Gemini 수식 OCR 정확도 | High | Claude Vision 교차검증으로 보완 |
| Claude Max API 제한 | Medium | Rate limiting 구현 |
| Stage 순서 변경 부작용 | Medium | 통합 테스트 강화 |
| 기존 테스트 실패 | Low | 테스트 케이스 업데이트 |

---

## 7. 질문 로그 (Q&A History)

| # | Date | Question | Answer |
|---|------|----------|--------|
| Q1 | 2026-01-19 | Stage C는 왜 필요? | YOLO: 도형 bbox, Gemini: 해석. Claude로 대체 가능 |
| Q2 | 2026-01-19 | 고도화 방향? | Option B: Gemini 단독 + Claude 교차검증 |
| Q3 | 2026-01-19 | HITL 위치? | Stage E 직후 (F↔G 순서 변경) |
| Q4 | 2026-01-19 | Mathpix 호출 위치? | Stage B `_run_stage_b()` (pipeline.py:915-998) |

---

## 8. 다음 단계

구현 착수 전 확인이 필요한 사항:

1. **Gemini 3.0 Pro API 접근** - API 키 발급 완료?
2. **Claude Max API 엔드포인트** - Vision API 접근 방법 확인
3. **기존 테스트 보존** - 마이그레이션 중 테스트 유지 전략
4. **롤백 계획** - V2 → V3 실패 시 복구 방법

---

## Change Log

| Date | Version | Change |
|------|---------|--------|
| 2026-01-19 | 1.0 | Initial Q&A (Stage C 목적) |
| 2026-01-19 | 2.0 | Gemini 비용 분석, 고도화 방안 추가 |
| 2026-01-19 | 3.0 | 최종 아키텍처 결정 (Option B + Claude + HITL) |
| 2026-01-19 | 3.1 | 전체 재정리 - 구현 계획 초안 완성 |

---

**Protocol Compliance:** orchestrator_protocol_v4.1.yaml

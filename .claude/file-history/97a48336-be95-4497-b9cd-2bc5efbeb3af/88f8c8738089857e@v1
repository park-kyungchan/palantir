# Threshold Calibration Configuration
# Math Image Parsing Pipeline v2.0.0
#
# 3-Layer Architecture:
#   Layer 1: Base thresholds (per element type)
#   Layer 2: Context modifiers (image quality, complexity, density)
#   Layer 3: Feedback loop (FN/FP rate adjustments)

version: "2.0.0"

global_settings:
  min_threshold: 0.15
  max_threshold: 0.90
  learning_rate: 0.08
  feedback_window_size: 100

targets:
  false_negative_rate: 0.05
  false_positive_rate: 0.30

element_thresholds:
  # CRITICAL risk (Recall >= 0.98)
  equation:
    base: 0.70
    risk: critical
    default_severity: blocker
  curves:
    base: 0.75
    risk: critical
    default_severity: blocker
  inconsistency:
    base: 0.80
    risk: critical
    default_severity: blocker

  # HIGH risk (Recall >= 0.95)
  points:
    base: 0.65
    risk: high
    default_severity: high
  diagram_type:
    base: 0.60
    risk: high
    default_severity: high
  alignment_match:
    base: 0.60
    risk: high
    default_severity: high
  node:
    base: 0.60
    risk: high
    default_severity: high

  # MEDIUM risk (Recall >= 0.90)
  labels:
    base: 0.55
    risk: medium_high
    default_severity: medium
  edge:
    base: 0.55
    risk: medium
    default_severity: medium
  text:
    base: 0.45
    risk: medium
    default_severity: medium

  # LOW risk (Recall >= 0.85)
  bbox:
    base: 0.40
    risk: low
    default_severity: low

context_modifiers:
  image_quality:
    formula: "0.85 + (quality_score * 0.15)"
    min_quality_score: 0.0
    max_quality_score: 1.0
  complexity:
    elementary: 1.05
    middle_school: 1.00
    high_school: 0.95
    advanced: 0.90
  element_density:
    formula: "1.0 - (min(element_count, 10) * 0.01)"
    max_elements: 10

feedback_loop:
  fn_rate_trigger: 0.05
  fn_adjustment: -0.08
  fp_rate_trigger: 0.30
  fp_adjustment: 0.04

hard_rules:
  - condition: "confidence < 0.2"
    action: "ALWAYS_REVIEW"
    severity: blocker
  - condition: "diagram_type == 'unknown'"
    action: "ALWAYS_REVIEW"
    severity: high
  - condition: "coordinate_system == 'ambiguous'"
    action: "ALWAYS_REVIEW"
    severity: high
  - condition: "blocker_count > 0"
    action: "HALT_PIPELINE"
    severity: blocker

monitoring:
  false_negative_rate:
    target: 0.05
    warning: 0.07
    critical: 0.10
  false_positive_rate:
    target: 0.30
    warning: 0.40
    critical: 0.50
  review_queue_depth:
    target: 200
    warning: 300
    critical: 500
  confidence_drift_kl:
    target: 0.10
    warning: 0.15
    critical: 0.25

calibration_schedule:
  initial: "Golden Dataset sweep"
  weekly: "Reviewer feedback analysis"
  monthly: "Drift detection (>5% triggers recalibration)"
  quarterly: "Full recalibration + operating point review"

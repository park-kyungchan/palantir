---
name: clarify
description: |
  Single entry point for all complex tasks with mandatory synthesis.
  Clarifies requirements, defines investigation scope, executes with Progressive-Deep-Dive.
  Workflow: Clarify → Investigate → Synthesize → Execute → Loop.
  Use for any task requiring careful requirement analysis before action.
user-invocable: true
disable-model-invocation: true
argument-hint: [request-description]
context: fork
model: opus
allowed-tools:
  - Read
  - Grep
  - Glob
  - Task
  - Write
  - AskUserQuestion
  - TodoWrite
version: "2.0.0"
---

# /clarify - Unified Workflow Entry Point

> **Version:** 2.0.0 | **Role:** Single Entry Point
> **Principle:** 불필요한 조사 방지 + Progressive-Deep-Dive

---

## Input

Request: $0

---

## Phase 1: Clarification (명확화)

### 1.1 의도 분석

사용자 요청을 분석하여 다음을 파악:

```yaml
intent_analysis:
  primary_goal: ""      # 핵심 목표
  implicit_needs: []    # 암묵적 요구사항
  ambiguous_points: []  # 모호한 부분
  assumptions: []       # 가정 사항
```

### 1.2 Socratic Questions

모호한 부분에 대해 질문:

```python
AskUserQuestion(
    questions=[{
        "question": "다음 중 어떤 방향을 원하시나요?",
        "header": "범위 확인",
        "options": [
            {"label": "옵션 A", "description": "설명"},
            {"label": "옵션 B", "description": "설명"},
            {"label": "둘 다", "description": "설명"},
        ],
        "multiSelect": False
    }]
)
```

### 1.3 Scope Definition (핵심)

**DO (조사할 것):**
```yaml
investigation_scope:
  include:
    - area: ""
      reason: ""
      priority: CRITICAL | HIGH | MEDIUM
```

**DON'T (조사하지 않을 것):**
```yaml
  exclude:
    - area: ""
      reason: "범위 외"
```

### 1.4 PE 기법 적용

```python
Task(
    subagent_type="claude-code-guide",
    prompt=f"""
    ## Original Request
    {user_input}

    ## Clarified Intent
    {intent_analysis}

    ## Task
    이 요청에 적합한 Prompt Engineering 기법을 적용하여
    더 명확하고 실행 가능한 프롬프트로 개선하세요.

    ## Consider
    - Task Decomposition: 복잡한 작업 분해
    - Constraint Setting: 제약 조건 명시
    - Output Specification: 출력 형식 지정
    """,
    description="PE refinement"
)
```

### 1.5 Clarification Approval

```python
AskUserQuestion(
    questions=[{
        "question": f"""
## 명확화된 요청

**목표:** {primary_goal}

**조사 범위:**
- DO: {include_list}
- DON'T: {exclude_list}

**개선된 프롬프트:**
```
{improved_prompt}
```

이대로 진행할까요?
""",
        "header": "Phase 1 승인",
        "options": [
            {"label": "승인 - 조사 시작", "description": "Phase 2로 진행"},
            {"label": "범위 수정", "description": "DO/DON'T 조정"},
            {"label": "처음부터", "description": "요청 재작성"}
        ],
        "multiSelect": False
    }]
)
```

---

## Phase 2: Investigation (조사)

**Only after Phase 1 approval.**

### 2.1 Progressive-Deep-Dive

```python
# 1단계: 표면 조사 (L1)
surface_scan = Task(
    subagent_type="Explore",
    prompt=f"""
    ## Scope
    {investigation_scope.include}

    ## Exclude
    {investigation_scope.exclude}

    ## Task
    범위 내에서만 표면 조사 수행.
    Deep-Dive 필요 영역 식별.

    ## Output
    L1 요약 + L2 인덱스 (Deep-Dive 후보)
    """,
    description="Surface scan"
)

# 2단계: 선택적 Deep-Dive (L3)
if surface_scan.recommendedRead:
    for area in surface_scan.recommendedRead:
        if area.priority in ["CRITICAL", "HIGH"]:
            deep_dive(area)
```

### 2.2 Boundary Enforcement

```python
# 범위 이탈 감지
if detected_area not in investigation_scope.include:
    log_skip(detected_area, "범위 외 - 건너뜀")
    continue
```

---

## Phase 3: Synthesis (종합) - 필수

**Always executed after investigation.**

### 3.1 결과 집계

```yaml
synthesis:
  findings:
    - area: ""
      insight: ""
      evidence: ""
      priority: CRITICAL | HIGH | MEDIUM | LOW

  patterns:
    - pattern: ""
      occurrences: []
      implication: ""

  cross_analysis:
    - connection: ""
      areas: []
      significance: ""
```

### 3.2 Action Proposals

```yaml
  proposed_actions:
    immediate:
      - action: ""
        reason: ""
        effort: S | M | L

    deferred:
      - action: ""
        reason: ""
        blocker: ""
```

### 3.3 Synthesis Approval

```python
AskUserQuestion(
    questions=[{
        "question": f"""
## Synthesis 결과

**핵심 발견:**
{findings_summary}

**패턴:**
{patterns_summary}

**제안 액션:**
1. {immediate_actions}

어떻게 진행할까요?
""",
        "header": "Phase 3 승인",
        "options": [
            {"label": "실행 진행", "description": "제안된 액션 실행"},
            {"label": "액션 수정", "description": "실행 전 조정"},
            {"label": "추가 조사", "description": "특정 영역 Deep-Dive"},
            {"label": "완료", "description": "여기서 종료"}
        ],
        "multiSelect": False
    }]
)
```

---

## Phase 4: Execution (실행) - 조건부

**Only if user approves execution.**

### 4.1 Task Decomposition

```python
TodoWrite([
    {"subject": action.name, "description": action.detail, "status": "pending"}
    for action in approved_actions
])
```

### 4.2 Execute with Progress

```python
for task in todo_list:
    TaskUpdate(taskId=task.id, status="in_progress")
    execute(task)
    TaskUpdate(taskId=task.id, status="completed")
```

### 4.3 Post-Execution Synthesis

**Loop back to Phase 3** with execution results.

```python
# 실행 후 다시 Synthesis
synthesis_round_2 = synthesize(execution_results)
# → Phase 3.3 Approval로 돌아감
```

---

## Log Management

### Log Path
```
.agent/plans/clarify_{session_id}_{slug}.md
```

### Log Structure
```markdown
# Clarify Session: {slug}

> **Created:** {datetime}
> **Status:** {in_progress|completed|cancelled}
> **Phases Completed:** [1, 2, 3, 4]

---

## Phase 1: Clarification
- Original: {original_request}
- Clarified: {improved_prompt}
- Scope: {include/exclude}

## Phase 2: Investigation
- Areas Explored: {list}
- Areas Skipped: {list with reasons}

## Phase 3: Synthesis
- Round 1: {findings}
- Round 2: {post-execution findings}

## Phase 4: Execution
- Actions Taken: {list}
- Results: {summary}

---

## Decision Log
| Time | Phase | Decision | Rationale |
|------|-------|----------|-----------|
| ... | 1 | Scope approved | ... |
| ... | 3 | Execute option A | ... |
```

---

## Exit Conditions

### 정상 종료
- Phase 3에서 "완료" 선택
- Phase 4 실행 후 모든 액션 완료

### Loop 조건
- Phase 3에서 "추가 조사" → Phase 2로
- Phase 4 완료 → Phase 3으로 (Synthesis)

### 취소
- 어느 Phase에서든 사용자 취소 가능
- 로그는 보존 (resume 가능)

---

## Integration Points

### 내부 스킬 호출
```python
# Investigation phase
Task(subagent_type="Explore", ...)

# Execution phase (if needed)
/orchestrate  # Multi-terminal 작업 시
/worker       # 병렬 실행 시
```

### Resume 기능
```bash
/clarify --resume {session_id}
```

---

## Example Usage

```bash
# 새 세션
/clarify "인증 시스템 보안 점검"

# Phase 1: 범위 정의
# → DO: 인증 로직, 토큰 관리
# → DON'T: UI, 로깅

# Phase 2: Progressive-Deep-Dive
# → L1: 전체 인증 파일 스캔
# → L3: auth.ts, token.ts만 Deep-Dive

# Phase 3: Synthesis
# → 발견: SQL Injection 위험 2건
# → 제안: 즉시 수정

# Phase 4: Execution
# → 수정 실행 → 다시 Synthesis → 완료
```

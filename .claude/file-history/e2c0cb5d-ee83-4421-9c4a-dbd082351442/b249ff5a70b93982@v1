# Claude Code Agent

> **Version:** 5.1 | **Role:** Main Agent Orchestrator
> **Method:** Progressive-Disclosure (Frontmatter → References → Detail)

---

## 1. Core Identity

```
VERIFY-FIRST   → Verify files/imports before ANY mutation
DELEGATE       → Use Task subagents for complex operations
AUDIT-TRAIL    → Track files_viewed for all operations
```

### Workspace
```yaml
workspace_root: /home/palantir
ontology_definition: /home/palantir/park-kyungchan/palantir/Ontology-Definition
```

---

## 2. Orchestration Protocol

### 2.1 Delegation Rules

**You are the ORCHESTRATOR. Delegate complex tasks.**

| Task Type | Delegate To | When |
|-----------|-------------|------|
| Codebase analysis | `Task(subagent_type="Explore")` | Structure discovery |
| Implementation planning | `Task(subagent_type="Plan")` | Design |
| Complex multi-step | `Task(subagent_type="general-purpose")` | Full workflow |
| Documentation search | `Task(subagent_type="claude-code-guide")` | Prompt engineering |

### 2.2 Delegation Template

```python
Task(
  subagent_type="{type}",
  prompt="""
    ## Context
    Reference: `.claude/references/native-capabilities.md`

    ## Task
    {specific_task_description}

    ## Required Evidence
    - files_viewed: [must populate]

    ## Output Format
    {expected_output_structure}
  """,
  description="{brief_description}"
)
```

### 2.3 Parallel Execution (Boris Cherny Pattern)

**Background execution for independent tasks:**

```python
# CORRECT: Parallel background delegation
Task(subagent_type="Explore", prompt="...", run_in_background=True)
Task(subagent_type="Plan", prompt="...", run_in_background=True)
```

### 2.4 Progressive Disclosure (L1/L2/L3 Pattern)

**Hook-based output format enforcement for token efficiency.**

Hook: `.claude/hooks/progressive-disclosure/pd-inject.sh`

#### Layer Architecture

```
┌─────────────────────────────────────────────────────┐
│ L1: Summary (≤500 tokens)                           │
│ - priority, summary, l2Index, recommendedRead       │
│ - Main Agent로 직접 반환 (tool_result)              │
└──────────────────────┬──────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────┐
│ L2: Index (l2Index[])                               │
│ - anchor, tokens, priority, description             │
│ - L3 섹션에 대한 메타데이터                         │
└──────────────────────┬──────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────┐
│ L3: Detail (File sections)                          │
│ - .agent/outputs/{type}/{id}.md 파일                │
│ - ## Section {#anchor} 형식으로 작성                │
│ - 필요 시만 Read()로 접근 (Lazy Loading)            │
└─────────────────────────────────────────────────────┘
```

#### L1 Summary Format (MAX 500 TOKENS)

```yaml
taskId: {8-char id}
agentType: {Explore|Plan|general-purpose}
summary: "1-2 sentence summary"
status: success | partial | failed

# Progressive Disclosure Fields
priority: CRITICAL | HIGH | MEDIUM | LOW
recommendedRead:
  - anchor: "#section-name"
    reason: "why this section should be read"

l2Index:
  - anchor: "#section-name"
    tokens: {estimated number}
    priority: CRITICAL | HIGH | MEDIUM | LOW
    description: "what this section contains"

l2Path: .agent/outputs/{agentType}/{taskId}.md
requiresL2Read: true | false
nextActionHint: "suggested next step"
```

#### L3 Detail Format (File)

```markdown
<!-- .agent/outputs/{agentType}/{taskId}.md -->
<!-- Estimated total: ~2000 tokens -->

## Section Name {#anchor}
<!-- ~500 tokens -->

Detailed content here...

## Another Section {#another-anchor}
<!-- ~800 tokens -->

More detailed content...
```

#### Reading Strategy

| Priority | Action |
|----------|--------|
| CRITICAL | MUST read recommendedRead L3 sections |
| HIGH | SHOULD read recommendedRead L3 sections |
| MEDIUM | MAY read L3 on demand |
| LOW | L1 is sufficient, skip L3 |

#### Priority Actions (Machine-Readable)

```yaml
priorityActions:
  CRITICAL:
    action: "mustRead"
    timing: "immediate"
    target: "recommendedRead"
    fallback: null
  HIGH:
    action: "shouldRead"
    timing: "beforeAction"
    target: "recommendedRead"
    fallback: "L1 summary"
  MEDIUM:
    action: "mayRead"
    timing: "onDemand"
    target: "l2Index filtered"
    fallback: "L1 summary"
  LOW:
    action: "skip"
    timing: null
    target: null
    fallback: "L1 sufficient"
```

#### Token Budget

- If `l2Index[].tokens` total > 10K → read CRITICAL/HIGH L3 only
- If context usage > 70% → read L1 + recommendedRead L3 only

#### Subagent Type Exceptions

| Subagent Type | L1/L2/L3 Format | Reason |
|---------------|-----------------|--------|
| `Explore` | ✅ Applied | Analysis output |
| `Plan` | ✅ Applied | Design output |
| `general-purpose` | ✅ Applied | Execution output |
| `prompt-assistant` | ❌ Skipped | Conversational |
| `onboarding-guide` | ❌ Skipped | Conversational |
| `statusline-setup` | ❌ Skipped | Config only |

### 2.5 Multi-Terminal Orchestration (Session-Aware Worker Prompt System)

**File-based coordination for parallel terminal workers.**

#### Architecture

```
┌─────────────────────────────────────────────────────────────┐
│ Terminal-A (Orchestrator)                                   │
│   - Creates _context.yaml, _progress.yaml                   │
│   - Assigns tasks via worker-{x}-task.yaml                  │
│   - Monitors progress, resolves dependencies                │
└──────────────────────┬──────────────────────────────────────┘
                       │
       ┌───────────────┼───────────────┐
       ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ Terminal-B  │ │ Terminal-C  │ │ Terminal-D  │
│  (Worker)   │ │  (Worker)   │ │  (Worker)   │
└─────────────┘ └─────────────┘ └─────────────┘
```

#### Session Registry

**Problem:** Environment variable `export` doesn't propagate to parent processes.

**Solution:** File-based session registry at `~/.agent/tmp/current_session.json`

```json
{
  "sessionId": "1769184373-644229",
  "startTime": "2026-01-24T00:00:00Z",
  "pid": "644229",
  "status": "active"
}
```

#### Worker Task Files

**Location:** `.agent/prompts/`

| Directory | Purpose |
|-----------|---------|
| `pending/` | Tasks waiting to be processed |
| `completed/` | Archived tasks (audit trail) |
| `_context.yaml` | Global project context |
| `_progress.yaml` | Real-time progress tracker |

#### Prompt File Lifecycle

```
Task() called → pending/{session}-{id}.yaml created
     │
     ▼
Task completed → mv pending/ → completed/
     │
     ▼
Audit log → .agent/logs/prompt_lifecycle.log
```

#### Hook Integration

| Hook | Phase | Function |
|------|-------|----------|
| `session-start.sh` | 1 | Create session registry + prompts directories |
| `pd-task-interceptor.sh` | 2 | Read session ID, generate prompt YAML |
| `pd-task-processor.sh` | 3 | Move completed prompts, write audit log |

---

## 3. Safety Rules (Non-Negotiable)

### Blocked Patterns
```
rm -rf          → ALWAYS DENY
sudo rm         → ALWAYS DENY
chmod 777       → ALWAYS DENY
DROP TABLE      → ALWAYS DENY
```

### Sensitive Files (Auto-Blocked)
```
.env*           → Contains secrets
*credentials*   → Authentication data
.ssh/id_*       → SSH private keys
**/secrets/**   → Secret storage
```

---

## 4. Behavioral Directives

### ALWAYS
- Use `TodoWrite` for multi-step tasks
- Verify files exist before editing
- Include `files_viewed` evidence for analysis

### NEVER
- Edit files without reading first
- Execute blocked patterns
- Hallucinate file contents or code

---

## 5. Communication Protocol

| Context | Language |
|---------|----------|
| Intent clarification | Korean (사용자 의도 확인) |
| Execution/Code | English |
| Documentation | English |

---

## 6. Native Capabilities (Quick Reference)

### Context Modes
| Mode | When | Effect |
|------|------|--------|
| `context: fork` | Deep analysis | Isolated execution |
| `context: standard` | User interaction | Shared context |

### Key Tools
| Tool | Purpose |
|------|---------|
| `Read` | File analysis |
| `Grep` | Pattern search |
| `Task` | Subagent delegation |
| `WebSearch` | External information |
| `TodoWrite` | Progress tracking |

**Full Detail:** `.claude/references/native-capabilities.md`

---

## 7. Reference Index

| Reference | Path | Purpose |
|-----------|------|---------|
| Native Capabilities | `.claude/references/native-capabilities.md` | Subagent capability details |
| Delegation Patterns | `.claude/references/delegation-patterns.md` | Orchestrator templates |
| Skill Dependencies | `.claude/references/skill-dependencies.md` | Skill invocation order |

---

> **Note:** ODA (Ontology-Driven Architecture) has been removed.
> Only `Ontology-Definition` directory is preserved for schema definitions.

> **v5.1 Update (2026-01-24):** Session-Aware Worker Prompt System added.
> Multi-terminal orchestration via file-based session registry and YAML prompt files.

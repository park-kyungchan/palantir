# =============================================================================
# Worker Task: Terminal-B - Enhanced Pipeline Skills
# =============================================================================
# Read this file AFTER reading _context.yaml
#
# Location: .agent/prompts/pending/worker-terminal-b-enhanced-pipeline.yaml
# Language: English (Machine-Readable)
# =============================================================================

assignedTo: "terminal-b"
orchestrator: "Terminal-A"
createdAt: "2026-01-24T20:55:00Z"

# =============================================================================
# CONTEXT REFERENCE
# =============================================================================
contextFile: ".agent/prompts/_context.yaml"
progressFile: ".agent/prompts/_progress.yaml"
planningDocument: ".agent/plans/enhanced_pipeline_skills_20260124.yaml"
researchDocument: ".agent/research/enhanced_pipeline_skills_20260124.md"

# =============================================================================
# ASSIGNED TASKS (in execution order)
# =============================================================================

tasks:
  # ---------------------------------------------------------------------------
  # Task 1: /research skill (No dependencies - can start immediately)
  # ---------------------------------------------------------------------------
  - nativeTaskId: "16"
    phaseId: "phase1-research-skill"
    name: "Implement /research skill"
    canStartImmediately: true
    priority: "P0"

    scope: |
      Create the /research skill for deep codebase analysis and external resource gathering.
      This skill runs after /clarify to provide informed context for planning.

    targetFiles:
      - path: "/home/palantir/.claude/skills/research/SKILL.md"
        action: "create"
        readOnly: false

    referenceFiles:
      - path: "/home/palantir/.claude/skills/build-research/SKILL.md"
        reason: "Similar research pattern to adapt"
      - path: "/home/palantir/.claude/skills/clarify/SKILL.md"
        reason: "Input format and hook patterns"

    detailedInstructions: |
      1. Create directory: mkdir -p /home/palantir/.claude/skills/research

      2. Create SKILL.md with frontmatter:
         ```yaml
         ---
         name: research
         description: |
           Deep codebase analysis and external resource gathering.
           Post-/clarify research phase for informed planning.
         user-invocable: true
         disable-model-invocation: false
         context: fork
         model: opus
         version: "1.0.0"
         argument-hint: "[--scope <path>] [--external] [--clarify-slug <slug>]"
         allowed-tools:
           - Read
           - Grep
           - Glob
           - WebSearch
           - WebFetch
           - Task
           - Bash
         hooks:
           Stop:
             - type: command
               command: "/home/palantir/.claude/hooks/research-finalize.sh"
               timeout: 180000
         ---
         ```

      3. Include sections:
         - Purpose: Deep codebase + external resource analysis
         - Execution Protocol: Pattern analysis, external gathering, risk assessment
         - Output Format: L1/L2/L3 Progressive Disclosure
         - Output Path: .agent/research/{slug}.md
         - Integration Points: /clarify → /research → /planning

      4. Key features to implement:
         - Codebase pattern analysis using Grep/Glob
         - External resource gathering with WebSearch
         - Risk assessment generation
         - L1 summary (< 500 tokens)
         - L2 detailed sections
         - L3 full findings

    completionCriteria:
      - "SKILL.md created with complete V2.1.19 frontmatter"
      - "Execution protocol includes codebase analysis logic"
      - "External resource gathering with WebSearch implemented"
      - "L1/L2/L3 output format specified"
      - "Integration with /clarify output documented"

    onComplete:
      - "TaskUpdate(taskId='16', status='completed')"
      - "Notify: Task #18, #20, #22 may now be unblocked"

  # ---------------------------------------------------------------------------
  # Task 2: research-finalize.sh hook (Depends on Task 16)
  # ---------------------------------------------------------------------------
  - nativeTaskId: "18"
    phaseId: "phase3a-research-hook"
    name: "Create research-finalize.sh hook"
    canStartImmediately: false
    blockedBy: ["16"]
    priority: "P1"

    scope: |
      Create Stop hook for /research skill finalization.
      Validates output, suggests next skill (/planning).

    targetFiles:
      - path: "/home/palantir/.claude/hooks/research-finalize.sh"
        action: "create"
        readOnly: false

    referenceFiles:
      - path: "/home/palantir/.claude/hooks/clarify-finalize.sh"
        reason: "Similar hook pattern"

    detailedInstructions: |
      1. Create hook script with:
         - Shebang: #!/bin/bash
         - Validate research output exists at .agent/research/
         - Log completion timestamp
         - Output suggestion: "Next step: /planning --research-slug {slug}"

      2. Make executable: chmod +x

    completionCriteria:
      - "Hook script created and executable"
      - "Validates research output exists"
      - "Suggests /planning as next step"

    onComplete:
      - "TaskUpdate(taskId='18', status='completed')"

  # ---------------------------------------------------------------------------
  # Task 3: /rsil-plan skill (Depends on Task 16, 17)
  # ---------------------------------------------------------------------------
  - nativeTaskId: "20"
    phaseId: "phase4-rsil-plan-skill"
    name: "Implement /rsil-plan skill"
    canStartImmediately: false
    blockedBy: ["16", "17"]
    priority: "P0"

    scope: |
      Create the /rsil-plan skill for Requirements-Synthesis Integration Loop.
      Handles 2nd+ loop iterations with code-level gap analysis.

    targetFiles:
      - path: "/home/palantir/.claude/skills/rsil-plan/SKILL.md"
        action: "create"
        readOnly: false

    referenceFiles:
      - path: "/home/palantir/.claude/skills/synthesis/SKILL.md"
        reason: "Traceability matrix and gap detection patterns"
      - path: "/home/palantir/.claude/skills/research/SKILL.md"
        reason: "Similar analysis patterns"

    detailedInstructions: |
      1. Create directory: mkdir -p /home/palantir/.claude/skills/rsil-plan

      2. Create SKILL.md with frontmatter:
         ```yaml
         ---
         name: rsil-plan
         description: |
           Requirements-Synthesis Integration Loop (RSIL).
           Verifies synthesis results against original requirements.
           Performs code-level gap analysis and creates remediation plans.
         user-invocable: true
         disable-model-invocation: false
         context: standard
         model: opus
         version: "1.0.0"
         argument-hint: "[--iteration <n>] [--auto-remediate]"
         allowed-tools:
           - Read
           - Grep
           - Glob
           - Task
           - TaskCreate
           - TaskUpdate
           - TaskList
           - AskUserQuestion
         ---
         ```

      3. Include sections:
         - Purpose: RSIL for 2nd+ loop iterations
         - Gap Analysis Protocol:
           * Load /clarify requirements
           * Load /research findings
           * Load /planning document
           * Load /synthesis results
           * Grep for implementation evidence
           * Compare with planning expectations
           * Mark: COVERED | PARTIAL | MISSING
         - Remediation Planning:
           * TaskCreate for each gap
           * Set severity and complexity
         - Decision Logic:
           * If gaps < 3 AND complexity low → auto-remediate
           * Otherwise → present to user

      4. Output files:
         - .agent/rsil/iteration_{n}.md (gap analysis report)
         - .agent/rsil/iteration_{n}_remediation.yaml (remediation plan)

    completionCriteria:
      - "SKILL.md created with complete V2.1.19 frontmatter"
      - "Gap analysis protocol with code-level verification"
      - "Remediation task generation using TaskCreate"
      - "Auto-remediate vs escalate decision logic"
      - "Gap analysis report schema defined"

    onComplete:
      - "TaskUpdate(taskId='20', status='completed')"
      - "Notify: Task #21, #22 may now be unblocked"

  # ---------------------------------------------------------------------------
  # Task 4: CLAUDE.md update (Depends on Task 16, 17, 20)
  # ---------------------------------------------------------------------------
  - nativeTaskId: "22"
    phaseId: "phase5b-pipeline-documentation"
    name: "Update CLAUDE.md pipeline documentation"
    canStartImmediately: false
    blockedBy: ["16", "17", "20"]
    priority: "P1"

    scope: |
      Update CLAUDE.md with enhanced pipeline flow diagram.
      Include /research, /planning, /rsil-plan in E2E pipeline.

    targetFiles:
      - path: "/home/palantir/.claude/CLAUDE.md"
        action: "modify"
        readOnly: false
        sections:
          - "orchestration_protocol"
          - "e2e_pipeline"

    referenceFiles:
      - path: "/home/palantir/.claude/CLAUDE.md"
        reason: "Current pipeline documentation to be updated"
      - path: "/home/palantir/.claude/skills/rsil-plan/SKILL.md"
        reason: "New RSIL skill to document in pipeline"
      - path: "/home/palantir/.claude/skills/research/SKILL.md"
        reason: "New research skill to document in pipeline"
      - path: "/home/palantir/.claude/skills/planning/SKILL.md"
        reason: "New planning skill to document in pipeline"

    detailedInstructions: |
      1. Find "## 3. Orchestration Protocol" section
      2. Update "### 3.1 E2E Pipeline" with:

         ```
         /clarify                     Requirements + Design Recording (YAML)
             │
             ▼
         /research                    Deep Codebase + External Analysis ◄── NEW
             │
             ▼
         /planning                    YAML Planning + Plan Agent Review ◄── NEW
             │
             ▼
         /orchestrate                 Task Decomposition + Auto-Dependency
             │
             ▼
         /assign                      Worker Assignment (Pull-Based)
             ▼
         ┌───┴───┬───────┐
         ▼       ▼       ▼
         Worker  Worker  Worker       Parallel Execution
         B       C       D
         └───────┼───────┘
                 ▼
         /collect                     Result Aggregation
             │
             ▼
         /synthesis                   Traceability + Quality Check
             │
             ├── COMPLETE ──▶ /commit-push-pr
             └── ITERATE ───▶ /rsil-plan ◄── NEW (2nd+ Loop)
                                 │
                                 ├── Auto-Remediate → /orchestrate
                                 └── Escalate → /clarify
         ```

    completionCriteria:
      - "E2E Pipeline section updated with new skills"
      - "Flow diagram includes /research → /planning path"
      - "ITERATE path shows /rsil-plan"

    onComplete:
      - "TaskUpdate(taskId='22', status='completed')"
      - "Notify: Task #23 (E2E testing) may now be unblocked"

# =============================================================================
# GLOBAL CONTEXT CONSIDERATIONS
# =============================================================================

globalContext:
  architecture: "Hybrid (Native Task System + File-Based Prompts)"
  fileNamingConvention: "kebab-case for skills, snake_case for outputs"
  skillVersion: "V2.1.19"
  outputFormat: "L1/L2/L3 Progressive Disclosure"

# =============================================================================
# OUTPUT FORMAT
# =============================================================================

outputFormat: "L1/L2/L3"
reportPath: ".agent/outputs/terminal-b/enhanced-pipeline-report.md"

# =============================================================================
# AUTONOMOUS EXECUTION INSTRUCTIONS (자율 실행 지침)
# =============================================================================
# Terminal-B는 이 지침에 따라 최종 완료까지 자율적으로 작업을 진행합니다.
# =============================================================================

autonomousExecution:
  enabled: true
  myTerminal: "terminal-b"
  myTasks: ["16", "18", "20", "22"]

  # -------------------------------------------------------------------------
  # EXECUTION SEQUENCE (실행 순서)
  # -------------------------------------------------------------------------
  executionSequence:
    - step: 1
      taskId: "16"
      name: "Implement /research skill"
      blockedBy: []
      action: "START IMMEDIATELY"
      onComplete: "Unblocks #18, #20 (partially), #22 (partially)"

    - step: 2
      taskId: "18"
      name: "Create research-finalize.sh hook"
      blockedBy: ["16"]
      action: "Wait for #16, then start"
      onComplete: "No direct unblocks"

    - step: 3
      taskId: "20"
      name: "Implement /rsil-plan skill"
      blockedBy: ["16", "17"]
      action: "Wait for #16 AND #17 (Terminal-C), then start"
      onComplete: "Unblocks #21 (Terminal-C), #22 (partially)"

    - step: 4
      taskId: "22"
      name: "Update CLAUDE.md pipeline documentation"
      blockedBy: ["16", "17", "20"]
      action: "Wait for #16, #17, #20, then start"
      onComplete: "Unblocks #23 (partially)"

  # -------------------------------------------------------------------------
  # SELF-MONITORING LOOP (자가 모니터링 루프)
  # -------------------------------------------------------------------------
  monitoringLoop: |
    REPEAT until all myTasks completed:
      1. TaskList() → Check current status
      2. FOR each taskId in ["16", "18", "20", "22"]:
           task = TaskGet(taskId)
           IF task.status == "pending":
             blockers = task.blockedBy
             allBlockersComplete = TRUE
             FOR each blockerId in blockers:
               blocker = TaskGet(blockerId)
               IF blocker.status != "completed":
                 allBlockersComplete = FALSE
                 BREAK
             IF allBlockersComplete:
               TaskUpdate(taskId, status="in_progress")
               EXECUTE task following detailedInstructions
               TaskUpdate(taskId, status="completed")
               LOG "✅ Task #{taskId} completed"
             ELSE:
               LOG "⏳ Task #{taskId} waiting for blockers: {blockers}"
      3. Check if Terminal-C tasks (#17, #19) completed for cross-deps
      4. IF all myTasks completed:
           REPORT "Terminal-B: All tasks completed"
           EXIT loop

  # -------------------------------------------------------------------------
  # CROSS-TERMINAL DEPENDENCY CHECK
  # -------------------------------------------------------------------------
  crossTerminalDeps:
    task20_requires: "Task #17 from Terminal-C"
    checkMethod: "TaskGet('17').status == 'completed'"

  # -------------------------------------------------------------------------
  # COMPLETION CRITERIA
  # -------------------------------------------------------------------------
  completionCriteria:
    allTasksCompleted: ["16", "18", "20", "22"]
    outputGenerated: ".agent/outputs/terminal-b/enhanced-pipeline-report.md"
    progressUpdated: "_progress.yaml reflects terminal-b.status = 'completed'"

# =============================================================================
# ON ALL COMPLETE
# =============================================================================

onAllComplete:
  - "Report to Orchestrator with L1 summary"
  - "Update .agent/prompts/_progress.yaml: terminal-b.status = 'completed'"
  - "Check if Task #23 can start (requires #21 from Terminal-C)"

#!/bin/bash
# ODA Audit Logger Post-Tool Hook
# Logs all tool operations for audit trail

set -e

# Configuration
AUDIT_LOG_DIR="/home/palantir/park-kyungchan/palantir/.agent/tmp"
AUDIT_LOG_FILE="$AUDIT_LOG_DIR/audit_$(date +%Y%m%d).jsonl"

# Ensure audit directory exists
mkdir -p "$AUDIT_LOG_DIR"

# Read input from stdin (JSON format)
INPUT=$(cat)

# Extract tool information
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // "unknown"')
TOOL_INPUT=$(echo "$INPUT" | jq -r '.tool_input // {}')
TOOL_RESULT=$(echo "$INPUT" | jq -r '.tool_result // {}')
SESSION_ID="${CLAUDE_SESSION_ID:-$(date +%s)}"

# Create audit log entry
AUDIT_ENTRY=$(jq -n \
    --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
    --arg session_id "$SESSION_ID" \
    --arg tool_name "$TOOL_NAME" \
    --argjson tool_input "$TOOL_INPUT" \
    --arg user "${USER:-unknown}" \
    --arg pwd "$(pwd)" \
    '{
        timestamp: $timestamp,
        session_id: $session_id,
        tool_name: $tool_name,
        tool_input: $tool_input,
        user: $user,
        working_directory: $pwd
    }'
)

# Append to audit log
echo "$AUDIT_ENTRY" >> "$AUDIT_LOG_FILE"

# Exit successfully (don't block)
exit 0

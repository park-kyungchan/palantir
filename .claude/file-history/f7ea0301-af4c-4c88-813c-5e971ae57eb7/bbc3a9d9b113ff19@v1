#!/bin/bash
# =============================================================================
# /clarify Skill Helper Functions
# =============================================================================
# Purpose: Provide logging utilities for clarify skill
# Usage: Source this file in clarify skill execution
# =============================================================================

set -euo pipefail

# Generate slug from user input
generate_slug() {
    local input="$1"
    echo "$input" | tr '[:upper:]' '[:lower:]' | tr -cs '[:alnum:]' '-' | cut -c1-50 | sed 's/-$//'
}

# Create clarify log header
write_log_header() {
    local log_path="$1"
    local original_input="$2"
    local timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    local slug=$(basename "$log_path" .md | sed 's/clarify_//')

    cat > "$log_path" <<EOF
# Clarify Log: ${slug}

> **Created:** ${timestamp}
> **Status:** in_progress
> **Rounds:** 0
> **Final Approved:** no

---

## INDEX

### 원본 요청
${original_input}

### 최종 프롬프트
N/A

### 적용 기법
(Empty)

### 라운드 요약
| Round | Input (요약) | 기법 | 결과 |
|-------|-------------|------|------|

---

## DETAIL: Round Logs {#rounds}

EOF
}

# Append round log entry
append_round_log() {
    local log_path="$1"
    local round_num="$2"
    local input="$3"
    local pe_technique="$4"
    local pe_reason="$5"
    local improved_prompt="$6"
    local user_response="$7"
    local feedback="${8:-N/A}"

    cat >> "$log_path" <<EOF

---

### Round ${round_num}

**Input:**
${input}

**PE Lookup Result:**
- Technique: ${pe_technique}
- Reason: ${pe_reason}

**Improved Prompt:**
\`\`\`
${improved_prompt}
\`\`\`

**User Response:** ${user_response}
**Feedback:** ${feedback}

EOF

    # Update round count in header
    sed -i "s/\*\*Rounds:\*\* [0-9]\+/\*\*Rounds:\*\* ${round_num}/" "$log_path"
}

# Finalize log after approval
finalize_log() {
    local log_path="$1"
    local final_prompt="$2"
    local timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)

    # Update status
    sed -i 's/\*\*Status:\*\* in_progress/\*\*Status:\*\* completed/' "$log_path"
    sed -i 's/\*\*Final Approved:\*\* no/\*\*Final Approved:\*\* yes/' "$log_path"

    # Update final prompt section
    sed -i "/### 최종 프롬프트/,/### 적용 기법/ s|N/A|${final_prompt}|" "$log_path"

    # Append completion timestamp
    echo "" >> "$log_path"
    echo "---" >> "$log_path"
    echo "" >> "$log_path"
    echo "> **Completed:** ${timestamp}" >> "$log_path"
}

# Cancel log
cancel_log() {
    local log_path="$1"
    local reason="$2"
    local timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)

    sed -i 's/\*\*Status:\*\* in_progress/\*\*Status:\*\* cancelled/' "$log_path"

    echo "" >> "$log_path"
    echo "---" >> "$log_path"
    echo "" >> "$log_path"
    echo "> **Cancelled:** ${timestamp}" >> "$log_path"
    echo "> **Reason:** ${reason}" >> "$log_path"
}

# Update round summary table
update_round_summary() {
    local log_path="$1"
    local round_num="$2"
    local input_summary="$3"
    local technique="$4"
    local result="$5"

    # Find the table and append row
    local row="| ${round_num} | ${input_summary} | ${technique} | ${result} |"

    # Insert before "---" that follows the table
    sed -i "/### 라운드 요약/,/^---$/ {
        /^---$/i\\
${row}
    }" "$log_path"
}

# Export functions
export -f generate_slug
export -f write_log_header
export -f append_round_log
export -f finalize_log
export -f cancel_log
export -f update_round_summary

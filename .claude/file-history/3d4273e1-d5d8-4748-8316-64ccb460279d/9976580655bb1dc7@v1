# Plan: Custom Command Enhancement (Pre-Mutation Zone Optimization)

> **Version:** 1.0.0 | **Date:** 2026-01-13
> **Status:** draft | **Complexity:** large
> **User Requirement:** "나는 앞으로 커스텀커맨드를 통해서만 진행할거야"

---

## Metadata

| Attribute | Value |
|-----------|-------|
| Created | 2026-01-13 11:38:00 |
| Status | draft |
| Complexity | large |
| Total Tasks | 35 |
| Total Phases | 6 |
| Files to Create | 8 |
| Files to Modify | 12 |
| Estimated Subagent Calls | 15+ |

---

## Overview

사용자 요구사항:
1. **커스텀 커맨드 고도화**: /ask, /plan, /audit, /deep-audit
2. **Pre-Mutation Zone 최적화**: ODA 제안 생성 직전까지의 모든 영역
3. **V2.1.4 기능 극대화**: context:fork, run_in_background, resume
4. **Auto Full-Context-Injection**: 커맨드 내 자동 컨텍스트 주입
5. **Agent 위임 최대화**: Main Agent는 조율만, 실행은 Subagent

---

## Agent Registry

Track subagent IDs for resume after Auto-Compact:

| Agent ID | Type | Task | Status |
|----------|------|------|--------|
| a740d90 | claude-code-guide | V2.1.4 features research | completed |
| a062a9b | Explore | Custom commands structure | completed |
| ac5f63b | Plan | Architecture analysis | running |

---

## Phase 1: /ask Skill Enhancement (6 tasks)

**목표:** 요구사항 명확화 및 프롬프트 엔지니어링 전문 스킬 구현

### Tasks

| # | Task | File | Priority | Status |
|---|------|------|----------|--------|
| 1.1 | Create dedicated /ask skill file | `.claude/skills/ask.md` | HIGH | pending |
| 1.2 | Implement Socratic questioning flow | `.claude/skills/ask.md` | HIGH | pending |
| 1.3 | Add prompt engineering keyword detection | `.claude/skills/ask.md` | MEDIUM | pending |
| 1.4 | Implement WebSearch fallback for techniques | `.claude/skills/ask.md` | MEDIUM | pending |
| 1.5 | Add auto-routing to other commands | `.claude/skills/ask.md` | HIGH | pending |
| 1.6 | Create /ask unit tests | `tests/oda/pai/skills/test_ask_skill.py` | MEDIUM | pending |

### Technical Details

**1.1 Create dedicated /ask skill file**
```yaml
---
name: ask
description: 요구사항 분석 및 명확화, Socratic questioning, 프롬프트 엔지니어링
version: "1.0"
model: sonnet
context: fork  # V2.1.4: Isolated context
output_format: ClarificationResult
triggers:
  keywords: ["도와줘", "이해 안돼", "help", "how", "what"]
tools: [Read, Grep, Glob, WebSearch, AskUserQuestion]
---
```

**1.3 Prompt Engineering Keywords**
```python
PROMPT_ENGINEERING_TRIGGERS = {
    "chain-of-thought": ["단계별", "논리적", "추론", "CoT"],
    "few-shot": ["예시", "예를 들면", "example"],
    "react": ["행동", "관찰", "ReAct"],
    "tree-of-thought": ["대안", "비교", "선택"],
    "structured-output": ["JSON", "포맷", "형식"],
}
```

**1.5 Auto-Routing Decision Tree**
```
User Input → /ask
    │
    ├── 분석/이해/설명 키워드
    │   └── Recommend: Task(subagent_type="Explore")
    │
    ├── 수정/고쳐/변경 키워드
    │   └── Recommend: EnterPlanMode or /plan
    │
    ├── 테스트/검사/리뷰 키워드
    │   └── Recommend: /audit
    │
    └── 계획/설계 키워드
        └── Recommend: /plan
```

---

## Phase 2: /plan Skill Enhancement (7 tasks)

**목표:** Dual-Path Analysis (ODA Protocol + Plan Subagent) 최적화

### Tasks

| # | Task | File | Priority | Status |
|---|------|------|----------|--------|
| 2.1 | Add `context: fork` to skill frontmatter | `.claude/skills/plan.md` | HIGH | pending |
| 2.2 | Implement parallel ODA + Plan subagent execution | `.claude/skills/plan.md` | HIGH | pending |
| 2.3 | Add auto plan file generation | `.claude/skills/plan.md` | HIGH | pending |
| 2.4 | Implement TaskDecomposer integration | `.claude/skills/plan.md` | MEDIUM | pending |
| 2.5 | Add resume parameter support | `.claude/skills/plan.md` | MEDIUM | pending |
| 2.6 | Create plan synthesis template | `.claude/skills/plan.md` | MEDIUM | pending |
| 2.7 | Add /plan integration tests | `tests/oda/pai/skills/test_plan_skill.py` | MEDIUM | pending |

### Technical Details

**2.2 Parallel Execution Pattern**
```python
# In /plan skill execution flow
# Path 1: ODA Protocol
Task(
    subagent_type="general-purpose",
    prompt="Execute ODA 3-Stage Protocol...",
    description="ODA Protocol analysis",
    run_in_background=True  # V2.1.4 parallel
)

# Path 2: Plan Subagent
Task(
    subagent_type="Plan",
    prompt="Analyze requirements and design...",
    description="Plan subagent analysis",
    run_in_background=True  # V2.1.4 parallel
)

# Synthesis after both complete
# Compare outputs → Extract best of both → Present
```

**2.3 Auto Plan File Generation**
```markdown
# Template: .agent/plans/{slug}.md
---
title: {user_requirement_summary}
created: {timestamp}
status: in_progress
phases: [{phase_list}]
---

## Agent Registry
| ID | Type | Task | Status |

## Quick Resume
{context_for_subagents}
```

**2.5 Resume Parameter Usage**
```python
# After Auto-Compact, read plan file
plan_file = Read(".agent/plans/{slug}.md")
agent_registry = parse_agent_registry(plan_file)

for agent in agent_registry:
    if agent.status == "running":
        Task(
            subagent_type=agent.type,
            prompt=agent.task,
            resume=agent.id,  # V2.1.4 resume
            run_in_background=True
        )
```

---

## Phase 3: /audit Skill Enhancement (6 tasks)

**목표:** Stage C 품질 검증 병렬화 및 context:fork 적용

### Tasks

| # | Task | File | Priority | Status |
|---|------|------|----------|--------|
| 3.1 | Verify `context: fork` in frontmatter | `.claude/skills/audit.md` | HIGH | pending |
| 3.2 | Implement parallel quality checks (4 streams) | `.claude/skills/audit.md` | HIGH | pending |
| 3.3 | Add severity-based filtering | `.claude/skills/audit.md` | MEDIUM | pending |
| 3.4 | Implement TodoWrite progress tracking | `.claude/skills/audit.md` | MEDIUM | pending |
| 3.5 | Add Pre-Mutation Zone boundary enforcement | `.claude/skills/audit.md` | HIGH | pending |
| 3.6 | Create /audit benchmark tests | `tests/oda/pai/skills/test_audit_skill.py` | MEDIUM | pending |

### Technical Details

**3.2 Parallel Quality Checks**
```python
# Deploy 4 parallel quality checks
quality_checks = [
    ("Build Check", "python -m py_compile"),
    ("Tests", "pytest --tb=short"),
    ("Lint", "ruff check"),
    ("Type Check", "mypy"),
]

for name, cmd in quality_checks:
    Task(
        subagent_type="Explore",
        prompt=f"Execute {name}: {cmd}...",
        description=f"Quality: {name}",
        run_in_background=True
    )

# Wait and synthesize
# Return unified AuditResult
```

**3.5 Pre-Mutation Zone Enforcement**
```python
# /audit operates ONLY in Pre-Mutation Zone
# If any finding requires mutation:
#   1. Return findings as proposals
#   2. DO NOT execute edits
#   3. Delegate to /plan for mutation planning
```

---

## Phase 4: /deep-audit Skill Enhancement (6 tasks)

**목표:** RSIL 심층 분석 + 4-Stream 병렬화 + BLOCK 강제

### Tasks

| # | Task | File | Priority | Status |
|---|------|------|----------|--------|
| 4.1 | Add `context: fork` with Opus model | `.claude/skills/deep-audit.md` | HIGH | pending |
| 4.2 | Implement 4-stream parallel analysis | `.claude/skills/deep-audit.md` | HIGH | pending |
| 4.3 | Add RSIL synthesis algorithm | `.claude/skills/deep-audit.md` | HIGH | pending |
| 4.4 | Implement BLOCK enforcement logic | `.claude/skills/deep-audit.md` | CRITICAL | pending |
| 4.5 | Add TaskDecomposer for large codebases | `.claude/skills/deep-audit.md` | MEDIUM | pending |
| 4.6 | Create /deep-audit E2E tests | `tests/oda/pai/skills/test_deep_audit_skill.py` | MEDIUM | pending |

### Technical Details

**4.2 Four Parallel Analysis Streams**
```python
ANALYSIS_STREAMS = [
    {
        "name": "Security Scan",
        "subagent": "Explore",
        "focus": ["credentials", "injection", "traversal"],
        "token_budget": 5000
    },
    {
        "name": "Architecture Analysis",
        "subagent": "Explore",
        "focus": ["coupling", "cohesion", "layers"],
        "token_budget": 5000
    },
    {
        "name": "Code Quality Metrics",
        "subagent": "Explore",
        "focus": ["complexity", "coverage", "duplication"],
        "token_budget": 5000
    },
    {
        "name": "Dependency Audit",
        "subagent": "Explore",
        "focus": ["outdated", "vulnerable", "unused"],
        "token_budget": 5000
    }
]

# ALL 4 streams MUST run in parallel
for stream in ANALYSIS_STREAMS:
    Task(
        subagent_type=stream["subagent"],
        prompt=f"Analyze {stream['name']}...",
        description=f"DeepAudit: {stream['name'][:20]}",
        run_in_background=True
    )
```

**4.4 BLOCK Enforcement**
```python
# CRITICAL findings → UNCONDITIONAL BLOCK
# ERROR findings → BLOCK (configurable)
# WARNING/INFO → ALLOW

def should_block(findings: List[Finding]) -> bool:
    critical_count = sum(1 for f in findings if f.severity == "CRITICAL")
    error_count = sum(1 for f in findings if f.severity == "ERROR")

    if critical_count > 0:
        return True  # Always block
    if error_count > 0 and config.block_on_error:
        return True
    return False
```

---

## Phase 5: Auto Full-Context-Injection System (5 tasks)

**목표:** 모든 커맨드에 자동 컨텍스트 주입 시스템 구현

### Tasks

| # | Task | File | Priority | Status |
|---|------|------|----------|--------|
| 5.1 | Create ContextInjector module | `lib/oda/pai/skills/context_injector.py` | HIGH | pending |
| 5.2 | Implement skill frontmatter auto-enrichment | `lib/oda/pai/skills/context_injector.py` | HIGH | pending |
| 5.3 | Add reference auto-loading | `lib/oda/pai/skills/context_injector.py` | MEDIUM | pending |
| 5.4 | Integrate with SkillRouter | `lib/oda/pai/skills/router.py` | HIGH | pending |
| 5.5 | Create context injection tests | `tests/oda/pai/skills/test_context_injector.py` | MEDIUM | pending |

### Technical Details

**5.1 ContextInjector Module**
```python
class ContextInjector:
    """
    Auto-inject relevant context into skill execution.

    V4.0 Features:
    - Reference auto-loading from .claude/references/
    - Plan file loading for resume context
    - Evidence schema injection
    - ODA governance rules injection
    """

    REFERENCE_MAP = {
        "/ask": ["native-capabilities.md", "intent-classification.md"],
        "/plan": ["3-stage-protocol.md", "delegation-patterns.md"],
        "/audit": ["3-stage-protocol.md", "governance-rules.md"],
        "/deep-audit": ["3-stage-protocol.md", "governance-rules.md"],
    }

    def inject(self, skill_name: str, base_prompt: str) -> str:
        """Inject relevant context into skill prompt."""
        references = self.REFERENCE_MAP.get(skill_name, [])

        context_blocks = []
        for ref in references:
            content = self._load_reference(ref)
            context_blocks.append(f"## Reference: {ref}\n{content[:2000]}")

        return base_prompt + "\n\n" + "\n\n".join(context_blocks)
```

**5.2 Skill Frontmatter Auto-Enrichment**
```yaml
# Before injection
---
name: audit
description: Quick audit skill
context: fork
---

# After injection (runtime)
---
name: audit
description: Quick audit skill
context: fork
_injected_references:
  - .claude/references/3-stage-protocol.md
  - .claude/references/governance-rules.md
_injected_context:
  oda_governance: true
  evidence_schema: StageC
  proposal_required: false
---
```

---

## Phase 6: Integration & Testing (5 tasks)

**목표:** 전체 통합 테스트 및 문서화

### Tasks

| # | Task | File | Priority | Status |
|---|------|------|----------|--------|
| 6.1 | Create E2E skill chain test | `tests/integration/test_skill_chain.py` | HIGH | pending |
| 6.2 | Update CLAUDE.md with new patterns | `CLAUDE.md` | HIGH | pending |
| 6.3 | Create skill dependency diagram | `.claude/references/skill-dependencies.md` | MEDIUM | pending |
| 6.4 | Add parallel execution benchmarks | `tests/benchmark/test_parallel_execution.py` | MEDIUM | pending |
| 6.5 | Create user guide for custom commands | `docs/custom-commands-guide.md` | LOW | pending |

### Technical Details

**6.1 E2E Skill Chain Test**
```python
@pytest.mark.integration
async def test_full_skill_chain():
    """Test: /ask → /plan → /audit → /deep-audit flow"""

    # Step 1: /ask clarifies requirements
    ask_result = await invoke_skill("ask", "새 기능 추가하고 싶어")
    assert ask_result.recommendation in ["/plan", "/audit"]

    # Step 2: /plan creates implementation plan
    plan_result = await invoke_skill("plan", ask_result.clarified_requirement)
    assert plan_result.plan_file_created

    # Step 3: /audit validates before mutation
    audit_result = await invoke_skill("audit", plan_result.target_path)
    assert audit_result.status == "PASS"

    # Step 4: /deep-audit for complex changes
    if plan_result.complexity == "large":
        deep_result = await invoke_skill("deep-audit", plan_result.target_path)
        assert not deep_result.blocked
```

---

## Progress Tracking

| Phase | Description | Tasks | Completed | Status |
|-------|-------------|-------|-----------|--------|
| 1 | /ask Enhancement | 6 | 0 | pending |
| 2 | /plan Enhancement | 7 | 0 | pending |
| 3 | /audit Enhancement | 6 | 0 | pending |
| 4 | /deep-audit Enhancement | 6 | 0 | pending |
| 5 | Context Injection | 5 | 0 | pending |
| 6 | Integration & Testing | 5 | 0 | pending |
| **Total** | | **35** | **0** | **0%** |

---

## Quick Resume (For Auto-Compact Recovery)

### Current State
- All 3 research subagents completed
- Plan file created with 35 tasks across 6 phases
- Ready for Phase 1 implementation

### Key Findings from Research

**V2.1.4 Features (from claude-code-guide agent):**
- `context: fork` - Isolated subagent execution
- `run_in_background=true` - Parallel subagent execution
- `resume` parameter - Continue after interruption
- Hot reload for skills - No restart needed
- Wildcard tool permissions - `Bash(python:*)`

**Current Structure (from Explore agent):**
- `/ask` - Currently in DEFAULT_COMMANDS only, no .md file
- `/plan` - Has .md file (354 lines), needs context:fork
- `/audit` - Has .md file (420 lines), has context:fork
- `/deep-audit` - Has .md file (476 lines), BLOCK enforcement exists

**Architecture (from Plan agent):**
- V4.0 LLM-Native Intent Classification active
- TriggerDetector completely removed
- Main Agent direct routing for Claude Code
- IntentClassifier for external API mode

### Next Action
Begin Phase 1: Create `/ask` skill file with full functionality

---

## Critical Files Reference

| File | Purpose | Lines |
|------|---------|-------|
| `.claude/skills/ask.md` | TO CREATE | ~300 |
| `.claude/skills/plan.md` | TO MODIFY | 354 |
| `.claude/skills/audit.md` | TO MODIFY | 420 |
| `.claude/skills/deep-audit.md` | TO MODIFY | 476 |
| `lib/oda/pai/skills/context_injector.py` | TO CREATE | ~200 |
| `lib/oda/pai/skills/router.py` | TO MODIFY | 557 |
| `lib/oda/pai/skills/intent_classifier.py` | REFERENCE | 555 |
| `lib/oda/llm/intent_adapter.py` | REFERENCE | 326 |

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Context overflow with injection | HIGH | Limit reference snippets to 2000 chars |
| Parallel subagent timeout | MEDIUM | Set 60s timeout, graceful fallback |
| Resume fails after long delay | MEDIUM | Store full context in plan file |
| BLOCK enforcement breaks workflow | HIGH | Configurable severity levels |

---

## Approval Gate

- [ ] Plan reviewed by user
- [ ] Complexity accepted (35 tasks)
- [ ] Phase order approved
- [ ] Ready to begin Phase 1

---

> **Generated by:** /plan command with Dual-Path Analysis
> **ODA Protocol:** Stage A (SCAN) + Stage B (TRACE) complete
> **Plan Agent:** Architecture analysis complete

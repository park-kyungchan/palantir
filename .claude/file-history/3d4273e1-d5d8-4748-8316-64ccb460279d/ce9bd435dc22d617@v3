# Foundry-Level ODA Upgrade Plan

> **Version:** 2.0 | **Status:** IN_PROGRESS | **Date:** 2026-01-12
> **Auto-Compact Safe:** This file persists across context compaction
> **Target:** Palantir Foundry/AIP Level ODA Implementation
> **Developer Profile:** Solo developer in education sector

---

## Metadata

| Item | Value |
|------|-------|
| Complexity | LARGE (7 phases, 103 tasks) |
| Total Phases | 5 Core + 1 Cleanup + 1 AI Agent |
| Estimated Tasks | 103 |
| Current ODA Files | 238 Python files |
| Current Directories | 30+ subdirectories |
| Current ObjectTypes | 7 registered |
| Current ActionTypes | 33+ registered |
| Schema Version | 3.0.1 |
| Priority | P0 (Major Architecture Upgrade) |

---

## Executive Summary

Upgrade ODA from current state (v3.0.1) to Palantir Foundry/AIP compliance level.
This plan is optimized for a solo developer workflow with maximum task decomposition
for Auto-Compact survival.

---

## Stage A: Current State Analysis (COMPLETED)

### Files Analyzed

| Category | Path | Lines | Key Classes |
|----------|------|-------|-------------|
| Core Types | `lib/oda/ontology/ontology_types.py` | 330 | Cardinality, PropertyType, Link[T], OntologyObject |
| Registry | `lib/oda/ontology/registry.py` | 225 | OntologyRegistry, @register_object_type |
| Actions | `lib/oda/ontology/actions/__init__.py` | 1106 | ActionType, ActionRegistry, GovernanceEngine |
| Storage | `lib/oda/ontology/storage/database.py` | 339 | Database, DatabaseConfig, async SQLAlchemy |
| Storage Models | `lib/oda/ontology/storage/models.py` | 330 | ProposalModel, ActionLogModel, AuditLogModel |
| Memory | `lib/oda/memory/manager.py` | 109 | MemoryManager, ActionRunner integration |
| Task Types | `lib/oda/ontology/objects/task_types.py` | 125 | Agent, Task with Link definitions |
| Core Defs | `lib/oda/ontology/objects/core_definitions.py` | 39 | Artifact ObjectType |

### Current Implementation Status

**✅ Implemented (Foundry-Aligned):**

| Component | Current State | Foundry Equivalent |
|-----------|--------------|-------------------|
| `Link[T]` generic | Type-safe with cardinality | LinkType definition |
| `Cardinality` enum | 1:1, 1:N, N:1, N:N | Cardinality constraints |
| `PropertyType` enum | 14 types including VECTOR | Property data types |
| `@register_object_type` | Decorator-based registration | ObjectType registration |
| `OntologyRegistry` | Schema export to JSON | Ontology schema management |
| `ActionType` base | With submission_criteria | Action definition |
| `GovernanceEngine` | ALLOW/REQUIRE_PROPOSAL/BLOCK/DENY | Action governance |
| `Proposal` workflow | DRAFT→PENDING→APPROVED→EXECUTED | Approval workflow |
| `AuditLog` | Full execution logging | Audit trail |
| Async SQLAlchemy | WAL mode, connection pooling | Data persistence |

**❌ Gaps Identified (vs Foundry Reference):**

| Gap | Foundry Concept | Current State | Priority |
|-----|-----------------|---------------|----------|
| **LinkTypeRegistry** | Centralized link management with metadata | Links embedded in ObjectTypes only | P0 |
| **PropertyDef validation** | Required/unique/default/range constraints | Basic Pydantic validation only | P0 |
| **ActionType side-effects** | Declared side-effects (notifications, triggers) | Not implemented | P1 |
| **Undo/Rollback** | Per-action undo capability | Partial (orchestration only) | P1 |
| **Semantic Layer** | Vector embeddings for objects | JSON storage, no embeddings | P1 |
| **Transaction branching** | Foundry commit/checkpoint pattern | Single transaction model | P2 |
| **Shared Properties** | Common properties across ObjectTypes | No mechanism | P2 |
| **Derived Properties** | Computed/readonly properties | Not implemented | P2 |
| **Multi-tenant** | Workspace/namespace isolation | Single workspace | P3 |

### Directory Structure Analysis

```
lib/oda/ (238 Python files)
├── ontology/           # Core ontology (registry, types, actions, storage)
│   ├── objects/        # ObjectType definitions (7 types)
│   ├── actions/        # ActionType implementations (33+ actions)
│   ├── storage/        # SQLAlchemy models, repositories
│   └── evidence/       # Stage C evidence schemas
├── pai/                # Personal AI Infrastructure (migrated from TS)
│   ├── algorithm/      # Universal Algorithm, ISC, EffortLevels
│   ├── traits/         # 28-trait agent composition
│   ├── hooks/          # Event-driven hook system
│   └── skills/         # Skill routing, workflows
├── memory/             # Semantic memory (Insight, Pattern)
├── planning/           # TaskDecomposer, task management
├── claude/             # Claude Code integration, handlers
├── llm/                # LLM adapters (Claude, OpenAI, etc.)
├── simulation/         # ActionRunner, ActionContext
├── api/                # API layer
├── tools/              # Domain tools (yt, sps)
└── [others]            # lib, voice, relay, etc.
```

### ObjectTypes Found (7 Registered)

| ObjectType | File | Properties | Links |
|------------|------|------------|-------|
| `Agent` | task_types.py:31 | name, agent_type, status | assigned_tasks (1:N) |
| `Task` | task_types.py:58 | title, description, status | assigned_to (N:1), depends_on (N:N) |
| `Proposal` | proposal.py | action_type, payload, status | - |
| `AuditLog` | audit_log.py | action, timestamp, actor_id | - |
| `Artifact` | core_definitions.py:21 | path, type | produced_by_task (N:1) |
| `Insight` | (memory) | content, source, embedding | - |
| `Pattern` | (memory) | name, description, applications | - |

### ActionTypes Found (33+ Registered)

| Category | Actions | File |
|----------|---------|------|
| File Operations | file.read, file.modify, file.write, file.delete | file_actions.py |
| Quality Gates | stage_c.run_tests, stage_c.run_lint, stage_c.run_build, stage_c.run_typecheck, stage_c.verify | quality_actions.py |
| Orchestration | orchestration.process_subagent_output, orchestration.execute_batch, orchestration.rollback, orchestration.status | (various) |
| Memory | memory.save_insight, memory.save_pattern | memory_actions.py |
| LLM | llm.generate_plan, llm.route_task, llm.process_prompt | llm_actions.py |
| Learning | learning.save_state, learning.update_kb | learning_actions.py |

---

## Gap Analysis: Foundry Reference vs Current ODA

### 1. ObjectType/Property Gap

**Foundry Reference:**
```json
{
  "name": "Sensor",
  "version": "1.0",
  "properties": [
    { "name": "sensorId", "type": "string", "required": true },
    { "name": "status", "type": "enum", "options": ["ACTIVE", "INACTIVE"], "default": "ACTIVE" },
    { "name": "lastReading", "type": "float", "required": true }
  ],
  "links": [
    { "name": "installedOn", "target": "Asset", "cardinality": "many-to-one", "directed": true }
  ]
}
```

**Current ODA:**
```python
@register_object_type
class Task(OntologyObject):
    title: str = Field(...)  # No constraint metadata
    assigned_to: ClassVar[Link[Agent]] = Link(...)  # Embedded, not registered
```

**Gap:** Property constraints (required, unique, default, range, enum options) are not declaratively captured.

### 2. LinkType Registry Gap

**Foundry Reference:**
- LinkTypes are first-class citizens with their own registry
- Each LinkType has: name, source_type, target_type, cardinality, directed, metadata

**Current ODA:**
- `Link[T]` is a generic embedded in ObjectTypes
- No centralized `LinkTypeRegistry`
- Cannot query "all links of type X" without scanning ObjectTypes

### 3. ActionType Side-Effects Gap

**Foundry Reference:**
```
ActionType: ShipOrder
- Target: Order
- Side Effects:
  - Notify old manager
  - Notify new manager
  - Update inventory
```

**Current ODA:**
- `ActionType.side_effects` exists but is not structured
- No `@declares_side_effect` decorator pattern
- Side effects not validated by GovernanceEngine

### 4. AI Agent Integration Gap

**Foundry Reference:**
- Agents receive ontology context (ObjectTypes, LinkTypes, ActionTypes)
- Agents can query objects via Object Query tool
- Agents can execute actions via Action tool
- Agents understand relationships and constraints

**Current ODA:**
- LLM adapters exist but no structured ontology context injection
- No "Object Query" or "Action" tool wrappers for agents
- Agent doesn't receive schema metadata automatically

### 5. Semantic/Vector Layer Gap

**Foundry Reference:**
- Objects can have vector embeddings for semantic search
- Hybrid search (keyword + vector) supported

**Current ODA:**
- `PropertyType.VECTOR` exists but not utilized
- Memory subsystem uses JSON storage, no vector DB
- No embedding generation pipeline

---

## Phase 1: LinkType Implementation (16 tasks)

### Overview
Implement centralized LinkTypeRegistry for explicit relationship management.

### 1.1 LinkTypeRegistry Core

| ID | Task | File | Status |
|----|------|------|--------|
| 1.1.1 | Create LinkTypeRegistry class | `lib/oda/ontology/link_registry.py` | [x] COMPLETED |
| 1.1.2 | Implement @register_link_type decorator | `lib/oda/ontology/link_registry.py` | [x] COMPLETED |
| 1.1.3 | Add LinkType validation rules | `lib/oda/ontology/link_registry.py` | [x] COMPLETED |
| 1.1.4 | Implement bidirectional link resolution | `lib/oda/ontology/link_registry.py` | [x] COMPLETED |

### 1.2 LinkType Metadata

| ID | Task | File | Status |
|----|------|------|--------|
| 1.2.1 | Add LinkTypeMetadata Pydantic model | `lib/oda/ontology/types/link_types.py` | [x] COMPLETED |
| 1.2.2 | Implement constraint validators | `lib/oda/ontology/types/link_types.py` | [x] COMPLETED |
| 1.2.3 | Add cascade delete/update policies | `lib/oda/ontology/types/link_types.py` | [x] COMPLETED |
| 1.2.4 | Implement referential integrity checks | `lib/oda/ontology/types/link_types.py` | [x] COMPLETED |

### 1.3 Storage Integration

| ID | Task | File | Status |
|----|------|------|--------|
| 1.3.1 | Create LinkModel for SQLAlchemy | `lib/oda/ontology/storage/models.py` | [ ] PENDING |
| 1.3.2 | Add LinkRepository | `lib/oda/ontology/storage/repositories.py` | [ ] PENDING |
| 1.3.3 | Implement M:N join table generator | `lib/oda/ontology/storage/link_tables.py` | [ ] PENDING |
| 1.3.4 | Add link migration utilities | `lib/oda/ontology/storage/migrations/` | [ ] PENDING |

### 1.4 Registry Integration

| ID | Task | File | Status |
|----|------|------|--------|
| 1.4.1 | Update OntologyRegistry to include links | `lib/oda/ontology/registry.py` | [ ] PENDING |
| 1.4.2 | Add export_links_json() method | `lib/oda/ontology/registry.py` | [ ] PENDING |
| 1.4.3 | Create LinkIntrospector utility | `lib/oda/ontology/introspection/links.py` | [ ] PENDING |
| 1.4.4 | Write unit tests for LinkTypeRegistry | `tests/ontology/test_link_registry.py` | [ ] PENDING |

---

## Phase 2: ObjectType Expansion (18 tasks)

### Overview
Enhance ObjectType system with property validation, computed properties, and lifecycle hooks.

### 2.1 Property Framework

| ID | Task | File | Status |
|----|------|------|--------|
| 2.1.1 | Create PropertyDefinition model | `lib/oda/ontology/types/property_types.py` | [ ] PENDING |
| 2.1.2 | Add property constraint validators | `lib/oda/ontology/types/property_types.py` | [ ] PENDING |
| 2.1.3 | Implement computed property decorator | `lib/oda/ontology/decorators/computed.py` | [ ] PENDING |
| 2.1.4 | Add property change tracking | `lib/oda/ontology/tracking/changes.py` | [ ] PENDING |

### 2.2 New ObjectTypes

| ID | Task | File | Status |
|----|------|------|--------|
| 2.2.1 | Create Workspace ObjectType | `lib/oda/ontology/objects/workspace.py` | [ ] PENDING |
| 2.2.2 | Create Session ObjectType | `lib/oda/ontology/objects/session.py` | [ ] PENDING |
| 2.2.3 | Create Learner ObjectType (expanded) | `lib/oda/ontology/objects/learner.py` | [ ] PENDING |
| 2.2.4 | Create Course ObjectType | `lib/oda/ontology/objects/course.py` | [ ] PENDING |
| 2.2.5 | Create Assessment ObjectType | `lib/oda/ontology/objects/assessment.py` | [ ] PENDING |
| 2.2.6 | Create Resource ObjectType | `lib/oda/ontology/objects/resource.py` | [ ] PENDING |

### 2.3 Lifecycle Hooks

| ID | Task | File | Status |
|----|------|------|--------|
| 2.3.1 | Implement pre_save hook | `lib/oda/ontology/hooks/lifecycle.py` | [ ] PENDING |
| 2.3.2 | Implement post_save hook | `lib/oda/ontology/hooks/lifecycle.py` | [ ] PENDING |
| 2.3.3 | Implement pre_delete hook | `lib/oda/ontology/hooks/lifecycle.py` | [ ] PENDING |
| 2.3.4 | Implement validation hook | `lib/oda/ontology/hooks/lifecycle.py` | [ ] PENDING |

### 2.4 ObjectType Versioning

| ID | Task | File | Status |
|----|------|------|--------|
| 2.4.1 | Add schema version tracking | `lib/oda/ontology/versioning/schema.py` | [ ] PENDING |
| 2.4.2 | Implement version migration framework | `lib/oda/ontology/versioning/migrate.py` | [ ] PENDING |
| 2.4.3 | Add backward compatibility layer | `lib/oda/ontology/versioning/compat.py` | [ ] PENDING |
| 2.4.4 | Write ObjectType expansion tests | `tests/ontology/test_object_types.py` | [ ] PENDING |

---

## Phase 3: ActionType Expansion (16 tasks)

### Overview
Enhance ActionType system with side-effects declaration, undo support, and batch execution.

### 3.1 Side-Effects Framework

| ID | Task | File | Status |
|----|------|------|--------|
| 3.1.1 | Create SideEffect model | `lib/oda/ontology/actions/side_effects.py` | [x] COMPLETED |
| 3.1.2 | Implement @declares_side_effect decorator | `lib/oda/ontology/actions/side_effects.py` | [x] COMPLETED |
| 3.1.3 | Add side-effect validation in GovernanceEngine | `lib/oda/ontology/actions/side_effects.py` | [x] COMPLETED |
| 3.1.4 | Create side-effect audit logging | `lib/oda/ontology/actions/side_effects.py` | [x] COMPLETED |

### 3.2 Undo/Rollback Support

| ID | Task | File | Status |
|----|------|------|--------|
| 3.2.1 | Create UndoableAction base class | `lib/oda/ontology/actions/undoable.py` | [x] COMPLETED |
| 3.2.2 | Implement undo() method pattern | `lib/oda/ontology/actions/undoable.py` | [x] COMPLETED |
| 3.2.3 | Add undo history storage | `lib/oda/ontology/storage/undo_history.py` | [x] COMPLETED |
| 3.2.4 | Create rollback orchestrator | `lib/oda/ontology/actions/rollback.py` | [x] COMPLETED |

### 3.3 Batch Execution

| ID | Task | File | Status |
|----|------|------|--------|
| 3.3.1 | Create BatchAction executor | `lib/oda/ontology/actions/batch.py` | [x] COMPLETED |
| 3.3.2 | Implement transaction grouping | `lib/oda/ontology/actions/batch.py` | [x] COMPLETED |
| 3.3.3 | Add batch progress reporting | `lib/oda/ontology/actions/batch.py` | [x] COMPLETED |
| 3.3.4 | Implement partial rollback on failure | `lib/oda/ontology/actions/batch.py` | [x] COMPLETED |

### 3.4 New ActionTypes

| ID | Task | File | Status |
|----|------|------|--------|
| 3.4.1 | Create WorkspaceAction types | `lib/oda/ontology/actions/workspace_actions.py` | [x] COMPLETED |
| 3.4.2 | Create SessionAction types | `lib/oda/ontology/actions/session_actions.py` | [x] COMPLETED |
| 3.4.3 | Create AssessmentAction types | `lib/oda/ontology/actions/assessment_actions.py` | [x] COMPLETED |
| 3.4.4 | Write ActionType expansion tests | `tests/ontology/test_action_types.py` | [x] COMPLETED |

---

## Phase 4: Semantic Layer (15 tasks)

### Overview
Implement vector embeddings and semantic search for knowledge management.

### 4.1 Embedding Infrastructure

| ID | Task | File | Status |
|----|------|------|--------|
| 4.1.1 | Create EmbeddingProvider interface | `lib/oda/semantic/embedding.py` | [ ] PENDING |
| 4.1.2 | Implement OpenAI adapter | `lib/oda/semantic/providers/openai.py` | [ ] PENDING |
| 4.1.3 | Implement local model adapter | `lib/oda/semantic/providers/local.py` | [ ] PENDING |
| 4.1.4 | Add embedding cache layer | `lib/oda/semantic/cache.py` | [ ] PENDING |

### 4.2 Vector Storage

| ID | Task | File | Status |
|----|------|------|--------|
| 4.2.1 | Create VectorStore interface | `lib/oda/semantic/vector_store.py` | [ ] PENDING |
| 4.2.2 | Implement SQLite-VSS adapter | `lib/oda/semantic/stores/sqlite_vss.py` | [ ] PENDING |
| 4.2.3 | Implement ChromaDB adapter | `lib/oda/semantic/stores/chroma.py` | [ ] PENDING |
| 4.2.4 | Add vector index management | `lib/oda/semantic/indexing.py` | [ ] PENDING |

### 4.3 Semantic Search

| ID | Task | File | Status |
|----|------|------|--------|
| 4.3.1 | Create SemanticQuery model | `lib/oda/semantic/query.py` | [ ] PENDING |
| 4.3.2 | Implement similarity search | `lib/oda/semantic/search.py` | [ ] PENDING |
| 4.3.3 | Add hybrid search (keyword + vector) | `lib/oda/semantic/search.py` | [ ] PENDING |
| 4.3.4 | Create semantic ranking | `lib/oda/semantic/ranking.py` | [ ] PENDING |

### 4.4 Integration

| ID | Task | File | Status |
|----|------|------|--------|
| 4.4.1 | Integrate with Memory subsystem | `lib/oda/memory/semantic_memory.py` | [ ] PENDING |
| 4.4.2 | Add auto-embedding on object save | `lib/oda/semantic/auto_embed.py` | [ ] PENDING |
| 4.4.3 | Write Semantic Layer tests | `tests/semantic/test_semantic_search.py` | [ ] PENDING |

---

## Phase 5: Transaction & Branching (15 tasks)

### Overview
Implement Foundry-style transaction management with branching and checkpoints.

### 5.1 Transaction Framework

| ID | Task | File | Status |
|----|------|------|--------|
| 5.1.1 | Create TransactionManager | `lib/oda/transaction/manager.py` | [ ] PENDING |
| 5.1.2 | Implement ACID guarantees | `lib/oda/transaction/manager.py` | [ ] PENDING |
| 5.1.3 | Add isolation level configuration | `lib/oda/transaction/manager.py` | [ ] PENDING |
| 5.1.4 | Create transaction context decorator | `lib/oda/transaction/decorators.py` | [ ] PENDING |

### 5.2 Branching System

| ID | Task | File | Status |
|----|------|------|--------|
| 5.2.1 | Create Branch ObjectType | `lib/oda/ontology/objects/branch.py` | [ ] PENDING |
| 5.2.2 | Implement branch creation | `lib/oda/transaction/branching.py` | [ ] PENDING |
| 5.2.3 | Add branch merge strategy | `lib/oda/transaction/merge.py` | [ ] PENDING |
| 5.2.4 | Implement conflict resolution | `lib/oda/transaction/conflicts.py` | [ ] PENDING |

### 5.3 Checkpoint System

| ID | Task | File | Status |
|----|------|------|--------|
| 5.3.1 | Create Checkpoint model | `lib/oda/transaction/checkpoint.py` | [ ] PENDING |
| 5.3.2 | Implement checkpoint creation | `lib/oda/transaction/checkpoint.py` | [ ] PENDING |
| 5.3.3 | Add checkpoint restore | `lib/oda/transaction/checkpoint.py` | [ ] PENDING |
| 5.3.4 | Create checkpoint comparison | `lib/oda/transaction/diff.py` | [ ] PENDING |

### 5.4 Integration

| ID | Task | File | Status |
|----|------|------|--------|
| 5.4.1 | Integrate with ActionRunner | `lib/oda/simulation/core.py` | [ ] PENDING |
| 5.4.2 | Add transaction-aware repositories | `lib/oda/ontology/storage/repositories.py` | [ ] PENDING |
| 5.4.3 | Write Transaction/Branching tests | `tests/transaction/test_branching.py` | [ ] PENDING |

---

## Phase 6: Cleanup & Optimization (BONUS)

### Overview
Remove obsolete files and optimize directory structure.

### 6.1 File Cleanup

| ID | Task | Action | Status |
|----|------|--------|--------|
| 6.1.1 | Audit unused imports | `ruff check --select F401` | [ ] PENDING |
| 6.1.2 | Remove deprecated modules | TBD after audit | [ ] PENDING |
| 6.1.3 | Consolidate duplicate utilities | `lib/oda/lib/` | [ ] PENDING |
| 6.1.4 | Archive legacy code | `.archive/legacy_oda/` | [ ] PENDING |

### 6.2 Directory Optimization

| ID | Task | Action | Status |
|----|------|--------|--------|
| 6.2.1 | Standardize __init__.py exports | All packages | [ ] PENDING |
| 6.2.2 | Create package index documentation | `lib/oda/README.md` | [ ] PENDING |
| 6.2.3 | Optimize import paths | Circular import resolution | [ ] PENDING |
| 6.2.4 | Run final quality checks | `pytest && ruff && mypy` | [ ] PENDING |

### 6.3 Directory Restructure Plan

**Target Structure (After Cleanup):**

```
lib/oda/
├── ontology/                    # Core Ontology Layer
│   ├── types/                   # NEW: PropertyDef, LinkTypeDef
│   │   ├── property_types.py    # PropertyDefinition, constraints
│   │   └── link_types.py        # LinkTypeMetadata, validators
│   ├── objects/                 # ObjectType definitions
│   │   ├── core_definitions.py  # Base types (Agent, Task, etc.)
│   │   ├── workspace.py         # NEW: Workspace ObjectType
│   │   ├── session.py           # NEW: Session ObjectType
│   │   ├── learner.py           # NEW: Learner (education domain)
│   │   ├── course.py            # NEW: Course ObjectType
│   │   ├── assessment.py        # NEW: Assessment ObjectType
│   │   └── resource.py          # NEW: Resource ObjectType
│   ├── actions/                 # ActionType implementations
│   │   ├── side_effects.py      # NEW: SideEffect framework
│   │   ├── undoable.py          # NEW: UndoableAction base
│   │   ├── batch.py             # NEW: BatchAction executor
│   │   └── rollback.py          # NEW: Rollback orchestrator
│   ├── storage/                 # Persistence layer
│   │   ├── link_tables.py       # NEW: M:N join table generator
│   │   ├── undo_history.py      # NEW: Undo history storage
│   │   └── migrations/          # NEW: Schema migrations
│   ├── hooks/                   # NEW: Lifecycle hooks
│   │   └── lifecycle.py         # pre_save, post_save, validation
│   ├── versioning/              # NEW: Schema versioning
│   │   ├── schema.py            # Version tracking
│   │   ├── migrate.py           # Migration framework
│   │   └── compat.py            # Backward compatibility
│   ├── introspection/           # NEW: Schema introspection
│   │   └── links.py             # LinkIntrospector
│   ├── registry.py              # MODIFY: Include LinkTypeRegistry
│   ├── link_registry.py         # NEW: Centralized link management
│   └── ontology_types.py        # Core types (Link[T], Cardinality)
│
├── semantic/                    # NEW: Semantic Layer
│   ├── embedding.py             # EmbeddingProvider interface
│   ├── cache.py                 # Embedding cache
│   ├── vector_store.py          # VectorStore interface
│   ├── query.py                 # SemanticQuery model
│   ├── search.py                # Similarity/hybrid search
│   ├── ranking.py               # Semantic ranking
│   ├── indexing.py              # Vector index management
│   ├── auto_embed.py            # Auto-embedding on save
│   ├── providers/               # Embedding providers
│   │   ├── openai.py            # OpenAI adapter
│   │   └── local.py             # Local model adapter
│   └── stores/                  # Vector storage backends
│       ├── sqlite_vss.py        # SQLite-VSS adapter
│       └── chroma.py            # ChromaDB adapter
│
├── transaction/                 # NEW: Transaction & Branching
│   ├── manager.py               # TransactionManager, ACID
│   ├── decorators.py            # @transactional context
│   ├── branching.py             # Branch creation/management
│   ├── merge.py                 # Branch merge strategy
│   ├── conflicts.py             # Conflict resolution
│   ├── checkpoint.py            # Checkpoint model
│   └── diff.py                  # Checkpoint comparison
│
├── agent/                       # NEW: AI Agent Integration
│   ├── tools/                   # Agent tool wrappers
│   │   ├── object_query.py      # Object Query tool
│   │   ├── action_executor.py   # Action execution tool
│   │   └── function_call.py     # Function call tool
│   ├── context_builder.py       # Ontology context injection
│   └── schema_prompt.py         # Schema → prompt conversion
│
├── pai/                         # Personal AI Infrastructure (keep)
├── memory/                      # Semantic memory (keep)
├── planning/                    # TaskDecomposer (keep)
├── claude/                      # Claude integration (keep)
├── llm/                         # LLM adapters (keep)
├── simulation/                  # ActionRunner (keep)
└── api/                         # API layer (keep)

# Files to Archive (.archive/legacy_oda/)
archive:
  - lib/oda/lib/textrank.py      # If unused
  - lib/oda/voice/               # If unused
  - lib/oda/relay/               # If unused
  - lib/oda/tools/yt/            # Domain-specific
  - lib/oda/tools/sps/           # Domain-specific
```

---

## Phase 7: AI Agent Integration (15 tasks)

### Overview
Implement Foundry-style AI agent integration with ontology-aware tools.

### 7.1 Agent Tool Framework

| ID | Task | File | Status |
|----|------|------|--------|
| 7.1.1 | Create ObjectQueryTool wrapper | `lib/oda/agent/tools/object_query.py` | [ ] PENDING |
| 7.1.2 | Create ActionExecutorTool wrapper | `lib/oda/agent/tools/action_executor.py` | [ ] PENDING |
| 7.1.3 | Create FunctionCallTool wrapper | `lib/oda/agent/tools/function_call.py` | [ ] PENDING |
| 7.1.4 | Implement tool registry | `lib/oda/agent/tools/__init__.py` | [ ] PENDING |

### 7.2 Ontology Context Builder

| ID | Task | File | Status |
|----|------|------|--------|
| 7.2.1 | Create OntologyContextBuilder | `lib/oda/agent/context_builder.py` | [ ] PENDING |
| 7.2.2 | Implement schema-to-prompt conversion | `lib/oda/agent/schema_prompt.py` | [ ] PENDING |
| 7.2.3 | Add constraint injection | `lib/oda/agent/context_builder.py` | [ ] PENDING |
| 7.2.4 | Implement link graph context | `lib/oda/agent/context_builder.py` | [ ] PENDING |

### 7.3 Agent Execution

| ID | Task | File | Status |
|----|------|------|--------|
| 7.3.1 | Implement agent planning loop | `lib/oda/agent/planner.py` | [ ] PENDING |
| 7.3.2 | Add reasoning trace logging | `lib/oda/agent/trace.py` | [ ] PENDING |
| 7.3.3 | Implement confirmation workflow | `lib/oda/agent/confirmation.py` | [ ] PENDING |
| 7.3.4 | Add agent permission checks | `lib/oda/agent/permissions.py` | [ ] PENDING |

### 7.4 Integration

| ID | Task | File | Status |
|----|------|------|--------|
| 7.4.1 | Integrate with LLM adapters | `lib/oda/llm/agent_adapter.py` | [ ] PENDING |
| 7.4.2 | Add MCP tool exposure | `lib/oda/mcp/agent_tools.py` | [ ] PENDING |
| 7.4.3 | Write Agent Integration tests | `tests/agent/test_agent_tools.py` | [ ] PENDING |

---

## Progress Tracking

| Phase | Tasks | Completed | Status |
|-------|-------|-----------|--------|
| 1: LinkType | 16 | 16 | [✓] COMPLETED |
| 2: ObjectType | 18 | 18 | [✓] COMPLETED |
| 3: ActionType | 16 | 16 | [✓] COMPLETED |
| 4: Semantic | 15 | 15 | [✓] COMPLETED |
| 5: Transaction | 15 | 0 | [ ] IN_PROGRESS |
| 6: Cleanup | 8 | 0 | [ ] PENDING |
| 7: AI Agent | 15 | 0 | [ ] PENDING |
| **Total** | **103** | **65** | **63%** |

### Phase 1 Completion Summary (2026-01-12)

**Files Created (10):**
- `lib/oda/ontology/link_registry.py`
- `lib/oda/ontology/types/__init__.py`
- `lib/oda/ontology/storage/link_repository.py`
- `lib/oda/ontology/storage/link_tables.py`
- `lib/oda/ontology/storage/migrations/__init__.py`
- `lib/oda/ontology/storage/migrations/link_migrations.py`
- `lib/oda/ontology/introspection/__init__.py`
- `lib/oda/ontology/introspection/links.py`
- `tests/ontology/__init__.py`
- `tests/ontology/test_link_registry.py`

**Files Modified (3):**
- `lib/oda/ontology/types/link_types.py` (CascadePolicy, LinkConstraint, ReferentialIntegrityChecker)
- `lib/oda/ontology/storage/models.py` (LinkModel, LinkTypeRegistryModel)
- `lib/oda/ontology/registry.py` (register_link_type, export_links_json)

**Tests:** 30 passing

### Phase 2 Completion Summary (2026-01-12)

**Files Created (11):**
- `lib/oda/ontology/types/property_types.py` (PropertyDefinition, PropertyConstraint, PropertyConstraintValidator)
- `lib/oda/ontology/decorators/__init__.py`
- `lib/oda/ontology/decorators/computed.py` (@computed_property decorator)
- `lib/oda/ontology/tracking/__init__.py`
- `lib/oda/ontology/tracking/changes.py` (ChangeTracker, ChangeTrackingMixin)
- `lib/oda/ontology/objects/workspace.py` (Workspace ObjectType)
- `lib/oda/ontology/objects/session.py` (Session ObjectType)
- `lib/oda/ontology/objects/learner.py` (Learner ObjectType - expanded)
- `lib/oda/ontology/objects/course.py` (Course ObjectType)
- `lib/oda/ontology/objects/assessment.py` (Assessment ObjectType)
- `lib/oda/ontology/objects/resource.py` (Resource ObjectType)
- `lib/oda/ontology/hooks/__init__.py`
- `lib/oda/ontology/hooks/lifecycle.py` (LifecycleHookRegistry, pre_save/post_save/validation hooks)
- `lib/oda/ontology/versioning/__init__.py`
- `lib/oda/ontology/versioning/schema.py` (SchemaVersion, semver tracking)
- `lib/oda/ontology/versioning/migrate.py` (Migration framework)
- `lib/oda/ontology/versioning/compat.py` (CompatibilityLayer)
- `tests/ontology/test_object_types.py` (47 tests)

**Files Modified (2):**
- `lib/oda/ontology/types/__init__.py` (exports)
- `lib/oda/ontology/registry.py` (@register_object_type integration)

**Tests:** 47 passing (Phase 2.3-2.4)

### Phase 3.1-3.2 Completion Summary (2026-01-12)

**Files Created (3):**
- `lib/oda/ontology/actions/undoable.py` (UndoableAction, UndoSnapshot, UndoResult, UndoPolicy)
- `lib/oda/ontology/actions/rollback.py` (RollbackOrchestrator, RollbackBuilder, RollbackPlan)
- `lib/oda/ontology/storage/undo_history.py` (UndoSnapshotModel, UndoHistoryRepository, UndoHistoryManager)

**Files Modified (2):**
- `lib/oda/ontology/actions/side_effects.py` (SideEffectDeclaration, SideEffectRegistry, @declares_side_effect, SideEffectAuditLogger, SideEffectExecutor, SideEffectGovernanceValidator)
- `lib/oda/ontology/actions/__init__.py` (exports for Phase 3.1-3.2 types)

**Key Components Implemented:**

| Component | Description |
|-----------|-------------|
| `SideEffectType` | Enum of Foundry-aligned side effect types (notification, webhook, link_creation, etc.) |
| `SideEffectDeclaration` | Declarative side effect model for ActionTypes |
| `SideEffectRegistry` | Central registry for declared side effects per action |
| `@declares_side_effect` | Decorator for declaring side effects on ActionTypes |
| `SideEffectAuditLogger` | Audit logging for side effect executions |
| `SideEffectExecutor` | Executes side effects with retry and audit |
| `SideEffectGovernanceValidator` | Validates side effect declarations against governance |
| `UndoSnapshot` | Captures state before action for undo capability |
| `UndoableAction` | Abstract base class for undoable actions |
| `UndoPolicy` | Configuration for undo restrictions |
| `RollbackOrchestrator` | Coordinates batch/session/checkpoint rollback |
| `RollbackBuilder` | Fluent API for building rollback requests |
| `UndoSnapshotModel` | SQLAlchemy model for persisting undo history |
| `UndoHistoryRepository` | Repository for undo snapshot CRUD operations |

**Syntax Validated:** All 4 files pass py_compile

### Phase 3.3-3.4 Completion Summary (2026-01-12)

**Files Created (5):**
- `lib/oda/ontology/actions/batch.py` (BatchExecutor, BatchProgress, BatchItem, RollbackStrategy)
- `lib/oda/ontology/actions/workspace_actions.py` (6 WorkspaceAction types)
- `lib/oda/ontology/actions/session_actions.py` (9 SessionAction types)
- `lib/oda/ontology/actions/assessment_actions.py` (10 AssessmentAction types)
- `tests/ontology/test_action_types.py` (comprehensive ActionType tests)

**Key Components Implemented:**

| Component | Description |
|-----------|-------------|
| `BatchExecutor` | Transaction-aware batch execution with 3 modes (sequential, parallel, transactional) |
| `BatchProgress` | Real-time progress tracking with ProgressCallback |
| `RollbackStrategy` | Enum: NONE, ALL, PARTIAL for partial rollback on failure |
| `WorkspaceAction` | 6 actions: create, update, archive, delete, add_member, remove_member |
| `SessionAction` | 9 actions: create, start, pause, resume, end, update_state, update_context, record_activity, record_hint |
| `AssessmentAction` | 10 actions: create, start, submit_response, submit, grade, auto_grade, add_feedback, retry, add_item, remove_item |

**Syntax Validated:** All 5 files pass py_compile

---

## Subagent Delegation Strategy

### Context Window Optimization

Each phase is designed for independent subagent execution to stay within 32K output limit:

| Phase | Subagent Type | Token Budget | Parallel Tasks |
|-------|---------------|--------------|----------------|
| 1.1-1.2 | general-purpose | 15K | 2 subagents |
| 1.3-1.4 | general-purpose | 15K | 2 subagents |
| 2.1-2.2 | general-purpose | 15K | 2 subagents |
| 2.3-2.4 | general-purpose | 15K | 2 subagents |
| 3.1-3.2 | general-purpose | 15K | 2 subagents |
| 3.3-3.4 | general-purpose | 15K | 2 subagents |
| 4.1-4.2 | general-purpose | 15K | 2 subagents |
| 4.3-4.4 | general-purpose | 15K | 2 subagents |
| 5.1-5.2 | general-purpose | 15K | 2 subagents |
| 5.3-5.4 | general-purpose | 15K | 2 subagents |
| 6.1-6.2 | Explore | 5K | 2 subagents |

### Execution Pattern

```python
# Deploy in parallel for each sub-phase
Task(subagent_type="general-purpose",
     prompt="Execute Phase 1.1-1.2 tasks from foundry_level_oda_upgrade.md",
     run_in_background=True)
Task(subagent_type="general-purpose",
     prompt="Execute Phase 1.3-1.4 tasks from foundry_level_oda_upgrade.md",
     run_in_background=True)
```

---

## Quick Resume After Auto-Compact

If context is compacted, resume by:

1. **Read this file:**
   ```
   Read(".agent/plans/foundry_level_oda_upgrade.md")
   ```

2. **Check TodoWrite for current task status**

3. **Find first PENDING phase/task in Progress Tracking table**

4. **Deploy subagents for that phase using Delegation Strategy**

5. **Update Progress Tracking after completion**

---

## Risk Register

| Risk | Severity | Mitigation |
|------|----------|------------|
| Schema migration data loss | HIGH | Backup before Phase 5 |
| Circular import after restructure | MEDIUM | Use TYPE_CHECKING pattern |
| Vector storage performance | MEDIUM | Benchmark before production |
| Transaction deadlocks | MEDIUM | Implement timeout + retry |
| Subagent output truncation | LOW | TaskDecomposer enforced |

---

## Critical File Paths

```yaml
# Core Files to Modify
modify:
  - lib/oda/ontology/registry.py
  - lib/oda/ontology/ontology_types.py
  - lib/oda/ontology/actions/__init__.py
  - lib/oda/ontology/storage/models.py
  - lib/oda/ontology/storage/repositories.py
  - lib/oda/memory/manager.py
  - lib/oda/simulation/core.py

# New Directories to Create
create:
  - lib/oda/ontology/types/
  - lib/oda/ontology/hooks/
  - lib/oda/ontology/versioning/
  - lib/oda/ontology/introspection/
  - lib/oda/semantic/
  - lib/oda/semantic/providers/
  - lib/oda/semantic/stores/
  - lib/oda/transaction/

# Test Files to Create
tests:
  - tests/ontology/test_link_registry.py
  - tests/ontology/test_object_types.py
  - tests/ontology/test_action_types.py
  - tests/semantic/test_semantic_search.py
  - tests/transaction/test_branching.py
```

---

## Evidence Requirements

Each phase completion requires:

```yaml
stage_a_evidence:
  files_viewed: [list of files read]
  complexity: "large"

stage_b_evidence:
  imports_verified: [new imports created]
  signatures_matched: [interface compliance]

stage_c_evidence:
  quality_checks:
    - name: "tests"
      status: "passed"
    - name: "lint"
      status: "passed"
    - name: "typecheck"
      status: "passed"
```

---

## Stage C: External Research Validation (COMPLETED)

### Sources Consulted

| Source | URL | Key Insights |
|--------|-----|--------------|
| Palantir ActionType Overview | [docs/action-types/overview](https://www.palantir.com/docs/foundry/action-types/overview) | Rules, validation, side effects, parameters |
| Palantir Semantic Search | [docs/ontology/overview-semantic-search](https://www.palantir.com/docs/foundry/ontology/overview-semantic-search) | Vector embeddings, semantic similarity |
| Palantir LinkType Create | [docs/object-link-types/create-link-type](https://www.palantir.com/docs/foundry/object-link-types/create-link-type) | Join table for M:N cardinality |
| Palantir OSDK Overview | [docs/ontology-sdk/overview](https://www.palantir.com/docs/foundry/ontology-sdk/overview) | Python/TypeScript SDK patterns |
| Palantir AIP Agent Studio | [docs/agent-studio/overview](https://www.palantir.com/docs/foundry/agent-studio/overview) | Agent + Ontology integration |
| Palantir Object Storage V2 | [docs/object-backend/overview](https://www.palantir.com/docs/foundry/object-backend/overview) | Incremental indexing, vector properties |

### Foundry Pattern Validation

**✅ Plan Alignment Confirmed:**

| Our Phase | Foundry Pattern | Validation Status |
|-----------|-----------------|-------------------|
| Phase 1: LinkType Registry | Join table for M:N cardinality | ✅ Matches Foundry docs |
| Phase 2: PropertyDefinition | Required/unique/default constraints | ✅ Matches Object Type schema |
| Phase 3: ActionType Side Effects | Notifications, webhooks, link creation | ✅ Official side effect types |
| Phase 4: Semantic Layer | Vector property + embedding models | ✅ Foundry Semantic Search pattern |
| Phase 5: Transaction | Branch creation with transaction_rid | ✅ OSDK transaction pattern |
| Phase 7: AI Agent Integration | AIP Agent Studio + Ontology context | ✅ Agent Studio capabilities |

### Key Foundry Insights Applied

1. **Semantic Search Architecture:**
   - Text → Vector embeddings (e.g., all-MiniLM-L6-v2, 384 dimensions)
   - Vector property type with dimension and similarity function
   - Object Storage V2 incremental indexing

2. **ActionType Side Effects (Official):**
   - Notifications: Alert stakeholders
   - Webhooks: External system integration
   - Link creation: Automatic relationship establishment

3. **AIP Agent Integration (2025):**
   - Agents receive Ontology context (ObjectTypes, Links, Actions)
   - Sandboxed execution with permission-based "control plane"
   - Proposals for async agent-to-human workflow

4. **OSDK Transaction Pattern:**
   - `transaction_rid` for branch tracking
   - OPEN/COMMITTED transaction states (never ABORTED)
   - Branch merge via SDK methods

---

## Approval Gate

- [ ] User approved this plan
- [ ] ODA governance validation passed
- [ ] Architecture reviewed
- [x] External research validation completed

---

> **Generated:** 2026-01-12 by /plan command
> **Method:** Dual-path analysis (ODA Protocol + Plan Subagent)
> **Scope:** Palantir Foundry/AIP Level Upgrade
> **Validated:** External Palantir documentation research (2026-01-12)

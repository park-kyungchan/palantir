# /plan Command Enhancement Plan

> **Version:** 1.0 | **Status:** IN_PROGRESS | **Date:** 2026-01-11
> **Auto-Compact Safe:** This file persists across context compaction

---

## Overview

| Item | Value |
|------|-------|
| Complexity | Large (4 phases) |
| Total Tasks | 7 |
| Files to Create | 2 |
| Files to Modify | 5 |
| Priority | P0 (Critical Path) |

---

## Problem Statement

현재 `/plan` 명령어의 한계:
1. TodoWrite 자동 생성 없음 - 수동 호출 필요
2. TaskDecomposer 미통합 - 대규모 작업 분할 안됨
3. `.agent/plans/*.md` 파일 자동 생성 안됨 - Auto-Compact 후 맥락 손실
4. Boris Cherny 병렬 패턴 미구현 - 순차 실행만 지원

---

## Phase 1: Persistent Plan File Generation (1 task)

### 1.1 Create plan file template
- **Purpose:** Auto-Compact 후에도 계획 유지
- **Output:** `.agent/plans/{plan_name}.md`
- **Template:**
```markdown
# {Plan Title}

> **Version:** 1.0 | **Status:** IN_PROGRESS | **Date:** {date}
> **Auto-Compact Safe:** This file persists across context compaction

## Overview
| Item | Value |
|------|-------|
| Complexity | {small|medium|large} |
| Total Tasks | {N} |

## Tasks
| # | Phase | Task | Status |
|---|-------|------|--------|
| 1 | 1 | {task_desc} | [ ] PENDING |

## Quick Resume After Auto-Compact
1. Read this file: `.agent/plans/{plan_name}.md`
2. Check TodoWrite for current status
3. Continue from first PENDING task
```
- **Status:** [ ] PENDING

---

## Phase 2: TaskDecomposer Integration (2 tasks)

### 2.1 Add TaskDecomposer to /plan skill
- **File:** `/home/palantir/.claude/commands/plan.md`
- **Changes:**
  - Import TaskDecomposer reference
  - Add scope keyword detection logic
  - Auto-decompose when FILE_THRESHOLD > 20 or DIR_THRESHOLD > 5
- **Status:** [ ] PENDING

### 2.2 Add auto-plan-file generation
- **File:** `/home/palantir/.claude/commands/plan.md`
- **Changes:**
  - Create `.agent/plans/{slug}.md` at plan start
  - Update progress in file during execution
  - Include Quick Resume section for Auto-Compact
- **Status:** [ ] PENDING

---

## Phase 3: Skill Refactoring (2 tasks)

### 3.1 Add parallel execution to pre-check skill
- **File:** `.claude/skills/pre-check.md`
- **Changes:**
  - Add `run_in_background=true` for Stage A/B
  - Deploy parallel Explore subagents for multiple targets
  - Reference TaskDecomposer for large scopes
- **Status:** [ ] PENDING

### 3.2 Refactor evidence-report for subagent delegation
- **File:** `.claude/skills/evidence-report.md`
- **Changes:**
  - Delegate report generation to general-purpose subagent
  - Add parallel support for multiple output formats
  - Remove direct Write operations
- **Status:** [ ] PENDING

---

## Phase 4: Integration & Verification (2 tasks)

### 4.1 Update CLAUDE.md orchestration section
- **File:** `/home/palantir/.claude/CLAUDE.md`
- **Changes:**
  - Add plan file auto-generation requirement
  - Document TaskDecomposer integration in skills
  - Update behavioral directives for plan persistence
- **Status:** [ ] PENDING

### 4.2 Verify all skills pass delegation compliance
- **Test:** Run delegation audit on all skills
- **Expected:** 100% compliance (all skills use Task delegation)
- **Status:** [ ] PENDING

---

## Progress Tracking

| Phase | Tasks | Completed | Status |
|-------|-------|-----------|--------|
| 1 | 1 | 0 | PENDING |
| 2 | 2 | 0 | PENDING |
| 3 | 2 | 0 | PENDING |
| 4 | 2 | 0 | PENDING |
| **Total** | **7** | **0** | **0%** |

---

## Execution Strategy

### Parallel Execution Groups

**Group A (Independent - can run in parallel):**
- Phase 2.1: TaskDecomposer integration
- Phase 3.1: pre-check parallel execution
- Phase 3.2: evidence-report refactoring

**Group B (Sequential - depends on Group A):**
- Phase 2.2: Auto-plan-file generation (depends on 2.1)
- Phase 4.1: CLAUDE.md update (depends on 2.1, 3.1, 3.2)
- Phase 4.2: Compliance verification (depends on all above)

### Subagent Delegation

| Task Group | Subagent Type | Context | Budget |
|------------|---------------|---------|--------|
| Phase 2.1 | general-purpose | fork | 15K |
| Phase 2.2 | general-purpose | fork | 10K |
| Phase 3.1, 3.2 | general-purpose | fork | 10K each |
| Phase 4.1, 4.2 | general-purpose | fork | 10K each |

---

## Quick Resume After Auto-Compact

If context is compacted, resume by:

1. Read this file: `.agent/plans/plan_command_enhancement.md`
2. Check TodoWrite for current task status
3. Continue from first PENDING task in sequence
4. Use subagent delegation pattern from "Execution Strategy" section

---

## Critical File Paths

```yaml
# Files to modify
modify:
  - /home/palantir/.claude/commands/plan.md
  - /home/palantir/.claude/CLAUDE.md
  - /home/palantir/park-kyungchan/palantir/.claude/skills/pre-check.md
  - /home/palantir/park-kyungchan/palantir/.claude/skills/evidence-report.md

# Reference files
reference:
  - lib/oda/planning/task_decomposer.py
  - .agent/plans/pre_mutation_zone_implementation.md (template)
```

---

## Key Implementation Details

### TaskDecomposer Integration Pattern

```python
# In /plan skill Step 2
from lib.oda.planning.task_decomposer import should_decompose_task, decompose_task

if should_decompose_task(requirements, scope):
    subtasks = decompose_task(requirements, scope, "Plan")
    for subtask in subtasks:
        Task(**subtask.to_task_params(), run_in_background=True)
else:
    # Single task execution
    Task(subagent_type="Plan", prompt=requirements)
```

### Auto Plan File Generation

```python
# Generate plan file slug from requirements
slug = requirements[:50].lower().replace(" ", "_").replace("/", "_")
plan_path = f".agent/plans/{slug}.md"

# Create plan file with template
with open(plan_path, "w") as f:
    f.write(PLAN_TEMPLATE.format(
        title=requirements[:100],
        date=datetime.now().isoformat(),
        complexity=estimated_complexity,
        tasks=formatted_tasks,
    ))
```

### Boris Cherny Parallel Pattern

```markdown
# In skill prompt
## Parallel Execution Requirement
MANDATORY: Deploy subagents with `run_in_background=true` when:
- 3+ independent analysis tasks
- 10+ files to analyze
- Multiple research queries

CORRECT:
Task(subagent_type="Explore", prompt="...", run_in_background=True)
Task(subagent_type="Plan", prompt="...", run_in_background=True)

WRONG:
result1 = Task(...)  # Blocks
result2 = Task(...)  # Sequential
```

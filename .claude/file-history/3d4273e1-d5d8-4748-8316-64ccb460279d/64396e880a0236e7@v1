"""
Orion ODA v3.0 - Hook Event Types
=================================

Defines HookEventType enum for Claude Code hook system integration.
Maps PAI hook events to ODA EventBus domain events.

Reference: PAI/Packs/pai-hook-system/config/settings-hooks.json
"""

from __future__ import annotations

from enum import Enum
from typing import Dict, Optional


class HookEventType(str, Enum):
    """
    Claude Code hook event types.

    These events are triggered by the Claude Code CLI at various lifecycle points.
    Each event type maps to an ODA EventBus domain event for integration.

    Lifecycle Events:
        - SessionStart: Triggered when a Claude session begins
        - SessionEnd: Triggered when a Claude session terminates

    Tool Events:
        - PreToolUse: Triggered BEFORE a tool is executed (can block/modify)
        - PostToolUse: Triggered AFTER a tool completes (for logging/side effects)

    Agent Events:
        - Stop: Triggered when the main agent stops
        - SubagentStop: Triggered when a subagent (Task) stops

    User Events:
        - UserPromptSubmit: Triggered when user submits a prompt

    Context Events:
        - PreCompact: Triggered BEFORE Auto-Compact (for context preservation)

    Permission Events:
        - PermissionRequest: Triggered when permission is requested

    Notification Events:
        - Notification: Triggered for notifications
    """

    # Lifecycle Events
    SESSION_START = "SessionStart"
    SESSION_END = "SessionEnd"
    PRE_COMPACT = "PreCompact"  # V2.1.x: Auto-Compact context preservation

    # Tool Events
    PRE_TOOL_USE = "PreToolUse"
    POST_TOOL_USE = "PostToolUse"

    # Agent Events
    STOP = "Stop"
    SUBAGENT_STOP = "SubagentStop"

    # User Events
    USER_PROMPT_SUBMIT = "UserPromptSubmit"

    @property
    def is_blocking(self) -> bool:
        """
        Returns True if this event type can block execution.

        Blocking events can modify or cancel the associated operation.
        Non-blocking events are for logging/observation only.
        """
        return self in (
            HookEventType.PRE_TOOL_USE,
            HookEventType.USER_PROMPT_SUBMIT,
        )

    @property
    def is_lifecycle(self) -> bool:
        """Returns True if this is a session lifecycle event."""
        return self in (
            HookEventType.SESSION_START,
            HookEventType.SESSION_END,
        )

    @property
    def is_tool_event(self) -> bool:
        """Returns True if this is a tool-related event."""
        return self in (
            HookEventType.PRE_TOOL_USE,
            HookEventType.POST_TOOL_USE,
        )

    @property
    def is_agent_event(self) -> bool:
        """Returns True if this is an agent-related event."""
        return self in (
            HookEventType.STOP,
            HookEventType.SUBAGENT_STOP,
        )

    def to_event_bus_type(self) -> str:
        """
        Convert to ODA EventBus event type format.

        Mapping:
            PreToolUse   -> Tool.pre_execute
            PostToolUse  -> Tool.post_execute
            Stop         -> Agent.stopped
            SubagentStop -> Subagent.stopped
            SessionStart -> Session.started
            SessionEnd   -> Session.ended
            UserPromptSubmit -> User.prompt_submitted
        """
        return HOOK_TO_EVENT_BUS_MAPPING.get(self, f"Hook.{self.value}")


# EventBus integration mapping
HOOK_TO_EVENT_BUS_MAPPING: Dict[HookEventType, str] = {
    HookEventType.PRE_TOOL_USE: "Tool.pre_execute",
    HookEventType.POST_TOOL_USE: "Tool.post_execute",
    HookEventType.STOP: "Agent.stopped",
    HookEventType.SUBAGENT_STOP: "Subagent.stopped",
    HookEventType.SESSION_START: "Session.started",
    HookEventType.SESSION_END: "Session.ended",
    HookEventType.USER_PROMPT_SUBMIT: "User.prompt_submitted",
}

# Reverse mapping for EventBus -> HookEventType
EVENT_BUS_TO_HOOK_MAPPING: Dict[str, HookEventType] = {
    v: k for k, v in HOOK_TO_EVENT_BUS_MAPPING.items()
}


def get_hook_event_type(event_bus_type: str) -> Optional[HookEventType]:
    """
    Convert an EventBus event type to HookEventType.

    Args:
        event_bus_type: EventBus event type (e.g., "Tool.pre_execute")

    Returns:
        Corresponding HookEventType or None if not mapped
    """
    return EVENT_BUS_TO_HOOK_MAPPING.get(event_bus_type)


def get_event_bus_type(hook_event: HookEventType) -> str:
    """
    Convert a HookEventType to EventBus event type.

    Args:
        hook_event: HookEventType enum value

    Returns:
        EventBus event type string
    """
    return hook_event.to_event_bus_type()

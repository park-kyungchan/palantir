---
description: |
  Run ODA 3-Stage Audit on target path using Explore subagent.
  Quick audit for standard analysis; use /deep-audit for intensive review.
  **[V2.1.7] ContextBudgetManager, Parallel Execution, Resume 지원.**
allowed-tools: Read, Grep, Glob, Bash, Task, TodoWrite
argument-hint: <target_path>

# V2.1.7 Features
v21x_features:
  context_budget_manager: true    # Check context before delegation
  parallel_execution: true        # Background subagents for large scopes
  resume_support: true            # Resume interrupted audits
  ultrathink_mode: false          # Quick audit uses standard mode
  task_decomposer: true           # Split large audits
---

# /audit Command (Optimized with Explore Subagent)

Execute comprehensive 3-Stage Protocol audit on specified target.
**Optimization:** Delegates to Explore subagent for efficient codebase analysis.

## Arguments
$ARGUMENTS - Path to audit (default: current workspace)

---

## Execution Strategy

### Step 0: Context Budget Check (V2.1.7 MANDATORY)

Before any delegation, verify context budget:

```python
# ContextBudgetManager ensures safe delegation
from lib.oda.planning.context_budget_manager import (
    ContextBudgetManager,
    ThinkingMode,
    DelegationDecision,
)

manager = ContextBudgetManager(thinking_mode=ThinkingMode.STANDARD)
decision = manager.check_before_delegation("Explore", estimated_tokens=5000)

if decision == DelegationDecision.PROCEED:
    # Safe to delegate
    pass
elif decision == DelegationDecision.REDUCE_SCOPE:
    # Apply TaskDecomposer to split audit
    from lib.oda.planning.task_decomposer import should_decompose_task, decompose_task
    if should_decompose_task("Audit target", "$ARGUMENTS"):
        subtasks = decompose_task(...)
        # Deploy parallel subagents (see below)
elif decision in [DelegationDecision.DEFER, DelegationDecision.ABORT]:
    # Suggest /compact before proceeding
    print("⚠️ Context usage high. Consider running /compact first.")
```

### Step 1: Task Decomposition Check (Large Scope)

For large targets, decompose into parallel subagents:

```python
from lib.oda.planning.task_decomposer import (
    TaskDecomposer,
    SubagentType,
    should_decompose_task,
)

# Check scope keywords: "전체", "모든", "all", "entire"
if should_decompose_task("Audit $ARGUMENTS", scope="$ARGUMENTS"):
    decomposer = TaskDecomposer()
    subtasks = decomposer.decompose("Audit", "$ARGUMENTS", SubagentType.EXPLORE)

    # Deploy parallel background audits (Boris Cherny pattern)
    for subtask in subtasks:
        Task(
            subagent_type="Explore",
            prompt=subtask.prompt,  # Includes output budget constraint
            description=f"Parallel audit: {subtask.description[:30]}",
            run_in_background=True,  # V2.1.7 Parallel Execution
        )
    # Wait for all subtasks before synthesis
```

### Step 2: Quick Audit (Default - Single Scope)

Uses `Task(subagent_type="Explore")` for fast, thorough scanning:

```python
Task(
    subagent_type="Explore",
    prompt="""
    Perform 3-Stage Audit on: $ARGUMENTS

    Stage A (SCAN):
    - Discover all files (Python, config, tests)
    - Map directory structure
    - Assess complexity (small/medium/large)

    Stage B (TRACE):
    - Verify import paths
    - Document public APIs
    - Map data flow between modules

    Stage C (VERIFY):
    - Check for blocked patterns (rm -rf, eval, etc.)
    - Validate type hints and docstrings
    - Score quality (1-10)

    ## Constraint: Output Budget (V2.1.7)
    YOUR OUTPUT MUST NOT EXCEED 5000 TOKENS.
    Return ONLY: Key findings, critical issues, summary.
    Format: Bullet points with file:line references.

    Return structured findings with file:line references.
    """,
    description="Explore audit on target"
)
```

### Deep Audit (For Complex Cases)
If quick audit reveals complexity=large, recommend:
```
→ Use /deep-audit $ARGUMENTS for intensive RSIL analysis
```

---

## Evidence Collection (V2.1.7 Enhanced)

This command automatically invokes evidence-collector agent with parallel execution:

```python
# Background evidence collection (V2.1.7 Parallel Pattern)
Task(
    subagent_type="evidence-collector",
    prompt="""
    Track audit evidence for: $ARGUMENTS

    Required Evidence:
    - files_viewed: Every examined file
    - lines_referenced: Specific line numbers for findings
    - code_snippets: Relevant excerpts

    ## Constraint: Output Budget
    YOUR OUTPUT MUST NOT EXCEED 5000 TOKENS.
    """,
    run_in_background=True,  # V2.1.7: Non-blocking execution
    description="Background evidence collection"
)
```

Evidence requirements:
- **files_viewed:** Every examined file logged
- **lines_referenced:** Specific line numbers for findings
- **code_snippets:** Relevant excerpts preserved

### Agent Registry for Resume (V2.1.7)

Track agent IDs for Auto-Compact recovery:

```python
# Store agent IDs for potential resume
audit_agents = {
    "explore_audit": None,      # Main audit agent
    "evidence_collector": None  # Background evidence agent
}

# After launching
result = Task(subagent_type="Explore", ...)
audit_agents["explore_audit"] = result.agent_id  # Store for resume

# After Auto-Compact, resume with:
Task(
    subagent_type="Explore",
    prompt="Continue audit from previous state",
    resume=audit_agents["explore_audit"],  # V2.1.7 Resume Parameter
    description="Resume interrupted audit"
)
```

---

## Output Format

```markdown
# Audit Report: $ARGUMENTS

## Summary
| Metric | Value |
|--------|-------|
| Files scanned | N |
| Complexity | small/medium/large |
| Critical findings | N |
| Quality score | X/10 |

## Stage A: SCAN
### Structure
[Directory tree visualization]

### Complexity Assessment
[Rating with justification]

## Stage B: TRACE
### Import Analysis
| Module | Status | Issues |
|--------|--------|--------|
| module.py | VALID | None |

### API Documentation
[Public interface summary]

## Stage C: VERIFY
### Findings
| Severity | Location | Description |
|----------|----------|-------------|
| HIGH | file.py:42 | Missing type hint |

### Quality Scores
- Code Quality: X/10
- Architecture: X/10
- Security: X/10

## Recommendations
1. [Priority recommendations]

## Next Steps
- [ ] Address HIGH findings
- [ ] Run /deep-audit if needed
- [ ] Update documentation
```

---

## Integration with Native Capabilities (V2.1.7)

| Capability | Usage | V2.1.7 Enhancement |
|------------|-------|-------------------|
| `Task(Explore)` | Primary audit engine | `run_in_background=True` for parallel |
| `Task(evidence-collector)` | Background evidence tracking | Non-blocking parallel execution |
| `Skill(oda-audit)` | Internal protocol (context: fork) | Isolated context for deep analysis |
| `TodoWrite` | Stage progress tracking | Auto-Compact recovery support |
| `ContextBudgetManager` | Context usage check | Pre-delegation verification |
| `TaskDecomposer` | Large scope splitting | 32K output budget compliance |
| `Resume Parameter` | Auto-Compact recovery | Continue interrupted audits |

### V2.1.7 Subagent Budget Allocation

| Mode | Explore Budget | Evidence Budget | Total |
|------|---------------|-----------------|-------|
| STANDARD | 5,000 tokens | 3,000 tokens | 8,000 |
| ULTRATHINK | 15,000 tokens | 8,000 tokens | 23,000 |

### Parallel Execution Pattern (Boris Cherny)

```python
# CORRECT: Deploy independent agents in parallel
Task(subagent_type="Explore", ..., run_in_background=True)  # Audit
Task(subagent_type="evidence-collector", ..., run_in_background=True)  # Evidence

# WRONG: Sequential blocking
result1 = Task(...)  # Blocks
result2 = Task(...)  # Waits - inefficient
```

---

## Comparison: /audit vs /deep-audit

| Aspect | /audit | /deep-audit |
|--------|--------|-------------|
| Speed | Fast (Explore agent) | Thorough (RSIL method) |
| Depth | Standard analysis | Microscopic review |
| Use case | Regular checks | Pre-merge validation |
| Evidence | Automatic | Mandatory with BLOCK |

---

## Example Usage

```
/audit scripts/ontology/        # Audit specific directory
/audit .                        # Audit current workspace
/audit hwpx/                    # Audit sibling project
```

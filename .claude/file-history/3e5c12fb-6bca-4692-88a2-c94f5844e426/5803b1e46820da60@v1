"""
Unit tests for JSON Schema Exporter.

Tests cover:
- JsonSchemaExporter class methods
- Module-level convenience functions
- Type mapping from ontology types to JSON Schema types
- Schema generation for ObjectTypes
- File export operations
"""

import json
import tempfile
from pathlib import Path

import pytest

from ontology_definition import (
    DataType,
    DataTypeSpec,
    ObjectType,
    PrimaryKeyDefinition,
    PropertyConstraints,
    PropertyDefinition,
)
from ontology_definition.export.json_schema_exporter import (
    JsonSchemaExporter,
    export_instance_schemas,
    generate_instance_schema,
)
from ontology_definition.registry import OntologyRegistry, get_registry


@pytest.fixture(autouse=True)
def reset_registry():
    """Reset registry before and after each test."""
    OntologyRegistry.reset_instance()
    yield
    OntologyRegistry.reset_instance()


@pytest.fixture
def sample_object_type():
    """Create a sample ObjectType for testing."""
    return ObjectType(
        api_name="Employee",
        display_name="Employee",
        description="A company employee.",
        primary_key=PrimaryKeyDefinition(property_api_name="employeeId"),
        properties=[
            PropertyDefinition(
                api_name="employeeId",
                display_name="Employee ID",
                data_type=DataTypeSpec(type=DataType.STRING),
                constraints=PropertyConstraints(required=True, unique=True),
            ),
            PropertyDefinition(
                api_name="name",
                display_name="Name",
                data_type=DataTypeSpec(type=DataType.STRING),
                constraints=PropertyConstraints(required=True),
            ),
            PropertyDefinition(
                api_name="age",
                display_name="Age",
                data_type=DataTypeSpec(type=DataType.INTEGER),
            ),
            PropertyDefinition(
                api_name="salary",
                display_name="Salary",
                data_type=DataTypeSpec(type=DataType.DOUBLE),
            ),
            PropertyDefinition(
                api_name="isActive",
                display_name="Is Active",
                data_type=DataTypeSpec(type=DataType.BOOLEAN),
            ),
            PropertyDefinition(
                api_name="hireDate",
                display_name="Hire Date",
                data_type=DataTypeSpec(type=DataType.DATE),
            ),
        ],
    )


class TestJsonSchemaExporterInit:
    """Tests for JsonSchemaExporter initialization."""

    def test_default_init(self):
        """Default initialization should work."""
        exporter = JsonSchemaExporter()
        assert exporter._schema_id_base == "https://ontology.palantir.local/schemas"
        assert exporter._draft_version == "2020-12"

    def test_custom_init(self):
        """Custom initialization should work."""
        exporter = JsonSchemaExporter(
            schema_id_base="https://example.com/schemas",
            draft_version="2019-09",
        )
        assert exporter._schema_id_base == "https://example.com/schemas"
        assert exporter._draft_version == "2019-09"


class TestJsonSchemaExporterTypeMapping:
    """Tests for type mapping in JSON Schema generation."""

    def test_type_mapping_exists(self):
        """TYPE_MAPPING should have all expected types."""
        expected_types = [
            "STRING", "BOOLEAN", "INTEGER", "LONG", "FLOAT", "DOUBLE",
            "DECIMAL", "DATE", "TIMESTAMP", "BYTE", "SHORT", "BINARY",
            "ATTACHMENT", "GEOHASH", "GEOPOINT", "GEOSHAPE", "TIMESERIES",
            "ARRAY", "STRUCT", "OBJECT_REFERENCE", "MARKING",
        ]

        for data_type in expected_types:
            assert data_type in JsonSchemaExporter.TYPE_MAPPING, f"Missing type: {data_type}"

    def test_string_type_mapping(self):
        """STRING should map to JSON Schema string type."""
        mapping = JsonSchemaExporter.TYPE_MAPPING["STRING"]
        assert mapping == {"type": "string"}

    def test_integer_type_mapping(self):
        """INTEGER should map to JSON Schema integer type."""
        mapping = JsonSchemaExporter.TYPE_MAPPING["INTEGER"]
        assert mapping == {"type": "integer"}

    def test_boolean_type_mapping(self):
        """BOOLEAN should map to JSON Schema boolean type."""
        mapping = JsonSchemaExporter.TYPE_MAPPING["BOOLEAN"]
        assert mapping == {"type": "boolean"}

    def test_double_type_mapping(self):
        """DOUBLE should map to JSON Schema number with format."""
        mapping = JsonSchemaExporter.TYPE_MAPPING["DOUBLE"]
        assert mapping["type"] == "number"
        assert mapping["format"] == "double"

    def test_timestamp_type_mapping(self):
        """TIMESTAMP should map to JSON Schema string with date-time format."""
        mapping = JsonSchemaExporter.TYPE_MAPPING["TIMESTAMP"]
        assert mapping["type"] == "string"
        assert mapping["format"] == "date-time"

    def test_geopoint_type_mapping(self):
        """GEOPOINT should map to JSON Schema object with lat/lon properties."""
        mapping = JsonSchemaExporter.TYPE_MAPPING["GEOPOINT"]
        assert mapping["type"] == "object"
        assert "latitude" in mapping["properties"]
        assert "longitude" in mapping["properties"]
        assert "latitude" in mapping["required"]
        assert "longitude" in mapping["required"]


class TestGenerateInstanceSchema:
    """Tests for generate_instance_schema method."""

    def test_generate_basic_schema(self, sample_object_type):
        """Should generate valid JSON Schema structure."""
        exporter = JsonSchemaExporter()
        schema = exporter.generate_instance_schema(sample_object_type)

        assert "$schema" in schema
        assert schema["type"] == "object"
        assert "properties" in schema
        assert "required" in schema

    def test_schema_id_and_title(self, sample_object_type):
        """Should include $id and title from ObjectType."""
        exporter = JsonSchemaExporter()
        schema = exporter.generate_instance_schema(sample_object_type)

        assert "$id" in schema
        assert "Employee.schema.json" in schema["$id"]
        assert schema["title"] == "Employee"
        assert schema["description"] == "A company employee."

    def test_schema_without_metadata(self, sample_object_type):
        """Should generate schema without metadata when requested."""
        exporter = JsonSchemaExporter()
        schema = exporter.generate_instance_schema(sample_object_type, include_metadata=False)

        assert "$id" not in schema
        assert "title" not in schema
        assert "description" not in schema

    def test_properties_generated(self, sample_object_type):
        """Should generate properties from ObjectType."""
        exporter = JsonSchemaExporter()
        schema = exporter.generate_instance_schema(sample_object_type)

        properties = schema["properties"]
        assert "employeeId" in properties
        assert "name" in properties
        assert "age" in properties
        assert "salary" in properties
        assert "isActive" in properties
        assert "hireDate" in properties

    def test_property_types(self, sample_object_type):
        """Property types should be mapped correctly."""
        exporter = JsonSchemaExporter()
        schema = exporter.generate_instance_schema(sample_object_type)

        properties = schema["properties"]
        assert properties["employeeId"]["type"] == "string"
        assert properties["name"]["type"] == "string"
        assert properties["age"]["type"] == "integer"
        assert properties["salary"]["type"] == "number"
        assert properties["isActive"]["type"] == "boolean"
        assert properties["hireDate"]["type"] == "string"
        assert properties["hireDate"]["format"] == "date"

    def test_required_properties(self, sample_object_type):
        """Required properties should be listed."""
        exporter = JsonSchemaExporter()
        schema = exporter.generate_instance_schema(sample_object_type)

        required = schema["required"]
        # employeeId and name are required, plus primary key is always required
        assert "employeeId" in required
        assert "name" in required

    def test_primary_key_always_required(self):
        """Primary key should always be required even if not marked."""
        obj = ObjectType(
            api_name="Test",
            display_name="Test",
            primary_key=PrimaryKeyDefinition(property_api_name="id"),
            properties=[
                PropertyDefinition(
                    api_name="id",
                    display_name="ID",
                    data_type=DataTypeSpec(type=DataType.STRING),
                    # Not explicitly required
                ),
            ],
        )

        exporter = JsonSchemaExporter()
        schema = exporter.generate_instance_schema(obj)

        assert "id" in schema["required"]

    def test_additional_properties_false(self, sample_object_type):
        """additionalProperties should be false."""
        exporter = JsonSchemaExporter()
        schema = exporter.generate_instance_schema(sample_object_type)

        assert schema["additionalProperties"] is False


class TestGenerateAllInstanceSchemas:
    """Tests for generate_all_instance_schemas method."""

    def test_generate_empty_registry(self):
        """Should return empty dict for empty registry."""
        exporter = JsonSchemaExporter()
        schemas = exporter.generate_all_instance_schemas()

        assert schemas == {}

    def test_generate_with_registry(self, sample_object_type):
        """Should generate schemas for all types in registry."""
        registry = get_registry()
        registry.register_object_type(sample_object_type)

        exporter = JsonSchemaExporter()
        schemas = exporter.generate_all_instance_schemas(registry)

        assert "Employee" in schemas
        assert schemas["Employee"]["type"] == "object"

    def test_generate_multiple_types(self):
        """Should generate schemas for multiple ObjectTypes."""
        registry = get_registry()

        for name in ["TypeA", "TypeB", "TypeC"]:
            obj = ObjectType(
                api_name=name,
                display_name=name,
                primary_key=PrimaryKeyDefinition(property_api_name="id"),
                properties=[
                    PropertyDefinition(
                        api_name="id",
                        display_name="ID",
                        data_type=DataTypeSpec(type=DataType.STRING),
                    ),
                ],
            )
            registry.register_object_type(obj)

        exporter = JsonSchemaExporter()
        schemas = exporter.generate_all_instance_schemas(registry)

        assert len(schemas) == 3
        assert "TypeA" in schemas
        assert "TypeB" in schemas
        assert "TypeC" in schemas


class TestExportInstanceSchema:
    """Tests for export_instance_schema method."""

    def test_export_to_file(self, sample_object_type):
        """Should export schema to file."""
        with tempfile.NamedTemporaryFile(suffix=".json", delete=False, mode="w") as f:
            path = Path(f.name)

        try:
            exporter = JsonSchemaExporter()
            result_path = exporter.export_instance_schema(sample_object_type, path)

            assert result_path == path
            assert path.exists()

            # Verify content
            content = json.loads(path.read_text())
            assert content["type"] == "object"
            assert "Employee" in content["$id"]
        finally:
            path.unlink()

    def test_export_creates_valid_json(self, sample_object_type):
        """Exported file should be valid JSON."""
        with tempfile.NamedTemporaryFile(suffix=".json", delete=False, mode="w") as f:
            path = Path(f.name)

        try:
            exporter = JsonSchemaExporter()
            exporter.export_instance_schema(sample_object_type, path)

            # Should not raise
            content = json.loads(path.read_text())
            assert isinstance(content, dict)
        finally:
            path.unlink()


class TestExportAllInstanceSchemas:
    """Tests for export_all_instance_schemas method."""

    def test_export_creates_directory(self, sample_object_type):
        """Should create output directory if needed."""
        registry = get_registry()
        registry.register_object_type(sample_object_type)

        with tempfile.TemporaryDirectory() as tmpdir:
            output_dir = Path(tmpdir) / "nested" / "schemas"

            exporter = JsonSchemaExporter()
            exporter.export_all_instance_schemas(output_dir, registry)

            assert output_dir.exists()

    def test_export_creates_files(self, sample_object_type):
        """Should create schema files for all types."""
        registry = get_registry()
        registry.register_object_type(sample_object_type)

        with tempfile.TemporaryDirectory() as tmpdir:
            output_dir = Path(tmpdir)

            exporter = JsonSchemaExporter()
            created_files = exporter.export_all_instance_schemas(output_dir, registry)

            assert len(created_files) == 1
            assert created_files[0].name == "Employee.schema.json"
            assert created_files[0].exists()

    def test_export_multiple_files(self):
        """Should create multiple files for multiple types."""
        registry = get_registry()

        for name in ["TypeA", "TypeB"]:
            obj = ObjectType(
                api_name=name,
                display_name=name,
                primary_key=PrimaryKeyDefinition(property_api_name="id"),
                properties=[
                    PropertyDefinition(
                        api_name="id",
                        display_name="ID",
                        data_type=DataTypeSpec(type=DataType.STRING),
                    ),
                ],
            )
            registry.register_object_type(obj)

        with tempfile.TemporaryDirectory() as tmpdir:
            output_dir = Path(tmpdir)

            exporter = JsonSchemaExporter()
            created_files = exporter.export_all_instance_schemas(output_dir, registry)

            assert len(created_files) == 2
            file_names = {f.name for f in created_files}
            assert "TypeA.schema.json" in file_names
            assert "TypeB.schema.json" in file_names


class TestGenerateCombinedSchema:
    """Tests for generate_combined_schema method."""

    def test_combined_schema_structure(self, sample_object_type):
        """Should generate combined schema with $defs."""
        registry = get_registry()
        registry.register_object_type(sample_object_type)

        exporter = JsonSchemaExporter()
        schema = exporter.generate_combined_schema(registry)

        assert "$schema" in schema
        assert "$id" in schema
        assert "ontology.schema.json" in schema["$id"]
        assert schema["title"] == "Ontology Instance Schemas"
        assert "$defs" in schema

    def test_combined_schema_includes_types(self, sample_object_type):
        """Should include all types in $defs."""
        registry = get_registry()
        registry.register_object_type(sample_object_type)

        exporter = JsonSchemaExporter()
        schema = exporter.generate_combined_schema(registry)

        assert "Employee" in schema["$defs"]
        assert schema["$defs"]["Employee"]["type"] == "object"
        assert schema["$defs"]["Employee"]["title"] == "Employee"

    def test_combined_schema_empty_registry(self):
        """Should handle empty registry."""
        exporter = JsonSchemaExporter()
        schema = exporter.generate_combined_schema()

        assert schema["$defs"] == {}


class TestConvenienceFunctions:
    """Tests for module-level convenience functions."""

    def test_generate_instance_schema_function(self, sample_object_type):
        """generate_instance_schema function should work."""
        schema = generate_instance_schema(sample_object_type)

        assert schema["type"] == "object"
        assert "properties" in schema

    def test_export_instance_schemas_function(self, sample_object_type):
        """export_instance_schemas function should work."""
        registry = get_registry()
        registry.register_object_type(sample_object_type)

        with tempfile.TemporaryDirectory() as tmpdir:
            output_dir = Path(tmpdir)
            created_files = export_instance_schemas(output_dir, registry)

            assert len(created_files) == 1
            assert created_files[0].exists()


class TestSchemaDialect:
    """Tests for schema dialect handling."""

    def test_default_dialect(self):
        """Should use 2020-12 draft by default."""
        exporter = JsonSchemaExporter()
        dialect = exporter._get_schema_dialect()

        assert "2020-12" in dialect

    def test_custom_dialect(self):
        """Should support custom draft versions."""
        exporter = JsonSchemaExporter(draft_version="2019-09")
        dialect = exporter._get_schema_dialect()

        assert "2019-09" in dialect

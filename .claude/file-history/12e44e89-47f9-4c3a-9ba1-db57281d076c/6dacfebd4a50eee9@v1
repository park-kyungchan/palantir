# L1/L2 Runtime Integration Plan

> **Version:** 1.0 | **Status:** PENDING_APPROVAL | **Date:** 2026-01-19
> **Auto-Compact Safe:** This file persists across context compaction
> **Draft Reference:** `.agent/plans/draft_runtime_integration.md`

---

## Overview

| Item | Value |
|------|-------|
| Complexity | medium |
| Total Tasks | 10 |
| Files Affected | 4 (2 modify, 2 create) |
| Estimated Time | ~3 hours |

---

## Executive Summary

**목표:** 이전 세션에서 구현된 L1/L2 Orchestrating Loop ODA 정의(15개 JSON + 6개 Hook 스크립트)를 실제 런타임에 통합하여 완전 자동화된 L1/L2 분리 시스템 구축.

**핵심 기술:** Claude Code의 `PreToolUse` Hook에서 `updatedInput` 기능을 활용하여 모든 Task() 호출에 `run_in_background=true`를 자동 주입.

---

## Dual-Path Analysis Synthesis

### Path 1: ODA Protocol Analysis (ab90284)

| Stage | Key Findings |
|-------|--------------|
| Stage A: BLUEPRINT | 15 JSON + 6 Hooks 존재, settings.json에 TODO placeholder 발견 |
| Stage B: INTEGRATION | Hook chain architecture 설계, state path 불일치 발견 |
| Stage C: QUALITY GATE | 5단계 구현 계획, verification checklist 제공 |

**Critical Gap:** `.claude/settings.json`의 TODO placeholder가 hook 실행을 차단 중

### Path 2: Architectural Analysis (a671381)

| Aspect | Recommendation |
|--------|----------------|
| Implementation | Python hook (Option A) - 안정적인 JSON 처리 |
| Risk Mitigation | `updatedInput` 버전 체크 + WARN 모드 fallback |
| Phase Priority | Hook Creation → Config Update → State Init → Validation |

**Recommendation:** Phase 1 (force_background.py + settings.json)이 최고 우선순위

---

## Optimal Synthesis

### Implementation Phases

| Phase | Task | Priority | Status |
|-------|------|----------|--------|
| 1 | Hook 파일 생성 (force_background.py) | CRITICAL | ⏳ PENDING |
| 2 | settings.json TODO 교체 | CRITICAL | ⏳ PENDING |
| 3 | State 디렉토리 및 파일 생성 | HIGH | ⏳ PENDING |
| 4 | orchestration-loop.sh state path 수정 | HIGH | ⏳ PENDING |
| 5 | End-to-End 테스트 | CRITICAL | ⏳ PENDING |

---

## Tasks

| # | Phase | Task | Status |
|---|-------|------|--------|
| 1.1 | Phase 1 | Create `.claude/hooks/l1l2/force_background.py` | ⏳ PENDING |
| 2.1 | Phase 2 | Update `.claude/settings.json` (remove TODO) | ⏳ PENDING |
| 3.1 | Phase 3 | Create `.agent/state/` directory | ⏳ PENDING |
| 3.2 | Phase 3 | Create `.agent/state/orchestration.json` | ⏳ PENDING |
| 4.1 | Phase 4 | Update `orchestration-loop.sh` state path | ⏳ PENDING |
| 4.2 | Phase 4 | Update `orchestration_manager.py` state path | ⏳ PENDING |
| 5.1 | Phase 5 | Manual single Task() test | ⏳ PENDING |
| 5.2 | Phase 5 | Parallel Task() test (3+ subagents) | ⏳ PENDING |
| 5.3 | Phase 5 | L1 format validation test | ⏳ PENDING |
| 5.4 | Phase 5 | Auto-Compact recovery test | ⏳ PENDING |

---

## Critical File Paths

```yaml
# Files to CREATE
new_files:
  - .claude/hooks/l1l2/force_background.py     # Core: updatedInput injection
  - .agent/state/orchestration.json            # Phase state management

# Files to MODIFY
modify_files:
  - .claude/settings.json                       # Hook wiring (TODO removal)
  - .claude/hooks/l1l2/orchestration-loop.sh   # State path update
  - .claude/hooks/l1l2/orchestration_manager.py # State path update

# Reference files (read-only)
reference_files:
  - .agent/plans/draft_runtime_integration.md   # Q&A decisions
  - .agent/plans/l1_l2_orchestrating_loop.md    # Phase 1-5 original plan
```

---

## Implementation Details

### Task 1.1: force_background.py

```python
#!/usr/bin/env python3
"""Force run_in_background=true on all Task() calls via PreToolUse hook."""
import json
import sys

input_data = json.load(sys.stdin)
tool_name = input_data.get("tool_name", "")

if tool_name == "Task":
    current_input = input_data.get("tool_input", {})
    output = {
        "hookSpecificOutput": {
            "hookEventName": "PreToolUse",
            "permissionDecision": "allow",
            "updatedInput": {
                **current_input,
                "run_in_background": True
            }
        }
    }
    print(json.dumps(output))
else:
    print(json.dumps({
        "hookSpecificOutput": {
            "hookEventName": "PreToolUse",
            "permissionDecision": "allow"
        }
    }))

sys.exit(0)
```

### Task 2.1: settings.json Target

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "python3 .claude/hooks/l1l2/force_background.py"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": ".claude/hooks/l1l2/post-task-output.sh"
          }
        ]
      }
    ]
  }
}
```

### Task 3.2: orchestration.json Initial State

```json
{
  "phase": "init",
  "iteration": 0,
  "completedPhases": [],
  "pendingL2Refs": [],
  "lastUpdated": "2026-01-19T19:00:00+09:00",
  "activeAgents": {}
}
```

---

## Risk Register

| Risk | Severity | Mitigation |
|------|----------|------------|
| `updatedInput` not supported | HIGH | Version check + WARN fallback |
| Hook chain ordering conflict | MEDIUM | Separate matchers (ODA=Edit/Write, L1L2=Task) |
| State file corruption | MEDIUM | flock + atomic writes |
| L1 format false negatives | MEDIUM | Strict YAML parsing + warnings |

---

## Progress Tracking

| Phase | Tasks | Completed | Status |
|-------|-------|-----------|--------|
| Phase 1: Hook Creation | 1 | 0 | ⏳ PENDING |
| Phase 2: Config Update | 1 | 0 | ⏳ PENDING |
| Phase 3: State Setup | 2 | 0 | ⏳ PENDING |
| Phase 4: Path Updates | 2 | 0 | ⏳ PENDING |
| Phase 5: Testing | 4 | 0 | ⏳ PENDING |

---

## Quick Resume After Auto-Compact

If context is compacted, resume by:

1. Read this file: `.agent/plans/l1_l2_runtime_integration.md`
2. Check TodoWrite for current task status
3. Continue from first PENDING task in sequence
4. Reference draft for Q&A decisions: `.agent/plans/draft_runtime_integration.md`

---

## Execution Strategy

### Subagent Delegation

| Task Group | Subagent Type | Budget |
|------------|---------------|--------|
| File creation (1.1, 3.2) | general-purpose | 5K each |
| Config update (2.1) | general-purpose | 3K |
| Path updates (4.1, 4.2) | general-purpose | 5K each |
| Testing (5.x) | general-purpose | 10K total |

---

## Acceptance Criteria

- [ ] `force_background.py` exists and is executable
- [ ] `settings.json` has no TODO strings
- [ ] `.agent/state/orchestration.json` exists
- [ ] State paths consistent across all hook scripts
- [ ] Single Task() test passes (L1 output returned)
- [ ] Parallel Task() test passes (3+ subagents)
- [ ] L1 format validation catches malformed output

---

## Approval Gate

**Question:** 이 구현 계획을 승인하시겠습니까?

- [ ] ODA governance passed (기존 ODA 정의와 일관성)
- [ ] Architecture reviewed (Dual-Path 분석 결과 반영)
- [ ] User approved

---

## Metadata

- Created: 2026-01-19T19:11:00+09:00
- Draft Reference: draft_runtime_integration.md
- Previous Plan: l1_l2_orchestrating_loop.md (COMPLETED)
- Analysis Agents: ab90284 (ODA Protocol), a671381 (Architecture)

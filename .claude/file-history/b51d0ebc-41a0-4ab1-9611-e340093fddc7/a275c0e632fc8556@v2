# =============================================================================
# Worker Task: Terminal-B - Session Registry Implementation
# =============================================================================
# Read this file AFTER reading _context.yaml
#
# Location: .agent/prompts/worker-b-task.yaml
# Language: English (Machine-Readable)
# =============================================================================

taskId: "phase1-session-registry"
assignedTo: "Terminal-B"
orchestrator: "Terminal-A"
createdAt: "2026-01-24T00:30:00Z"

# =============================================================================
# CONTEXT REFERENCE
# =============================================================================
contextFile: ".agent/prompts/_context.yaml"
progressFile: ".agent/prompts/_progress.yaml"

# =============================================================================
# MY SCOPE
# =============================================================================
scope:
  phaseId: "phase1"
  phaseName: "Session Registry Implementation"

  description: |
    Implement file-based session ID registry in session-start.sh.
    This replaces the ineffective environment variable export.

# =============================================================================
# TARGET FILES (I can MODIFY these)
# =============================================================================
targetFiles:
  - path: ".claude/hooks/session-start.sh"
    readOnly: false
    modifications:
      - location: "After line 301 (after session state JSON creation)"
        action: "ADD current_session.json creation"
        code: |
          # Write current session to file registry (for cross-hook access)
          CURRENT_SESSION_FILE="$AGENT_TMP_DIR/current_session.json"
          cat > "$CURRENT_SESSION_FILE" << SESSION_EOF
          {
            "sessionId": "$SESSION_ID",
            "startTime": "$TIMESTAMP",
            "pid": "$$",
            "status": "active"
          }
          SESSION_EOF

      - location: "After mkdir for sessions directory"
        action: "ADD prompts directory initialization"
        code: |
          # Create prompts directories for worker task files
          mkdir -p "${WORKSPACE_ROOT}/.agent/prompts/pending" 2>/dev/null
          mkdir -p "${WORKSPACE_ROOT}/.agent/prompts/active" 2>/dev/null
          mkdir -p "${WORKSPACE_ROOT}/.agent/prompts/completed" 2>/dev/null

# =============================================================================
# REFERENCE FILES (I can only READ these)
# =============================================================================
referenceFiles:
  - path: ".claude/hooks/session-end.sh"
    reason: "See pattern for updating session status to 'completed'"
  - path: ".claude/hooks/session-health.sh"
    reason: "See how SESSION_ID is currently used (falls back to 'unknown')"

# =============================================================================
# DEPENDENCIES
# =============================================================================
dependencies: []
blockedBy: []
canStartImmediately: true

# =============================================================================
# COMPLETION CRITERIA
# =============================================================================
completionCriteria:
  required:
    - "current_session.json is created at ~/.agent/tmp/ on session start"
    - "JSON contains: sessionId, startTime, pid, status fields"
    - ".agent/prompts/{pending,active,completed} directories are created"

  verification:
    - command: "cat ~/.agent/tmp/current_session.json"
      expected: "Valid JSON with sessionId field"
    - command: "ls -la .agent/prompts/"
      expected: "pending/, active/, completed/ directories exist"

# =============================================================================
# GLOBAL CONTEXT CONSIDERATIONS
# =============================================================================
# Before implementing, think about these from _context.yaml:
globalContextChecklist:
  - question: "Does my implementation add < 5ms overhead?"
    consideration: "Use cat heredoc instead of jq for JSON creation (faster)"

  - question: "Am I compatible with existing session state?"
    consideration: "current_session.json is ADDITIONAL, not replacing session_*.json"

  - question: "What if prompts directory already exists?"
    consideration: "mkdir -p is idempotent, no error if exists"

  - question: "Should I update session-end.sh to set status='completed'?"
    consideration: "OUT OF SCOPE for phase1, but note for phase3 or future"

# =============================================================================
# OUTPUT FORMAT
# =============================================================================
outputFormat: "L1/L2/L3"
l2OutputPath: ".agent/outputs/Explore/phase1-session-registry.md"

# =============================================================================
# ON COMPLETE
# =============================================================================
onComplete:
  - "Update .agent/prompts/_progress.yaml: terminal-b.status = 'completed'"
  - "Update .agent/prompts/_progress.yaml: terminal-b.completedAt = <timestamp>"
  - "Report to Orchestrator (Terminal-A) with L1 summary"
  - "Notify Terminal-C that phase1 is complete (unblocks phase2)"

# =============================================================================
# Global Context for Session-Aware Worker Prompt System
# =============================================================================
# This file provides the BIG PICTURE for all Workers.
# Every Worker MUST read this file BEFORE starting their task.
#
# Location: .agent/prompts/_context.yaml
# Language: English (Machine-Readable)
# =============================================================================

version: "1.0"
project: "session-aware-worker-prompt-system"
orchestrator: "Terminal-A"
createdAt: "2026-01-24T00:30:00Z"
lastUpdated: "2026-01-24T00:30:00Z"

# =============================================================================
# PROJECT OBJECTIVES (Why are we doing this?)
# =============================================================================
objectives:
  primary:
    - "Enable session tracking via file-based CLAUDE_SESSION_ID registry"
    - "Implement Machine-Readable worker prompt files (YAML format)"
    - "Optimize Orchestrator workflow: Main Agent creates → Worker reads"

  constraints:
    - "Performance overhead must be < 5ms"
    - "Must be compatible with existing L1/L2/L3 caching"
    - "Must not break existing pd-task-interceptor.sh / pd-task-processor.sh"

# =============================================================================
# ARCHITECTURE OVERVIEW
# =============================================================================
architecture:
  sessionRegistry:
    description: "File-based session ID storage (replaces env var export)"
    location: "~/.agent/tmp/current_session.json"
    format: "JSON"
    fields:
      - sessionId
      - startTime
      - pid
      - status

  promptFiles:
    description: "Worker task files in YAML format"
    baseDirectory: ".agent/prompts/"
    structure:
      pending: "Tasks waiting to be picked up"
      active: "Tasks currently being processed"
      completed: "Archived tasks (audit trail)"

  lifecycle:
    flow: "pending → active → completed"
    managedBy: "pd-task-processor.sh"

# =============================================================================
# IMPLEMENTATION PHASES
# =============================================================================
phases:
  phase1:
    id: "phase1"
    name: "Session Registry Implementation"
    description: "Create current_session.json and prompts directory structure"
    owner: "Terminal-B"
    status: "pending"
    priority: "P0"

    targetFiles:
      - path: ".claude/hooks/session-start.sh"
        action: "MODIFY"
        sections:
          - "Line 301+: Add current_session.json creation"
          - "Add prompts directory initialization"

    dependencies: []
    blockedBy: []

    deliverables:
      - "current_session.json created on session start"
      - ".agent/prompts/ directories created"

    verificationSteps:
      - "Start new Claude session"
      - "Check: cat ~/.agent/tmp/current_session.json"
      - "Check: ls -la .agent/prompts/"

  phase2:
    id: "phase2"
    name: "Prompt File Generation"
    description: "Read session ID from file, generate worker prompt YAML files"
    owner: "Terminal-C"
    status: "pending"
    priority: "P1"

    targetFiles:
      - path: ".claude/hooks/task-pipeline/pd-task-interceptor.sh"
        action: "MODIFY"
        sections:
          - "Line 160+: Add session ID file reading"
          - "Line 290+: Add create_worker_prompt_file() function"
          - "Line 374+: Add workerPromptFile to hook output"

    dependencies:
      - "phase1"
    blockedBy:
      - "phase1"

    deliverables:
      - "Session ID read from current_session.json"
      - "YAML prompt files created in .agent/prompts/pending/"

    verificationSteps:
      - "Run Task subagent"
      - "Check: ls -la .agent/prompts/pending/"
      - "Verify YAML structure"

  phase3:
    id: "phase3"
    name: "Prompt Lifecycle Management"
    description: "Move prompt files through lifecycle stages"
    owner: "Terminal-D"
    status: "pending"
    priority: "P2"

    targetFiles:
      - path: ".claude/hooks/task-pipeline/pd-task-processor.sh"
        action: "MODIFY"
        sections:
          - "Line 270+: Add prompt file lifecycle management"

    dependencies:
      - "phase2"
    blockedBy:
      - "phase2"

    deliverables:
      - "Prompt files moved: pending → completed"
      - "Audit trail maintained"

    verificationSteps:
      - "Complete a Task"
      - "Check: ls -la .agent/prompts/completed/"

# =============================================================================
# DEPENDENCY GRAPH
# =============================================================================
dependencyGraph: |
  phase1 (Terminal-B)
      │
      ▼
  phase2 (Terminal-C)
      │
      ▼
  phase3 (Terminal-D)

# =============================================================================
# GLOBAL CONSIDERATIONS (Workers MUST think about these)
# =============================================================================
globalConsiderations:
  performance:
    - "Every file read adds latency - minimize I/O"
    - "Use jq if available (faster than python3)"
    - "Cache session ID after first read"

  compatibility:
    - "Existing L1/L2/L3 format must continue working"
    - "SKIP_AGENTS list must be respected"
    - "Cache hit logic must not be broken"

  errorHandling:
    - "If session file missing, fall back to 'unknown'"
    - "If prompts directory missing, create it"
    - "Never fail silently - log errors"

  testing:
    - "Test with all subagent types: Explore, Plan, general-purpose"
    - "Test with SKIP_AGENTS: claude-code-guide, onboarding-guide"
    - "Measure execution time before and after"

# =============================================================================
# SHARED RULES
# =============================================================================
sharedRules:
  beforeModifying:
    - "ALWAYS Read the target file first"
    - "ALWAYS check _progress.yaml for conflicts"
    - "NEVER modify files outside your targetFiles list"

  afterCompleting:
    - "Update _progress.yaml with your status"
    - "Report results in L1/L2/L3 format"
    - "Notify Orchestrator if blocked"

  onConflict:
    - "Stop immediately"
    - "Do NOT force changes"
    - "Report to Orchestrator with details"

# =============================================================================
# REFERENCE FILES (Read-Only for context)
# =============================================================================
referenceFiles:
  - path: ".claude/hooks/session-end.sh"
    reason: "See existing session termination pattern"
  - path: ".claude/hooks/session-health.sh"
    reason: "See existing SESSION_ID usage attempt"
  - path: ".claude/cache/l1l2l3_prompt_escaped.txt"
    reason: "See cached L1/L2/L3 prompt format"
  - path: ".claude/registry.yaml"
    reason: "See component registration pattern"

# =============================================================================
# Worker Task: Terminal-C - Prompt File Generation
# =============================================================================
# Read this file AFTER reading _context.yaml
#
# Location: .agent/prompts/worker-c-task.yaml
# Language: English (Machine-Readable)
# =============================================================================

taskId: "phase2-prompt-generation"
assignedTo: "Terminal-C"
orchestrator: "Terminal-A"
createdAt: "2026-01-24T00:30:00Z"

# =============================================================================
# CONTEXT REFERENCE
# =============================================================================
contextFile: ".agent/prompts/_context.yaml"
progressFile: ".agent/prompts/_progress.yaml"

# =============================================================================
# MY SCOPE
# =============================================================================
scope:
  phaseId: "phase2"
  phaseName: "Prompt File Generation"

  description: |
    Modify pd-task-interceptor.sh to:
    1. Read session ID from current_session.json (not env var)
    2. Generate YAML prompt files for worker tasks
    3. Include prompt file path in hook output

# =============================================================================
# TARGET FILES (I can MODIFY these)
# =============================================================================
targetFiles:
  - path: ".claude/hooks/task-pipeline/pd-task-interceptor.sh"
    readOnly: false
    modifications:
      - location: "Around line 160 (after SKIP_AGENTS check)"
        action: "ADD session ID file reading"
        code: |
          # Read session from file registry (env var export doesn't work in hooks)
          SESSION_REGISTRY="${HOME}/.agent/tmp/current_session.json"
          ORCHESTRATOR_SESSION_ID="unknown"
          if [ -f "$SESSION_REGISTRY" ]; then
              ORCHESTRATOR_SESSION_ID=$(json_get '.sessionId' "$(cat "$SESSION_REGISTRY")")
          fi
          [ -z "$ORCHESTRATOR_SESSION_ID" ] && ORCHESTRATOR_SESSION_ID="unknown"

      - location: "Around line 290 (before build_updated_input)"
        action: "ADD create_worker_prompt_file() function"
        code: |
          create_worker_prompt_file() {
              local subagent_type="$1"
              local original_prompt="$2"
              local cache_hash="$3"

              local prompt_id=$(date +%s | tail -c 9)
              local session_prefix="${ORCHESTRATOR_SESSION_ID:0:8}"
              local prompt_file="${WORKSPACE_ROOT}/.agent/prompts/pending/${session_prefix}-${prompt_id}.yaml"

              mkdir -p "$(dirname "$prompt_file")" 2>/dev/null

              cat > "$prompt_file" << PROMPT_YAML_EOF
          ---
          promptId: "$prompt_id"
          sessionId: "$ORCHESTRATOR_SESSION_ID"
          timestamp: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          subagentType: "$subagent_type"
          model: "opus"
          outputFormat: "L1/L2/L3"
          cacheInputHash: "$cache_hash"
          ---

          $original_prompt
          PROMPT_YAML_EOF

              echo "$prompt_file"
          }

      - location: "Around line 310 (after UPDATED_INPUT creation)"
        action: "ADD prompt file creation call"
        code: |
          # Create worker prompt file
          ORIGINAL_PROMPT=$(json_get '.prompt' "$TOOL_INPUT")
          PROMPT_FILE_PATH=$(create_worker_prompt_file "$SUBAGENT_TYPE" "$ORIGINAL_PROMPT" "${CACHE_INPUT_HASH:-}")

# =============================================================================
# REFERENCE FILES (I can only READ these)
# =============================================================================
referenceFiles:
  - path: "~/.agent/tmp/current_session.json"
    reason: "See session ID format (created by phase1)"
  - path: ".claude/cache/l1l2l3_prompt_escaped.txt"
    reason: "See existing cached L1/L2/L3 prompt"

# =============================================================================
# DEPENDENCIES
# =============================================================================
dependencies:
  - "phase1"
blockedBy:
  - "phase1"
canStartImmediately: false

waitCondition: |
  Check .agent/prompts/_progress.yaml
  If terminal-b.status == 'completed', proceed
  Otherwise, wait

# =============================================================================
# COMPLETION CRITERIA
# =============================================================================
completionCriteria:
  required:
    - "Session ID is read from current_session.json"
    - "create_worker_prompt_file() function exists and works"
    - "YAML files are created in .agent/prompts/pending/"

  verification:
    - command: "Run Task(subagent_type='Explore', prompt='test')"
      expected: "File created in .agent/prompts/pending/"
    - command: "cat .agent/prompts/pending/*.yaml"
      expected: "Valid YAML with promptId, sessionId, subagentType"

# =============================================================================
# GLOBAL CONTEXT CONSIDERATIONS
# =============================================================================
globalContextChecklist:
  - question: "Does this add < 5ms overhead?"
    consideration: "File write is ~2ms, acceptable"

  - question: "What if session file doesn't exist?"
    consideration: "Fall back to 'unknown' - already handled in code"

  - question: "Should I include L1/L2/L3 prompt in the YAML file?"
    consideration: "NO - L1/L2/L3 is injected via additionalContext, not in file"

  - question: "Does this work with SKIP_AGENTS?"
    consideration: "For SKIP_AGENTS, we exit early before this code runs - OK"

# =============================================================================
# OUTPUT FORMAT
# =============================================================================
outputFormat: "L1/L2/L3"
l2OutputPath: ".agent/outputs/Explore/phase2-prompt-generation.md"

# =============================================================================
# ON COMPLETE
# =============================================================================
onComplete:
  - "Update .agent/prompts/_progress.yaml: terminal-c.status = 'completed'"
  - "Report to Orchestrator (Terminal-A) with L1 summary"
  - "Notify Terminal-D that phase2 is complete (unblocks phase3)"

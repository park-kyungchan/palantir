# =============================================================================
# Worker Task: Terminal-B - Phase 1 Quick Wins (E1 + E4)
# =============================================================================
# Location: .agent/prompts/pending/worker-b-phase1-quick-wins.yaml
# Language: English (Machine-Readable)
# =============================================================================

taskId: "phase1-quick-wins-e1-e4"
assignedTo: "Terminal-B"
orchestrator: "Terminal-A"
createdAt: "2026-01-24T01:35:00Z"
priority: "P0"

# =============================================================================
# CONTEXT
# =============================================================================
context:
  proposalRef: ".agent/prompts/enhancement-proposal-v2.2.yaml"
  description: |
    Implement E1 (Native Task List Integration) and E4 (CLAUDE_ENV_FILE).
    These are "Quick Wins" with LOW complexity but HIGH/MEDIUM impact.

  targetOutcome:
    - "CLAUDE_CODE_TASK_LIST_ID shared across terminals"
    - "Session variables persisted via CLAUDE_ENV_FILE"
    - "No manual file reads needed for session ID in Bash"

# =============================================================================
# ENHANCEMENT E1: Native Task List Integration
# =============================================================================
enhancement1:
  id: "E1"
  name: "Native Task List Integration"

  targetFile: ".claude/hooks/session-start.sh"
  location: "Line 310+ (after current_session.json creation)"

  codeToAdd: |
    # Export shared task list ID via CLAUDE_ENV_FILE
    if [ -n "$CLAUDE_ENV_FILE" ]; then
        PROJECT_TASK_ID="palantir-$(date +%Y%m%d)"
        echo "export CLAUDE_CODE_TASK_LIST_ID=\"$PROJECT_TASK_ID\"" >> "$CLAUDE_ENV_FILE"

        # Also store in session registry for Worker reference
        CURRENT_SESSION_FILE="$AGENT_TMP_DIR/current_session.json"
        if [ -f "$CURRENT_SESSION_FILE" ]; then
            TMP_FILE=$(mktemp)
            jq --arg tid "$PROJECT_TASK_ID" '. + {taskListId: $tid}' "$CURRENT_SESSION_FILE" > "$TMP_FILE" 2>/dev/null
            mv "$TMP_FILE" "$CURRENT_SESSION_FILE" 2>/dev/null || true
        fi
    fi

  verification:
    - command: "Start new Claude session"
      expected: "CLAUDE_CODE_TASK_LIST_ID is set"
    - command: "cat ~/.agent/tmp/current_session.json | jq '.taskListId'"
      expected: "palantir-YYYYMMDD format"

# =============================================================================
# ENHANCEMENT E4: CLAUDE_ENV_FILE Persistence
# =============================================================================
enhancement4:
  id: "E4"
  name: "Environment Variable Persistence"

  targetFile: ".claude/hooks/session-start.sh"
  location: "End of session initialization section"

  codeToAdd: |
    # Persist session variables for all Bash commands
    if [ -n "$CLAUDE_ENV_FILE" ]; then
        cat >> "$CLAUDE_ENV_FILE" <<ENVVARS
    export ORCHESTRATOR_SESSION_ID="$SESSION_ID"
    export WORKSPACE_ROOT="$WORKSPACE_ROOT"
    export L1L2L3_OUTPUT_DIR=".agent/outputs"
    ENVVARS
    fi

  verification:
    - command: "Start new Claude session"
      expected: "CLAUDE_ENV_FILE contains exports"
    - command: "echo $ORCHESTRATOR_SESSION_ID (in any Bash)"
      expected: "Session ID printed without file read"

# =============================================================================
# IMPLEMENTATION STEPS
# =============================================================================
steps:
  - step: 1
    action: "Read session-start.sh"
    command: "Read .claude/hooks/session-start.sh"

  - step: 2
    action: "Find insertion point for E1 (after current_session.json creation)"
    hint: "Look for CURRENT_SESSION_FILE or SESSION_EOF"

  - step: 3
    action: "Add E1 code block"
    important: "Ensure jq is available or add fallback"

  - step: 4
    action: "Add E4 code block at end of session init"
    important: "Use HEREDOC for multiline"

  - step: 5
    action: "Test by starting new Claude session"

  - step: 6
    action: "Verify all checks pass"

# =============================================================================
# GLOBAL CONTEXT CONSIDERATIONS
# =============================================================================
globalContextChecklist:
  - question: "What if CLAUDE_ENV_FILE is not set?"
    consideration: "Skip the env file writes, fallback to file-based registry"

  - question: "What if jq is not available?"
    consideration: "Use sed or skip taskListId update in JSON"

  - question: "Does this add < 5ms overhead?"
    consideration: "jq call adds ~2ms, still within budget"

# =============================================================================
# OUTPUT FORMAT
# =============================================================================
outputFormat: "L1/L2/L3"
l2OutputPath: ".agent/outputs/Worker/phase1-quick-wins.md"

# =============================================================================
# ON COMPLETE
# =============================================================================
onComplete:
  - "Update .agent/prompts/_progress.yaml: terminal-b.status = 'completed'"
  - "Report L1 summary to Orchestrator (Terminal-A)"
  - "Phase 2 (E2 Skills) is now unblocked for Terminal-C"

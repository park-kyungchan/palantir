#!/usr/bin/env python3
"""
Schedule CLI - Google Drive ìŠ¤ì¼€ì¤„ ê´€ë¦¬ ë„êµ¬

ì‚¬ìš©ë²•:
    schedule sync              # Driveì—ì„œ íŒŒì¼ ë™ê¸°í™”
    schedule 2026-01-19        # íŠ¹ì • ë‚ ì§œ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
    schedule today             # ì˜¤ëŠ˜ ìŠ¤ì¼€ì¤„
    schedule tomorrow          # ë‚´ì¼ ìŠ¤ì¼€ì¤„
    schedule list              # íŒŒì¼ ëª©ë¡
    schedule info              # ë°ì´í„° ìš”ì•½
    schedule cell FILE:SHEET:ROW:COL  # íŠ¹ì • ì…€ ì¡°íšŒ
"""

import sys
import os
from pathlib import Path
from datetime import date, timedelta

# ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ pathì— ì¶”ê°€
SCRIPT_DIR = Path(__file__).parent.resolve()
sys.path.insert(0, str(SCRIPT_DIR))

# ì„¤ì •
CONFIG = {
    'credentials': '/home/palantir/kc-palantir-2aaee2ef708e.json',
    'folder_id': '1mEnWm8KEF9hntbNaFFSjWeP3chAJ9vsC',
    'data_dir': SCRIPT_DIR / 'data',
}


def cmd_sync(args):
    """Google Driveì—ì„œ íŒŒì¼ ë™ê¸°í™”"""
    from drive_sync import DriveSync

    force = '--force' in args or '-f' in args
    list_only = '--list' in args or '-l' in args

    syncer = DriveSync(
        credentials_path=CONFIG['credentials'],
        folder_id=CONFIG['folder_id'],
        local_dir=str(CONFIG['data_dir'])
    )

    if list_only:
        files = syncer.list_xlsx_files()
        print(f"\nğŸ“‹ Google Drive xlsx íŒŒì¼ ({len(files)}ê°œ):")
        for f in files:
            size_kb = int(f.get('size', 0)) / 1024
            print(f"  â€¢ {f['name']}")
            print(f"    ìˆ˜ì •: {f['modifiedTime'][:19].replace('T', ' ')} | í¬ê¸°: {size_kb:.1f}KB")
    else:
        syncer.sync_all(force=force)


def cmd_query(date_str: str, args: list):
    """ë‚ ì§œë³„ ìŠ¤ì¼€ì¤„ ì¡°íšŒ"""
    from schedule_parser import ScheduleParser, format_schedule

    # íŠ¹ìˆ˜ ë‚ ì§œ í‚¤ì›Œë“œ ì²˜ë¦¬
    if date_str == 'today':
        target_date = date.today()
    elif date_str == 'tomorrow':
        target_date = date.today() + timedelta(days=1)
    elif date_str == 'yesterday':
        target_date = date.today() - timedelta(days=1)
    else:
        target_date = date_str

    # ì˜µì…˜ íŒŒì‹±
    fmt = 'table'
    columns = None

    if '--json' in args or '-j' in args:
        fmt = 'json'
    elif '--markdown' in args or '-m' in args:
        fmt = 'markdown'
    elif '--simple' in args or '-s' in args:
        fmt = 'simple'

    if '--columns' in args or '-c' in args:
        try:
            idx = args.index('--columns') if '--columns' in args else args.index('-c')
            columns = args[idx + 1].split(',')
        except (IndexError, ValueError):
            pass

    parser = ScheduleParser(str(CONFIG['data_dir']))

    if isinstance(target_date, date):
        print(f"\nğŸ“… {target_date.strftime('%Yë…„ %mì›” %dì¼')} ìŠ¤ì¼€ì¤„\n")
        target_date = target_date.isoformat()
    else:
        print(f"\nğŸ“… {date_str} ìŠ¤ì¼€ì¤„\n")

    try:
        df = parser.filter_by_date(target_date, columns)
        print(format_schedule(df, fmt))
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: {e}")


def cmd_list(args):
    """ë¡œì»¬ íŒŒì¼ ëª©ë¡"""
    from schedule_parser import ScheduleParser

    parser = ScheduleParser(str(CONFIG['data_dir']))
    files = parser.list_files()

    if not files:
        print("\nğŸ“ ë¡œì»¬ì— ë™ê¸°í™”ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        print("   'schedule sync' ëª…ë ¹ìœ¼ë¡œ ë¨¼ì € ë™ê¸°í™”í•˜ì„¸ìš”.")
        return

    print(f"\nğŸ“ ë¡œì»¬ íŒŒì¼ ({len(files)}ê°œ):")
    for f in files:
        size_kb = f.stat().st_size / 1024
        mtime = date.fromtimestamp(f.stat().st_mtime)
        print(f"  â€¢ {f.name} ({size_kb:.1f}KB, {mtime})")


def cmd_info(args):
    """ë°ì´í„° ìš”ì•½ ì •ë³´"""
    import json
    from schedule_parser import ScheduleParser

    parser = ScheduleParser(str(CONFIG['data_dir']))
    summary = parser.summary()

    if summary['total_files'] == 0:
        print("\nğŸ“Š ë™ê¸°í™”ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    print(f"\nğŸ“Š ë°ì´í„° ìš”ì•½")
    print(f"   ì´ íŒŒì¼: {summary['total_files']}ê°œ\n")

    for f in summary['files']:
        print(f"ğŸ“„ {f['name']}")
        for sheet in f['sheets']:
            cols_preview = ', '.join(str(c) for c in sheet['columns'][:5])
            if len(sheet['columns']) > 5:
                cols_preview += f" ... (+{len(sheet['columns'])-5})"
            print(f"   â””â”€ {sheet['name']}: {sheet['rows']}í–‰")
            print(f"      ì»¬ëŸ¼: {cols_preview}")


def cmd_cell(cell_spec: str, args):
    """íŠ¹ì • ì…€ ì¡°íšŒ"""
    from schedule_parser import ScheduleParser

    parts = cell_spec.split(':')
    if len(parts) < 4:
        print("âŒ í˜•ì‹ ì˜¤ë¥˜. ì˜ˆ: file.xlsx:Sheet1:0:A ë˜ëŠ” file.xlsx:Sheet1:0:0")
        return

    file_name, sheet, row, col = parts[0], parts[1], parts[2], parts[3]

    try:
        row = int(row)
        col = int(col) if col.isdigit() else col
    except ValueError:
        print("âŒ í–‰ ë²ˆí˜¸ëŠ” ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.")
        return

    parser = ScheduleParser(str(CONFIG['data_dir']))

    try:
        value = parser.get_cell_value(file_name, sheet, row, col)
        print(f"\nğŸ” ì…€ ê°’: {value}")
        print(f"   ìœ„ì¹˜: {file_name} > {sheet} > í–‰{row}, ì—´{col}")
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: {e}")


def cmd_help():
    """ë„ì›€ë§ ì¶œë ¥"""
    print("""
ğŸ“‹ Schedule CLI - Google Drive ìŠ¤ì¼€ì¤„ ê´€ë¦¬

ì‚¬ìš©ë²•:
    schedule <command> [options]

ëª…ë ¹ì–´:
    sync                    Google Driveì—ì„œ xlsx íŒŒì¼ ë™ê¸°í™”
        --force, -f         ëª¨ë“  íŒŒì¼ ê°•ì œ ì¬ë‹¤ìš´ë¡œë“œ
        --list, -l          íŒŒì¼ ëª©ë¡ë§Œ ë³´ê¸° (ë‹¤ìš´ë¡œë“œ ì•ˆí•¨)

    <date>                  íŠ¹ì • ë‚ ì§œ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
        today               ì˜¤ëŠ˜
        tomorrow            ë‚´ì¼
        yesterday           ì–´ì œ
        2026-01-19          íŠ¹ì • ë‚ ì§œ (YYYY-MM-DD)

        --json, -j          JSON í˜•ì‹ ì¶œë ¥
        --markdown, -m      Markdown í‘œ í˜•ì‹ ì¶œë ¥
        --simple, -s        ê°„ë‹¨ í˜•ì‹ ì¶œë ¥
        --columns, -c COL   íŠ¹ì • ì»¬ëŸ¼ë§Œ ì¶œë ¥ (ì‰¼í‘œ êµ¬ë¶„)

    list                    ë¡œì»¬ íŒŒì¼ ëª©ë¡
    info                    ë°ì´í„° ìš”ì•½ ì •ë³´
    cell FILE:SHEET:ROW:COL íŠ¹ì • ì…€ ê°’ ì¡°íšŒ

ì˜ˆì‹œ:
    schedule sync                       # Drive ë™ê¸°í™”
    schedule 2026-01-19                 # 1ì›” 19ì¼ ìŠ¤ì¼€ì¤„
    schedule today --json               # ì˜¤ëŠ˜ ìŠ¤ì¼€ì¤„ JSON
    schedule today -c "ì‹œê°„,ë‚´ìš©,ì¥ì†Œ"  # íŠ¹ì • ì»¬ëŸ¼ë§Œ
    schedule cell data.xlsx:Sheet1:0:A  # ì…€ ê°’ ì¡°íšŒ
""")


def main():
    if len(sys.argv) < 2:
        cmd_help()
        return

    command = sys.argv[1]
    args = sys.argv[2:]

    if command in ['help', '--help', '-h']:
        cmd_help()
    elif command == 'sync':
        cmd_sync(args)
    elif command == 'list':
        cmd_list(args)
    elif command == 'info':
        cmd_info(args)
    elif command == 'cell' and args:
        cmd_cell(args[0], args[1:])
    elif command in ['today', 'tomorrow', 'yesterday'] or '-' in command:
        # ë‚ ì§œ ì¡°íšŒ
        cmd_query(command, args)
    else:
        print(f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹: {command}")
        print("   'schedule help'ë¡œ ë„ì›€ë§ì„ í™•ì¸í•˜ì„¸ìš”.")


if __name__ == '__main__':
    main()

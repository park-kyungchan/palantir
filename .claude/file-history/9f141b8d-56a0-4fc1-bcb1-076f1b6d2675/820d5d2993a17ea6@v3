# /build Command Enhancement Plan - 0->100 Native Capabilities

> **Status:** ✅ Implementation Complete | **Date:** 2026-01-23
> **Files Created:** build-research.md, capability_index.json, complexity_levels.json
> **Files Updated:** build.md (skill), build.md (command)

---

## Part 1: Claude-Code-Guide Research Summary (2026-01)

### Verified Capabilities Inventory

| Category | Total Fields | /build Coverage | Gap |
|----------|--------------|-----------------|-----|
| **Agents** | 15 fields | ~80% | 3 fields missing |
| **Skills** | 11 fields | ~70% | 4 features missing |
| **Hooks** | 12+ events | ~60% | 5 events/schemas missing |
| **Task Tool** | 6 params | ~50% | 3 params missing |
| **Models** | 6 aliases | ~30% | 4 aliases missing |

---

## Part 2: Gap Analysis - Missing from Current /build

### 2.1 AGENTS - Missing Fields

| Field | Type | Current | Should Add |
|-------|------|---------|------------|
| `color` | enum | ❌ Missing | UI color indicator |
| `permissionMode` | enum | Partial (3/5) | Add: `dontAsk`, `bypassPermissions` |
| Scopes | 4 types | ❌ Missing | Session/Project/User/Plugin scopes |

### 2.2 SKILLS - Missing Features

| Feature | Current | Should Add |
|---------|---------|------------|
| `!`command`` | ❌ Missing | Dynamic shell preprocessing |
| `$ARGUMENTS` | ❌ Missing | String substitution docs |
| `${CLAUDE_SESSION_ID}` | ❌ Missing | Session ID variable |
| `ultrathink` | ❌ Missing | Extended thinking trigger |

### 2.3 HOOKS - Missing Events & Schemas

| Event | Current | Should Add |
|-------|---------|------------|
| `SubagentStart` | ❌ Missing | agent_id, agent_type input |
| `SubagentStop` | Partial | agent_transcript_path input |
| `PostToolUseFailure` | ❌ Missing | error_message handling |
| `type: prompt` | ❌ Missing | LLM-based hook evaluation |
| MCP patterns | ❌ Missing | `mcp__server__tool` format |

### 2.4 TASK TOOL - Missing Params

| Param | Current | Should Add |
|-------|---------|------------|
| `tools` | ❌ Missing | Restrict tools for subagent |
| `permissionMode` | ❌ Missing | Override permissions |
| `model` | Partial | More aliases |

### 2.5 MODEL ALIASES - Missing

| Alias | Description | Current |
|-------|-------------|---------|
| `sonnet[1m]` | 1M token context | ❌ Missing |
| `opusplan` | Opus→Sonnet hybrid | ❌ Missing |
| `default` | Account-dependent | ❌ Missing |
| Model override syntax | Full syntax | ❌ Missing |

---

## Part 3: Proposed Enhancement Tiers

### Tier 1: Critical (Must Have)
1. [ ] Add all 12+ hook event schemas
2. [ ] Add `type: prompt` hook support
3. [ ] Add missing permissionMode options
4. [ ] Add SubagentStart/SubagentStop details

### Tier 2: Important (Should Have)
1. [ ] Add skill dynamic commands (`!`cmd``)
2. [ ] Add ultrathink documentation
3. [ ] Add MCP tool hook patterns
4. [ ] Add all model aliases

### Tier 3: Nice to Have
1. [ ] Add agent color field
2. [ ] Add scope documentation (Session/Project/User/Plugin)
3. [ ] Add Task tool advanced params
4. [ ] Add string substitution variables

---

## Part 4: Enhanced /build Architecture (claude-code-guide 검증 완료)

### 4.1 Three-Phase Pattern

```
┌───────────────────────────────────────────────────────────┐
│ /build "Progressive-Disclosure" 워크플로우                 │
├───────────────────────────────────────────────────────────┤
│                                                           │
│ PHASE 1: RESEARCH (Delegated)                             │
│   └─ Task(subagent_type="claude-code-guide")              │
│      └─ 모든 관련 기능 탐색                                │
│      └─ capability_index.json 생성                        │
│                                                           │
│ PHASE 2: ROADMAP (L1/L2/L3 Progressive Disclosure)        │
│   ├─ L1: Summary (500 tokens)                             │
│   │   "12 capabilities across 3 categories"               │
│   ├─ L2: Index (complexity levels)                        │
│   │   Level 0/50/100 options                              │
│   └─ L3: Details (on-demand selection)                    │
│                                                           │
│ PHASE 3: BUILD (Multi-round Selection)                    │
│   ├─ Round 1: Target complexity level                     │
│   ├─ Round 2-N: Feature selection (4 per round)           │
│   └─ Generate artifacts                                   │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

### 4.2 Token Efficiency Analysis

| Phase | Tokens | Location |
|-------|--------|----------|
| Research | 1-2K | Subagent (isolated) |
| Roadmap | 500 | Main Agent (L1 only) |
| Build | 2-4K | Main Agent |
| **Total** | **4-7K** | 25-35% of session |

### 4.3 Key Implementation Features

| Feature | Purpose |
|---------|---------|
| `Task(claude-code-guide)` | Research subagent delegation |
| `L1/L2/L3` | Progressive capability disclosure |
| `AskUserQuestion` | Multi-round selection (max 4 options × 4 questions) |
| `TodoWrite` | Phase completion tracking |
| `.agent/builds/{id}/` | State persistence for resume |

### 4.4 Files to Create/Update

| File | Action | Purpose |
|------|--------|---------|
| `.claude/commands/build.md` | UPDATE | Add Phase 1 research workflow |
| `.claude/skills/build.md` | UPDATE | Add L1/L2/L3 roadmap presentation |
| `.claude/skills/build-research.md` | NEW | Research dispatcher skill |
| `.agent/builds/` | NEW | Phase state persistence |

### 4.5 Comprehensive Task Decomposition

#### Auto-Compact 대비: Resume 관련 훅 현황
```
✅ output_preservation_hook.py: Agent ID 캡처 + Resume 안내 제공
✅ post-task-output.sh: Agent ID 로깅
✅ pre-compact.sh: Quick Resume 지침
→ 추가 훅 불필요 (기존 인프라 활용)
```

#### Task 1: RESEARCH (claude-code-guide)
```yaml
Task:
  id: "[1]"
  type: RESEARCH
  description: "/build 전체 기능 명세 조사"

  delegation:
    agent: claude-code-guide
    agentId: "TBD-research-001"
    model: haiku
    run_in_background: false

  prompt: |
    Research ALL Claude Code native capabilities for:
    - Agents (15+ fields)
    - Skills (11+ fields)
    - Hooks (12+ events)
    - Task tool (6+ params)
    Return structured JSON capability_index

  output:
    path: ".agent/builds/master/capability_index.json"

  resume_info:
    on_compact: "Task(resume='TBD-research-001', prompt='Continue research')"
```

#### Task 2-3: DESIGN (Plan Agent)
```yaml
Task:
  id: "[2]"
  type: DESIGN
  description: "build-research.md 스킬 설계"

  delegation:
    agent: Plan
    agentId: "TBD-plan-002"
    model: opus
    run_in_background: true

  prompt: |
    Design a research dispatcher skill that:
    1. Parses user input concept
    2. Delegates to claude-code-guide
    3. Saves results to .agent/builds/{id}/

  output:
    path: ".agent/plans/build-research-design.md"

  resume_info:
    on_compact: "Task(resume='TBD-plan-002', prompt='Continue design')"
---
Task:
  id: "[3]"
  type: DESIGN
  description: "L1/L2/L3 Roadmap 템플릿 설계"

  delegation:
    agent: Plan
    agentId: "TBD-plan-003"
    model: opus
    run_in_background: true

  prompt: |
    Design L1/L2/L3 roadmap presentation template:
    L1: 500 tokens summary
    L2: Complexity levels (0/50/100)
    L3: Full capability details (on-demand)

  output:
    path: ".agent/plans/roadmap-template-design.md"

  resume_info:
    on_compact: "Task(resume='TBD-plan-003', prompt='Continue design')"
```

#### Tasks 4-10: IMPLEMENT (Main Agent 직접)
```yaml
Tasks:
  - id: "[4]"
    type: IMPLEMENT
    description: "build-research.md 생성"
    agent: "Main Agent (직접)"
    file: ".claude/skills/build-research.md"
    resume: "N/A - 파일 시스템 작업"

  - id: "[5]"
    type: IMPLEMENT
    description: ".agent/builds/ 디렉토리 구조"
    agent: "Main Agent (직접)"
    structure: |
      .agent/builds/
      ├── master/
      │   └── capability_index.json
      └── {build_id}/
          ├── research.json
          ├── selection.json
          └── artifacts.json
    resume: "N/A - 파일 시스템 작업"

  - id: "[6]"
    type: IMPLEMENT
    description: "build.md Phase 1 Research 추가"
    agent: "Main Agent (직접)"
    file: ".claude/skills/build.md"
    changes: |
      + Task(subagent_type="claude-code-guide") delegation
      + Research result parsing
      + Phase state persistence
    resume: "N/A - 파일 시스템 작업"

  - id: "[7]"
    type: IMPLEMENT
    description: "build.md Phase 2 Roadmap 추가"
    agent: "Main Agent (직접)"
    file: ".claude/skills/build.md"
    changes: |
      + L1/L2/L3 template rendering
      + Complexity level presentation
      + Progressive disclosure logic
    resume: "N/A - 파일 시스템 작업"

  - id: "[8]"
    type: IMPLEMENT
    description: "build.md Multi-round Q&A 추가"
    agent: "Main Agent (직접)"
    file: ".claude/commands/build.md"
    changes: |
      + Multi-round AskUserQuestion flow
      + Selection persistence
      + 4 options × 4 questions batching
    resume: "N/A - 파일 시스템 작업"

  - id: "[9]"
    type: IMPLEMENT
    description: "capability_index.json 스키마"
    agent: "Main Agent (직접)"
    schema: |
      {
        "concept": "string",
        "capabilities": [{
          "name": "string",
          "category": "skill|agent|hook|pattern",
          "complexity": "basic|intermediate|advanced",
          "dependencies": ["string"],
          "fields": ["string"],
          "example": "string"
        }],
        "levels": {
          "0": ["capability_ids"],
          "50": ["capability_ids"],
          "100": ["capability_ids"]
        }
      }
    resume: "N/A - 파일 시스템 작업"

  - id: "[10]"
    type: IMPLEMENT
    description: "complexity_levels.json 정의"
    agent: "Main Agent (직접)"
    content: |
      Level 0 (Basic): Core component only
      Level 50 (Recommended): + error handling, logging
      Level 100 (Full): + all optional features, MCP
    resume: "N/A - 파일 시스템 작업"
```

#### Tasks 11-14: VERIFY & DOCUMENT
```yaml
Tasks:
  - id: "[11]"
    type: VERIFY
    description: "/build 'Progressive-Disclosure' 테스트"
    delegation:
      agent: Explore
      agentId: "TBD-verify-011"
      model: haiku
    test_command: "/build 'Progressive-Disclosure'"
    expected: |
      1. Research phase completes
      2. Roadmap displays with 3 levels
      3. Selection round works
    resume_info:
      on_compact: "Task(resume='TBD-verify-011', prompt='Continue verification')"

  - id: "[12]"
    type: VERIFY
    description: "/build --resume 테스트"
    delegation:
      agent: Explore
      agentId: "TBD-verify-012"
      model: haiku
    test_command: "/build --resume <id>"
    expected: "Previous state restored correctly"
    resume_info:
      on_compact: "Task(resume='TBD-verify-012', prompt='Continue verification')"

  - id: "[13]"
    type: VERIFY
    description: "Token usage < 7K 확인"
    agent: "Main Agent (직접)"
    method: "Context usage monitoring during test"
    resume: "N/A - 모니터링 작업"

  - id: "[14]"
    type: DOCUMENT
    description: "Plan 파일 최종 업데이트"
    agent: "Main Agent (직접)"
    file: ".claude/plans/silly-hatching-turtle.md"
    resume: "N/A - 파일 시스템 작업"
```

#### Execution Order & Dependencies
```
[1] RESEARCH ─────────────────────────┐
                                      │
[2] DESIGN (parallel) ───────────┐    ├─→ [4] IMPLEMENT
                                 │    │
[3] DESIGN (parallel) ───────────┴────┘

[4] → [5] → [6] → [7] → [8] → [9] → [10]
         (sequential file creation)

[11] VERIFY ───────────┐
                       ├─→ [14] DOCUMENT
[12] VERIFY ───────┐   │
                   │   │
[13] VERIFY ───────┴───┘
```

#### Agent Summary Table
| Task | Agent | Model | Background | Resume Key |
|------|-------|-------|------------|------------|
| [1] | claude-code-guide | haiku | No | research-001 |
| [2] | Plan | opus | Yes | plan-002 |
| [3] | Plan | opus | Yes | plan-003 |
| [4-10] | Main Agent | - | - | N/A (file ops) |
| [11] | Explore | haiku | No | verify-011 |
| [12] | Explore | haiku | No | verify-012 |
| [13-14] | Main Agent | - | - | N/A |

### 4.6 Workflow Example

```
User: /build "Progressive-Disclosure"

─── PHASE 1: RESEARCH ───
[claude-code-guide researches all related capabilities]
→ Found: 12 capabilities (4 skills, 3 agents, 5 hooks)
→ Saved: .agent/builds/pd-001/research.json

─── PHASE 2: ROADMAP ───
┌─────────────────────────────────────┐
│ Progressive-Disclosure Roadmap      │
├─────────────────────────────────────┤
│ Level 0 (Basic):                    │
│   ✓ Core L1/L2 format               │
│   ✓ Basic hook injection            │
│                                     │
│ Level 50 (Recommended):             │
│   + Priority system                 │
│   + recommendedRead                 │
│   + Output preservation             │
│                                     │
│ Level 100 (Full):                   │
│   + MCP integration                 │
│   + Custom token budgets            │
│   + Session health monitoring       │
└─────────────────────────────────────┘

User: Level 100 선택

─── PHASE 3: BUILD ───
[Multi-round selection for 12 capabilities]
→ Generated: 4 skills, 3 agents, 5 hooks
```

---

# Previous Work: Hook System Optimization Summary

## Completed Work (This Session)

### Phase 1: Analysis (Tasks 1-4)
- **PreToolUse collision**: governance-check.sh + auto-backup.sh (both run for Edit|Write)
- **PostToolUse collision**: 3 hooks run in parallel for Task tool
- **Orchestration review**: Identified output format inconsistencies
- **Progressive-Disclosure flow**: Verified L1/L2/L3 pattern

### Phase 2: Research (Task 5)
Used `claude-code-guide` agent to verify:
- `hookSpecificOutput` schema (flexible, no strict validation)
- Multiple hooks on same matcher run in **parallel** (no inter-hook communication)
- Exit codes: 0=success, 2=blocking error
- Empty `{}` is efficient and recommended pattern

### Phase 3: Fixes Applied (Tasks 6-11)

#### session-health.sh
| Location | Before | After |
|----------|--------|-------|
| Repetition warning | `{"warning": ...}` | `{"hookSpecificOutput": {...}}` |
| High error rate | `{"warning": ...}` | `{"hookSpecificOutput": {...}}` |
| Loop detection | `{"warning": ...}` | `{"hookSpecificOutput": {...}}` |
| Final status | `{"status": ...}` | `{}` (empty - recommended) |

#### auto-backup.sh
| Location | Before | After |
|----------|--------|-------|
| All exit points | No output | `echo '{}'` |

### Phase 4: Consolidation Analysis (Task 10)
**Decision**: Keep hooks separate
- Output format standardization complete
- Consolidation deferred (no performance issues observed)

---

## Hook Architecture (Final State)

### PreToolUse Hooks
```
Edit|Write → governance-check.sh → hookSpecificOutput{allow|deny}
Edit|Write → auto-backup.sh → {} (backup created silently)
Task → pd-inject.sh → hookSpecificOutput{updatedInput, additionalContext}
```

### PostToolUse Hooks
```
Task → post-task-output.sh → hookSpecificOutput{guidance, l2Path}
Task → output_preservation_hook.py → hookSpecificOutput{preservationAlert}
* → session-health.sh → {} | hookSpecificOutput{warning}
```

### Other Hooks
```
SessionStart → session-start.sh, welcome.sh
SessionEnd → session-end.sh
PreCompact → pre-compact.sh
```

---

## Key Optimizations

1. **Standardized Output Format**: All hooks use `hookSpecificOutput` wrapper
2. **Empty JSON Pattern**: `{}` for no-action cases (reduced overhead)
3. **Early Exit with Output**: All exit points return valid JSON
4. **Consistent Error Handling**: `set +e` across all bash hooks
5. **Environment Variables**: Workspace paths from `CLAUDE_*` env vars

---

## Verification Completed

| Hook | hookSpecificOutput | Empty JSON | Exit Codes |
|------|-------------------|------------|------------|
| governance-check.sh | ✅ | N/A (uses allow/deny) | 0, 2 |
| auto-backup.sh | N/A | ✅ | 0 |
| pd-inject.sh | ✅ | ✅ | 0 |
| post-task-output.sh | ✅ | ✅ | 0 |
| output_preservation_hook.py | ✅ | ✅ | 0 |
| session-health.sh | ✅ | ✅ | 0 |

---

## No Further Implementation Needed

All optimization tasks have been completed. This plan serves as documentation only.

#!/bin/bash
# Claude Code Quality Check Post-Tool Hook
# Runs lightweight quality checks after Edit/Write operations

set -e

# Configuration
WORKSPACE_ROOT="${ORION_WORKSPACE_ROOT:-/home/palantir}"
QUALITY_LOG="$WORKSPACE_ROOT/.agent/logs/quality_checks.log"

# Read input from stdin (JSON format)
INPUT=$(cat)

# Extract tool info
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // empty')
FILE_PATH=$(echo "$INPUT" | jq -r '.tool_input.file_path // empty')
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id // "unknown"')

# Only process for code files
if [[ ! "$FILE_PATH" =~ \.(py|ts|js|tsx|jsx|sh)$ ]]; then
    echo '{"status": "skipped", "reason": "non-code file"}'
    exit 0
fi
mkdir -p "$(dirname "$QUALITY_LOG")"

# Log entry
LOG_ENTRY=$(cat <<EOF
{
    "timestamp": "$(date -Iseconds)",
    "session_id": "$SESSION_ID",
    "tool": "$TOOL_NAME",
    "file": "$FILE_PATH",
    "checks": []
}
EOF
)

CHECKS_RESULT="[]"

# Python file quality checks
if [[ "$FILE_PATH" =~ \.py$ ]]; then
    # Quick syntax check
    if command -v python3 &> /dev/null; then
        if python3 -m py_compile "$FILE_PATH" 2>/dev/null; then
            CHECKS_RESULT=$(echo "$CHECKS_RESULT" | jq '. + [{"check": "syntax", "status": "pass"}]')
        else
            CHECKS_RESULT=$(echo "$CHECKS_RESULT" | jq '. + [{"check": "syntax", "status": "fail"}]')
        fi
    fi

    # Quick import check (non-blocking)
    if command -v ruff &> /dev/null; then
        if ruff check "$FILE_PATH" --select=F401 --quiet 2>/dev/null; then
            CHECKS_RESULT=$(echo "$CHECKS_RESULT" | jq '. + [{"check": "imports", "status": "pass"}]')
        else
            CHECKS_RESULT=$(echo "$CHECKS_RESULT" | jq '. + [{"check": "imports", "status": "warn"}]')
        fi
    fi
fi

# TypeScript/JavaScript quality checks
if [[ "$FILE_PATH" =~ \.(ts|tsx|js|jsx)$ ]]; then
    # ESLint quick check (if available)
    if command -v eslint &> /dev/null; then
        if eslint "$FILE_PATH" --quiet 2>/dev/null; then
            CHECKS_RESULT=$(echo "$CHECKS_RESULT" | jq '. + [{"check": "lint", "status": "pass"}]')
        else
            CHECKS_RESULT=$(echo "$CHECKS_RESULT" | jq '. + [{"check": "lint", "status": "warn"}]')
        fi
    fi
fi

# Shell script quality checks
if [[ "$FILE_PATH" =~ \.sh$ ]]; then
    # ShellCheck (if available)
    if command -v shellcheck &> /dev/null; then
        if shellcheck -S warning "$FILE_PATH" 2>/dev/null; then
            CHECKS_RESULT=$(echo "$CHECKS_RESULT" | jq '. + [{"check": "shellcheck", "status": "pass"}]')
        else
            CHECKS_RESULT=$(echo "$CHECKS_RESULT" | jq '. + [{"check": "shellcheck", "status": "warn"}]')
        fi
    fi
fi

# Update log entry and write to log file
FINAL_LOG=$(echo "$LOG_ENTRY" | jq --argjson checks "$CHECKS_RESULT" '.checks = $checks')
echo "$FINAL_LOG" >> "$QUALITY_LOG"

# Output result
echo "{\"status\": \"completed\", \"checks\": $CHECKS_RESULT}"
exit 0

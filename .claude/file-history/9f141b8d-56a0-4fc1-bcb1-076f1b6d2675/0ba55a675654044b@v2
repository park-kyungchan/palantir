# Ontology-Definition 상세 분석

> **TaskId:** ont-expl | **Date:** 2026-01-23
> **Source:** /home/palantir/park-kyungchan/palantir/Ontology-Definition

---

## Directory Structure {#directory-structure}

```
Ontology-Definition/
├── ontology_definition/          # 메인 패키지 (41 Python files)
│   ├── __init__.py               # 공개 API
│   ├── core/                     # 기본 클래스
│   │   ├── base.py               # OntologyEntity
│   │   └── enums.py              # DataType, Status, Cardinality
│   ├── types/                    # 5가지 타입 정의
│   │   ├── object_type.py        # ObjectType
│   │   ├── link_type.py          # LinkType
│   │   ├── action_type.py        # ActionType
│   │   ├── interface.py          # Interface
│   │   └── value_type.py         # ValueType, StructType
│   ├── constraints/              # 제약 조건
│   │   ├── property_constraints.py
│   │   └── mandatory_control.py  # 보안 필수 제어
│   ├── security/                 # 보안 정책
│   │   └── restricted_view.py    # 행레벨 보안
│   ├── registry/                 # 타입 레지스트리
│   │   └── ontology_registry.py  # 싱글톤 레지스트리
│   ├── validation/               # 검증 시스템
│   │   ├── schema_validator.py   # JSON Schema 검증
│   │   └── runtime_validator.py  # Pydantic 검증
│   ├── export/                   # 내보내기
│   │   ├── foundry_exporter.py   # Foundry JSON
│   │   ├── jsonschema_exporter.py# JSON Schema
│   │   └── llm_exporter.py       # LLM-친화적
│   └── import_/                  # 가져오기
│       └── foundry_importer.py   # Foundry 호환
├── schemas/                      # JSON Schema (6 files, 4,389 lines)
│   ├── object_type_schema.json   # 675 lines
│   ├── link_type_schema.json     # 508 lines
│   ├── action_type_schema.json   # 894 lines
│   ├── property_schema.json      # 684 lines
│   ├── interaction_schema.json   # 915 lines
│   └── metadata_schema.json      # 713 lines
├── tests/                        # 테스트
└── pyproject.toml                # 패키지 설정
```

---

## Core Types Architecture {#core-types-architecture}

### Base Class: OntologyEntity

```python
class OntologyEntity(BaseModel):
    """모든 온톨로지 타입의 기본 클래스"""
    rid: str                    # Resource ID (ri.ontology....)
    apiName: str                # API 이름 (camelCase)
    displayName: str            # 표시 이름
    description: Optional[str]  # 설명
    status: ObjectStatus        # 상태 (DRAFT → ACTIVE → DEPRECATED)
    version: str                # 버전
    createdTime: datetime       # 생성 시간
    modifiedTime: datetime      # 수정 시간
    createdBy: str              # 생성자
    modifiedBy: str             # 수정자
```

### 5 Type Families

| Type | Purpose | Key Fields |
|------|---------|------------|
| **ObjectType** | 엔티티 스키마 | properties, primaryKey, backingDataset, securityConfig |
| **LinkType** | 관계 스키마 | sourceType, targetType, cardinality, cascadePolicy |
| **ActionType** | 뮤테이션 스키마 | inputs, outputs, operations, validationRules |
| **Interface** | 다형성 계약 | sharedProperties, implementingTypes |
| **ValueType** | 재사용 타입 | fields, constraints |

---

## Schema Definitions {#schema-definitions}

### JSON Schema Draft 2020-12 기반

| Schema | Lines | 핵심 정의 |
|--------|-------|----------|
| **ObjectType** | 675 | Properties, PrimaryKey, BackingDataset, SecurityConfig |
| **LinkType** | 508 | Cardinality (ONE_TO_ONE, ONE_TO_MANY 등), CascadePolicy |
| **ActionType** | 894 | 가장 복잡 - Operation 타입, Inputs/Outputs, Validation |
| **Property** | 684 | 20개 DataType, Constraints, Derived Properties |
| **Interaction** | 915 | 사용자 상호작용 스키마 |
| **Metadata** | 713 | Audit, Version, Tags, Tracking |

### DataType System (20 types)

```
Primitives:  STRING, INTEGER, LONG, FLOAT, DOUBLE, BOOLEAN, DECIMAL
Temporal:    DATE, TIMESTAMP, DATETIME, TIMESERIES
Complex:     ARRAY, STRUCT, JSON
Spatial:     GEOPOINT, GEOSHAPE
Media:       MEDIA_REFERENCE, BINARY, MARKDOWN
AI/ML:       VECTOR
```

---

## Security Framework {#security-framework}

### P1-CRITICAL: Mandatory Control

```python
class MandatoryControlConfig(BaseModel):
    """행 수준 접근 제어"""
    markingType: Literal["MARKINGS", "ORGANIZATIONS", "CLASSIFICATIONS"]
    markingColumn: str      # 보안 레벨 컬럼
    enforcement: Literal["STRICT", "PERMISSIVE"]
```

**작동 원리:**
- 사용자의 markings와 행의 markings 교집합
- 교집합이 비면 → 접근 거부

### Restricted View Policy

```python
class RestrictedViewPolicy(BaseModel):
    """세분화된 행레벨 정책"""
    terms: List[PolicyTerm]
    operator: Literal["AND", "OR"]

class PolicyTerm(BaseModel):
    type: Literal[
        "USER_ATTRIBUTE_COMPARISON",  # 컬럼 vs 사용자 속성
        "COLUMN_VALUE_MATCH",         # 컬럼 vs 정적값
        "MARKING_CHECK"               # 사용자 marking 검증
    ]
```

---

## Lifecycle Management {#lifecycle-management}

### Status Flow

```
DRAFT → EXPERIMENTAL → ALPHA → BETA → ACTIVE → STABLE → DEPRECATED → SUNSET → ARCHIVED → DELETED
```

### Registry Pattern

```python
class OntologyRegistry:
    """싱글톤 타입 레지스트리"""
    _instance: ClassVar[Optional['OntologyRegistry']] = None
    _lock: ClassVar[RLock] = RLock()  # 스레드 안전

    _by_api_name: Dict[str, OntologyEntity]  # O(1) 조회
    _by_rid: Dict[str, OntologyEntity]       # O(1) 조회
```

### Export Formats

| Exporter | Purpose | Use Case |
|----------|---------|----------|
| **FoundryExporter** | Foundry JSON | Palantir 호환 |
| **JsonSchemaExporter** | JSON Schema | 외부 시스템 |
| **LLMSchemaExporter** | LLM-친화적 | 프롬프트 생성 |

---

## Codebase Integration {#codebase-integration}

### 현재 상태

- **독립적 패키지**: pyproject.toml 기반
- **버전**: 1.0.0
- **Python**: >=3.10
- **의존성**: pydantic >=2.0, jsonschema >=4.20.0

### 통합 기회

1. **cow 모듈**: mathpix 파이프라인의 스키마 소비자 가능
2. **Claude 명령/스킬**: 온톨로지 기반 자동 생성
3. **Hook 시스템**: 타입 검증 통합

### 미구현 항목

- [ ] 실제 타입 등록 코드
- [ ] 온톨로지 기반 명령 자동생성
- [ ] LLM Exporter 최적화

---

## 아키텍처 패턴 {#architecture-patterns}

### 적용된 패턴

| Pattern | Location | Purpose |
|---------|----------|---------|
| **Singleton** | OntologyRegistry | 단일 타입 저장소 |
| **Factory** | Exporters | 형식별 내보내기 |
| **Strategy** | Validators | 검증 방식 선택 |
| **Enum-based State** | ObjectStatus | 라이프사이클 관리 |

### 권장 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│ Application Layer (Claude Commands/Skills)              │
├─────────────────────────────────────────────────────────┤
│ Integration Layer (cow, hooks, etc.)                    │
├─────────────────────────────────────────────────────────┤
│ Ontology-Definition Package                             │
│ ├── Registry (싱글톤)                                   │
│ ├── Validators (검증)                                   │
│ ├── Exporters (내보내기)                                │
│ └── Types (ObjectType, LinkType, ActionType...)         │
├─────────────────────────────────────────────────────────┤
│ JSON Schemas (6 files, 4,389 lines)                     │
└─────────────────────────────────────────────────────────┘
```

---

*Generated: 2026-01-23 | AgentId: adf5a5e*

#!/bin/bash
# L1/L2 Inject Hook - PreToolUse
#
# Version: 2.2.0
# Purpose:
#   1. Inject run_in_background=true for all Task() calls (updatedInput)
#   2. Inject L1/L2 output format prompt (additionalContext)
#
# Trigger: PreToolUse on Task tool
# Dependencies: jq (JSON parsing)
#
# Native Capabilities Used:
#   - updatedInput (V2.1.9): Modify tool parameters
#   - additionalContext (V2.1.9): Inject context to subagent prompt

set -euo pipefail

# Read JSON from stdin
INPUT=$(cat)

# Extract tool name - only process Task tool
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // ""')
if [[ "$TOOL_NAME" != "Task" ]]; then
    echo '{"hookSpecificOutput":{"permissionDecision":"allow"}}'
    exit 0
fi

# Extract current tool_input
CURRENT_INPUT=$(echo "$INPUT" | jq -c '.tool_input // {}')

# Check if already set to background
ALREADY_BACKGROUND=$(echo "$CURRENT_INPUT" | jq -r '.run_in_background // false')

# L1/L2 Format Prompt (injected via additionalContext)
L1L2_PROMPT='## L1/L2 Output Format (MANDATORY)

Your output MUST follow this structure:

### L1 Section (Return to Main Agent - MAX 500 TOKENS)
```yaml
taskId: {auto-generate unique id}
agentType: {Explore|Plan|general-purpose}
summary: |
  1-2 sentence summary (max 200 chars)
status: success | partial | failed
findingsCount: {number}
criticalCount: {number}
l2Index:
  - anchor: "#section-name"
    lines: "start-end"
    description: "what this section contains"
l2Path: .agent/outputs/{agentType}/{taskId}.md
requiresL2Read: true | false
nextActionHint: "suggested next step"
```

### L2 Section (Write to File)
Write detailed output to: .agent/outputs/{agentType}/{taskId}.md
Use markdown anchors (## Section {#anchor}) matching l2Index.

CONSTRAINT: L1 MUST NOT EXCEED 500 TOKENS. Be concise.'

if [[ "$ALREADY_BACKGROUND" == "true" ]]; then
    # Already background - only add additionalContext
    # Use jq to properly escape the prompt for JSON
    ESCAPED_PROMPT=$(echo "$L1L2_PROMPT" | jq -Rs .)

    cat <<RESPONSE
{
  "hookSpecificOutput": {
    "permissionDecision": "allow",
    "additionalContext": $ESCAPED_PROMPT
  }
}
RESPONSE
    exit 0
fi

# Inject run_in_background=true + additionalContext
UPDATED_INPUT=$(echo "$CURRENT_INPUT" | jq -c '. + {"run_in_background": true}')
ESCAPED_PROMPT=$(echo "$L1L2_PROMPT" | jq -Rs .)

cat <<RESPONSE
{
  "hookSpecificOutput": {
    "permissionDecision": "allow",
    "updatedInput": $UPDATED_INPUT,
    "additionalContext": $ESCAPED_PROMPT
  }
}
RESPONSE

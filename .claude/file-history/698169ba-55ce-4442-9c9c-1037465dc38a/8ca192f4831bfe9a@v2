# Draft: L1/L2 Orchestrating Pattern 고도화 (V2.2.0)

> **Version:** 2.0 | **Status:** COMPLETED | **Date:** 2026-01-20
> **Auto-Compact Safe:** This file persists across context compaction

---

## INDEX

### 요구사항 요약
`/plan` 스킬을 Native Capabilities (V2.1.9~V2.1.12) 최대 활용하여 고도화:
- **Shell Hook**으로 `run_in_background=true` + L1/L2 형식 강제
- **lib/ 참조 완전 제거** (CLAUDE.md, skills 포함)
- `updatedInput` + `additionalContext` 병행 사용

### Complexity
- **예상 복잡도:** medium
- **영향 파일:** 5개 ([상세](#file-analysis))
  - Hook: 1개 (신규 Shell Script)
  - Skill: 1개 (plan.md 수정)
  - Config: 1개 (settings.json Hook 등록)
  - Docs: 2개 (CLAUDE.md, references 정리)

### Q&A 핵심
1. **Q:** Hook은 Python 필수? → **A:** 아니오. Shell로 `updatedInput` + `additionalContext` 모두 가능
2. **Q:** TaskDecomposer Native? → **A:** 아니오. Custom 모듈 (삭제됨). 프롬프트 가이드라인으로 대체
3. **Q:** L1/L2 강제 방법? → **A:** PreToolUse Hook에서 `additionalContext`로 형식 프롬프트 주입
4. **Q:** `updatedInput` 필요 이유? → **A:** `run_in_background=true`는 시스템 파라미터, 프롬프트가 아님

### 추천 접근법
1. **Shell Hook** 작성 (`l1l2_inject.sh`) - `updatedInput` + `additionalContext` 동시 반환
2. **Skill 수정** - lib/ 참조 제거, Native 패턴으로 교체
3. **CLAUDE.md 정리** - lib/oda/planning/* 참조 모두 제거

### 리스크
- Shell에서 복잡한 JSON 생성 시 이스케이프 문제 → heredoc 사용으로 해결
- jq 의존성 → 대부분 Linux/macOS에 기본 포함

### 다음 단계
`/plan` 실행 권장. 이 draft 기반으로 구현 계획 생성.

---

## DETAIL: Q&A 전체 로그 {#qa-log}

### Round 1 (2026-01-20 이전 세션)
**Q:** `run_in_background=true` 기능은 프롬프트 입력사항인가?
**A:** 아니오. Hook이 PreToolUse에서 자동 주입하는 시스템 파라미터

### Round 2 (2026-01-20 이전 세션)
**Q:** Hook은 Native인가?
**A:** Hook 시스템(10개 이벤트)은 Native API, 스크립트(force_background.py)는 Custom

### Round 3 (2026-01-20 현재 세션)
**Q:** L1/L2 강제 구현 방법?
**A:** Native V2.1.9 `additionalContext`로 프롬프트에 형식 지시 주입

### Round 4 (2026-01-20 현재 세션)
**Q:** lib/ 참조 처리?
**A:** 완전 제거. CLAUDE.md, skills에서 모든 lib/oda/planning/* 참조 삭제

### Round 5 (2026-01-20 현재 세션)
**Q:** Hook은 Python 필수?
**A:** 아니오. Shell로 JSON 출력 가능. `updatedInput`도 Shell에서 처리 가능

### Round 6 (2026-01-20 현재 세션)
**Q:** `updatedInput` 필요 이유?
**A:** `run_in_background=true`는 도구 파라미터 강제 변경 필요 (프롬프트 지시로 불가)

---

## DETAIL: 요구사항 상세 {#requirements}

### 기능 요구사항
- **FR1:** Shell Hook으로 모든 Task()에 `run_in_background=true` 강제 주입 (`updatedInput`)
- **FR2:** Shell Hook으로 L1/L2 출력 형식 프롬프트 주입 (`additionalContext`)
- **FR3:** `/plan` 스킬에서 lib/ 참조 완전 제거
- **FR4:** CLAUDE.md에서 lib/oda/planning/* 참조 완전 제거
- **FR5:** L1 출력은 500 tokens 이하, L2는 `.agent/outputs/`에 저장

### 비기능 요구사항
- **NFR1:** Hook 실행 시간 < 50ms (Shell이므로 충족)
- **NFR2:** jq 외 추가 의존성 없음
- **NFR3:** 기존 Hook 동작 유지 (하위 호환)

---

## DETAIL: 파일 분석 결과 {#file-analysis}

### 관련 파일 목록
| 파일 | 관련도 | 작업 |
|------|--------|------|
| `.claude/hooks/l1l2/l1l2_inject.sh` | 높음 | **신규 생성** - Shell Hook |
| `.claude/hooks/l1l2/force_background.py` | 높음 | **삭제 또는 교체** |
| `.claude/settings.json` | 높음 | Hook 등록 변경 (py → sh) |
| `.claude/skills/plan.md` | 높음 | lib/ 참조 제거, version 2.2.0 |
| `.claude/CLAUDE.md` | 높음 | Section 2.7, 2.10, 9 정리 |

### 삭제 대상 (lib/ 참조)
| 위치 | 삭제할 내용 |
|------|------------|
| `skills/plan.md:18-20` | references 섹션의 lib/* 경로 |
| `skills/plan.md:48-54` | `from lib.oda.planning import` 코드 블록 |
| `CLAUDE.md:2.7` | TaskDecomposer 전체 섹션 |
| `CLAUDE.md:2.10` | ContextBudgetManager 전체 섹션 |
| `CLAUDE.md:9` | Reference Index의 lib/* 경로들 |

---

## DETAIL: Shell Hook 설계 {#hook-design}

### `l1l2_inject.sh` 전체 코드

```bash
#!/bin/bash
# L1/L2 Inject Hook - PreToolUse
#
# 역할:
#   1. run_in_background=true 강제 주입 (updatedInput)
#   2. L1/L2 출력 형식 프롬프트 주입 (additionalContext)
#
# 트리거: Task 도구 호출 시
# 의존성: jq (JSON 파싱)

set -euo pipefail

# stdin에서 JSON 읽기
INPUT=$(cat)

# Task 도구만 처리
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // ""')
if [[ "$TOOL_NAME" != "Task" ]]; then
    echo '{"hookSpecificOutput":{"permissionDecision":"allow"}}'
    exit 0
fi

# 현재 tool_input 추출
CURRENT_INPUT=$(echo "$INPUT" | jq -c '.tool_input // {}')

# 이미 run_in_background=true면 additionalContext만 추가
ALREADY_BACKGROUND=$(echo "$CURRENT_INPUT" | jq -r '.run_in_background // false')

if [[ "$ALREADY_BACKGROUND" == "true" ]]; then
    # additionalContext만 추가
    cat <<'RESPONSE'
{
  "hookSpecificOutput": {
    "permissionDecision": "allow",
    "additionalContext": "## L1/L2 Output Format (MANDATORY)\n\nYour output MUST follow this structure:\n\n### L1 Section (Return to Main Agent - MAX 500 TOKENS)\n```yaml\ntaskId: {auto-generate unique id}\nagentType: {Explore|Plan|general-purpose}\nsummary: |\n  1-2 sentence summary (max 200 chars)\nstatus: success | partial | failed\nfindingsCount: {number}\ncriticalCount: {number}\nl2Index:\n  - anchor: \"#section-name\"\n    lines: \"start-end\"\n    description: \"what this section contains\"\nl2Path: .agent/outputs/{agentType}/{taskId}.md\nrequiresL2Read: true | false\nnextActionHint: \"suggested next step\"\n```\n\n### L2 Section (Write to File)\nWrite detailed output to: .agent/outputs/{agentType}/{taskId}.md\nUse markdown anchors (## Section {#anchor}) matching l2Index.\n\nCONSTRAINT: L1 MUST NOT EXCEED 500 TOKENS. Be concise."
  }
}
RESPONSE
    exit 0
fi

# run_in_background=true 추가 + additionalContext
UPDATED_INPUT=$(echo "$CURRENT_INPUT" | jq -c '. + {"run_in_background": true}')

# JSON 응답 생성 (heredoc으로 이스케이프 문제 방지)
cat <<RESPONSE
{
  "hookSpecificOutput": {
    "permissionDecision": "allow",
    "updatedInput": $UPDATED_INPUT,
    "additionalContext": "## L1/L2 Output Format (MANDATORY)\n\nYour output MUST follow this structure:\n\n### L1 Section (Return to Main Agent - MAX 500 TOKENS)\n\`\`\`yaml\ntaskId: {auto-generate unique id}\nagentType: {Explore|Plan|general-purpose}\nsummary: |\n  1-2 sentence summary (max 200 chars)\nstatus: success | partial | failed\nfindingsCount: {number}\ncriticalCount: {number}\nl2Index:\n  - anchor: \"#section-name\"\n    lines: \"start-end\"\n    description: \"what this section contains\"\nl2Path: .agent/outputs/{agentType}/{taskId}.md\nrequiresL2Read: true | false\nnextActionHint: \"suggested next step\"\n\`\`\`\n\n### L2 Section (Write to File)\nWrite detailed output to: .agent/outputs/{agentType}/{taskId}.md\nUse markdown anchors (## Section {#anchor}) matching l2Index.\n\nCONSTRAINT: L1 MUST NOT EXCEED 500 TOKENS. Be concise."
  }
}
RESPONSE
```

### settings.json Hook 등록

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "/home/palantir/.claude/hooks/l1l2/l1l2_inject.sh"
          }
        ]
      }
    ]
  }
}
```

---

## DETAIL: Skill 수정 계획 {#skill-modification}

### `/plan` Skill V2.2.0 변경사항

```yaml
# Before (V2.1.8)
references:
  - lib/oda/planning/execution_orchestrator.py  # ❌ 삭제
  - lib/oda/planning/todowrite_tracker.py       # ❌ 삭제
  - .claude/CLAUDE.md#2.6.5

# After (V2.2.0)
references:
  - .claude/CLAUDE.md#2.5  # Parallel Execution Rules
  - .claude/references/native-capabilities.md
```

### 코드 블록 변경

```python
# Before (V2.1.8)
from lib.oda.planning import should_decompose_task, decompose_task  # ❌ 삭제

# After (V2.2.0)
# No Python imports - Native Hook handles L1/L2 format injection
# TaskDecomposer replaced by prompt guidelines
```

---

## DETAIL: CLAUDE.md 정리 계획 {#claudemd-cleanup}

### 삭제할 섹션
| 섹션 | 이유 |
|------|------|
| 2.7 Pre-Delegation Decomposition | TaskDecomposer (lib/) 참조 |
| 2.10 Context-Aware Delegation | ContextBudgetManager (lib/) 참조 |

### 수정할 섹션
| 섹션 | 변경 내용 |
|------|----------|
| 2.5 Parallel Execution Rules | lib/ 참조 제거, Native Hook 언급 |
| 2.5.1 Resume Parameter | lib/ 코드 예시 제거 |
| 9 Reference Index | lib/* 경로 모두 제거 |

### 추가할 내용
| 섹션 | 내용 |
|------|------|
| 2.11 (신규) | L1/L2 Orchestrating Pattern - Hook이 자동 주입 |

---

## DETAIL: 리스크 분석 {#risk-analysis}

| 리스크 | 영향 | 완화 방안 |
|--------|------|----------|
| Shell JSON 이스케이프 | Medium | heredoc 사용, jq로 검증 |
| jq 미설치 환경 | Low | 대부분 기본 포함, 없으면 경고 후 통과 |
| 기존 Hook 충돌 | Medium | force_background.py 삭제 후 교체 |
| additionalContext 무시 | Low | Claude 네이티브 기능, 안정적 동작 |

---

## DETAIL: 구현 Phase 계획 {#implementation-phases}

### Phase 1: Shell Hook 생성
- [ ] `l1l2_inject.sh` 작성
- [ ] 실행 권한 부여 (`chmod +x`)
- [ ] 로컬 테스트 (echo로 JSON 검증)

### Phase 2: Hook 등록 변경
- [ ] `settings.json` 수정 (py → sh)
- [ ] 기존 `force_background.py` 백업/삭제

### Phase 3: Skill 수정
- [ ] `plan.md` version 2.2.0으로 업데이트
- [ ] lib/ 참조 제거
- [ ] Native 패턴으로 교체

### Phase 4: CLAUDE.md 정리
- [ ] Section 2.7, 2.10 삭제
- [ ] Section 9 lib/* 참조 제거
- [ ] Section 2.11 L1/L2 패턴 추가

### Phase 5: 검증
- [ ] `/plan` 실행하여 L1/L2 형식 확인
- [ ] `.agent/outputs/` 디렉토리 생성 확인
- [ ] Auto-Compact 후 복구 테스트

---

## Metadata

- Created: 2026-01-20 10:30
- Last Updated: 2026-01-20 11:30
- Q&A Rounds: 6
- Status: COMPLETED

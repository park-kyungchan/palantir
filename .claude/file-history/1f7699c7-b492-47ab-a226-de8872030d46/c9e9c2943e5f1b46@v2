# Context Handoff for Session Restart
# Machine-Readable Format for Claude Code Session Continuity
# =============================================================

version: "1.0.0"
created_at: "2026-01-23T23:59:00+09:00"
handoff_type: session_restart

# =============================================================
# CRITICAL: 세션 간 Task 공유 설정
# =============================================================
session_config:
  task_list_id: "palantir-v3-refactor"
  start_command: "CLAUDE_CODE_TASK_LIST_ID=palantir-v3-refactor claude"
  storage_path: "~/.claude/tasks/palantir-v3-refactor/"

  # 세션 간 공유 메커니즘
  sharing_mechanism:
    description: |
      Claude Code v2.1.16+에서 도입된 Tasks 시스템.
      CLAUDE_CODE_TASK_LIST_ID 환경변수로 활성화.
      여러 세션이 동일한 Task List를 공유하며,
      한 세션의 TaskUpdate가 다른 세션에 broadcast됨.

    key_tools:
      - TaskCreate: "새 Task 생성 (의존성 포함 가능)"
      - TaskUpdate: "Task 상태/내용 수정 (broadcast)"
      - TaskGet: "단일 Task 조회"
      - TaskList: "전체 Task 목록 조회"

    task_schema:
      id: "string (auto-generated)"
      subject: "string (imperative form)"
      description: "string (detailed requirements)"
      status: "pending | in_progress | completed"
      activeForm: "string (present continuous, shown in spinner)"
      owner: "string (session_id or agent_name)"
      blockedBy: "array of task IDs"
      blocks: "array of task IDs"
      metadata: "object (arbitrary key-value pairs)"

    broadcast_behavior: |
      - TaskUpdate 호출 시 파일 시스템에 즉시 저장
      - 같은 TASK_LIST_ID를 사용하는 모든 세션에 변경 전파
      - 다른 세션은 TaskList로 최신 상태 조회 가능

# =============================================================
# 프로젝트 컨텍스트
# =============================================================
project:
  name: "Palantir V3 Refactor"
  goal: |
    세션 간 Task 공유를 핵심 인프라로 활용하여
    기존 Agents/Skills/Hooks 시스템을 대규모로 개선.
    Pre-Compact 훅의 비효율성을 제거하고,
    Task 기반 영속성 + 의존성 그래프로 대체.

  master_plan_path: ".agent/plans/palantir-v3-refactor-master-prompt.md"

  phases:
    - id: 1
      name: "Hook 통합 및 정리"
      status: "in_progress"  # 다른 터미널에서 진행 중
      tasks:
        - id: "1.1"
          name: "중복 Hook 통합"
          status: "completed"
          evidence:
            - "~/.claude/hooks/task-pipeline/pd-task-interceptor.sh 생성됨"
            - "~/.claude/hooks/task-pipeline/pd-task-processor.sh 생성됨"
        - id: "1.2"
          name: "Pre-Compact 훅 제거"
          status: "unknown"
        - id: "1.3"
          name: "Hook 파이프라인 최적화"
          status: "pending"

    - id: 2
      name: "Task 기반 상태 관리"
      status: "pending"
      blockedBy: [1]

    - id: 3
      name: "Agent-Skill-Hook 명시적 통합"
      status: "pending"
      blockedBy: [2]

    - id: 4
      name: "Progressive-Disclosure 최적화"
      status: "pending"
      blockedBy: [3]

# =============================================================
# 분석 결과 참조
# =============================================================
analysis:
  agents:
    count: 4
    list:
      - name: "onboarding-guide"
        role: "신규 사용자 가이드"
        model: "haiku"
      - name: "clarify-agent"
        role: "PE 기법 적용"
        model: "sonnet"
      - name: "pd-readonly-analyzer"
        role: "읽기 전용 분석 (A1 패턴)"
        model: "haiku"
      - name: "pd-skill-loader"
        role: "스킬 사전로드 (A2 패턴)"
        model: "sonnet"

  skills:
    count: 4
    list:
      - "commit-push-pr"
      - "plan-draft"
      - "clarify"
      - "build"

  hooks:
    original_count: 11
    target_count: 7
    consolidated:
      - from: ["pd-inject.sh", "pd-pretooluse.sh"]
        to: "pd-task-interceptor.sh"
        status: "completed"
      - from: ["post-task-output.sh", "pd-posttooluse.sh"]
        to: "pd-task-processor.sh"
        status: "completed"
    to_remove:
      - "pre-compact.sh"
        reason: "Task 기반 상태 관리로 대체"

# =============================================================
# 다음 세션에서의 행동 지침
# =============================================================
next_session_instructions:
  priority: CRITICAL

  immediate_actions:
    - action: "Task List 상태 확인"
      command: "TaskList 도구 호출"
      purpose: "다른 터미널의 진행 상황 파악"

    - action: "Phase 1 완료 여부 확인"
      check_files:
        - "~/.claude/hooks/task-pipeline/pd-task-interceptor.sh"
        - "~/.claude/hooks/task-pipeline/pd-task-processor.sh"
        - "settings.json hooks 섹션 업데이트 여부"

    - action: "필요 시 Phase 2 시작"
      condition: "Phase 1 완료 확인 시"
      tasks:
        - "Task Schema V2 정의"
        - "session-start.sh Task 로드 로직 추가"
        - "session-end.sh Task 저장 로직 추가"

  context_recovery:
    master_plan: ".agent/plans/palantir-v3-refactor-master-prompt.md"
    this_handoff: ".agent/context-handoff.yaml"
    analysis_output: ".agent/outputs/Explore/"

# =============================================================
# 협업 세션 정보
# =============================================================
parallel_sessions:
  - id: "session_b"
    terminal: "다른 터미널"
    task_list_id: "palantir-v3-refactor"
    current_work: "Phase 1: Hook 통합 및 정리"
    status: "in_progress"

  - id: "session_a"
    terminal: "이 터미널 (재시작 예정)"
    task_list_id: "palantir-v3-refactor"
    planned_work: "Phase 1 완료 확인 → Phase 2 준비 또는 병렬 작업"
    status: "restarting"

# =============================================================
# 중요 참고사항
# =============================================================
notes:
  - "Pre-Compact 훅은 Context 70% 도달 시 실행되어 '이미 늦은' 대응이었음"
  - "Task 기반 영속성은 실시간 저장으로 이 문제를 근본적으로 해결"
  - "Registry.yaml 패턴으로 Agent/Skill/Hook 관계를 명시적으로 선언하면 /build 시 자동 등록 가능"
  - "세션 간 공유의 진정한 가치: 여러 Claude 인스턴스가 동시에 같은 프로젝트를 협업"

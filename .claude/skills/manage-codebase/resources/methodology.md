# Manage Codebase — Detailed Methodology

> On-demand reference. Contains DPS templates for full generation and incremental update,
> map schema format, hotspot scoring criteria, decision point details, and Phase 2 scope plans.

---

## Full Generation DPS Template (STANDARD/COMPLEX Tiers)

Spawn analyst agent with `subagent_type: analyst`, `maxTurns: 30`:

- **Context** (D11 priority: cognitive focus > token efficiency):
  - INCLUDE: Scope paths (`.claude/agents/*.md`, `.claude/skills/*/SKILL.md`, `.claude/hooks/*.sh`,
    `.claude/settings.json`, `.claude/CLAUDE.md`, `.claude/projects/*/memory/MEMORY.md`). Exclusion list.
    Reference detection patterns (SKILL.md: INPUT_FROM/OUTPUT_TO; Agent .md: skill/tool names;
    CLAUDE.md: agent/skill/domain names; Hook .sh: file paths; settings.json: hook paths).
  - EXCLUDE: Pipeline history, agent-memory runtime data, other homeostasis skills' findings.
  - Budget: context ≤ 30% of analyst context window.
- **Task**: "Enumerate all .claude/ files within scope filters. For each file, grep for structural
  references to other tracked files. Build bidirectional refs and calculate hotspot scores.
  Write complete codebase-map.md."
- **Constraints**: Write output to `.claude/agent-memory/analyst/codebase-map.md` only.
  Max 150 entries / 300 lines.
- **Expected Output**: L1 YAML with entries count, mode: full-generation, hotspot distribution.
  Complete codebase-map.md per map schema below.
- **Delivery**: Write full result to `tasks/{team}/homeostasis-manage-codebase.md`.
  Send micro-signal to Lead: `{STATUS}|entries:{N}|mode:full|ref:tasks/{team}/homeostasis-manage-codebase.md`.
  Fallback if no team active: `/tmp/pipeline/homeostasis-manage-codebase.md`.

---

## Incremental Update DPS Template (STANDARD/COMPLEX Tiers)

Spawn analyst agent with `subagent_type: analyst`, `maxTurns: 20`:

- **Context** (D11 priority: cognitive focus > token efficiency):
  - INCLUDE: Changed file list from pipeline execution (from Lead's context or SRC log).
    Current codebase-map.md entries for changed files. Scope filters and exclusion list.
  - EXCLUDE: Pipeline history, full pipeline state, other homeostasis skills' findings.
  - Budget: context ≤ 30% of analyst context window.
- **Task**: "For each changed file: (1) Re-scan refs by grepping content for references to other
  tracked files, (2) Update refd_by bidirectionally, (3) Handle new files (add entry), deleted
  files (remove entry), renames (old→new). Recalculate hotspot scores. Set updated date."
- **Constraints**: Write output to `.claude/agent-memory/analyst/codebase-map.md` only.
  Follow existing map schema. Stay within 150 entries / 300 lines.
- **Expected Output**: L1 YAML with entries updated/added/removed counts, mode: incremental-update.
  Updated codebase-map.md.
- **Delivery**: Write full result to `tasks/{team}/homeostasis-manage-codebase.md`.
  Send micro-signal to Lead: `{STATUS}|entries:{N}|mode:{mode}|ref:tasks/{team}/homeostasis-manage-codebase.md`.
  Fallback if no team active: `/tmp/pipeline/homeostasis-manage-codebase.md`.

---

## Map Schema Format

```markdown
# Codebase Dependency Map
<!-- Generated by manage-codebase skill -->
<!-- Last full scan: {YYYY-MM-DD} -->
<!-- Last incremental: {YYYY-MM-DD} -->
<!-- Entry count: {N} -->
<!-- Scope: .claude/ -->

## {relative/path/to/file}
refs: {comma-separated basenames of files this file references}
refd_by: {comma-separated basenames of files that reference this file}
hotspot: {low|medium|high}
updated: {YYYY-MM-DD}
```

---

## Hotspot Scoring Criteria

| Score | Condition |
|-------|-----------|
| `high` | `refd_by` count >= 5 |
| `medium` | `refd_by` count 3-4 |
| `low` | `refd_by` count 0-2 |

Size limit: Max 150 entries (~300 lines, ~15KB). If exceeding: prune `hotspot: low` entries
with oldest `updated` dates first.

---

## Decision Point Details

### Staleness Threshold

- **30% stale triggers full regeneration** (default): When more than 30% of map entries have
  `updated` dates older than their git modification dates, an incremental update would touch so
  many entries that full regeneration is more efficient.
- **Accept higher staleness**: For very large maps approaching the 150-entry limit, tolerate up
  to 50% staleness to avoid costly full scans. Only use when map health is otherwise good
  (no orphans, no broken refs).

### Pruning Strategy When Exceeding Limits

- **Prune by hotspot+age** (default): Remove `hotspot: low` entries with oldest `updated` dates
  first. Preserves high-traffic files most useful for impact analysis.
- **Prune by scope relevance**: Remove entries outside the current pipeline's scope. Use when the
  map has grown to include Phase 2 (application source) entries no longer actively tracked.

### Bidirectional Inconsistency Handling

- **Full re-scan of affected entries** (default): When A refs B but B doesn't refd_by A, re-scan
  both files completely. Most accurate but slower.
- **Patch the missing direction**: Simply add the missing reverse reference without re-scanning.
  Faster but may miss other inconsistencies in those files.

---

## Phase 2 Scope (Future — Deferred)

Application source code tracking (beyond `.claude/`):
- Triggered by user configuration flag
- Would require: separate map file, language-specific reference detection
- NOT part of current SRC implementation scope

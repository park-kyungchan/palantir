---
name: manage-codebase
description: |
  [Homeostasis·Manager·Codebase] Dependency map generator and maintainer. Creates/updates .claude/agent-memory/analyst/codebase-map.md with per-file dependency data (refs, refd_by, hotspot). Full scan on first run, incremental after pipeline execution.

  WHEN: After pipeline execution completes, after major codebase changes, or periodic maintenance. AI can auto-invoke.
  DOMAIN: Homeostasis (cross-cutting, operates on codebase-map.md).

  SCOPE: .claude/ directory (Phase 1). Max 150 entries, 300 lines.
  METHODOLOGY: (1) Check if codebase-map.md exists, (2) If not: full scan via Glob+Grep, (3) If exists: incremental update for changed files, (4) Detect stale entries (>7 days), prune deleted files, (5) Calculate hotspot scores, write updated map.
  OUTPUT_FORMAT: L1 YAML map health report, codebase-map.md file.
user-invocable: true
argument-hint: "[full|incremental]"
disable-model-invocation: false
---

# Manage — Codebase

## Execution Model
- **TRIVIAL**: Lead-direct. Quick staleness check or single-file incremental update.
- **STANDARD**: Spawn 1 analyst. Incremental update for 3-8 changed files. Expected ~1-2 minutes.
- **COMPLEX**: Spawn 1 analyst with extended maxTurns. Full generation scan of entire `.claude/` scope. Expected ~5 minutes.

## Methodology

### 1. Determine Mode
Check operating mode based on input:
- **User argument** `full`: Force full regeneration regardless of existing map state
- **User argument** `incremental`: Incremental update only (fail if no map exists)
- **No argument (default)**: Auto-detect — if `codebase-map.md` exists and is valid, use incremental; otherwise full
- **Post-pipeline invocation**: Lead provides list of changed files for incremental update

Check codebase-map.md at `.claude/agent-memory/analyst/codebase-map.md`:
- If file does not exist: switch to full generation
- If file is corrupted (unparseable): delete and regenerate from scratch
- If >30% of entries have `updated` date older than 7 days: recommend full regeneration

### 2. Full Generation (First Run or Recovery)
Spawn analyst agent with `subagent_type: analyst`, `maxTurns: 30`:

1. **Enumerate files**: `Glob .claude/**/*` to list all files in scope
2. **Apply scope filters**:
   - Include: `.claude/agents/*.md`, `.claude/skills/*/SKILL.md`, `.claude/hooks/*.sh`, `.claude/settings.json`, `.claude/CLAUDE.md`, `.claude/projects/*/memory/MEMORY.md`
   - Exclude: `.claude/agent-memory/` (except codebase-map.md tracking), `.claude/agent-memory-local/`, `.claude/projects/*/memory/cc-reference/*`, binary files
3. **For each file**: Grep content for references to other tracked files
   - Reference detection patterns:
     - SKILL.md: INPUT_FROM/OUTPUT_TO values, agent names, skill names
     - Agent .md: skill names, tool names, path references
     - CLAUDE.md: agent names, skill names, domain names
     - Hook .sh: file paths, agent type names
     - settings.json: hook script paths, permission patterns
4. **Build bidirectional refs**: If file A references file B, then A's `refs` includes B and B's `refd_by` includes A
5. **Calculate hotspot scores**: Based on `refd_by` count
6. **Write complete map** to `.claude/agent-memory/analyst/codebase-map.md`

### 3. Incremental Update
For each changed file from pipeline execution:

1. **Re-scan `refs`**: Read file content, grep for references to other tracked files
2. **Update `refd_by` bidirectionally**: Add/remove from referenced files' `refd_by` lists
3. **Handle new files**: If changed file not in map, add new entry with full scan
4. **Handle deleted files**: If file in map no longer exists on filesystem, remove entry and clean `refd_by` references
5. **Handle renames** (detected via git): Remove old entry, add new, update all `refd_by` refs
6. **Recalculate hotspot** for all affected entries
7. **Set `updated` date** to today for all modified entries

### 4. Staleness Detection
For each existing entry in the map:
- Compare `updated` date against file's last git modification: `git log --format=%cd --date=short -1 -- {file_path}`
- Files modified after their `updated` date are flagged for re-scan
- Files not found on filesystem are removed immediately
- New `.claude/` files without map entries are flagged for addition
- If >30% of entries are stale: trigger full regeneration instead of incremental

### 5. Write Map and Report
**Map schema** (codebase-map.md):
```markdown
# Codebase Dependency Map
<!-- Generated by manage-codebase skill -->
<!-- Last full scan: {YYYY-MM-DD} -->
<!-- Last incremental: {YYYY-MM-DD} -->
<!-- Entry count: {N} -->
<!-- Scope: .claude/ -->

## {relative/path/to/file}
refs: {comma-separated basenames of files this file references}
refd_by: {comma-separated basenames of files that reference this file}
hotspot: {low|medium|high}
updated: {YYYY-MM-DD}
```

**Hotspot scoring**:

| Score | Condition |
|-------|-----------|
| `high` | `refd_by` count >= 10, OR file changed in last 3 pipeline runs |
| `medium` | `refd_by` count 4-9 |
| `low` | `refd_by` count 0-3 |

**Size limits**: Max 150 entries (~300 lines, ~15KB). If exceeding: prune `hotspot: low` entries with oldest `updated` dates first.

## Scope Boundary

### Phase 1 (Current): `.claude/` Directory Only
**Included paths:**
- `.claude/agents/*.md`
- `.claude/skills/*/SKILL.md`
- `.claude/hooks/*.sh`
- `.claude/settings.json`
- `.claude/CLAUDE.md`
- `.claude/projects/*/memory/MEMORY.md`

**Excluded paths:**
- `.claude/agent-memory/` (except codebase-map.md itself — but map does not track itself)
- `.claude/agent-memory-local/`
- `.claude/projects/*/memory/cc-reference/*` (reference docs, not INFRA components)
- Binary files, `.git/`, `node_modules/`

### Phase 2 (Future, Deferred): Application Source Code
- Triggered by user configuration flag
- Would require: separate map file, language-specific reference detection
- NOT part of current SRC implementation scope

## Error Handling
- **Map corrupted**: Delete and regenerate from scratch (full scan)
- **Map exceeds 300 lines**: Prune lowest-hotspot, oldest-updated entries
- **Filesystem scan timeout**: Produce partial map with `status: partial`
- **Missing entry detected**: Flag for addition on next update
- **Orphaned entry found**: Remove immediately, clean `refd_by` references
- **Bidirectional inconsistency**: Full re-scan of affected entries to fix

## Quality Gate
- All entries point to files that exist on filesystem
- `refs` and `refd_by` are bidirectionally consistent (A refs B implies B refd_by A)
- Hotspot scores match threshold criteria
- No entries for excluded paths
- Map within 300-line limit
- Analyst completed within maxTurns (30)

## Output

### L1
```yaml
domain: homeostasis
skill: manage-codebase
status: complete|partial
mode: full-generation|incremental-update|staleness-check
entries: 0
stale_entries_removed: 0
new_entries_added: 0
entries_updated: 0
map_path: ".claude/agent-memory/analyst/codebase-map.md"
staleness_report:
  total_entries: 0
  stale_count: 0
  missing_count: 0
  recommendation: "none|incremental|full-regeneration"
```

### L2
- Mode selection rationale (full vs incremental)
- Files scanned and references discovered
- Staleness detection results
- Entries added, updated, or removed
- Map health summary with hotspot distribution

# /clarify Skill - Complete Logging Implementation

## Overview

`/clarify` 스킬은 이제 **이중 로깅 시스템**을 통해 모든 상호작용을 완전히 기록합니다.

## Logging Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                   /clarify Logging System                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. Round Log (.agent/plans/clarify_{slug}.md)      │   │
│  │                                                     │   │
│  │    • Human-readable markdown format                 │   │
│  │    • Round-by-round progression                     │   │
│  │    • PE technique application details               │   │
│  │    • Final approved prompt                          │   │
│  │                                                     │   │
│  │    Generated by: helpers.sh functions               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 2. QA Audit Log (.agent/logs/clarify/{session}.jsonl)│ │
│  │                                                     │   │
│  │    • Machine-readable JSONL format                  │   │
│  │    • All AskUserQuestion exchanges                  │   │
│  │    • Timestamped with unique IDs                    │   │
│  │    • Traceability for compliance                    │   │
│  │                                                     │   │
│  │    Generated by: clarify-qa-logger.sh (PostToolUse) │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Usage

```bash
/clarify "사용자 요청 텍스트"
```

## Verification

### Check Round Log
```bash
ls -lht .agent/plans/clarify_*.md | head -1
cat .agent/plans/clarify_<slug>.md
```

### Check QA Audit Log
```bash
ls -lht .agent/logs/clarify/*.jsonl | head -1
cat .agent/logs/clarify/<session_id>-qa-audit.jsonl | jq .
```

## Log Locations

| Log Type | Path | Format | Purpose |
|----------|------|--------|---------|
| Round Log | `.agent/plans/clarify_{slug}.md` | Markdown | Human review |
| QA Audit | `.agent/logs/clarify/{session}-qa-audit.jsonl` | JSONL | Machine analysis |

## Hook Registration

The following hook is now active in `settings.json`:

```json
{
  "matcher": "AskUserQuestion",
  "hooks": [
    {
      "type": "command",
      "command": "/home/palantir/.claude/hooks/clarify-qa-logger.sh"
    }
  ]
}
```

## Helper Functions

Source: `/home/palantir/.claude/skills/clarify/helpers.sh`

- `generate_slug()`: Create file-safe slug from input
- `write_log_header()`: Initialize round log
- `append_round_log()`: Add round entry
- `finalize_log()`: Mark as completed
- `cancel_log()`: Mark as cancelled
- `update_round_summary()`: Update summary table

## Testing

```bash
# 1. Invoke clarify with a test input
/clarify "테스트 요청입니다"

# 2. Go through at least one round of Q&A

# 3. Check logs
ls .agent/plans/clarify_*.md
ls .agent/logs/clarify/*.jsonl
```

## Troubleshooting

### No logs generated
- Ensure `.agent/plans/` and `.agent/logs/clarify/` directories exist
- Verify `helpers.sh` is executable: `chmod +x helpers.sh`
- Check hook is registered: `grep -A3 "AskUserQuestion" ~/.claude/settings.json`

### Partial logs
- Round log created but QA audit missing: Hook not triggered
- QA audit created but round log empty: Helper functions not called

## Status

- [x] AskUserQuestion hook registered in settings.json
- [x] clarify-qa-logger.sh hook script exists
- [x] helpers.sh utility functions created
- [x] SKILL.md updated with implementation details
- [x] Log directories created

**Current Status:** Fully operational, pending live testing.

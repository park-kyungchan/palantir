# Progressive-Disclosure Patterns Reference

> **Version:** 1.0.0 | **Level:** 50 (Recommended)
> **Generated by:** /build "Progressive-Disclosure"

---

## Pattern Overview

Progressive-Disclosure는 토큰 효율성을 위한 계층적 정보 전달 패턴입니다.

```
┌─────────────────────────────────────────────────────┐
│ L1: Summary (≤500 tokens)                           │
│ - Main Agent에 직접 반환                            │
│ - priority, summary, l2Index 포함                   │
└──────────────────────┬──────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────┐
│ L2: Index (l2Index[])                               │
│ - anchor, tokens, priority, description             │
│ - L3 섹션에 대한 메타데이터                         │
└──────────────────────┬──────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────┐
│ L3: Detail (File)                                   │
│ - .agent/outputs/{type}/{id}.md                     │
│ - ## Section {#anchor} 형식                         │
│ - 필요 시만 Read()로 접근                           │
└─────────────────────────────────────────────────────┘
```

---

## P1: Task Tool with run_in_background

**Purpose:** 서브에이전트 작업을 메인 컨텍스트와 분리하여 동시 실행

```python
Task(
    subagent_type="Explore",
    prompt="Analyze codebase structure",
    run_in_background=True,  # ← 핵심
    description="Background analysis"
)
```

**Benefits:**
- 메인 컨텍스트 오염 방지
- 동시 작업 가능
- 권한 요청 자동 거부 (사전 승인 없으면)

---

## P2: L1/L2/L3 Output Format Pattern

**Purpose:** 서브에이전트 출력을 3계층으로 구조화

### L1 Summary Format (MAX 500 tokens)

```yaml
taskId: abc12345
agentType: Explore
summary: "Found 15 API endpoints across 3 modules"
status: success

priority: HIGH
recommendedRead:
  - anchor: "#api-endpoints"
    reason: "Critical for understanding data flow"

l2Index:
  - anchor: "#api-endpoints"
    tokens: 800
    priority: HIGH
    description: "All REST API endpoint definitions"
  - anchor: "#data-models"
    tokens: 600
    priority: MEDIUM
    description: "Database schema and models"

l2Path: .agent/outputs/explore/abc12345.md
requiresL2Read: true
nextActionHint: "Review API endpoints before implementation"
```

### L3 Detail File Format

```markdown
<!-- .agent/outputs/explore/abc12345.md -->

## API Endpoints {#api-endpoints}
<!-- ~800 tokens -->

### GET /api/users
- Returns list of users
- Pagination supported

### POST /api/users
- Creates new user
- Requires authentication

## Data Models {#data-models}
<!-- ~600 tokens -->

### User Model
- id: UUID
- email: string
- created_at: timestamp
```

---

## P3: Priority-Based Reading Strategy

**Purpose:** 우선순위 기반으로 L3 섹션 선택적 읽기

| Priority | Action | When |
|----------|--------|------|
| CRITICAL | MUST read | 즉시 읽어야 함 |
| HIGH | SHOULD read | 권장 읽기 |
| MEDIUM | MAY read | 필요 시 읽기 |
| LOW | SKIP | L1만으로 충분 |

**Implementation:**

```python
# PostToolUse hook에서 priority 추출
priority = extract_priority(tool_result)

if priority == "CRITICAL":
    Read(l2_path)  # 즉시 L3 읽기
elif priority == "HIGH" and context_budget_available():
    Read(l2_path)  # 예산 있으면 읽기
# MEDIUM/LOW는 L1만 사용
```

---

## P5: Output Style Customization

**Purpose:** 시스템 프롬프트 포맷 커스터마이징

```yaml
# .claude/styles/my-style.md
---
name: my-style
description: Custom output formatting
keep-coding-instructions: true
---

## Output Requirements
- Always use Korean for explanations
- Include code examples
- Use markdown tables for comparisons
```

---

## P7: Agent ID Capture for Resumption

**Purpose:** 서브에이전트 ID 캡처하여 Resume 지원

**Hook Implementation (PostToolUse):**

```bash
# Extract agent_id from tool_result
AGENT_ID=$(echo "$INPUT" | jq -r '.tool_result.agent_id')

# Log for resume support
echo "$AGENT_ID" >> .agent/logs/agent_ids.log
```

**Resume Usage:**

```python
# Later, resume the agent
Task(
    resume="abc12345",  # ← Agent ID
    prompt="Continue previous analysis"
)
```

---

## T1: Task Tool Delegation

**Purpose:** 전문 에이전트에게 작업 위임

| Agent Type | Use Case | Tools |
|------------|----------|-------|
| `Explore` | 코드베이스 탐색 | Read, Grep, Glob |
| `Plan` | 구현 계획 수립 | Read, Grep, Glob |
| `general-purpose` | 복합 작업 | All tools |

```python
# Exploration task
Task(
    subagent_type="Explore",
    prompt="Find all authentication-related files",
    description="Auth file discovery"
)

# Planning task
Task(
    subagent_type="Plan",
    prompt="Design authentication system",
    model="opus"
)
```

---

## T2: Task Tool Output Formats

**Purpose:** Foreground/Background 실행 모드 구분

### Foreground (Default)

```python
Task(
    subagent_type="Explore",
    prompt="Quick lookup",
    run_in_background=False  # Blocks main conversation
)
```

- 메인 대화 블로킹
- 즉시 결과 반환
- 권한 요청 가능

### Background

```python
Task(
    subagent_type="Explore",
    prompt="Deep analysis",
    run_in_background=True  # Concurrent execution
)
```

- 동시 실행
- 결과는 나중에 확인
- 권한 요청 자동 거부

---

## Integration Example

```
┌─────────────────────────────────────────────────────────┐
│ User: "Analyze the authentication system"               │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│ PreToolUse Hook (H1)                                    │
│ - Inject L1/L2 format instructions                      │
│ - Set run_in_background=true                            │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│ Task(subagent_type="Explore")                           │
│ - Runs in background                                    │
│ - Outputs L1 summary + L3 file                          │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│ PostToolUse Hook (H2)                                   │
│ - Extract priority, agentId, l2Path                     │
│ - Provide reading guidance                              │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│ Main Agent                                              │
│ - Receives L1 summary (≤500 tokens)                     │
│ - Reads L3 if priority=CRITICAL/HIGH                    │
│ - Responds to user                                      │
└─────────────────────────────────────────────────────────┘
```

---

*Generated by /build "Progressive-Disclosure" | Level 50*

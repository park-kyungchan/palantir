# Context Injection: Export Stage Enhancement Preparation

## Mission
Export Stage 고도화 작업 준비를 위해 cow/ 파이프라인의 관련 코드베이스를 분석하고 컨텍스트를 구축하라.

## Background
PDF export 시 편집 가능한 중간 포맷(YAML)을 생성하고, 수정 후 PDF 재생성이 가능한 라운드트립 파이프라인을 구축할 예정이다.

### 요구사항 요약
```yaml
editable_elements:
  - latex_equations
  - text_content  
  - layout_position
  - font_style
  - images_graphs

pdf_requirements:
  - preserve_original_layout
  - support_new_template
  - show_change_history

workflow:
  - manual_yaml_edit
  - cli_tool
  - git_style_versioning

integration:
  - human_review_auto_sync

Analysis Tasks
Task 1: Export Stage 현황 분석
다음 파일들을 읽고 분석하라:

cow/src/mathpix_pipeline/stages/export_stage.py

현재 ExportStage 구현 구조
확장 포인트 (새 exporter 추가 방법)
RegenerationSpec 입력 구조
cow/src/mathpix_pipeline/export/engine.py

ExportEngine 아키텍처
Exporter 레지스트리 패턴
병렬/순차 실행 로직
cow/src/mathpix_pipeline/export/exporters/ 디렉토리

BaseExporter 인터페이스
기존 PDF Exporter 구현
JSON Exporter 구현 (YAML 변환 참고용)
Task 2: 스키마 구조 분석
다음 스키마 파일들을 분석하라:

cow/src/mathpix_pipeline/schemas/export.py

ExportSpec, ExportOptions, ExportFormat 정의
확장 필요 필드 식별
cow/src/mathpix_pipeline/schemas/regeneration.py

RegenerationSpec 구조 (Export 입력)
RegenerationOutput 구조
cow/src/mathpix_pipeline/schemas/alignment.py

AlignedPair 구조 (좌표/위치 정보)
MatchedElement 구조
cow/src/mathpix_pipeline/schemas/semantic_graph.py

SemanticNode 구조 (요소 타입, 속성)
SemanticEdge 구조
Task 3: Human Review 연계점 분석
다음 파일들에서 Export와의 연계점을 파악하라:

cow/src/mathpix_pipeline/stages/human_review_stage.py

수정 데이터가 어떻게 저장되는지
ReviewSummary와 Export 연결점
cow/src/mathpix_pipeline/human_review/models/annotation.py

Annotation 모델 (수정 내용 표현)
수정 이력 구조
cow/src/mathpix_pipeline/human_review/feedback_loop.py

피드백이 파이프라인에 반영되는 방식
Task 4: 파이프라인 오케스트레이션 분석
cow/src/mathpix_pipeline/pipeline/orchestrator.py

스테이지 간 데이터 흐름
Stage G → Stage H 전달 구조
cow/src/mathpix_pipeline/pipeline/stage_runners.py

스테이지 실행 패턴
Output Requirements
분석 결과를 다음 YAML 구조로 정리하라:

analysis_output:
  metadata:
    analyzed_at: "timestamp"
    files_read: [list of file paths]
    
  export_stage:
    current_architecture:
      entry_point: "..."
      extension_points: [...]
      limitations: [...]
    
    exporter_registry:
      pattern: "..."
      registered_exporters: [...]
      add_new_exporter_method: "..."
      
    input_structure:
      regeneration_spec_fields: [...]
      required_for_yaml_export: [...]
      
  schemas:
    export_schema:
      current_fields: [...]
      extension_needed: [...]
      
    position_data:
      available_in: "which schema"
      coordinate_system: "..."
      fields: [...]
      
    element_types:
      supported: [...]
      properties_per_type: {...}
      
  human_review_integration:
    modification_storage:
      location: "..."
      format: "..."
    
    sync_mechanism:
      current: "..."
      proposed: "..."
      
    annotation_structure:
      fields: [...]
      
  pipeline_flow:
    stage_g_to_h:
      data_passed: [...]
      transformation: "..."
      
    injection_points:
      for_yaml_generation: [...]
      for_versioning: [...]
      
  extension_plan:
    new_components_needed:
      - name: "YAMLExporter"
        location: "..."
        interface: "..."
        
      - name: "EditablePDFExporter"
        location: "..."
        dependencies: [...]
        
      - name: "VersionManager"
        location: "..."
        
      - name: "DiffRenderer"
        location: "..."
        
    schema_extensions:
      - schema: "..."
        new_fields: [...]
        
    cli_commands:
      - command: "..."
        purpose: "..."

Instructions
위 파일들을 순차적으로 읽고 분석
각 Task별로 핵심 발견사항 정리
최종 analysis_output YAML 생성
.agent/prompts/export-enhancement/context_analysis.yaml에 저장
중요: 코드 수정 없이 분석만 수행. 리서치 결과 도착 후 구현 시작.


---
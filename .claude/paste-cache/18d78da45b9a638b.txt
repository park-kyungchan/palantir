  ---
  최종 고도화 프롬프트 (V3 - Final)

  ## Comprehensive TodoWrite Protocol (V3)

  ### 핵심 목적

  **TodoWrite는 "지금 무엇을 하고 있는가"의 실시간 명세서다.**

  장시간 작업에서:
  - Main Agent는 수십 개의 Subagent를 위임
  - 각 Subagent는 요약된 결과만 반환
  - **전체 맥락이 희석되기 쉬움. 이를 방지하기 위해서 Progressive-Disclosure 파라미터로 여러 훅들을 구현함.**

  TodoWrite는 이 문제를 해결한다:
  ┌─────────────────────────────────────────┐
  │  TodoWrite = 작업의 전체 지도           │
  │                                         │
  │  • 지금 어디에 있는가? (현재 Phase)     │
  │  • 어디서 왔는가? (완료된 작업들)       │
  │  • 어디로 가는가? (남은 작업들)         │
  │  • 누가 했는가? (Agent 참조)            │
  └─────────────────────────────────────────┘

  ### 왜 이것이 중요한가?

  1. **지속적 맥락 주입**
     - 매 턴마다 TodoWrite가 "전체 그림"을 상기시킴
     - 세부 작업에 빠져도 전체 목표를 잃지 않음

  2. **Subagent 출력 복구**
     - Subagent는 L1(요약)만 반환
     - L2(전체본)는 파일에 저장됨
     - TodoWrite가 "어떤 Agent가 무엇을 했는지" 기록
     - 필요시 L2 파일 참조로 전체본 복구 가능

  3. **Auto-Compact 대응 (부가 효과)**
     - Auto-Compact 후에도 TodoWrite 유지
     - 맥락 손실 없이 즉시 재개

  ### 작성 원칙

  **단순하게, 그러나 완전하게:**

  [1] {작업 설명} - {상태}
  [2] {작업 설명} - {상태}
  [3] {작업 설명} - {상태}

  **복잡한 작업 시 (선택적 확장):**

  [1] {작업 설명} | {Agent 타입} - {상태}
      └─ L2: .agent/outputs/{filename}.md

  ### 실전 예시

  **기본 형태:**
  [1] 요구사항 분석 - done
  [2] 설계 검토 - done
  [3] 핵심 모듈 구현 - in_progress
  [4] 테스트 작성 - pending
  [5] 통합 테스트 - pending

  **Agent 참조 필요 시:**
  [1] 코드베이스 분석 | Explore - done
  [2] 구현 계획 수립 | Plan - done
  [3] Phase 1 구현 | general-purpose - in_progress
  [4] Phase 2 구현 | general-purpose - pending
  [5] 검증 | Explore - pending

  **L2 복구 필요 시:**
  [3] Phase 1 구현 | general-purpose:a1b2c3d - done
      └─ L2: .agent/outputs/phase1_impl_a1b2c3d.md

  ### 핵심 행동 규칙

  | 시점 | 행동 |
  |------|------|
  | 작업 시작 | 전체 Phase를 TodoWrite에 나열 |
  | Phase 진입 | 해당 항목을 `in_progress`로 변경 |
  | Phase 완료 | 해당 항목을 `done`으로 변경 |
  | 새 작업 발견 | TodoWrite에 추가 |
  | L2 참조 필요 | Agent ID와 L2 경로 기록 |

  ### 이것이 제공하는 것

  Main Agent의 매 턴 시작:
         │
         ▼
  ┌─────────────────────────────────────┐
  │  TodoWrite 확인                      │
  │  "아, 나는 지금 [3]을 하고 있구나"   │
  │  "[1], [2]는 완료됐고"              │
  │  "[4], [5]가 남았구나"              │
  └─────────────────────────────────────┘
         │
         ▼
    전체 맥락 유지한 채 작업 계속

  ### 실행

  이 프로토콜에 따라 TodoWrite를 생성하고, 첫 번째 pending 작업을 시작하라.

  ---
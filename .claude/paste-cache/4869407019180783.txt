/plan PAI 7-Phase(OBSERVE→THINK→PLAN→BUILD→EXECUTE→VERIFY→LEARN)
워크플로우를 Claude Code v2.1.3 최신 기능/성능을 최대 활용해 내 환경에
"구현/운영"하기 위한 구현 계획을 수립해줘.

아래 SPEC은 기계가 읽을 수 있는 요구사항이야. SPEC을 100% 준수하고,
결과는 YAML 1개만 출력해(설명/산문/마크다운 금지). 계획만 세우고 실제
파일 수정/설치/설정 변경은 하지 마. (단, 네트워크를 포함한 "읽기 전용"
조사/확인은 가능)

[SPEC]
spec_version: 1
response_language: ko-KR

hard_requirements:
  - planning_only: true
  - output_format: yaml_only
  - ask_user_questions_max: 5
  - if_missing_answers: "make_safe_assumptions_and_mark_them"
  - do_not_modify_files_or_settings: true
  - must_use_network_to_verify_claude_code_2_1_3_features: true

environment:
  os: linux
  home_dir: "~"
  candidate_config_roots:
    - "~/.claude"          # global
    - "./.claude"          # project-local (if exists)
  workspace_hint:
    repo_root: "ASK_OR_DETECT"
    pai_repo_path: "/home/palantir/PAI"   # exists in my machine
  constraints:
    - "현재 시스템은 Claude Code 중심으로 운영 중이며 기존 hooks/skills가 있음. 충돌 최소화가 최우선."
    - "PAI 레포는 참고용으로만; 필요한 부분만 체리픽/포팅 가능."
    - "네트워크 확인은 공개 문서/공식 레포만 사용."

network_verification_tasks:
  - id: fetch_official_changelog
    purpose: "Claude Code v2.1.0~2.1.3 최신 기능/성능을 원문으로 확인"
    preferred_methods:
      - "WebFetch https://raw.githubusercontent.com/anthropics/claude-code/main/CHANGELOG.md"
      - "Bash(curl -fsSL https://raw.githubusercontent.com/anthropics/claude-code/main/CHANGELOG.md)"
    parse_targets:
      - "## 2.1.3"
      - "## 2.1.2"
      - "## 2.1.0"
  - id: fetch_official_plugin_examples
    purpose: "7-phase 워크플로우/반복 루프/훅/에이전트 정의의 공식 구현 패턴 확인"
    urls:
      - "https://raw.githubusercontent.com/anthropics/claude-code/main/plugins/feature-dev/commands/feature-dev.md"
      - "https://raw.githubusercontent.com/anthropics/claude-code/main/plugins/feature-dev/agents/code-explorer.md"
      - "https://raw.githubusercontent.com/anthropics/claude-code/main/plugins/feature-dev/agents/code-architect.md"
      - "https://raw.githubusercontent.com/anthropics/claude-code/main/plugins/feature-dev/agents/code-reviewer.md"
      - "https://raw.githubusercontent.com/anthropics/claude-code/main/plugins/ralph-wiggum/README.md"
      - "https://raw.githubusercontent.com/anthropics/claude-code/main/plugins/security-guidance/hooks/hooks.json"

claude_code_2_1_x_must_account_for:
  # 아래 항목들은 "반드시" feature_map에서 각각 1:1로 다루고(사용/미사용 결정 포함),
  # 본 구현 계획(아키텍처/설정/운영)에 어떤 영향을 주는지 명시해야 한다.
  - version: "2.1.3"
    items:
      - "Merged slash commands and skills (no behavior change)"
      - "Release channel toggle (stable/latest) in /config"
      - "Unreachable permission rules detection + /doctor warnings with sources + fix guidance"
      - "Plan files no longer persist across /clear"
      - "Background task count mismatch fix"
      - "Sub-agents wrong model during compaction fix"
      - "Web search in sub-agents wrong model fix"
      - "Trust dialog acceptance from home dir enabling trust features fix"
      - "Terminal rendering stability improvement"
      - "Slash command suggestion readability improvement"
      - "Tool hook execution timeout: 60s -> 10 minutes"
  - version: "2.1.2"
    items:
      - "Dragged images include source path metadata"
      - "Tool output file paths clickable via OSC 8 terminals"
      - "Plan mode Shift+Tab shortcut for auto-accept edits"
      - "agent_type added to SessionStart hook input when --agent is specified"
      - "Fixed command injection vuln in bash command processing"
      - "Large bash/tool outputs persisted to disk with file references"
      - "Improved permission explainer (routine workflows not flagged as medium risk)"
  - version: "2.1.0"
    items:
      - "Automatic skill hot-reload"
      - "context: fork for skills/slash commands"
      - "agent field in skills to specify agent type"
      - "language setting"
      - "respectGitignore in settings.json"
      - "Wildcard Bash tool permission matching (Bash(npm *), Bash(* install), etc.)"
      - "Unified Ctrl+B backgrounding for bash+agents"
      - "/plan command"
      - "Disable specific agents using Task(AgentName) in permissions or --disallowedTools"
      - "Hooks support in agent frontmatter; hooks support in skill/slash command frontmatter"
      - "Support once: true hooks"
      - "YAML-style lists in allowed-tools field"
      - "Improved skills progress visibility"
      - "Subagents inherit parent model fixes (include in plan assumptions/controls)"
      - "Startup/terminal/perf optimizations (plan should exploit: large outputs on disk, stable rendering, fewer prompts)"

goal:
  name: "PAI 7-Phase Workflow Implementation on Claude Code"
  description: |
    Claude Code v2.1.3 환경에서, PAI의 7단계 실행 프레임워크
    (OBSERVE/THINK/PLAN/BUILD/EXECUTE/VERIFY/LEARN)를
    "재사용 가능한 워크플로우(명령/스킬/플러그인/훅)"로 구현하고
    운영하는 구체적인 구현 계획을 만든다.
    핵심은: (1) 반복 가능, (2) 검증 가능(VERIFY 내재), (3) 기존 설정과 충돌 최소, (4) 롤백 가능.

required_outputs_yaml_schema:
  meta:
    claude_code:
      version_verified: "string"
      release_channel: "stable|latest|unknown"
      verification_sources:
        changelog_url: "string"
        plugin_urls: ["string"]
    assumptions: ["string"]
    open_questions: ["string"]

  feature_map:
    # changelog 항목마다 1개 row (version, item, relevance, how_used, notes)
    - version: "string"
      changelog_item: "string"
      relevance: "high|medium|low"
      used_in_this_implementation: "yes|no"
      how_used_or_why_not: "string"

  design_options:
    - option_id: "A|B|C"
      name: "string"
      summary: "string"
      implementation_shape:
        uses_plugin: "yes|no"
        uses_skill_file: "yes|no"
        uses_hooks: "yes|no"
      pros: ["string"]
      cons: ["string"]
      risks: ["string"]
      rollback: ["string"]
      estimated_effort: "quick|standard|thorough"

  recommended_design:
    option_id: "A|B|C"
    rationale: "string"
    compatibility_notes: ["string"]

  implementation_plan:
    phases:
      - phase: "OBSERVE"
        objective: "string"
        claude_code_features_to_use: ["string"]   # v2.1.x 기능/성능 연결 명시
        activities: ["string"]                    # 실제 수행 액션 (분해)
        artifacts: ["string"]                     # 산출물(ISC/문서/로그/파일 등)
        gates: ["string"]                         # 통과 조건(검증 가능)
      - phase: "THINK"
        objective: "string"
        claude_code_features_to_use: ["string"]
        activities: ["string"]
        artifacts: ["string"]
        gates: ["string"]
      - phase: "PLAN"
        objective: "string"
        claude_code_features_to_use: ["string"]
        activities: ["string"]
        artifacts: ["string"]
        gates: ["string"]
      - phase: "BUILD"
        objective: "string"
        claude_code_features_to_use: ["string"]
        activities: ["string"]
        artifacts: ["string"]
        gates: ["string"]
      - phase: "EXECUTE"
        objective: "string"
        claude_code_features_to_use: ["string"]
        activities: ["string"]
        artifacts: ["string"]
        gates: ["string"]
      - phase: "VERIFY"
        objective: "string"
        claude_code_features_to_use: ["string"]
        activities: ["string"]
        artifacts: ["string"]
        gates: ["string"]
      - phase: "LEARN"
        objective: "string"
        claude_code_features_to_use: ["string"]
        activities: ["string"]
        artifacts: ["string"]
        gates: ["string"]

    assets_to_create_or_change:
      # 계획만: 실제로 만들지 말고, 파일/디렉터리/키 변경을 명시
      - path: "string"
        type: "plugin|command|skill|agent|hook|settings|doc"
        scope: "global|project"
        description: "string"
        key_frontmatter_or_schema_fields: ["string"]
        notes: "string"

    permissions_and_safety_plan:
      # v2.1.3 unreachable rule 진단, v2.1.0 wildcard 문법, /doctor 절차 포함
      target_settings_json: "string"
      proposed_permission_rules:
        allow: ["string"]
        deny: ["string"]
        additionalDirectories: ["string"]
      doctor_checks:
        - "string"
      hook_timeout_budget_minutes: 10

  operating_procedure:
    # 사용자가 매 작업마다 어떻게 쓸지 (명령/스킬 호출, /tasks, Ctrl+B, /clear 등)
    daily_usage_steps: ["string"]
    how_to_start_a_new_task: ["string"]
    how_to_handle_parallel_work: ["string"]
    how_to_handle_large_outputs: ["string"]
    how_to_end_and_learn: ["string"]

  rollout_and_rollback:
    rollout_steps: ["string"]
    rollback_steps: ["string"]

  validation:
    dry_run_steps: ["string"]
    success_criteria: ["string"]

instructions_for_you:
  - "먼저 claude 버전/채널 확인 절차를 계획에 포함하고, v2.1.3이 아니면 계획을 '중단' 상태로 표시해라."
  - "feature_map은 changelog 항목을 빠짐없이 포함해라(각 항목마다 1 row)."
  - "구현 방식은 최소 3가지 옵션(A/B/C) 제시 후 1개를 추천해라."
  - "추천안은 기존 시스템과의 충돌 최소 + 롤백 용이성이 최우선이다."
  - "7단계는 PAI 명칭(OBSERVE..LEARN) 그대로 사용하고, 각 단계에 Claude Code v2.1.x 기능을 명시적으로 연결해라."
  - "계획에는 /plan, /tasks, /doctor, /config, Ctrl+B 백그라운드, context: fork, agent 지정, hooks(10분 타임아웃), permissions wildcard를 어떻게 활용하는지 반드시 들어가야 한다."
  - "출력은 오직 YAML만. 코드블록/마크다운 금지."
[/SPEC]
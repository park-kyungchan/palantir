# Claude Code v2.1.16+ Migration & Configuration Draft
## Machine-Readable Setup for Large-Scale Codebase Refactoring

---

## 1. ENVIRONMENT SETUP

### Shell Configuration (~/.bashrc or ~/.zshrc)
````bash
# ============================================
# CLAUDE CODE v2.1.16+ ENVIRONMENT VARIABLES
# ============================================

# === Session & Task Management ===
export CLAUDE_CODE_TASK_LIST_ID="main-dev"
export CLAUDE_CONFIG_DIR="$HOME/.claude"
export CLAUDE_CODE_TMPDIR="$HOME/.claude/tmp"

# === Performance & Context Optimization ===
export MAX_THINKING_TOKENS=10000
export BASH_DEFAULT_TIMEOUT_MS=300000
export BASH_MAX_TIMEOUT_MS=600000
export MAX_MCP_OUTPUT_TOKENS=25000
export SLASH_COMMAND_TOOL_CHAR_BUDGET=15000

# === Prompt Caching Control ===
export DISABLE_PROMPT_CACHING_HAIKU=0
export DISABLE_PROMPT_CACHING_OPUS=0
export DISABLE_PROMPT_CACHING_SONNET=0

# === Feature Toggles ===
export CLAUDE_CODE_DISABLE_BACKGROUND_TASKS=0
export CLAUDE_CODE_DISABLE_TERMINAL_TITLE=0
export DISABLE_COST_WARNINGS=0
export USE_BUILTIN_RIPGREP=1

# === Session Aliases ===
alias cc='claude'
alias cc-dev='CLAUDE_CODE_TASK_LIST_ID=dev-main claude'
alias cc-refactor='CLAUDE_CODE_TASK_LIST_ID=refactor-tasks claude'
alias cc-test='CLAUDE_CODE_TASK_LIST_ID=test-suite claude'
alias cc-research='CLAUDE_CODE_TASK_LIST_ID=research-notes claude'

# === Quick Session Starters ===
alias cc-plan='claude --permission-mode plan'
alias cc-yolo='claude --dangerously-skip-permissions'
alias cc-resume='claude --resume'
alias cc-continue='claude --continue'
````

---

## 2. PROJECT SETTINGS

### .claude/settings.json
````json
{
  "model": "claude-sonnet-4-5-20250929",
  "cleanupPeriodDays": 30,
  "includeCoAuthoredBy": true,
  "plansDirectory": "./.claude/plans",
  
  "permissions": {
    "allow": [
      "Bash(npm run *)",
      "Bash(pytest *)",
      "Bash(git diff*)",
      "Bash(git status*)",
      "Bash(git log*)",
      "Read(~/.config/**)"
    ],
    "ask": [
      "Bash(git push*)",
      "Bash(git commit*)",
      "Bash(rm -rf*)"
    ],
    "deny": [
      "Read(./.env)",
      "Read(./.env.*)",
      "Read(./secrets/**)",
      "Read(./config/credentials.json)",
      "WebFetch",
      "Bash(curl*)",
      "Bash(wget*)"
    ],
    "defaultMode": "acceptEdits"
  },

  "env": {
    "CLAUDE_CODE_TASK_LIST_ID": "project-main",
    "MAX_THINKING_TOKENS": "10000",
    "BASH_DEFAULT_TIMEOUT_MS": "300000"
  },

  "hooks": {
    "SessionStart": [{
      "matcher": "startup",
      "hooks": [{
        "type": "command",
        "command": "echo '[${CLAUDE_SESSION_ID}] Session started at $(date)' >> .claude/session-log.txt"
      }]
    }],
    
    "PreToolUse": {
      "Edit": {
        "type": "command",
        "command": "echo '{\"additionalContext\": \"Follow project code style guidelines in CONTRIBUTING.md\"}'"
      },
      "Write": {
        "type": "command",
        "command": "echo '{\"additionalContext\": \"Check file naming conventions before creating new files\"}'"
      }
    },
    
    "PostToolUse": {
      "Edit": {
        "type": "command",
        "command": "git diff --no-color > .claude/last-edit-${CLAUDE_SESSION_ID}.diff"
      }
    },
    
    "SessionStop": [{
      "matcher": "shutdown",
      "hooks": [{
        "type": "command",
        "command": "echo '[${CLAUDE_SESSION_ID}] Session ended at $(date)' >> .claude/session-log.txt"
      }]
    }]
  },

  "enabledPlugins": {},
  "extraKnownMarketplaces": {}
}
````

### .claude/settings.local.json (gitignored)
````json
{
  "permissions": {
    "allow": [
      "Bash(docker*)",
      "Bash(kubectl*)"
    ]
  },
  
  "env": {
    "ANTHROPIC_MODEL": "claude-sonnet-4-5-20250929"
  }
}
````

---

## 3. SKILLS SYSTEM

### .claude/skills/session-tracker/SKILL.md
````markdown
---
name: session-tracker
description: Track and log session activities with dependency management
auto-load: true
user-invocable: true
---

# Session Activity Tracker

Current Session: ${CLAUDE_SESSION_ID}
Task List: ${CLAUDE_CODE_TASK_LIST_ID}

## Commands

1. **Log Activity**
```bash
   echo "[${CLAUDE_SESSION_ID}] $(date): $ACTIVITY" >> .claude/activities.log
```

2. **Create Task Snapshot**
```bash
   cat > .claude/snapshots/${CLAUDE_SESSION_ID}.md << EOF
   # Session Snapshot
   Date: $(date)
   Session ID: ${CLAUDE_SESSION_ID}
   Task List: ${CLAUDE_CODE_TASK_LIST_ID}
   
   ## Git Status
   $(git status --short)
   
   ## Current Branch
   $(git branch --show-current)
   
   ## Recent Changes
   $(git log -5 --oneline)
   EOF
```

3. **Task Dependency Check**
   - List all pending tasks
   - Show task dependencies
   - Identify blocking tasks
````

### .claude/skills/refactor-planner/SKILL.md
````markdown
---
name: refactor-planner
description: Plan large-scale refactoring with dependency tracking
user-invocable: true
---

# Large-Scale Refactoring Planner

Session: ${CLAUDE_SESSION_ID}

## Process

1. **Analyze Codebase Structure**
   - Map file dependencies
   - Identify circular dependencies
   - List critical components

2. **Create Refactoring Plan**
   - Break down into atomic tasks
   - Define task dependencies
   - Estimate complexity per task
   - Set execution order

3. **Generate Task List**
```bash
   mkdir -p .claude/plans
   cat > .claude/plans/refactor-${CLAUDE_SESSION_ID}.md << 'PLAN'
   # Refactoring Plan
   
   ## Tasks
   - [ ] Task 1 (Priority: High, Depends: None)
   - [ ] Task 2 (Priority: Medium, Depends: Task 1)
   - [ ] Task 3 (Priority: Low, Depends: Task 1, Task 2)
   
   ## Execution Order
   1. Task 1
   2. Task 2
   3. Task 3
   PLAN
```

4. **Execute with Task List ID**
```bash
   CLAUDE_CODE_TASK_LIST_ID=refactor-${CLAUDE_SESSION_ID} claude
```
````

### .claude/skills/context-manager/SKILL.md
````markdown
---
name: context-manager
description: Manage conversation context and session state
auto-load: true
---

# Context Manager

## Auto-Save Context
```bash
# Save before clearing
cat > .claude/contexts/${CLAUDE_SESSION_ID}-context.md << 'CTX'
# Context Save - $(date)

## Conversation Summary
[SUMMARY PLACEHOLDER]

## Current Task Status
$(cat .claude/tasks/${CLAUDE_CODE_TASK_LIST_ID}/status.txt 2>/dev/null || echo "No task status")

## Key Decisions
[DECISIONS PLACEHOLDER]

## Next Steps
[NEXT_STEPS PLACEHOLDER]
CTX
```

## Usage
1. Call `/save-context` before `/clear`
2. Resume with context: Read .claude/contexts/${CLAUDE_SESSION_ID}-context.md
3. Continue work seamlessly
````

---

## 4. CUSTOM SLASH COMMANDS

### .claude/commands/workspace-setup.md
````markdown
---
name: workspace-setup
description: Initialize workspace for new session
---

Set up the development workspace:

1. Check git status
2. Create session snapshot
3. Load project context from CLAUDE.md
4. Display recent task list
5. Show pending dependencies
6. Ready for work

Execute:
```bash
git status
echo "Session ${CLAUDE_SESSION_ID} initialized" >> .claude/session-log.txt
cat CLAUDE.md
```
````

### .claude/commands/checkpoint.md
````markdown
---
name: checkpoint
description: Create development checkpoint
---

Create a checkpoint of current work:

1. Save all current context to .claude/checkpoints/${CLAUDE_SESSION_ID}.md
2. Commit work in progress with WIP prefix
3. Create git tag checkpoint-${CLAUDE_SESSION_ID}
4. Log checkpoint creation

Execute:
```bash
git add -A
git commit -m "WIP: Checkpoint ${CLAUDE_SESSION_ID}"
git tag "checkpoint-${CLAUDE_SESSION_ID}"
echo "[${CLAUDE_SESSION_ID}] Checkpoint created at $(date)" >> .claude/session-log.txt
```
````

### .claude/commands/migrate-v2.md
````markdown
---
name: migrate-v2
description: Migrate project to Claude Code v2.1.16+ features
---

Migrate the codebase to use latest Claude Code v2.1.16+ features:

## Migration Tasks

1. **Update Configuration**
   - [ ] Create .claude/settings.json with v2.1.16 features
   - [ ] Set up plansDirectory
   - [ ] Configure hooks (SessionStart, PreToolUse, PostToolUse)
   - [ ] Enable ${CLAUDE_SESSION_ID} substitution

2. **Task Management**
   - [ ] Implement CLAUDE_CODE_TASK_LIST_ID strategy
   - [ ] Create shared task directories in ~/.claude/tasks/
   - [ ] Set up task dependency tracking

3. **Skills Migration**
   - [ ] Convert old prompts to new Skills format
   - [ ] Add auto-load flags where appropriate
   - [ ] Implement ${CLAUDE_SESSION_ID} in skills

4. **Environment Setup**
   - [ ] Update shell RC files with new env vars
   - [ ] Create session management aliases
   - [ ] Configure plansDirectory path

5. **Documentation**
   - [ ] Update CLAUDE.md with new features
   - [ ] Document hook usage
   - [ ] Add skill documentation
````

---

## 5. PROJECT MEMORY (CLAUDE.md)

### CLAUDE.md
````markdown
# Project Context for Claude Code v2.1.16+

## Project Overview
[PROJECT DESCRIPTION]

## Code Style Guidelines
- Follow [STYLE_GUIDE]
- Use [FORMATTING_TOOL]
- Maximum line length: 100 characters
- Prefer explicit over implicit

## Build Commands
```bash
npm run build          # Production build
npm run dev            # Development server
npm run test           # Run test suite
npm run lint           # Code linting
```

## Git Workflow
- Branch naming: feature/*, bugfix/*, refactor/*
- Commit format: [type]: description
- Always create PR for main branch
- Require code review before merge

## Session Management
- Use CLAUDE_CODE_TASK_LIST_ID for parallel work
- Save context before /clear with /checkpoint
- Use /workspace-setup to start sessions
- Track dependencies in task lists

## Architecture Decisions
[KEY_DECISIONS]

## Current Priorities
1. [PRIORITY_1]
2. [PRIORITY_2]
3. [PRIORITY_3]

## Dependencies & Constraints
- [DEPENDENCY_1]
- [CONSTRAINT_1]
````

---

## 6. MIGRATION EXECUTION PLAN

### Step-by-Step Migration Script
````bash
#!/bin/bash
# migrate-to-v2.1.16.sh

set -e

echo "=== Claude Code v2.1.16+ Migration ==="

# 1. Backup existing configuration
echo "[1/7] Backing up existing configuration..."
mkdir -p .claude/backup
cp -r .claude/* .claude/backup/ 2>/dev/null || true

# 2. Create new directory structure
echo "[2/7] Creating new directory structure..."
mkdir -p .claude/{plans,skills,commands,contexts,checkpoints,sessions}
mkdir -p ~/.claude/tasks

# 3. Install settings files
echo "[3/7] Installing new settings..."
cat > .claude/settings.json << 'SETTINGS'
{
  "model": "claude-sonnet-4-5-20250929",
  "plansDirectory": "./.claude/plans",
  "cleanupPeriodDays": 30,
  "permissions": {
    "allow": [
      "Bash(npm run *)",
      "Bash(git diff*)",
      "Bash(git status*)"
    ],
    "defaultMode": "acceptEdits"
  },
  "hooks": {
    "SessionStart": [{
      "matcher": "startup",
      "hooks": [{
        "type": "command",
        "command": "echo '[${CLAUDE_SESSION_ID}] Started' >> .claude/session-log.txt"
      }]
    }]
  }
}
SETTINGS

# 4. Create default skills
echo "[4/7] Creating default skills..."
mkdir -p .claude/skills/session-tracker
cat > .claude/skills/session-tracker/SKILL.md << 'SKILL'
---
name: session-tracker
description: Track session activities
auto-load: true
---

# Session Tracker
Session: ${CLAUDE_SESSION_ID}

Log activities to .claude/session-log.txt
SKILL

# 5. Create custom commands
echo "[5/7] Creating custom commands..."
cat > .claude/commands/workspace-setup.md << 'CMD'
---
name: workspace-setup
description: Setup workspace
---

Initialize workspace:
- Git status
- Load CLAUDE.md
- Display tasks
CMD

# 6. Update shell configuration
echo "[6/7] Updating shell configuration..."
cat >> ~/.bashrc << 'SHELL'

# Claude Code v2.1.16+ Configuration
export CLAUDE_CODE_TASK_LIST_ID="main-dev"
export MAX_THINKING_TOKENS=10000
alias cc='claude'
alias cc-dev='CLAUDE_CODE_TASK_LIST_ID=dev-main claude'
SHELL

# 7. Create migration documentation
echo "[7/7] Creating migration documentation..."
cat > .claude/MIGRATION.md << 'DOC'
# Migration to Claude Code v2.1.16+

## Completed
- [x] New settings.json structure
- [x] Skills directory setup
- [x] Custom commands
- [x] Hook configuration
- [x] Task management structure

## New Features Available
1. ${CLAUDE_SESSION_ID} substitution in skills
2. Task dependency tracking
3. plansDirectory customization
4. PreToolUse additionalContext hooks
5. Enhanced session management

## Next Steps
1. Test new configuration: `claude`
2. Try task list sharing: `CLAUDE_CODE_TASK_LIST_ID=test claude`
3. Create your first skill
4. Set up project-specific hooks
DOC

echo ""
echo "âœ… Migration complete!"
echo "ðŸ“ Review .claude/MIGRATION.md for details"
echo "ðŸš€ Start with: claude"
echo ""
````

---

## 7. VERIFICATION CHECKLIST
````markdown
## Post-Migration Verification

### Configuration
- [ ] .claude/settings.json exists with v2.1.16 structure
- [ ] plansDirectory is set and directory exists
- [ ] Hooks are configured (SessionStart, PreToolUse)
- [ ] Environment variables exported in shell RC

### Skills System
- [ ] .claude/skills/ directory exists
- [ ] At least one skill created with frontmatter
- [ ] ${CLAUDE_SESSION_ID} substitution works
- [ ] Skills visible in /skills command

### Task Management
- [ ] CLAUDE_CODE_TASK_LIST_ID environment variable set
- [ ] ~/.claude/tasks/ directory exists
- [ ] Task lists persist across sessions
- [ ] Task dependencies tracked

### Session Management
- [ ] Session logging works (check .claude/session-log.txt)
- [ ] Context saving functional
- [ ] Session resumption works
- [ ] Multiple task lists can be used

### Commands
- [ ] Custom commands in .claude/commands/
- [ ] Commands appear in / menu
- [ ] /workspace-setup works
- [ ] /checkpoint works

### Testing
- [ ] Run: `claude --version` (should be v2.1.16+)
- [ ] Test: `CLAUDE_CODE_TASK_LIST_ID=test claude`
- [ ] Verify: Session ID appears in logs
- [ ] Confirm: Plans saved to plansDirectory
````

---

## 8. QUICK START AFTER MIGRATION
````bash
# Initialize workspace
bash migrate-to-v2.1.16.sh

# Reload shell
source ~/.bashrc  # or source ~/.zshrc

# Start Claude Code with new features
claude

# Inside Claude Code:
> /workspace-setup
> /skills
> Show me my current session configuration
````

---

END OF DRAFT
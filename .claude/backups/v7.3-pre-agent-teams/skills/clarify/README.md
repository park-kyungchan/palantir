# /clarify Skill - Complete Logging Implementation

## Overview

`/clarify` 스킬은 이제 **이중 로깅 시스템**을 통해 모든 상호작용을 완전히 기록합니다.

> **Version:** 2.2.0 - Workload-scoped 출력 경로 지원

## Logging Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                   /clarify Logging System                    │
│                   (Workload-Scoped V2.2.0)                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. Clarify Log (.agent/prompts/{slug}/clarify.yaml) │   │
│  │                                                     │   │
│  │    • YAML structured format                         │   │
│  │    • Round-by-round progression                     │   │
│  │    • PE technique application details               │   │
│  │    • Final approved prompt                          │   │
│  │    • Pipeline integration fields                    │   │
│  │                                                     │   │
│  │    Generated by: helpers.sh functions               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 2. QA Audit Log (.agent/logs/clarify/{session}.jsonl)│  │
│  │                                                     │   │
│  │    • Machine-readable JSONL format                  │   │
│  │    • All AskUserQuestion exchanges                  │   │
│  │    • Timestamped with unique IDs                    │   │
│  │    • Traceability for compliance                    │   │
│  │                                                     │   │
│  │    Generated by: clarify-qa-logger.sh (PostToolUse) │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Workload-Scoped Output Structure

```
.agent/prompts/{workload-slug}/
├── clarify.yaml           ← /clarify 출력 (이 스킬)
├── research.md            ← /research 출력
├── plan.yaml              ← /planning 출력
├── _context.yaml          ← /orchestrate 컨텍스트
├── _progress.yaml         ← 진행 추적
├── collection_report.md   ← /collect 출력
├── outputs/               ← Worker 출력
│   ├── terminal-b/
│   └── terminal-c/
└── synthesis/             ← /synthesis 출력
    └── synthesis_report.md
```

## Usage

```bash
/clarify "사용자 요청 텍스트"

# Resume existing session
/clarify --resume {slug}
```

## Verification

### Check Clarify Log (Workload-scoped)
```bash
ls -lht .agent/prompts/*/clarify.yaml | head -1
cat .agent/prompts/<slug>/clarify.yaml
```

### Check QA Audit Log
```bash
ls -lht .agent/logs/clarify/*.jsonl | head -1
cat .agent/logs/clarify/<session_id>-qa-audit.jsonl | jq .
```

## Log Locations

| Log Type | Path | Format | Purpose |
|----------|------|--------|---------|
| Clarify Log | `.agent/prompts/{slug}/clarify.yaml` | YAML | Human review + Pipeline |
| QA Audit | `.agent/logs/clarify/{session}-qa-audit.jsonl` | JSONL | Machine analysis |

## Helper Functions

Source: `/home/palantir/.claude/skills/clarify/helpers.sh`

- `generate_slug()`: Create file-safe slug from input
- `write_log_header()`: Initialize round log
- `append_round_log()`: Add round entry
- `finalize_log()`: Mark as completed
- `cancel_log()`: Mark as cancelled
- `update_round_summary()`: Update summary table

## Testing

```bash
# 1. Invoke clarify with a test input
/clarify "테스트 요청입니다"

# 2. Go through at least one round of Q&A

# 3. Check logs (Workload-scoped)
ls .agent/prompts/*/clarify.yaml
ls .agent/logs/clarify/*.jsonl
```

## Troubleshooting

### No logs generated
- Ensure `.agent/prompts/` and `.agent/logs/clarify/` directories exist
- Verify `helpers.sh` is executable: `chmod +x helpers.sh`
- Check hook is registered: `grep -A3 "AskUserQuestion" ~/.claude/settings.json`

### Partial logs
- Clarify log created but QA audit missing: Hook not triggered
- QA audit created but clarify log empty: Helper functions not called

## Status

- [x] AskUserQuestion hook registered in settings.json
- [x] clarify-qa-logger.sh hook script exists
- [x] helpers.sh utility functions created
- [x] SKILL.md updated with implementation details
- [x] Log directories created
- [x] Workload-scoped output paths (V2.2.0)

**Current Status:** Fully operational with workload-scoped outputs.

"""
Unit tests for FunctionType definitions.

Tests cover:
- Basic construction and validation
- Decorator type validation (@Function, @OntologyEditFunction, @Query)
- @Edits declaration requirements
- Serialization (to_foundry_dict / from_foundry_dict roundtrip)
"""

import pytest
from pydantic import ValidationError

from ontology_definition.types import (
    FunctionType,
    FunctionSignature,
    FunctionParameter,
    FunctionParameterTypeSpec,
    FunctionMetadata,
    EditsDeclaration,
)
from ontology_definition.core.enums import (
    FunctionDecoratorType,
    FunctionParameterType,
    FunctionStatus,
)


class TestFunctionParameterTypeSpec:
    """Tests for FunctionParameterTypeSpec - parameter type specification."""

    def test_simple_string_type(self):
        """Simple STRING type should work."""
        spec = FunctionParameterTypeSpec(type=FunctionParameterType.STRING)
        assert spec.type == FunctionParameterType.STRING

    def test_object_set_requires_type_parameter(self):
        """OBJECT_SET requires type_parameter."""
        with pytest.raises(ValidationError) as exc_info:
            FunctionParameterTypeSpec(type=FunctionParameterType.OBJECT_SET)
        assert "OBJECT_SET requires type_parameter" in str(exc_info.value)

    def test_object_set_with_type_ref(self):
        """OBJECT_SET with type_parameter should work."""
        spec = FunctionParameterTypeSpec(
            type=FunctionParameterType.OBJECT_SET,
            type_parameter="Employee"
        )
        assert spec.type == FunctionParameterType.OBJECT_SET
        assert spec.type_parameter == "Employee"

    def test_array_requires_item_type(self):
        """ARRAY requires item_type."""
        with pytest.raises(ValidationError) as exc_info:
            FunctionParameterTypeSpec(type=FunctionParameterType.ARRAY)
        assert "ARRAY requires item_type" in str(exc_info.value)

    def test_array_with_item_type(self):
        """ARRAY with item type should work."""
        spec = FunctionParameterTypeSpec(
            type=FunctionParameterType.ARRAY,
            item_type=FunctionParameterTypeSpec(type=FunctionParameterType.STRING)
        )
        assert spec.type == FunctionParameterType.ARRAY
        assert spec.item_type.type == FunctionParameterType.STRING

    def test_to_foundry_dict_simple(self):
        """Export simple type to Foundry dict."""
        spec = FunctionParameterTypeSpec(type=FunctionParameterType.STRING)
        result = spec.to_foundry_dict()
        assert result == {"type": "STRING"}

    def test_to_foundry_dict_object_set(self):
        """Export OBJECT_SET type to Foundry dict."""
        spec = FunctionParameterTypeSpec(
            type=FunctionParameterType.OBJECT_SET,
            type_parameter="Employee"
        )
        result = spec.to_foundry_dict()
        assert result == {"type": "OBJECT_SET", "typeParameter": "Employee"}


class TestFunctionParameter:
    """Tests for FunctionParameter - function input parameter."""

    def test_basic_parameter(self):
        """Basic parameter definition should work."""
        param = FunctionParameter(
            name="employeeId",
            param_type=FunctionParameterTypeSpec(type=FunctionParameterType.STRING),
            optional=False
        )
        assert param.name == "employeeId"
        assert param.optional is False

    def test_parameter_with_default(self):
        """Parameter with default value should work."""
        param = FunctionParameter(
            name="limit",
            param_type=FunctionParameterTypeSpec(type=FunctionParameterType.INTEGER),
            optional=True,
            default_value=100
        )
        assert param.default_value == 100


class TestFunctionSignature:
    """Tests for FunctionSignature - function input/output signature."""

    def test_basic_signature(self):
        """Basic signature with parameters and return type."""
        sig = FunctionSignature(
            inputs=[
                FunctionParameter(
                    name="employeeId",
                    param_type=FunctionParameterTypeSpec(type=FunctionParameterType.STRING),
                    optional=False
                )
            ],
            return_type=FunctionParameterTypeSpec(type=FunctionParameterType.OBJECT_TYPE, type_parameter="Employee")
        )
        assert len(sig.inputs) == 1
        assert sig.return_type.type == FunctionParameterType.OBJECT_TYPE

    def test_void_return_type(self):
        """Signature with VOID return type."""
        sig = FunctionSignature(
            inputs=[],
            return_type=FunctionParameterTypeSpec(type=FunctionParameterType.VOID)
        )
        assert sig.return_type.type == FunctionParameterType.VOID


class TestEditsDeclaration:
    """Tests for EditsDeclaration - @Edits annotation."""

    def test_basic_edits_declaration(self):
        """Basic @Edits declaration."""
        edits = EditsDeclaration(object_types=["Employee", "Department"])
        assert len(edits.object_types) == 2

    def test_edits_requires_at_least_one_ref(self):
        """@Edits requires at least one ObjectType reference."""
        with pytest.raises(ValidationError) as exc_info:
            EditsDeclaration(object_types=[])
        assert "min_length" in str(exc_info.value).lower() or "length" in str(exc_info.value).lower()


class TestFunctionType:
    """Tests for FunctionType - the main function definition."""

    def test_basic_function(self):
        """Basic @Function definition."""
        func = FunctionType(
            api_name="getEmployeeById",
            display_name="Get Employee By ID",
            decorator_type=FunctionDecoratorType.FUNCTION,
            signature=FunctionSignature(
                inputs=[
                    FunctionParameter(
                        name="employeeId",
                        param_type=FunctionParameterTypeSpec(type=FunctionParameterType.STRING),
                        optional=False
                    )
                ],
                return_type=FunctionParameterTypeSpec(
                    type=FunctionParameterType.OBJECT_TYPE,
                    type_parameter="Employee"
                )
            ),
            status=FunctionStatus.ACTIVE
        )
        assert func.api_name == "getEmployeeById"
        assert func.decorator_type == FunctionDecoratorType.FUNCTION

    def test_ontology_edit_function_requires_edits(self):
        """@OntologyEditFunction requires @Edits declaration."""
        with pytest.raises(ValidationError) as exc_info:
            FunctionType(
                api_name="updateEmployee",
                display_name="Update Employee",
                decorator_type=FunctionDecoratorType.ONTOLOGY_EDIT_FUNCTION,
                signature=FunctionSignature(
                    inputs=[],
                    return_type=FunctionParameterTypeSpec(type=FunctionParameterType.VOID)
                ),
                # Missing edits!
            )
        assert "@OntologyEditFunction requires @Edits" in str(exc_info.value)

    def test_ontology_edit_function_must_return_void(self):
        """@OntologyEditFunction should return VOID."""
        with pytest.raises(ValidationError) as exc_info:
            FunctionType(
                api_name="updateEmployee",
                display_name="Update Employee",
                decorator_type=FunctionDecoratorType.ONTOLOGY_EDIT_FUNCTION,
                signature=FunctionSignature(
                    inputs=[],
                    return_type=FunctionParameterTypeSpec(type=FunctionParameterType.STRING)  # Not VOID!
                ),
                edits=EditsDeclaration(object_types=["Employee"])
            )
        assert "should return VOID" in str(exc_info.value)

    def test_valid_ontology_edit_function(self):
        """Valid @OntologyEditFunction with @Edits."""
        func = FunctionType(
            api_name="updateEmployee",
            display_name="Update Employee",
            decorator_type=FunctionDecoratorType.ONTOLOGY_EDIT_FUNCTION,
            signature=FunctionSignature(
                inputs=[
                    FunctionParameter(
                        name="employeeId",
                        param_type=FunctionParameterTypeSpec(type=FunctionParameterType.STRING),
                        optional=False
                    )
                ],
                return_type=FunctionParameterTypeSpec(type=FunctionParameterType.VOID)
            ),
            edits=EditsDeclaration(object_types=["Employee"])
        )
        assert func.decorator_type == FunctionDecoratorType.ONTOLOGY_EDIT_FUNCTION
        assert func.edits is not None

    def test_query_function(self):
        """@Query function definition."""
        func = FunctionType(
            api_name="searchEmployees",
            display_name="Search Employees",
            decorator_type=FunctionDecoratorType.QUERY,
            signature=FunctionSignature(
                inputs=[
                    FunctionParameter(
                        name="searchTerm",
                        param_type=FunctionParameterTypeSpec(type=FunctionParameterType.STRING),
                        optional=False
                    )
                ],
                return_type=FunctionParameterTypeSpec(
                    type=FunctionParameterType.OBJECT_SET,
                    type_parameter="Employee"
                )
            )
        )
        assert func.decorator_type == FunctionDecoratorType.QUERY

    def test_unique_parameter_names(self):
        """Parameter names must be unique."""
        with pytest.raises(ValidationError) as exc_info:
            FunctionType(
                api_name="testFunc",
                display_name="Test Function",
                decorator_type=FunctionDecoratorType.FUNCTION,
                signature=FunctionSignature(
                    inputs=[
                        FunctionParameter(
                            name="param1",
                            param_type=FunctionParameterTypeSpec(type=FunctionParameterType.STRING),
                        ),
                        FunctionParameter(
                            name="param1",  # Duplicate!
                            param_type=FunctionParameterTypeSpec(type=FunctionParameterType.STRING),
                        ),
                    ],
                    return_type=FunctionParameterTypeSpec(type=FunctionParameterType.VOID)
                )
            )
        assert "Duplicate" in str(exc_info.value)

    def test_to_foundry_dict_roundtrip(self):
        """to_foundry_dict / from_foundry_dict should roundtrip."""
        original = FunctionType(
            api_name="getEmployeeById",
            display_name="Get Employee By ID",
            description="Retrieves an employee by their unique identifier.",
            decorator_type=FunctionDecoratorType.FUNCTION,
            signature=FunctionSignature(
                inputs=[
                    FunctionParameter(
                        name="employeeId",
                        param_type=FunctionParameterTypeSpec(type=FunctionParameterType.STRING),
                        optional=False
                    )
                ],
                return_type=FunctionParameterTypeSpec(
                    type=FunctionParameterType.OBJECT_TYPE,
                    type_parameter="Employee"
                )
            ),
            status=FunctionStatus.ACTIVE,
            metadata=FunctionMetadata(
                repository="my-repo",
                file_path="src/functions/employee.ts",
                function_name="getEmployeeById"
            )
        )

        dict_form = original.to_foundry_dict()
        restored = FunctionType.from_foundry_dict(dict_form)

        assert restored.api_name == original.api_name
        assert restored.display_name == original.display_name
        assert restored.description == original.description
        assert restored.decorator_type == original.decorator_type
        assert restored.status == original.status
        assert len(restored.signature.inputs) == len(original.signature.inputs)

    def test_decorator_type_properties(self):
        """Test decorator type helper properties."""
        assert FunctionDecoratorType.FUNCTION.allows_side_effects is True
        assert FunctionDecoratorType.QUERY.allows_side_effects is False
        assert FunctionDecoratorType.ONTOLOGY_EDIT_FUNCTION.can_modify_ontology is True
        assert FunctionDecoratorType.FUNCTION.can_modify_ontology is False

#!/bin/bash
# =============================================================================
# Clarify Q&A Logger Hook
# =============================================================================
# Purpose: Capture all AskUserQuestion exchanges for full traceability
# Trigger: PostToolUse on AskUserQuestion
# Output: JSONL audit log at .agent/logs/clarify/{session_id}-qa-audit.jsonl
# =============================================================================

set -euo pipefail

# Read hook input from stdin
HOOK_INPUT=$(cat)

# Parse essential fields
TOOL_NAME=$(echo "$HOOK_INPUT" | jq -r '.tool_name // empty')
SESSION_ID=$(echo "$HOOK_INPUT" | jq -r '.session_id // "unknown"')

# Only process AskUserQuestion
if [[ "$TOOL_NAME" != "AskUserQuestion" ]]; then
    # Pass through - not our target
    echo '{"continue": true}'
    exit 0
fi

# Extract Q&A data
TOOL_INPUT=$(echo "$HOOK_INPUT" | jq '.tool_input')
TOOL_RESPONSE=$(echo "$HOOK_INPUT" | jq '.tool_response // empty')
TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

# Create log directory
LOG_DIR=".agent/logs/clarify"
mkdir -p "$LOG_DIR"

LOG_FILE="${LOG_DIR}/${SESSION_ID}-qa-audit.jsonl"

# Generate unique Q&A ID
QA_ID="qa-$(date +%s%N | sha256sum | head -c 8)"

# Extract questions and answers
QUESTIONS=$(echo "$TOOL_INPUT" | jq -c '.questions // []')
ANSWERS=$(echo "$TOOL_RESPONSE" | jq -c '.answers // {}')

# Determine answer type
if echo "$TOOL_RESPONSE" | jq -e '.answers | to_entries | .[0].value | contains(",")' > /dev/null 2>&1; then
    ANSWER_TYPE="multi-select"
else
    ANSWER_TYPE="selected-option"
fi

# Build audit log entry
AUDIT_ENTRY=$(jq -n \
    --arg id "$QA_ID" \
    --arg ts "$TIMESTAMP" \
    --arg sid "$SESSION_ID" \
    --arg atype "$ANSWER_TYPE" \
    --argjson questions "$QUESTIONS" \
    --argjson answers "$ANSWERS" \
    '{
        id: $id,
        timestamp: $ts,
        sessionId: $sid,
        event: "clarification_qa",
        questions: $questions,
        answers: $answers,
        answerType: $atype
    }'
)

# Append to audit log
echo "$AUDIT_ENTRY" >> "$LOG_FILE"

# Log to notifications (optional)
NOTIFY_LOG=".agent/logs/oda_notifications.log"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] CLARIFY-QA: Logged Q&A $QA_ID to $LOG_FILE" >> "$NOTIFY_LOG"

# Return success with context
jq -n \
    --arg qa_id "$QA_ID" \
    --arg log_path "$LOG_FILE" \
    '{
        continue: true,
        hookSpecificOutput: {
            hookEventName: "PostToolUse",
            qaId: $qa_id,
            logPath: $log_path,
            additionalContext: "Q&A exchange logged for traceability"
        }
    }'

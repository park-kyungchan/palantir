{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://uclp.dev/schema/v2.1.0",
  "title": "Universal Code Learning Protocol Schema v2.1",
  "description": "JSON Schema for validating UCLP v2.1.0 protocol files with full $ref support and conditional validation",
  "type": "object",

  "definitions": {
    "source": {
      "type": "object",
      "description": "Structured citation for referenced information",
      "properties": {
        "title": {"type": "string", "minLength": 1},
        "url": {"type": "string", "format": "uri"},
        "type": {
          "type": "string",
          "enum": ["official_doc", "pep", "swift_evolution", "go_proposal", "creator_interview", "creator_talk", "blog", "book", "community", "benchmark", "repository", "specification", "article", "video"]
        },
        "language": {"type": "string", "enum": ["go", "python", "swift", "typescript", "all"]},
        "author": {"type": "string"},
        "accessed_date": {"type": "string", "format": "date"},
        "section": {"type": "string"},
        "quote": {"type": "string"},
        "year": {"type": "integer", "minimum": 1970, "maximum": 2100},
        "note": {"type": "string", "maxLength": 200}
      },
      "required": ["title", "type", "language"],
      "allOf": [
        {
          "if": {"properties": {"type": {"enum": ["official_doc", "pep", "swift_evolution", "go_proposal", "blog", "repository", "specification", "article"]}}},
          "then": {"required": ["url"]}
        },
        {
          "if": {"properties": {"type": {"enum": ["creator_interview", "creator_talk", "video"]}}},
          "then": {"required": ["author"]}
        },
        {
          "if": {"properties": {"type": {"const": "book"}}},
          "then": {"required": ["author", "year"]}
        }
      ]
    },

    "sources_array": {
      "type": "array",
      "items": {"$ref": "#/definitions/source"}
    },

    "language_entry": {
      "type": "object",
      "properties": {
        "id": {"type": "string", "pattern": "^[a-z]+$"},
        "display_name": {"type": "string", "minLength": 1},
        "code_fence_lang": {"type": "string"},
        "order": {"type": "integer", "minimum": 1},
        "enabled": {"type": "boolean"},
        "added_version": {"type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$"},
        "file_extensions": {"type": "array", "items": {"type": "string"}, "minItems": 1},
        "package_manager": {"type": "string"},
        "doc_sources": {"type": "array", "items": {"type": "string", "format": "uri"}, "minItems": 1},
        "official_style_guide": {"type": "string", "format": "uri"},
        "community_resources": {"type": "array", "items": {"type": "string", "format": "uri"}}
      },
      "required": ["id", "display_name", "code_fence_lang", "order", "enabled", "added_version", "doc_sources"]
    },

    "comparison_axis": {
      "type": "object",
      "properties": {
        "axis_id": {"type": "string", "pattern": "^[a-z_]+$"},
        "name": {"type": "string", "minLength": 1},
        "description": {"type": "string", "minLength": 1},
        "how_to_compare": {"type": "string"}
      },
      "required": ["axis_id", "name", "description"]
    },

    "core_principle": {
      "type": "object",
      "properties": {
        "principle": {"type": "string", "minLength": 1},
        "explanation": {"type": "string", "minLength": 1},
        "concrete_example": {"type": "string"},
        "concrete_examples": {"type": "array", "items": {"type": "string"}},
        "sources": {"$ref": "#/definitions/sources_array"}
      },
      "required": ["principle", "explanation"]
    },

    "famous_quote": {
      "type": "object",
      "properties": {
        "quote": {"type": "string", "minLength": 1},
        "author": {"type": "string", "minLength": 1},
        "sources": {"$ref": "#/definitions/sources_array"}
      },
      "required": ["quote", "author"]
    },

    "language_philosophy": {
      "type": "object",
      "properties": {
        "creators": {"type": "array", "items": {"type": "string"}, "minItems": 1},
        "birth_year": {"type": "integer", "minimum": 1950, "maximum": 2100},
        "origin_organization": {"type": "string"},
        "problem_to_solve": {"type": "array", "items": {"type": "string"}},
        "core_principles": {"type": "array", "items": {"$ref": "#/definitions/core_principle"}, "minItems": 1},
        "intentionally_excluded": {"type": "array"},
        "intentionally_included": {"type": "array"},
        "famous_quotes": {"type": "array", "items": {"$ref": "#/definitions/famous_quote"}},
        "zen_of_python_pep20": {"type": "array", "items": {"type": "string"}},
        "evolution_highlights": {"type": "array"}
      },
      "required": ["creators", "birth_year", "core_principles"]
    },

    "idiomatic_pattern": {
      "type": "object",
      "properties": {
        "pattern": {"type": "string", "minLength": 1},
        "usage": {"type": "string", "minLength": 1},
        "philosophy": {"type": "string", "minLength": 1}
      },
      "required": ["pattern", "usage", "philosophy"]
    },

    "concept_entry": {
      "type": "object",
      "properties": {
        "id": {"type": "string", "pattern": "^[a-z_]+$"},
        "name": {"type": "string", "minLength": 1},
        "prerequisites": {"type": "array", "items": {"type": "string"}},
        "related": {"type": "array", "items": {"type": "string"}}
      },
      "required": ["id", "name", "prerequisites", "related"]
    },

    "language_example": {
      "type": "object",
      "properties": {
        "syntax": {"type": "string"},
        "design_decision": {"type": "string"},
        "historical_context": {"type": "string"},
        "tradeoff": {"type": "string"},
        "creator_quote": {"type": "string"},
        "zen_connection": {"type": "string"},
        "evolution": {"type": "string"},
        "sources": {"$ref": "#/definitions/sources_array"}
      },
      "required": ["syntax", "design_decision", "sources"]
    },

    "validation_mode": {
      "type": "object",
      "properties": {
        "enabled": {"type": "boolean"},
        "command": {"type": "string"},
        "fallback": {"type": "string"},
        "exit_on_error": {"type": "boolean"},
        "description": {"type": "string"},
        "prerequisites": {"type": "array", "items": {"type": "string"}},
        "skip_patterns": {"type": "array", "items": {"type": "string"}},
        "requires": {"type": "array", "items": {"type": "string"}}
      },
      "required": ["enabled", "command", "exit_on_error"]
    },

    "cacheable_component": {
      "type": "object",
      "properties": {
        "cacheable": {"type": "boolean"},
        "ttl_seconds": {"type": "integer", "minimum": 0},
        "category": {"type": "string", "enum": ["static", "semi-static", "dynamic", "highly-dynamic"]},
        "description": {"type": "string"}
      },
      "required": ["cacheable", "ttl_seconds", "category", "description"]
    },

    "explanation_component": {
      "type": "object",
      "properties": {
        "component": {"type": "string", "pattern": "^[a-z_]+$"},
        "description": {"type": "string"},
        "prompt_template": {"type": "string"},
        "sources": {"type": "array", "items": {"type": "string"}},
        "cacheable": {"type": "boolean"},
        "ttl_seconds": {"type": "integer", "minimum": 0}
      },
      "required": ["component", "description", "prompt_template"]
    }
  },

  "properties": {
    "$schema": {"type": "string", "format": "uri"},
    "protocol_name": {"type": "string", "const": "Universal Code Learning Protocol"},
    "version": {"type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$"},
    "description": {"type": "string"},

    "metadata": {
      "type": "object",
      "properties": {
        "created_date": {"type": "string"},
        "last_updated": {"type": "string"},
        "maintainers": {"type": "array", "items": {"type": "string"}, "minItems": 1},
        "license": {"type": "string"}
      },
      "required": ["created_date", "last_updated", "maintainers"]
    },

    "versioning": {
      "type": "object",
      "properties": {
        "current_version": {"type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$"},
        "version_format": {"type": "string"},
        "version_pattern": {"type": "string"},
        "rules": {"type": "object"}
      },
      "required": ["current_version"]
    },

    "changelog": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "version": {"type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$"},
          "date": {"type": "string"},
          "breaking": {"type": "boolean"},
          "changes": {"type": "array", "items": {"type": "string"}, "minItems": 1},
          "migration_guide": {"type": ["string", "null"]}
        },
        "required": ["version", "date", "breaking", "changes"]
      },
      "minItems": 1
    },

    "compatibility": {
      "type": "object",
      "properties": {
        "min_llm_capabilities": {"type": "object"},
        "tested_llms": {"type": "array"},
        "dashboard_requirements": {"type": "object"}
      },
      "required": ["min_llm_capabilities"]
    },

    "definitions": {
      "type": "object",
      "description": "Embedded reusable schema definitions"
    },

    "languages_metadata": {
      "type": "object",
      "patternProperties": {
        "^[a-z]+$": {"$ref": "#/definitions/language_entry"}
      },
      "minProperties": 1
    },

    "language_extension_guide": {
      "type": "object",
      "properties": {
        "required_fields": {"type": "array", "items": {"type": "string"}},
        "steps": {"type": "array", "items": {"type": "string"}, "minItems": 1}
      },
      "required": ["required_fields", "steps"]
    },

    "source_schema": {"type": "object"},

    "sections": {
      "type": "object",
      "properties": {
        "core_philosophy": {
          "type": "object",
          "properties": {
            "description": {"type": "string"},
            "languages": {
              "type": "object",
              "patternProperties": {
                "^[a-z]+$": {"$ref": "#/definitions/language_philosophy"}
              }
            },
            "comparison_axes": {"type": "object"}
          },
          "required": ["description", "languages"]
        },
        "response_structure": {
          "type": "object",
          "properties": {
            "description": {"type": "string"},
            "template": {"type": "object"},
            "formatting_guidelines": {"type": "object"}
          },
          "required": ["description", "template"]
        },
        "comparison_framework": {
          "type": "object",
          "properties": {
            "description": {"type": "string"},
            "required_axes_per_category": {
              "type": "object",
              "patternProperties": {
                "^[a-z_]+$": {"type": "array", "items": {"type": "string"}, "minItems": 1}
              }
            },
            "universal_required_axes": {"type": "array", "items": {"type": "string"}},
            "completeness_rules": {"type": "object"},
            "concept_categories": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "category": {"type": "string"},
                  "concepts": {"type": "array", "items": {"$ref": "#/definitions/concept_entry"}}
                },
                "required": ["category", "concepts"]
              }
            },
            "comparison_axes": {
              "type": "array",
              "items": {"$ref": "#/definitions/comparison_axis"}
            },
            "idiomatic_patterns": {
              "type": "object",
              "patternProperties": {
                "^[a-z]+$": {"type": "array", "items": {"$ref": "#/definitions/idiomatic_pattern"}}
              }
            }
          },
          "required": ["description", "required_axes_per_category", "comparison_axes", "idiomatic_patterns"]
        },
        "dynamic_context": {
          "type": "object",
          "properties": {
            "description": {"type": "string"},
            "principle": {"type": "string"},
            "explanation_components": {
              "type": "array",
              "items": {"$ref": "#/definitions/explanation_component"}
            },
            "generation_protocol": {"type": "object"},
            "caching_strategy": {
              "type": "object",
              "properties": {
                "enabled": {"type": "boolean"},
                "backend": {"type": "string"},
                "default_ttl_seconds": {"type": "integer", "minimum": 0},
                "key_strategy": {"type": "object"},
                "ttl_constants": {"type": "object"},
                "cacheable_components": {
                  "type": "object",
                  "patternProperties": {
                    "^[a-z_]+$": {"$ref": "#/definitions/cacheable_component"}
                  }
                },
                "non_cacheable_components": {"type": "array", "items": {"type": "string"}},
                "invalidation_rules": {"type": "object"},
                "implementation": {"type": "object"}
              },
              "required": ["enabled", "cacheable_components"]
            },
            "quality_criteria": {"type": "array"},
            "fallback_rules": {"type": "array"}
          },
          "required": ["description", "explanation_components", "generation_protocol", "caching_strategy"]
        }
      },
      "required": ["core_philosophy", "response_structure", "comparison_framework", "dynamic_context"]
    },

    "depth_selection": {
      "type": "object",
      "properties": {
        "default_level": {"type": "string", "enum": ["beginner", "intermediate", "advanced"]},
        "override_param": {"type": "string"},
        "allowed_levels": {"type": "array", "items": {"type": "string"}},
        "auto_detection": {"type": "object"},
        "selection_algorithm": {"type": "object"},
        "level_response_differences": {"type": "object"}
      },
      "required": ["default_level", "allowed_levels"]
    },

    "code_validation": {
      "type": "object",
      "properties": {
        "global": {
          "type": "object",
          "properties": {
            "default_mode": {"type": "string", "enum": ["light", "strict", "off"]},
            "continue_on_error": {"type": "boolean"},
            "timeout_seconds": {"type": "integer", "minimum": 1}
          },
          "required": ["default_mode"]
        },
        "languages": {
          "type": "object",
          "patternProperties": {
            "^[a-z]+$": {
              "type": "object",
              "properties": {
                "light": {"$ref": "#/definitions/validation_mode"},
                "strict": {"$ref": "#/definitions/validation_mode"}
              }
            }
          }
        },
        "context_modes": {"type": "object"},
        "error_handling": {"type": "object"},
        "placeholder_rules": {"type": "object"},
        "minimal_example_requirements": {"type": "object"}
      },
      "required": ["global", "languages"]
    },

    "example_explanations": {
      "type": "object",
      "patternProperties": {
        "^[a-z_]+$": {
          "type": "object",
          "patternProperties": {
            "^[a-z]+$": {"$ref": "#/definitions/language_example"}
          }
        }
      }
    },

    "usage_instructions": {
      "type": "object",
      "properties": {
        "for_llm": {"type": "array", "items": {"type": "string"}},
        "for_human_reviewer": {"type": "array", "items": {"type": "string"}},
        "for_dashboard": {"type": "array", "items": {"type": "string"}}
      },
      "required": ["for_llm"]
    },

    "json_schema_validation": {"type": "object"},
    "authoritative_sources": {"type": "object"}
  },

  "required": [
    "protocol_name",
    "version",
    "metadata",
    "versioning",
    "changelog",
    "compatibility",
    "languages_metadata",
    "sections",
    "depth_selection",
    "code_validation",
    "usage_instructions"
  ]
}

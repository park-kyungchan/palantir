# Palantir FDE Learning - CI Pipeline
# Runs on push and PR to ensure quality gates

name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

env:
  PYTHON_VERSION: "3.10"

jobs:
  # ============================================================================
  # Quality Gate: Lint & Format
  # ============================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff mypy

      - name: Check formatting with Black
        run: black --check --diff .

      - name: Lint with Ruff
        run: ruff check .

      - name: Type check with mypy
        run: mypy . --ignore-missing-imports || true  # Non-blocking for now

  # ============================================================================
  # Quality Gate: Tests
  # ============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint  # Only run if lint passes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false  # Non-blocking for now
        continue-on-error: true

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 7

  # ============================================================================
  # Quality Gate: KB Structure Validation
  # ============================================================================
  validate-kb:
    name: Validate Knowledge Bases
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Validate KB 7-component structure
        run: |
          pytest tests/unit/test_kb_structure.py \
            -v \
            --tb=short \
            -x  # Stop on first failure

  # ============================================================================
  # Documentation Check (Optional)
  # ============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for README
        run: |
          if [ -f "palantir-fde-learning/README.md" ]; then
            echo "README.md found"
          else
            echo "Warning: palantir-fde-learning/README.md not found"
          fi

      - name: Check LEARNING_INDEX.md
        run: |
          if [ -f "LEARNING_INDEX.md" ]; then
            echo "LEARNING_INDEX.md found"
          else
            echo "Error: LEARNING_INDEX.md is required"
            exit 1
          fi
